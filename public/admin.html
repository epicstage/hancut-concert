<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê´€ë¦¬ì í˜ì´ì§€ - í•œë™í›ˆ í† í¬ì½˜ì„œíŠ¸</title>
  <link rel="stylesheet" href="/styles.css" />
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.1); }
    th { font-weight: 600; color: #374151; }
    tr:hover { background: rgba(0,0,0,0.02); }
    .zone-select { padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #d1d5db; }
    .seat-input { width: 80px; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #d1d5db; }
  </style>
</head>
<body>
  <div class="min-h-screen bg-gradient-to-br from-red-50 via-white to-sky-50">
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
      <div class="glass-card max-w-md w-full">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
        <form id="loginForm" class="space-y-4">
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
            <input id="password" type="password" class="input-glass" required />
          </div>
          <button type="submit" class="btn-primary-glass w-full" id="loginBtn">ë¡œê·¸ì¸</button>
        </form>
      </div>
    </div>

    <div id="adminScreen" class="hidden">
      <header class="glass-header">
        <div class="max-w-7xl mx-auto px-4 py-4">
          <div class="flex items-center justify-between">
            <h1 class="text-2xl font-bold text-gray-900">ê´€ë¦¬ì í˜ì´ì§€</h1>
            <div id="statistics" class="flex gap-4 text-sm">
              <div class="text-gray-600">
                <span class="font-semibold text-gray-900">ì‹ ì²­ ì¸ì›:</span>
                <span id="totalCount" class="ml-1 text-gray-700">0</span>ëª…
              </div>
              <div class="text-gray-600">
                <span class="font-semibold text-red-600">ì…ê¸ˆ í™•ì¸:</span>
                <span id="paidCount" class="ml-1 text-red-600">0</span>ëª…
              </div>
            </div>
          </div>
        </div>
      </header>

      <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="glass-card mb-6">
          <div class="flex gap-4 border-b border-gray-200">
            <button onclick="showParticipantsTab()" id="participantsTab" class="px-4 py-2 font-semibold text-red-600 border-b-2 border-red-600">
              ì°¸ê°€ì ê´€ë¦¬
            </button>
            <button onclick="showPaymentTab()" id="paymentTab" class="px-4 py-2 font-semibold text-gray-600 hover:text-red-600">
              ì…ê¸ˆí™•ì¸
            </button>
            <button onclick="showInquiriesTab()" id="inquiriesTab" class="px-4 py-2 font-semibold text-gray-600 hover:text-red-600">
              ë¬¸ì˜ ê´€ë¦¬
            </button>
            <button onclick="showCheckinTab()" id="checkinTab" class="px-4 py-2 font-semibold text-gray-600 hover:text-red-600">
              QR ì²´í¬ì¸
            </button>
          </div>
        </div>

        <!-- ì°¸ê°€ì ê´€ë¦¬ íƒ­ -->
        <div id="participantsSection">
        <!-- ì¢Œì„ ë°°ì • íŒ¨ë„ -->
        <div class="glass-card mb-6">
          <h3 class="text-lg font-bold text-gray-900 mb-4">ì¢Œì„ ë°°ì •</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ê·¸ë£¹ ê°œìˆ˜</label>
              <input type="number" id="groupCount" class="input-glass" placeholder="14" value="14" min="1" max="14" onchange="updateGroupDisplay()" />
              <p class="text-xs text-gray-500 mt-1" id="groupDisplay">ê°€,ë‚˜,ë‹¤,ë¼,ë§ˆ,ë°”,ì‚¬,ì•„,ì,ì°¨,ì¹´,íƒ€,íŒŒ,í•˜</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ê·¸ë£¹ë‹¹ ì—´ ìˆ˜</label>
              <input type="number" id="rowsPerGroup" class="input-glass" placeholder="10" value="10" min="1" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ì—´ë‹¹ ì¢Œì„ ìˆ˜</label>
              <input type="number" id="seatsPerRow" class="input-glass" placeholder="20" value="20" min="1" />
            </div>
          </div>
          <div class="flex gap-3 flex-wrap mb-4">
            <button onclick="randomAssignSeats()" class="btn-primary-glass px-6">
              ëœë¤ ë°°ì •
            </button>
            <button onclick="ageBasedAssignSeats()" class="btn-primary-glass px-6">
              ì—°ë ¹ëŒ€ ê³ ë ¤ ë°°ì •
            </button>
            <button onclick="resetAllSeats()" class="btn-secondary-glass px-6" style="background: rgba(239, 68, 68, 0.1); color: #dc2626; border-color: rgba(220, 38, 38, 0.3);">
              ì „ì²´ ì´ˆê¸°í™”
            </button>
          </div>
          <p class="text-sm text-gray-500">ì…ê¸ˆ ì™„ë£Œëœ ì°¸ê°€ìë“¤ì—ê²Œ ìë™ìœ¼ë¡œ ì¢Œì„ì„ ë°°ì •í•©ë‹ˆë‹¤. ì—°ë ¹ëŒ€ ê³ ë ¤ ë°°ì •ì€ 00ë…„ëŒ€ìƒ â†’ 90ë…„ëŒ€ìƒ â†’ 80ë…„ëŒ€ìƒ ìˆœìœ¼ë¡œ ì•ì¢Œì„ì— ë°°ì •ë©ë‹ˆë‹¤.</p>
        </div>

        <div class="glass-card mb-6">
          <div class="flex gap-3 items-center">
            <div class="relative flex-1 min-w-0">
              <input
                type="text"
                id="searchInput"
                class="input-glass pl-10 w-full"
                placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰..."
              />
              <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <button onclick="loadParticipants(true)" title="ìƒˆë¡œê³ ì¹¨" style="background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); color: #374151; font-weight: 600; padding: 0.75rem 1rem; border-radius: 0.75rem; font-size: 0.875rem; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease; white-space: nowrap; flex-shrink: 0; display: flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.background='rgba(255, 255, 255, 0.8)'; this.style.transform='scale(1.02)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.6)'; this.style.transform='scale(1)'">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              <span class="hidden md:inline">ìƒˆë¡œê³ ì¹¨</span>
            </button>
          </div>
        </div>

        <div class="glass-card overflow-x-auto">
          <div id="loading" class="text-center py-8 text-gray-500">ë¡œë”© ì¤‘...</div>
          <table id="participantsTable" class="hidden">
            <thead>
              <tr>
                <th class="text-center" style="width: 60px;">
                  ì—°ë²ˆ
                </th>
                <th class="sortable" data-sort="user_name" onclick="sortTable('user_name')">
                  ì´ë¦„
                  <span class="sort-icon" id="sort-icon-user_name"></span>
                </th>
                <th>
                  ëŒ€ë¦¬ì‹ ì²­
                </th>
                <th class="sortable" data-sort="phone" onclick="sortTable('phone')">
                  ì „í™”ë²ˆí˜¸
                  <span class="sort-icon" id="sort-icon-phone"></span>
                </th>
                <th class="sortable" data-sort="ssn_first" onclick="sortTable('ssn_first')">
                  ì£¼ë¯¼ë²ˆí˜¸ ì•ìë¦¬
                  <span class="sort-icon" id="sort-icon-ssn_first"></span>
                </th>
                <th class="sortable" data-sort="is_paid" onclick="sortTable('is_paid')">
                  ì…ê¸ˆ ìƒíƒœ
                  <span class="sort-icon" id="sort-icon-is_paid"></span>
                </th>
                <th class="sortable" data-sort="is_checked_in" onclick="sortTable('is_checked_in')">
                  ì…ì¥ í™•ì¸
                  <span class="sort-icon" id="sort-icon-is_checked_in"></span>
                </th>
                <th class="sortable" data-sort="seat_group" onclick="sortTable('seat_group')">
                  ì¢Œì„ ê·¸ë£¹
                  <span class="sort-icon" id="sort-icon-seat_group"></span>
                </th>
                <th class="sortable" data-sort="seat_row" onclick="sortTable('seat_row')">
                  ì—´
                  <span class="sort-icon" id="sort-icon-seat_row"></span>
                </th>
                <th class="sortable" data-sort="seat_number" onclick="sortTable('seat_number')">
                  ì¢Œì„ë²ˆí˜¸
                  <span class="sort-icon" id="sort-icon-seat_number"></span>
                </th>
                <th class="sortable" data-sort="seat_full" onclick="sortTable('seat_full')">
                  ì „ì²´ ì¢Œì„
                  <span class="sort-icon" id="sort-icon-seat_full"></span>
                </th>
                <th class="sortable" data-sort="created_at" onclick="sortTable('created_at')">
                  ì‹ ì²­ ì¼ì‹œ
                  <span class="sort-icon" id="sort-icon-created_at"></span>
                </th>
                <th>ì‘ì—…</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
          <div id="emptyMessage" class="hidden text-center py-8 text-gray-500"></div>
        </div>

        <div class="mt-4 text-sm text-gray-600" id="countText"></div>
        </div>

        <!-- ì…ê¸ˆí™•ì¸ íƒ­ -->
        <div id="paymentSection" class="hidden">
          <div class="glass-card mb-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">ì…ê¸ˆ ë‚´ì—­ í™•ì¸</h3>
            <p class="text-sm text-gray-600 mb-4">ì—‘ì…€ì—ì„œ ë°ì´í„°ë¥¼ ë³µì‚¬(Ctrl+C)í•œ í›„ ì•„ë˜ í…Œì´ë¸”ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</p>
            
            <div id="paymentTableContainer" class="overflow-x-auto mb-4">
              <table id="paymentTable" class="w-full border-collapse border border-gray-300 bg-white">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ì—°ë²ˆ</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ê±°ë˜ì¼ì‹œ</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">êµ¬ë¶„</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ê±°ë˜ê¸ˆì•¡</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ê±°ë˜ í›„ ì”ì•¡</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ê±°ë˜êµ¬ë¶„</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ë‚´ìš©</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ë©”ëª¨</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ë§¤ì¹­ëœ ì‹ ì²­ì</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ë¹„ê³ </th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ìƒíƒœ</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ì‘ì—…</th>
                  </tr>
                </thead>
                <tbody id="paymentTableBody">
                  <!-- ë¹ˆ í–‰ í•˜ë‚˜ ì¶”ê°€ -->
                  <tr>
                    <td class="border border-gray-300 px-2 py-1 text-sm text-center text-gray-500">1</td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
                    <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
                    <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
                    <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
                    <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">ëŒ€ê¸°ì¤‘</td>
                    <td class="border border-gray-300 px-2 py-2">
                      <div class="flex gap-2">
                        <button onclick="approvePaymentFromTable(0)" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#16a34a'" onmouseout="this.style.backgroundColor='#22c55e'">ìŠ¹ì¸</button>
                        <button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">ì‚­ì œ</button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="flex gap-3 flex-wrap">
              <button onclick="addPaymentRow()" style="background-color: #475569; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; box-shadow: 0 10px 15px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; border: none;" onmouseover="this.style.backgroundColor='#334155'" onmouseout="this.style.backgroundColor='#475569'">
                + í–‰ ì¶”ê°€
              </button>
              <button onclick="savePaymentData()" style="background-color: #3b82f6; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; box-shadow: 0 10px 15px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; border: none;" onmouseover="this.style.backgroundColor='#2563eb'" onmouseout="this.style.backgroundColor='#3b82f6'">
                ğŸ’¾ ì €ì¥í•˜ê¸°
              </button>
              <button onclick="resetPaymentTable()" style="background-color: #f97316; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; box-shadow: 0 10px 15px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; border: none;" onmouseover="this.style.backgroundColor='#ea580c'" onmouseout="this.style.backgroundColor='#f97316'">
                ğŸ—‘ï¸ ì´ˆê¸°í™”
              </button>
            </div>
          </div>
        </div>

        <!-- QR ì²´í¬ì¸ íƒ­ -->
        <div id="checkinSection" class="hidden">
          <div class="glass-card mb-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">QR ì½”ë“œ ì²´í¬ì¸</h3>
            
            <!-- í†µê³„ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <div class="text-sm text-blue-600 mb-1">ì…ê¸ˆ ì™„ë£Œ ì¸ì›</div>
                <div class="text-2xl font-bold text-blue-900" id="checkinTotal">0</div>
              </div>
              <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <div class="text-sm text-green-600 mb-1">ì…ì¥ í™•ì¸</div>
                <div class="text-2xl font-bold text-green-900" id="checkinCount">0</div>
              </div>
              <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                <div class="text-sm text-orange-600 mb-1">ë‚¨ì€ ì¸ì›</div>
                <div class="text-2xl font-bold text-orange-900" id="checkinRemaining">0</div>
              </div>
            </div>

            <!-- QR ì½”ë“œ ìŠ¤ìºë„ˆ -->
            <div class="mb-6">
              <div class="flex gap-4 mb-4">
                <button onclick="startQRScanner()" id="startScannerBtn" class="btn-primary-glass px-6">
                  ì¹´ë©”ë¼ ìŠ¤ìº” ì‹œì‘
                </button>
                <button onclick="stopQRScanner()" id="stopScannerBtn" class="btn-secondary-glass px-6 hidden">
                  ìŠ¤ìº” ì¤‘ì§€
                </button>
                <button onclick="loadCheckinStats()" class="btn-secondary-glass px-6">
                  í†µê³„ ìƒˆë¡œê³ ì¹¨
                </button>
              </div>
              
              <div id="qrScannerContainer" class="hidden mb-4">
                <div id="qrReader" class="max-w-md mx-auto bg-white p-4 rounded-lg border border-gray-300" style="min-height: 300px; position: relative;"></div>
                <p class="text-sm text-gray-600 text-center mt-2">QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶°ì£¼ì„¸ìš”</p>
              </div>

              <!-- ìˆ˜ë™ ì…ë ¥ -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">QR ì½”ë“œ ë°ì´í„° ì§ì ‘ ì…ë ¥</label>
                <div class="flex gap-2">
                  <input 
                    type="text" 
                    id="manualQRInput" 
                    class="input-glass flex-1" 
                    placeholder="QR ì½”ë“œ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ ì…ë ¥í•˜ì„¸ìš”"
                    onkeypress="if(event.key==='Enter') processManualCheckin()"
                  />
                  <button onclick="processManualCheckin()" class="btn-primary-glass px-6">
                    í™•ì¸
                  </button>
                </div>
              </div>

              <!-- ê²°ê³¼ ë©”ì‹œì§€ -->
              <div id="checkinResult" class="hidden mb-4 p-4 rounded-lg"></div>

              <!-- ìµœê·¼ ì²´í¬ì¸ ë‚´ì—­ -->
              <div class="mt-6">
                <h4 class="text-md font-bold text-gray-900 mb-3">ìµœê·¼ ì²´í¬ì¸ ë‚´ì—­</h4>
                <div id="recentCheckins" class="space-y-2 max-h-64 overflow-y-auto">
                  <p class="text-sm text-gray-500 text-center">ì²´í¬ì¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ë¬¸ì˜ ê´€ë¦¬ íƒ­ -->
        <div id="inquiriesSection" class="hidden">
          <div class="glass-card mb-6">
            <div class="flex gap-3">
              <div class="relative flex-1">
                <input
                  type="text"
                  id="inquirySearchInput"
                  class="input-glass pl-10"
                  placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰..."
                />
                <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <button onclick="loadInquiries()" class="btn-secondary-glass px-6 flex items-center gap-2" title="ìƒˆë¡œê³ ì¹¨">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span class="hidden md:inline">ìƒˆë¡œê³ ì¹¨</span>
              </button>
            </div>
          </div>

          <div class="glass-card overflow-x-auto">
            <div id="inquiryLoading" class="text-center py-8 text-gray-500">ë¡œë”© ì¤‘...</div>
            <div id="inquiriesList" class="hidden space-y-4"></div>
            <div id="inquiryEmptyMessage" class="hidden text-center py-8 text-gray-500"></div>
          </div>

          <div class="mt-4 text-sm text-gray-600" id="inquiryCountText"></div>
        </div>
      </main>

      <!-- í‘¸í„° (ë‚˜ì¤‘ì— ë°°í¬ì‚¬/ìš´ì˜ì‚¬ ì •ë³´ ì¶”ê°€ ì˜ˆì •) -->
      <footer class="mt-16 py-8 border-t border-white/20">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-600">
          <!-- ë°°í¬ì‚¬/ìš´ì˜ì‚¬ ì •ë³´ëŠ” ì¶”í›„ ì¶”ê°€ ì˜ˆì • -->
        </div>
      </footer>
    </div>
  </div>

  <script>
    let participants = [];
    let isAuthenticated = false;
    let currentSort = { column: null, direction: 'asc' };
    let filteredParticipants = [];
    let participantsCache = null;
    let participantsCacheTime = null;
    const CACHE_DURATION = 30000; // 30ì´ˆ ìºì‹œ
    let savePaymentDataTimeout = null; // localStorage ì €ì¥ debounceìš©

    // ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showError(message) {
      alert('ì˜¤ë¥˜: ' + message);
      console.error(message);
    }

    function showSuccess(message) {
      alert(message);
    }

    // ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜
    function performLogin() {
      console.log('performLogin called');
      
      try {
        const passwordInput = document.getElementById('password');
        if (!passwordInput) {
          alert('ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          console.error('Password input element not found');
          return false;
        }
        
        const password = passwordInput.value.trim();
        console.log('Login attempt, password:', password);
        console.log('Expected: admin123');
        console.log('Match:', password === 'admin123');
        
        // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
        if (password === 'admin123') {
          console.log('Password correct');
          isAuthenticated = true;
          
          const loginScreen = document.getElementById('loginScreen');
          const adminScreen = document.getElementById('adminScreen');
          
          if (!loginScreen) {
            console.error('Login screen element not found');
            alert('ë¡œê·¸ì¸ í™”ë©´ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return false;
          }
          
          if (!adminScreen) {
            console.error('Admin screen element not found');
            alert('ê´€ë¦¬ì í™”ë©´ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return false;
          }
          
          console.log('Hiding login, showing admin');
          loginScreen.classList.add('hidden');
          adminScreen.classList.remove('hidden');
          console.log('Loading participants');
          loadParticipants();
          return true;
        } else {
          console.log('Password incorrect');
          alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          passwordInput.value = '';
          passwordInput.focus();
          return false;
        }
      } catch (error) {
        console.error('Login error:', error);
        alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        return false;
      }
    }

    // DOMì´ ë¡œë“œëœ í›„ ì‹¤í–‰
    function initAdmin() {
      const loginScreen = document.getElementById('loginScreen');
      const adminScreen = document.getElementById('adminScreen');
      const loginForm = document.getElementById('loginForm');
      const searchInput = document.getElementById('searchInput');

      console.log('Initializing admin page...');
      console.log('loginScreen:', loginScreen);
      console.log('adminScreen:', adminScreen);
      console.log('loginForm:', loginForm);

      if (!loginForm) {
        console.error('Login form not found');
        alert('ë¡œê·¸ì¸ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!loginScreen) {
        console.error('Login screen not found');
      }

      if (!adminScreen) {
        console.error('Admin screen not found');
      }

      // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Form submit event triggered');
        performLogin();
        return false;
      });

      // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ë°±ì—…)
      const loginBtn = document.getElementById('loginBtn');
      if (loginBtn) {
        loginBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Login button clicked');
          performLogin();
          return false;
        });
      }

      console.log('Login form event listener attached');

      if (searchInput) {
        searchInput.addEventListener('input', () => {
          filterParticipants();
        });
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAdmin);
    } else {
      // DOMì´ ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì¦‰ì‹œ ì‹¤í–‰
      initAdmin();
    }

    async function loadParticipants(forceRefresh = false) {
      // ìºì‹œ í™•ì¸
      const now = Date.now();
      if (!forceRefresh && participantsCache && participantsCacheTime && (now - participantsCacheTime) < CACHE_DURATION) {
        participants = participantsCache;
        filteredParticipants = participants;
        updateStatistics();
        filterParticipants();
        return;
      }

      const loading = document.getElementById('loading');
      if (loading) loading.classList.remove('hidden');
      
      try {
        const response = await fetch('/api/admin/participants');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          participants = data.participants || [];
          filteredParticipants = participants;
          // ìºì‹œ ì—…ë°ì´íŠ¸
          participantsCache = participants;
          participantsCacheTime = now;
          updateStatistics();
          filterParticipants();
        } else {
          console.error('API error:', data.error);
          showError('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (err) {
        console.error('Error loading participants:', err);
        showError('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\në„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      } finally {
        if (loading) loading.classList.add('hidden');
      }
    }

    function updateStatistics() {
      const totalCountEl = document.getElementById('totalCount');
      const paidCountEl = document.getElementById('paidCount');
      
      if (!totalCountEl || !paidCountEl) return;
      
      // ì „ì²´ ì‹ ì²­ ì¸ì›ìˆ˜ (1ì¸ ì‹ ì²­ì€ 1ëª…, 2ì¸ ì‹ ì²­ì€ 2ëª…ìœ¼ë¡œ ê³„ì‚°)
      let totalCount = 0;
      let paidCount = 0;
      
      participants.forEach(function(p) {
        const ticketCount = p.ticket_count || 1;
        totalCount += ticketCount;
        
        // ì…ê¸ˆ ì™„ë£Œëœ ê²½ìš°
        if (p.is_paid) {
          paidCount += ticketCount;
        }
      });
      
      totalCountEl.textContent = totalCount;
      paidCountEl.textContent = paidCount;
    }

    function filterParticipants() {
      const search = searchInput.value.toLowerCase();
      filteredParticipants = search
        ? participants.filter(p => 
            p.user_name.toLowerCase().includes(search) || 
            p.phone.includes(search) ||
            (p.ssn_first && p.ssn_first.includes(search))
          )
        : participants;

      // ì •ë ¬ ì ìš©
      if (currentSort.column) {
        sortData(filteredParticipants, currentSort.column, currentSort.direction);
      }

      displayParticipants(filteredParticipants);
    }

    function sortTable(column) {
      // ê°™ì€ ì»¬ëŸ¼ í´ë¦­ ì‹œ ë°©í–¥ ì „í™˜, ë‹¤ë¥¸ ì»¬ëŸ¼ í´ë¦­ ì‹œ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì‹œì‘
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
      }

      // ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
      updateSortIcons();

      // ë°ì´í„° ì •ë ¬
      sortData(filteredParticipants, currentSort.column, currentSort.direction);
      displayParticipants(filteredParticipants);
    }

    function sortData(data, column, direction) {
      data.sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];

        // null/undefined ì²˜ë¦¬
        if (aVal === null || aVal === undefined || aVal === '') aVal = '';
        if (bVal === null || bVal === undefined || bVal === '') bVal = '';

        let comparison = 0;

        switch (column) {
          case 'user_name':
          case 'phone':
          case 'ssn_first':
          case 'seat_group':
          case 'seat_full':
            // ë¬¸ìì—´ ì •ë ¬
            comparison = String(aVal).localeCompare(String(bVal), 'ko');
            break;
          
          case 'is_paid':
          case 'is_checked_in':
            // boolean ì •ë ¬ (trueê°€ ë¨¼ì €)
            comparison = (bVal ? 1 : 0) - (aVal ? 1 : 0);
            break;
          
          case 'seat_row':
          case 'seat_number':
            // ìˆ«ì ì •ë ¬ (ë¹ˆ ê°’ì€ ë’¤ë¡œ)
            if (aVal === '' && bVal === '') return 0;
            if (aVal === '') return 1;
            if (bVal === '') return -1;
            comparison = parseInt(aVal) - parseInt(bVal);
            break;
          
          case 'created_at':
            // ë‚ ì§œ ì •ë ¬
            comparison = new Date(aVal) - new Date(bVal);
            break;
          
          default:
            comparison = String(aVal).localeCompare(String(bVal), 'ko');
        }

        return direction === 'asc' ? comparison : -comparison;
      });
    }

    function updateSortIcons() {
      // ëª¨ë“  ì•„ì´ì½˜ ì´ˆê¸°í™”
      document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.innerHTML = '';
      });

      // í˜„ì¬ ì •ë ¬ ì»¬ëŸ¼ ì•„ì´ì½˜ í‘œì‹œ
      if (currentSort.column) {
        const iconId = `sort-icon-${currentSort.column}`;
        const icon = document.getElementById(iconId);
        if (icon) {
          if (currentSort.direction === 'asc') {
            icon.innerHTML = ' â†‘';
            icon.style.color = '#dc2626';
          } else {
            icon.innerHTML = ' â†“';
            icon.style.color = '#dc2626';
          }
        }
      }
    }

    function displayParticipants(list) {
      const tableBody = document.getElementById('tableBody');
      const table = document.getElementById('participantsTable');
      const loading = document.getElementById('loading');
      const emptyMessage = document.getElementById('emptyMessage');
      const countText = document.getElementById('countText');

      loading.classList.add('hidden');
      
      if (list.length === 0) {
        table.classList.add('hidden');
        emptyMessage.classList.remove('hidden');
        emptyMessage.textContent = searchInput.value ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.';
        countText.textContent = '';
        return;
      }

      table.classList.remove('hidden');
      emptyMessage.classList.add('hidden');
      
      // ì‹¤ì œ ì°¸ê°€ì ìˆ˜ ê³„ì‚° (ticket_count í•©ì‚°)
      let totalCount = 0;
      list.forEach(function(p) {
        const ticketCount = p.ticket_count || 1;
        totalCount += ticketCount;
      });
      countText.textContent = `ì´ ${totalCount}ëª…`;

      // ì°¸ê°€ì ëª©ë¡ì„ í‰íƒ„í™”í•˜ì—¬ 2ë²ˆì§¸ ì°¸ê°€ìë„ ë³„ë„ í–‰ìœ¼ë¡œ í‘œì‹œ
      const flattenedList = [];
      list.forEach(p => {
        // 1ë²ˆì§¸ ì°¸ê°€ì í–‰
        flattenedList.push({
          ...p,
          is_guest: false,
          display_name: p.user_name,
          display_phone: p.phone,
          display_ssn: p.ssn_first,
          original_id: p.id,
          representative_name: '', // 1ì¸ ì‹ ì²­ìëŠ” ëŒ€ë¦¬ì‹ ì²­ ì—†ìŒ
          display_seat: p.seat_full || '-', // ì²« ë²ˆì§¸ ì¢Œì„
          display_checked_in: p.is_checked_in || false // ì…ì¥ í™•ì¸ ìƒíƒœ
        });
        
        // 2ë²ˆì§¸ ì°¸ê°€ìê°€ ìˆëŠ” ê²½ìš° (2ì¸ ì‹ ì²­)
        // ticket_countê°€ 2ì´ê±°ë‚˜, guest2_nameì´ ìˆìœ¼ë©´ 2ì¸ ì‹ ì²­
        const isTwoPerson = (p.ticket_count === 2) || p.guest2_name;
        
        if (isTwoPerson) {
          // 2ë²ˆì§¸ ì°¸ê°€ì í–‰ ì¶”ê°€
          // ì´ë¦„: guest2_nameì´ ìˆìœ¼ë©´ ì‹¤ì œ ì´ë¦„, ì—†ìœ¼ë©´ "ì²«ë²ˆì§¸ì‹ ì²­ì_2" í˜•ì‹
          // ëŒ€ë¦¬ì‹ ì²­: ì²« ë²ˆì§¸ ì‹ ì²­ìì˜ ì´ë¦„
          // ì¢Œì„: ë‘ ë²ˆì§¸ ì¢Œì„ (seat_full_2)
          flattenedList.push({
            ...p,
            is_guest: true,
            display_name: p.guest2_name || `${p.user_name}_2`,
            display_phone: p.guest2_phone || p.phone,
            display_ssn: p.guest2_ssn_first || p.ssn_first || '-',
            original_id: p.id,
            is_guest2_pending: !p.guest2_name, // ì•„ì§ ì…ë ¥ ì•ˆë¨
            representative_name: p.user_name, // ëŒ€ë¦¬ì‹ ì²­ì ì´ë¦„ (ì²« ë²ˆì§¸ ì‹ ì²­ì)
            display_seat: p.seat_full_2 || '-', // ë‘ ë²ˆì§¸ ì¢Œì„
            display_checked_in: p.is_checked_in_2 || false // ë‘ ë²ˆì§¸ ì°¸ê°€ì ì…ì¥ í™•ì¸ ìƒíƒœ
          });
        }
      });
      
      tableBody.innerHTML = flattenedList.map((p, index) => {
        const rowClass = p.is_guest2_pending ? 'opacity-60' : '';
        
        return `
        <tr class="${rowClass}">
          <td class="text-center text-gray-500">${index + 1}</td>
          <td>${p.display_name}${p.is_guest2_pending ? ' <span class="text-xs text-gray-400">(ì…ë ¥ ëŒ€ê¸°)</span>' : ''}</td>
          <td>${p.representative_name || '-'}</td>
          <td>${formatPhone(p.display_phone)}</td>
          <td>${p.display_ssn || '-'}</td>
          <td>
            <label class="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                ${p.is_paid ? 'checked' : ''}
                onchange="togglePayment(${p.original_id}, ${p.is_paid})"
                style="width: 1.25rem; height: 1.25rem;"
              />
              <span class="${p.is_paid ? 'text-red-600 font-medium' : 'text-gray-500'}">
                ${p.is_paid ? 'ì…ê¸ˆ ì™„ë£Œ' : 'ì…ê¸ˆ ëŒ€ê¸°'}
              </span>
            </label>
          </td>
          <td>
            <span class="${p.display_checked_in ? 'text-green-600 font-medium' : 'text-gray-400'}">
              ${p.display_checked_in ? 'âœ“ ì…ì¥ì™„ë£Œ' : '-'}
            </span>
          </td>
          <td>
            <select class="zone-select" id="group-${p.original_id}${p.is_guest ? '-2' : ''}" onchange="updateSeat(${p.original_id}, ${p.is_guest ? 'true' : 'false'})">
              <option value="">ì„ íƒ</option>
              <option value="ê°€" ${p.seat_group === 'ê°€' ? 'selected' : ''}>ê°€</option>
              <option value="ë‚˜" ${p.seat_group === 'ë‚˜' ? 'selected' : ''}>ë‚˜</option>
              <option value="ë‹¤" ${p.seat_group === 'ë‹¤' ? 'selected' : ''}>ë‹¤</option>
              <option value="ë¼" ${p.seat_group === 'ë¼' ? 'selected' : ''}>ë¼</option>
              <option value="ë§ˆ" ${p.seat_group === 'ë§ˆ' ? 'selected' : ''}>ë§ˆ</option>
              <option value="ë°”" ${p.seat_group === 'ë°”' ? 'selected' : ''}>ë°”</option>
              <option value="ì‚¬" ${p.seat_group === 'ì‚¬' ? 'selected' : ''}>ì‚¬</option>
              <option value="ì•„" ${p.seat_group === 'ì•„' ? 'selected' : ''}>ì•„</option>
              <option value="ì" ${p.seat_group === 'ì' ? 'selected' : ''}>ì</option>
              <option value="ì°¨" ${p.seat_group === 'ì°¨' ? 'selected' : ''}>ì°¨</option>
              <option value="ì¹´" ${p.seat_group === 'ì¹´' ? 'selected' : ''}>ì¹´</option>
              <option value="íƒ€" ${p.seat_group === 'íƒ€' ? 'selected' : ''}>íƒ€</option>
              <option value="íŒŒ" ${p.seat_group === 'íŒŒ' ? 'selected' : ''}>íŒŒ</option>
              <option value="í•˜" ${p.seat_group === 'í•˜' ? 'selected' : ''}>í•˜</option>
            </select>
          </td>
          <td>
            <input
              type="text"
              class="seat-input"
              id="row-${p.original_id}${p.is_guest ? '-2' : ''}"
              value="${p.seat_row || ''}"
              placeholder="ì—´"
              onchange="updateSeat(${p.original_id}, ${p.is_guest ? 'true' : 'false'})"
            />
          </td>
          <td>
            <input
              type="text"
              class="seat-input"
              id="seat-${p.original_id}${p.is_guest ? '-2' : ''}"
              value="${p.seat_number || ''}"
              placeholder="ë²ˆí˜¸"
              onchange="updateSeat(${p.original_id}, ${p.is_guest ? 'true' : 'false'})"
            />
          </td>
          <td class="font-semibold text-red-600">${p.display_seat || p.seat_full || '-'}</td>
          <td class="text-sm text-gray-600">${formatDateTime(p.created_at)}</td>
          <td>
            <div class="flex gap-2">
              ${p.seat_full && !p.is_guest ? `
                <button 
                  onclick="resetParticipantSeat(${p.original_id}, '${p.display_name}')" 
                  class="p-2 text-orange-600 hover:text-orange-700 hover:bg-orange-50 rounded transition-colors"
                  title="ì¢Œì„ ì´ˆê¸°í™”"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                </button>
              ` : ''}
              <button 
                onclick="deleteParticipant(${p.original_id}, '${p.display_name}')" 
                class="p-2 text-red-600 hover:text-red-700 hover:bg-red-50 rounded transition-colors"
                title="ì‚­ì œ"
                ${p.is_guest ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `;
      }).join('');
    }

    async function togglePayment(id, currentStatus) {
      try {
        const response = await fetch(`/api/admin/participants/${id}/payment`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_paid: !currentStatus }),
        });

        const data = await response.json();
        if (data.success) {
          loadParticipants();
        }
      } catch (err) {
        alert('ì…ê¸ˆ ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function updateSeat(id, isGuest) {
      const idSuffix = isGuest ? '-2' : '';
      const group = document.getElementById(`group-${id}${idSuffix}`)?.value || '';
      const row = document.getElementById(`row-${id}${idSuffix}`)?.value || '';
      const number = document.getElementById(`seat-${id}${idSuffix}`)?.value || '';

      try {
        const response = await fetch(`/api/admin/participants/${id}/seat`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            seat_group: group, 
            seat_row: row, 
            seat_number: number,
            is_guest: isGuest || false
          }),
        });

        const data = await response.json();
        if (data.success) {
          loadParticipants();
        } else {
          alert(data.error || 'ì¢Œì„ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Error updating seat:', err);
        alert('ì¢Œì„ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function updateGroupDisplay() {
      const groupCount = parseInt(document.getElementById('groupCount').value) || 14;
      const groupNames = ['ê°€', 'ë‚˜', 'ë‹¤', 'ë¼', 'ë§ˆ', 'ë°”', 'ì‚¬', 'ì•„', 'ì', 'ì°¨', 'ì¹´', 'íƒ€', 'íŒŒ', 'í•˜'];
      const selectedGroups = groupNames.slice(0, Math.min(groupCount, 14));
      document.getElementById('groupDisplay').textContent = selectedGroups.join(',');
    }


    // ì¢Œì„ ë°°ì • ê³µí†µ ë¡œì§
    function getSeatAssignmentParams() {
      const groupCount = parseInt(document.getElementById('groupCount').value) || 14;
      const rowsPerGroup = parseInt(document.getElementById('rowsPerGroup').value);
      const seatsPerRow = parseInt(document.getElementById('seatsPerRow').value);

      if (!groupCount || !rowsPerGroup || !seatsPerRow) {
        return null;
      }

      const groupNames = ['ê°€', 'ë‚˜', 'ë‹¤', 'ë¼', 'ë§ˆ', 'ë°”', 'ì‚¬', 'ì•„', 'ì', 'ì°¨', 'ì¹´', 'íƒ€', 'íŒŒ', 'í•˜'];
      const groups = groupNames.slice(0, Math.min(groupCount, 14));

      return { groupCount, rowsPerGroup, seatsPerRow, groups };
    }

    async function assignSeatsCommon(endpoint, confirmMessage) {
      const params = getSeatAssignmentParams();
      if (!params) {
        showError('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            groups: params.groups, 
            rowsPerGroup: params.rowsPerGroup, 
            seatsPerRow: params.seatsPerRow 
          }),
        });

        const data = await response.json();
        if (data.success) {
          showSuccess(data.message);
          loadParticipants();
        } else {
          showError(data.error || 'ì¢Œì„ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Seat assignment error:', err);
        showError('ì¢Œì„ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function randomAssignSeats() {
      const params = getSeatAssignmentParams();
      if (!params) {
        showError('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const confirmMessage = `ì…ê¸ˆ ì™„ë£Œëœ ì°¸ê°€ìë“¤ì—ê²Œ ëœë¤ìœ¼ë¡œ ì¢Œì„ì„ ë°°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê·¸ë£¹: ${params.groups.join(', ')}\nê·¸ë£¹ë‹¹ ì—´ ìˆ˜: ${params.rowsPerGroup}\nì—´ë‹¹ ì¢Œì„ ìˆ˜: ${params.seatsPerRow}`;
      await assignSeatsCommon('/api/admin/participants/random-seats', confirmMessage);
    }

    async function resetParticipantSeat(id, userName) {
      const confirmMessage = userName 
        ? `"${userName}" ì°¸ê°€ìì˜ ì¢Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
        : 'ì´ ì°¸ê°€ìì˜ ì¢Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
      
      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/participants/${id}/seat`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (data.success) {
          alert('ì¢Œì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadParticipants();
        } else {
          alert(data.error || 'ì¢Œì„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Reset seat error:', err);
        alert('ì¢Œì„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function deleteParticipant(id, userName) {
      const confirmMessage = userName 
        ? `"${userName}" ì°¸ê°€ì ì •ë³´ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
        : 'ì´ ì°¸ê°€ì ì •ë³´ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      
      if (!confirm(confirmMessage)) return;

      try {
        const response = await fetch(`/api/admin/participants/${id}`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (data.success) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadParticipants();
        } else {
          alert(data.error || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Delete error:', err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }

    async function ageBasedAssignSeats() {
      const params = getSeatAssignmentParams();
      if (!params) {
        showError('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const confirmMessage = `ì…ê¸ˆ ì™„ë£Œëœ ì°¸ê°€ìë“¤ì—ê²Œ ì—°ë ¹ëŒ€ë³„ë¡œ ì¢Œì„ì„ ë°°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n00ë…„ëŒ€ìƒ â†’ 90ë…„ëŒ€ìƒ â†’ 80ë…„ëŒ€ìƒ ìˆœìœ¼ë¡œ ì•ì¢Œì„ì— ë°°ì •ë©ë‹ˆë‹¤.\n\nê·¸ë£¹: ${params.groups.join(', ')}\nê·¸ë£¹ë‹¹ ì—´ ìˆ˜: ${params.rowsPerGroup}\nì—´ë‹¹ ì¢Œì„ ìˆ˜: ${params.seatsPerRow}`;
      await assignSeatsCommon('/api/admin/participants/age-based-seats', confirmMessage);
    }

    async function resetAllSeats() {
      if (!confirm('ëª¨ë“  ì°¸ê°€ìì˜ ì¢Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
      }

      try {
        const response = await fetch('/api/admin/participants/reset-seats', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        const data = await response.json();
        if (data.success) {
          alert(data.message || 'ëª¨ë“  ì¢Œì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadParticipants();
        } else {
          alert(data.error || 'ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Reset seats error:', err);
        alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function formatPhone(value) {
      if (value.length <= 3) return value;
      if (value.length <= 7) return `${value.slice(0, 3)}-${value.slice(3)}`;
      return `${value.slice(0, 3)}-${value.slice(3, 7)}-${value.slice(7, 11)}`;
    }

    function formatDateTime(dateTimeStr) {
      if (!dateTimeStr) return '-';
      try {
        // YYYY-MM-DD HH:mm:ss í˜•ì‹ì„ íŒŒì‹±
        const dateStr = dateTimeStr.replace(' ', 'T');
        const date = new Date(dateStr);
        // í•œêµ­ ì‹œê°„ëŒ€ë¡œ í‘œì‹œ
        return date.toLocaleString('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false,
          timeZone: 'Asia/Seoul'
        });
      } catch (e) {
        return dateTimeStr;
      }
    }

    // íƒ­ ì „í™˜ í•¨ìˆ˜
    function showParticipantsTab() {
      document.getElementById('participantsSection').classList.remove('hidden');
      document.getElementById('paymentSection').classList.add('hidden');
      document.getElementById('inquiriesSection').classList.add('hidden');
      document.getElementById('checkinSection').classList.add('hidden');
      document.getElementById('checkinSection').classList.add('hidden');
      document.getElementById('participantsTab').classList.add('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('participantsTab').classList.remove('text-gray-600');
      document.getElementById('paymentTab').classList.remove('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('paymentTab').classList.add('text-gray-600');
      document.getElementById('inquiriesTab').classList.remove('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('inquiriesTab').classList.add('text-gray-600');
    }

    function showPaymentTab() {
      document.getElementById('participantsSection').classList.add('hidden');
      document.getElementById('paymentSection').classList.remove('hidden');
      document.getElementById('inquiriesSection').classList.add('hidden');
      document.getElementById('checkinSection').classList.add('hidden');
      document.getElementById('checkinSection').classList.add('hidden');
      document.getElementById('paymentTab').classList.add('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('paymentTab').classList.remove('text-gray-600');
      document.getElementById('participantsTab').classList.remove('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('participantsTab').classList.add('text-gray-600');
      document.getElementById('inquiriesTab').classList.remove('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('inquiriesTab').classList.add('text-gray-600');
      
      // ì €ì¥ëœ ë°ì´í„° ë³µì›
      if (paymentDataList.length === 0) {
        loadPaymentDataFromStorage();
      }
    }

    function showInquiriesTab() {
      document.getElementById('participantsSection').classList.add('hidden');
      document.getElementById('paymentSection').classList.add('hidden');
      document.getElementById('inquiriesSection').classList.remove('hidden');
      document.getElementById('inquiriesTab').classList.add('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('inquiriesTab').classList.remove('text-gray-600');
      document.getElementById('participantsTab').classList.remove('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('participantsTab').classList.add('text-gray-600');
      document.getElementById('paymentTab').classList.remove('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('paymentTab').classList.add('text-gray-600');
      document.getElementById('checkinTab').classList.remove('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('checkinTab').classList.add('text-gray-600');
      document.getElementById('checkinSection').classList.add('hidden');
      loadInquiries();
    }

    function showCheckinTab() {
      document.getElementById('participantsSection').classList.add('hidden');
      document.getElementById('paymentSection').classList.add('hidden');
      document.getElementById('inquiriesSection').classList.add('hidden');
      document.getElementById('checkinSection').classList.remove('hidden');
      document.getElementById('checkinTab').classList.add('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('checkinTab').classList.remove('text-gray-600');
      document.getElementById('participantsTab').classList.remove('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('participantsTab').classList.add('text-gray-600');
      document.getElementById('paymentTab').classList.remove('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('paymentTab').classList.add('text-gray-600');
      document.getElementById('inquiriesTab').classList.remove('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('inquiriesTab').classList.add('text-gray-600');
      
      // ì²´í¬ì¸ í†µê³„ ë¡œë“œ
      loadCheckinStats();
    }

    // ë¬¸ì˜ ëª©ë¡ ë¡œë“œ
    let inquiries = [];
    let filteredInquiries = [];

    async function loadInquiries() {
      const loading = document.getElementById('inquiryLoading');
      if (loading) loading.classList.remove('hidden');
      
      try {
        const response = await fetch('/api/admin/inquiries');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          inquiries = data.inquiries || [];
          filteredInquiries = inquiries;
          displayInquiries(inquiries);
        } else {
          console.error('API error:', data.error);
          alert('ë¬¸ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (err) {
        console.error('Error loading inquiries:', err);
        alert('ë¬¸ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      } finally {
        if (loading) loading.classList.add('hidden');
      }
    }

    function displayInquiries(list) {
      const inquiriesList = document.getElementById('inquiriesList');
      const loading = document.getElementById('inquiryLoading');
      const emptyMessage = document.getElementById('inquiryEmptyMessage');
      const countText = document.getElementById('inquiryCountText');

      loading.classList.add('hidden');
      
      if (list.length === 0) {
        inquiriesList.classList.add('hidden');
        emptyMessage.classList.remove('hidden');
        emptyMessage.textContent = 'ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.';
        countText.textContent = '';
        return;
      }

      inquiriesList.classList.remove('hidden');
      emptyMessage.classList.add('hidden');
      countText.textContent = `ì´ ${list.length}ê±´`;

      inquiriesList.innerHTML = list.map(inq => `
        <div class="glass-card p-6 ${inq.is_answered ? 'bg-green-50/50' : 'bg-white'}">
          <div class="flex justify-between items-start mb-4">
            <div>
              <div class="flex items-center gap-3 mb-2">
                <span class="font-semibold text-gray-900">${inq.user_name}</span>
                <span class="text-sm text-gray-500">${formatPhone(inq.phone)}</span>
                <span class="text-xs text-gray-400">${formatDateTime(inq.created_at)}</span>
              </div>
              ${inq.is_answered ? '<span class="badge-green text-xs">ë‹µë³€ ì™„ë£Œ</span>' : '<span class="badge-red text-xs">ë‹µë³€ ëŒ€ê¸°</span>'}
            </div>
            <button 
              onclick="deleteInquiry(${inq.id}, '${inq.user_name}')" 
              class="p-2 text-red-600 hover:text-red-700 hover:bg-red-50 rounded transition-colors"
              title="ì‚­ì œ"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
          
          <div class="mb-4">
            <p class="text-sm font-medium text-gray-700 mb-2">ë¬¸ì˜ë‚´ìš©</p>
            <p class="text-gray-900 whitespace-pre-wrap">${inq.content}</p>
          </div>

          ${inq.is_answered ? `
            <div class="mt-4 pt-4 border-t border-gray-200">
              <p class="text-sm font-medium text-gray-700 mb-2">ë‹µë³€</p>
              <p class="text-gray-900 whitespace-pre-wrap">${inq.answer}</p>
              <p class="text-xs text-gray-400 mt-2">ë‹µë³€ì¼ì‹œ: ${formatDateTime(inq.answered_at)}</p>
            </div>
          ` : `
            <div class="mt-4 pt-4 border-t border-gray-200">
              <textarea
                id="answer-${inq.id}"
                class="input-glass w-full"
                rows="3"
                placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..."
              ></textarea>
              <button 
                onclick="submitAnswer(${inq.id})" 
                class="btn-primary-glass mt-2"
              >
                ë‹µë³€ ë“±ë¡
              </button>
            </div>
          `}
        </div>
      `).join('');

      // ê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      const inquirySearchInput = document.getElementById('inquirySearchInput');
      if (inquirySearchInput) {
        inquirySearchInput.addEventListener('input', () => {
          const search = inquirySearchInput.value.toLowerCase();
          filteredInquiries = search
            ? inquiries.filter(i => 
                i.user_name.toLowerCase().includes(search) || 
                i.phone.includes(search) ||
                i.content.toLowerCase().includes(search)
              )
            : inquiries;
          displayInquiries(filteredInquiries);
        });
      }
    }

    async function submitAnswer(id) {
      const answerInput = document.getElementById(`answer-${id}`);
      if (!answerInput || !answerInput.value.trim()) {
        alert('ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const response = await fetch(`/api/admin/inquiries/${id}/answer`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ answer: answerInput.value.trim() }),
        });

        const data = await response.json();
        if (data.success) {
          alert('ë‹µë³€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadInquiries();
        } else {
          alert(data.error || 'ë‹µë³€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Submit answer error:', err);
        alert('ë‹µë³€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function deleteInquiry(id, userName) {
      if (!confirm(`"${userName}"ë‹˜ì˜ ë¬¸ì˜ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/inquiries/${id}`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (data.success) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadInquiries();
        } else {
          alert(data.error || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Delete inquiry error:', err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì…ê¸ˆ ë°ì´í„° íŒŒì‹± ë° ë§¤ì¹­
    let paymentDataList = [];
    let allParticipants = [];

    // localStorageì— ì…ê¸ˆ ë°ì´í„° ì €ì¥ (debounce ì ìš©)
    function savePaymentDataToStorage() {
      // ì´ì „ íƒ€ì´ë¨¸ ì·¨ì†Œ
      if (savePaymentDataTimeout) {
        clearTimeout(savePaymentDataTimeout);
      }
      
      // 500ms í›„ ì €ì¥ (debounce)
      savePaymentDataTimeout = setTimeout(function() {
        try {
          // matchedParticipantëŠ” ê°ì²´ì´ë¯€ë¡œ IDë§Œ ì €ì¥
          const dataToSave = paymentDataList.map(function(item) {
            return {
              date: item.date,
              type: item.type,
              amount: item.amount,
              balance: item.balance,
              transactionType: item.transactionType,
              content: item.content,
              memo: item.memo,
              matchedName: item.matchedName,
              matchedPhoneLast4: item.matchedPhoneLast4,
              matchedParticipantId: item.matchedParticipant ? item.matchedParticipant.id : null,
              expectedParticipantIds: item.expectedParticipants ? item.expectedParticipants.map(function(p) { return p.id; }) : [],
              approved: item.approved
            };
          });
          localStorage.setItem('paymentDataList', JSON.stringify(dataToSave));
        } catch (err) {
          console.error('Error saving payment data to storage:', err);
        }
      }, 500);
    }

    // localStorageì—ì„œ ì…ê¸ˆ ë°ì´í„° ë³µì›
    function loadPaymentDataFromStorage() {
      try {
        const saved = localStorage.getItem('paymentDataList');
        if (!saved) return false;

        const savedData = JSON.parse(saved);
        if (!Array.isArray(savedData) || savedData.length === 0) return false;

        // ì°¸ê°€ì ëª©ë¡ ë¡œë“œ (ë§¤ì¹­ì„ ìœ„í•´ í•„ìš”)
        fetch('/api/admin/participants')
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (data.success) {
              allParticipants = data.participants || [];
              
              // ì €ì¥ëœ ë°ì´í„° ë³µì› (matchedParticipantì™€ expectedParticipantsëŠ” IDë¡œ ë³µì›)
              paymentDataList = savedData.map(function(item) {
                let matchedParticipant = null;
                if (item.matchedParticipantId) {
                  matchedParticipant = allParticipants.find(function(p) {
                    return p.id === item.matchedParticipantId;
                  });
                }
                
                let expectedParticipants = [];
                if (item.expectedParticipantIds && item.expectedParticipantIds.length > 0) {
                  expectedParticipants = allParticipants.filter(function(p) {
                    return item.expectedParticipantIds.indexOf(p.id) !== -1;
                  });
                }
                
                return {
                  date: item.date || '',
                  type: item.type || '',
                  amount: item.amount || '',
                  balance: item.balance || '',
                  transactionType: item.transactionType || '',
                  content: item.content || '',
                  memo: item.memo || '',
                  matchedName: item.matchedName || '',
                  matchedPhoneLast4: item.matchedPhoneLast4 || '',
                  matchedParticipant: matchedParticipant,
                  expectedParticipants: expectedParticipants,
                  approved: item.approved || false
                };
              });

              // í…Œì´ë¸”ì— ë³µì›ëœ ë°ì´í„° í‘œì‹œ
              restorePaymentTableFromData();
            }
          })
          .catch(function(err) {
            console.error('Error loading participants for payment data:', err);
          });

        return true;
      } catch (err) {
        console.error('Error loading payment data from storage:', err);
        return false;
      }
    }

    // ì €ì¥ëœ ë°ì´í„°ë¥¼ í…Œì´ë¸”ì— ë³µì›
    function restorePaymentTableFromData() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody || paymentDataList.length === 0) return;

      tbody.innerHTML = '';

      paymentDataList.forEach(function(item, index) {
        const row = document.createElement('tr');
        const hasMatch = item.matchedParticipant !== null;
        const hasPhoneLast4 = item.matchedPhoneLast4 !== '';
        
        row.className = hasMatch ? '' : 'bg-yellow-50';
        row.innerHTML = `
          <td class="border border-gray-300 px-2 py-1 text-sm text-center text-gray-500">${index + 1}</td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.date || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.type || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.amount || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.balance || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.transactionType || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.content || ''}" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.memo || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1">
            ${hasMatch ? `
              <div class="text-green-600 font-semibold text-sm">
                âœ“ ${item.matchedParticipant.user_name} (${formatPhone(item.matchedParticipant.phone)})
              </div>
            ` : hasPhoneLast4 ? `
              <div class="text-red-600 text-sm">
                âœ— ë§¤ì¹­ë˜ì§€ ì•ŠìŒ (${item.matchedName}${item.matchedPhoneLast4})
              </div>
            ` : `
              <div class="text-orange-600 text-sm">
                âš  ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ì—†ìŒ
              </div>
            `}
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${!item.matchedParticipant && item.expectedParticipants && item.expectedParticipants.length > 0 ? (
              item.expectedParticipants.length === 1 ? `
                <div class="text-blue-600 text-sm">
                  ${item.expectedParticipants[0].user_name} (${formatPhone(item.expectedParticipants[0].phone)})
                </div>
              ` : `
                <div class="text-orange-600 font-semibold text-sm">
                  âš  ë™ëª…ì´ì¸ ë°œìƒ, ì—°ë½ í›„ ì…ê¸ˆí™•ì¸ í•„ìš”
                </div>
              `
            ) : '<span class="text-gray-400 text-sm">-</span>'}
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${item.expectedParticipants && item.expectedParticipants.length > 1 ? (() => {
              // expectedParticipantsê°€ 2ëª… ì´ìƒì¼ ë•Œë§Œ ë™ëª…ì´ì¸ ëª©ë¡ í‘œì‹œ
              // ì´ë¯¸ ë§¤ì¹­ëœ ì°¸ê°€ìë¥¼ ì œì™¸í•œ ë™ëª…ì´ì¸ ëª©ë¡
              const unapprovedDuplicates = item.expectedParticipants.filter(function(p) {
                if (item.matchedParticipant && item.matchedParticipant.id === p.id) {
                  return false;
                }
                return true;
              });
              
              if (unapprovedDuplicates.length > 0) {
                return '<div class="text-sm space-y-2">' + unapprovedDuplicates.map(function(p, pIndex) {
                  return '<div class="flex items-center justify-between gap-2 p-2 bg-gray-50 rounded border border-gray-200"><span class="text-gray-700">' + p.user_name + ' (' + formatPhone(p.phone) + ')</span><button onclick="approveDuplicateParticipant(' + index + ', ' + p.id + ')" style="background-color: #22c55e; color: white; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-weight: bold; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; white-space: nowrap;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button></div>';
                }).join('') + '</div>';
              } else {
                return '<span class="text-gray-400 text-sm">-</span>';
              }
            })() : '<span class="text-gray-400 text-sm">-</span>'}
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${item.approved ? '<span class="text-green-600 font-semibold text-sm">ìŠ¹ì¸ë¨</span>' : '<span class="text-gray-500 text-sm">ëŒ€ê¸°ì¤‘</span>'}
          </td>
          <td class="border border-gray-300 px-2 py-2">
            <div class="flex gap-2">
              ${!item.approved ? `
                <button onclick="approvePaymentFromTable(${index})" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#16a34a'" onmouseout="this.style.backgroundColor='#22c55e'">
                  ìŠ¹ì¸
                </button>
              ` : `
                <span style="background-color: #dcfce7; color: #166534; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; display: inline-block;">âœ“ ìŠ¹ì¸ë¨</span>
              `}
              <button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">
                ì‚­ì œ
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // ì…ê¸ˆ ë°ì´í„° ì €ì¥í•˜ê¸°
    async function savePaymentData() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;

      // ì°¸ê°€ì ëª©ë¡ì´ ì—†ìœ¼ë©´ ë¨¼ì € ë¡œë“œ
      if (allParticipants.length === 0) {
        try {
          const response = await fetch('/api/admin/participants');
          const data = await response.json();
          if (data.success) {
            allParticipants = data.participants || [];
          }
        } catch (err) {
          console.error('Error loading participants:', err);
          alert('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return;
        }
      }

      // í…Œì´ë¸”ì—ì„œ ì§ì ‘ ë°ì´í„°ë¥¼ ì½ì–´ì„œ paymentDataList ì—…ë°ì´íŠ¸
      const rows = tbody.querySelectorAll('tr');
      const updatedList = [];

      rows.forEach(function(row, rowIndex) {
        const inputs = row.querySelectorAll('input[type="text"]');
        if (inputs.length < 7) return;

        const date = inputs[0].value.trim();
        const type = inputs[1].value.trim();
        const amount = inputs[2].value.trim();
        const balance = inputs[3].value.trim();
        const transactionType = inputs[4].value.trim();
        const content = inputs[5].value.trim();
        const memo = inputs[6].value.trim();

        // ë¹ˆ í–‰ì€ ì œì™¸
        if (!date && !type && !amount && !content) return;

        // ê¸°ì¡´ paymentDataListì—ì„œ í•´ë‹¹ ì¸ë±ìŠ¤ì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìˆëŠ” ê²½ìš°)
        // paymentDataListê°€ ì¶©ë¶„íˆ í¬ì§€ ì•Šìœ¼ë©´ í™•ì¥
        while (paymentDataList.length <= rowIndex) {
          paymentDataList.push({
            date: '',
            type: '',
            amount: '',
            balance: '',
            transactionType: '',
            content: '',
            memo: '',
            matchedName: '',
            matchedPhoneLast4: '',
            matchedParticipant: null,
            expectedParticipants: [],
            approved: false
          });
        }
        const existingItem = paymentDataList[rowIndex] || null;

        // ë‚´ìš©ì—ì„œ ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ 4ê°œ ì¶”ì¶œ
        const nameMatch = content.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
        let matchedName = '';
        let matchedPhoneLast4 = '';
        
        if (nameMatch) {
          matchedName = nameMatch[1].trim();
          matchedPhoneLast4 = nameMatch[2] || '';
        }

        // ì‹ ì²­ì ë§¤ì¹­
        let matchedParticipant = null;
        if (matchedName && matchedPhoneLast4) {
          matchedParticipant = allParticipants.find(function(p) {
            // ì´ë¦„ ë§¤ì¹­: ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš°
            // ë‹¨, í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();
            
            // ì •í™•íˆ ì¼ì¹˜
            if (pName === matchedNameTrimmed) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }
            
            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);
            
            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }
            
            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }
            
            return false;
          });
        }

        // ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ì°¾ê¸° (ì´ë¦„ë§Œìœ¼ë¡œ ë§¤ì¹­, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ëŠ” ë¬´ì‹œ)
        let expectedParticipants = [];
        if (matchedName) {
          expectedParticipants = allParticipants.filter(function(p) {
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();
            
            // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš° (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            if (pName === matchedNameTrimmed) {
              return true;
            }
            
            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);
            
            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }
            
            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              return true;
            }
            
            return false;
          });
        }

        // ê¸°ì¡´ ë°ì´í„°ì˜ approved ìƒíƒœ ìœ ì§€ (ì—†ìœ¼ë©´ false)
        const approved = existingItem ? existingItem.approved : false;

        updatedList.push({
          date: date,
          type: type,
          amount: amount,
          balance: balance,
          transactionType: transactionType,
          content: content,
          memo: memo,
          matchedName: matchedName,
          matchedPhoneLast4: matchedPhoneLast4,
          matchedParticipant: matchedParticipant,
          expectedParticipants: expectedParticipants,
          approved: approved
        });
      });

      if (updatedList.length === 0) {
        alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // paymentDataList ì—…ë°ì´íŠ¸
      paymentDataList = updatedList;

      // localStorageì— ì €ì¥
      savePaymentDataToStorage();

      // í…Œì´ë¸” ì—…ë°ì´íŠ¸
      updatePaymentTableWithMatches();

      alert('ì…ê¸ˆ ë‚´ì—­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // í…Œì´ë¸”ì—ì„œ ë°ì´í„° ì½ê¸° ë° ë§¤ì¹­
    async function parsePaymentDataFromTable() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;

      // ì°¸ê°€ì ëª©ë¡ ë¡œë“œ
      try {
        const response = await fetch('/api/admin/participants');
        const data = await response.json();
        if (data.success) {
          allParticipants = data.participants || [];
        }
      } catch (err) {
        console.error('Error loading participants:', err);
        alert('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      const rows = tbody.querySelectorAll('tr');
      paymentDataList = [];

      rows.forEach(function(row) {
        const inputs = row.querySelectorAll('input[type="text"]');
        if (inputs.length < 7) return;

        const date = inputs[0].value.trim();
        const type = inputs[1].value.trim();
        const amount = inputs[2].value.trim();
        const balance = inputs[3].value.trim();
        const transactionType = inputs[4].value.trim();
        const content = inputs[5].value.trim();
        const memo = inputs[6].value.trim();

        // ë¹ˆ í–‰ì€ ì œì™¸
        if (!date && !type && !amount && !content) return;

        // ë‚´ìš©ì—ì„œ ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ 4ê°œ ì¶”ì¶œ
        const nameMatch = content.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
        let matchedName = '';
        let matchedPhoneLast4 = '';
        
        if (nameMatch) {
          matchedName = nameMatch[1].trim();
          matchedPhoneLast4 = nameMatch[2] || '';
        }

        // ì‹ ì²­ì ë§¤ì¹­
        let matchedParticipant = null;
        if (matchedName && matchedPhoneLast4) {
          matchedParticipant = allParticipants.find(function(p) {
            // ì´ë¦„ ë§¤ì¹­: ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš°
            // ë‹¨, í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();
            
            // ì •í™•íˆ ì¼ì¹˜
            if (pName === matchedNameTrimmed) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }
            
            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);
            
            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }
            
            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }
            
            return false;
          });
        }

        // ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ì°¾ê¸° (ì´ë¦„ë§Œìœ¼ë¡œ ë§¤ì¹­, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ëŠ” ë¬´ì‹œ)
        let expectedParticipants = [];
        if (matchedName) {
          expectedParticipants = allParticipants.filter(function(p) {
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();
            
            // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš° (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            if (pName === matchedNameTrimmed) {
              return true;
            }
            
            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);
            
            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }
            
            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              return true;
            }
            
            return false;
          });
        }

        // ê¸°ì¡´ paymentDataListì—ì„œ í•´ë‹¹ ì¸ë±ìŠ¤ì˜ approved ìƒíƒœ í™•ì¸
        const currentIndex = paymentDataList.length;
        const existingItem = paymentDataList[currentIndex] || null;
        const approved = existingItem ? existingItem.approved : false;

        paymentDataList.push({
          date: date,
          type: type,
          amount: amount,
          balance: balance,
          transactionType: transactionType,
          content: content,
          memo: memo,
          matchedName: matchedName,
          matchedPhoneLast4: matchedPhoneLast4,
          matchedParticipant: matchedParticipant,
          expectedParticipants: expectedParticipants,
          approved: approved
        });
      });

      // ë§¤ì¹­ ê²°ê³¼ë¥¼ í…Œì´ë¸”ì— ë°˜ì˜
      updatePaymentTableWithMatches();
      // localStorageì— ì €ì¥
      savePaymentDataToStorage();
    }

    function updatePaymentTableWithMatches() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;

      const rows = tbody.querySelectorAll('tr');
      rows.forEach(function(row, index) {
        const item = paymentDataList[index];
        if (!item) return;

        // ì—°ë²ˆ ì—…ë°ì´íŠ¸ (ì²« ë²ˆì§¸ ì…€)
        const numberCell = row.cells[0];
        if (numberCell) {
          numberCell.textContent = index + 1;
        }

        // ë§¤ì¹­ ê²°ê³¼ ì…€ ì—…ë°ì´íŠ¸
        // ì…€ ì¸ë±ìŠ¤: 0=ì—°ë²ˆ, 1=ê±°ë˜ì¼ì‹œ, 2=êµ¬ë¶„, 3=ê±°ë˜ê¸ˆì•¡, 4=ê±°ë˜í›„ì”ì•¡, 5=ê±°ë˜êµ¬ë¶„, 6=ë‚´ìš©, 7=ë©”ëª¨, 8=ë§¤ì¹­ëœì‹ ì²­ì, 9=ì˜ˆìƒë˜ëŠ”ì‹ ì²­ì, 10=ë¹„ê³ , 11=ìƒíƒœ, 12=ì‘ì—…
        const matchCell = row.cells[8];
        const expectedCell = row.cells[9];
        const noteCell = row.cells[10];
        const statusCell = row.cells[11];
        const actionCell = row.cells[12];

        if (matchCell) {
          const hasMatch = item.matchedParticipant !== null;
          const hasPhoneLast4 = item.matchedPhoneLast4 !== '';
          
          if (hasMatch) {
            matchCell.innerHTML = '<div class="text-green-600 font-semibold text-sm">âœ“ ' + item.matchedParticipant.user_name + ' (' + formatPhone(item.matchedParticipant.phone) + ')</div>';
            row.className = '';
          } else if (hasPhoneLast4) {
            matchCell.innerHTML = '<div class="text-red-600 text-sm">âœ— ë§¤ì¹­ë˜ì§€ ì•ŠìŒ (' + item.matchedName + item.matchedPhoneLast4 + ')</div>';
            row.className = 'bg-yellow-50';
          } else {
            matchCell.innerHTML = '<div class="text-orange-600 text-sm">âš  ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ì—†ìŒ</div>';
            row.className = 'bg-yellow-50';
          }
        }

        if (expectedCell) {
          // matchedParticipantê°€ ì—†ì„ ë•Œë§Œ ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì í‘œì‹œ
          if (!item.matchedParticipant && item.expectedParticipants && item.expectedParticipants.length > 0) {
            if (item.expectedParticipants.length === 1) {
              expectedCell.innerHTML = '<div class="text-blue-600 text-sm">' + item.expectedParticipants[0].user_name + ' (' + formatPhone(item.expectedParticipants[0].phone) + ')</div>';
            } else {
              expectedCell.innerHTML = '<div class="text-orange-600 font-semibold text-sm">âš  ë™ëª…ì´ì¸ ë°œìƒ, ì—°ë½ í›„ ì…ê¸ˆí™•ì¸ í•„ìš”</div>';
            }
          } else {
            expectedCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
          }
        }

        if (noteCell) {
          // expectedParticipantsê°€ 2ëª… ì´ìƒì¼ ë•Œ ë¹„ê³  ë€ì— ë™ëª…ì´ì¸ ëª©ë¡ í‘œì‹œ
          // matchedParticipantê°€ ìˆì–´ë„ ë™ëª…ì´ì¸ì´ ìˆìœ¼ë©´ í‘œì‹œ (ì´ë¯¸ ìŠ¹ì¸ëœ ì°¸ê°€ìëŠ” ì œì™¸)
          if (item.expectedParticipants && item.expectedParticipants.length > 1) {
            // ì´ë¯¸ ìŠ¹ì¸ëœ ì°¸ê°€ìë¥¼ ì œì™¸í•œ ë™ëª…ì´ì¸ ëª©ë¡
            const unapprovedDuplicates = item.expectedParticipants.filter(function(p) {
              // matchedParticipantê°€ ìˆê³ , ê·¸ ì°¸ê°€ìê°€ ì´ë¯¸ ìŠ¹ì¸ëœ ê²½ìš°ëŠ” ì œì™¸
              if (item.matchedParticipant && item.matchedParticipant.id === p.id) {
                return false;
              }
              return true;
            });
            
            if (unapprovedDuplicates.length > 0) {
              let noteHtml = '<div class="text-sm space-y-2">';
              unapprovedDuplicates.forEach(function(p) {
                noteHtml += '<div class="flex items-center justify-between gap-2 p-2 bg-gray-50 rounded border border-gray-200"><span class="text-gray-700">' + p.user_name + ' (' + formatPhone(p.phone) + ')</span><button onclick="approveDuplicateParticipant(' + index + ', ' + p.id + ')" style="background-color: #22c55e; color: white; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-weight: bold; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; white-space: nowrap;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button></div>';
              });
              noteHtml += '</div>';
              noteCell.innerHTML = noteHtml;
            } else {
              // ëª¨ë“  ë™ëª…ì´ì¸ì´ ìŠ¹ì¸ëœ ê²½ìš°
              noteCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
            }
          } else {
            noteCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
          }
        }

        if (statusCell) {
          statusCell.innerHTML = item.approved ? '<span class="text-green-600 font-semibold text-sm">ìŠ¹ì¸ë¨</span>' : '<span class="text-gray-500 text-sm">ëŒ€ê¸°ì¤‘</span>';
        }

        if (actionCell) {
          const approveBtn = !item.approved 
            ? '<button onclick="approvePaymentFromTable(' + index + ')" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button>' 
            : '<span style="background-color: #dcfce7; color: #166534; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; display: inline-block;">âœ“ ìŠ¹ì¸ë¨</span>';
          const deleteBtn = '<button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#dc2626\'" onmouseout="this.style.backgroundColor=\'#ef4444\'">ì‚­ì œ</button>';
          actionCell.innerHTML = '<div class="flex gap-2">' + approveBtn + deleteBtn + '</div>';
        }
      });
    }

    function updatePaymentDataFromInput(input) {
      // í…Œì´ë¸”ì—ì„œ ì§ì ‘ ì…ë ¥ ì‹œ paymentDataList ì—…ë°ì´íŠ¸ëŠ” savePaymentData()ì—ì„œ ì²˜ë¦¬
      // ì—¬ê¸°ì„œëŠ” ì¦‰ì‹œ ì €ì¥í•˜ì§€ ì•Šê³ , ì €ì¥ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ í•œ ë²ˆì— ì²˜ë¦¬
    }

    async function reMatchPaymentFromInput(input) {
      // ë‚´ìš© í•„ë“œ ë³€ê²½ ì‹œ ìë™ ì¬ë§¤ì¹­
      const row = input.closest('tr');
      if (!row) return;
      
      // ì°¸ê°€ì ëª©ë¡ ë¡œë“œ (ì—†ìœ¼ë©´)
      if (allParticipants.length === 0) {
        try {
          const response = await fetch('/api/admin/participants');
          const data = await response.json();
          if (data.success) {
            allParticipants = data.participants || [];
          }
        } catch (err) {
          console.error('Error loading participants:', err);
          return;
        }
      }
      
      // í–‰ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;
      const rows = tbody.querySelectorAll('tr');
      const rowIndex = Array.from(rows).indexOf(row);
      if (rowIndex < 0) return;
      
      // í•´ë‹¹ í–‰ì˜ ëª¨ë“  ì…ë ¥ê°’ ì½ê¸°
      const inputs = row.querySelectorAll('input[type="text"]');
      if (inputs.length < 7) return;
      
      const date = inputs[0].value.trim();
      const type = inputs[1].value.trim();
      const amount = inputs[2].value.trim();
      const balance = inputs[3].value.trim();
      const transactionType = inputs[4].value.trim();
      const content = inputs[5].value.trim();
      const memo = inputs[6].value.trim();
      
      // ë‚´ìš©ì—ì„œ ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ 4ê°œ ì¶”ì¶œ
      const nameMatch = content.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
      let matchedName = '';
      let matchedPhoneLast4 = '';
      
      if (nameMatch) {
        matchedName = nameMatch[1].trim();
        matchedPhoneLast4 = nameMatch[2] || '';
      }
      
      // ì‹ ì²­ì ë§¤ì¹­
      let matchedParticipant = null;
      if (matchedName && matchedPhoneLast4) {
        matchedParticipant = allParticipants.find(function(p) {
          // ì´ë¦„ ë§¤ì¹­: ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš°
          // ë‹¨, í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
          const pName = p.user_name.trim();
          const matchedNameTrimmed = matchedName.trim();
          
          // ì •í™•íˆ ì¼ì¹˜
          if (pName === matchedNameTrimmed) {
            const phoneLast4 = p.phone.slice(-4);
            return phoneLast4 === matchedPhoneLast4;
          }
          
          // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ)
          const pNameHasHangul = /[ê°€-í£]/.test(pName);
          const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
          const pNameHasEnglish = /[a-zA-Z]/.test(pName);
          const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);
          
          // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
          if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
            return false;
          }
          
          // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸
          const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
          if (nameMatch) {
            const phoneLast4 = p.phone.slice(-4);
            return phoneLast4 === matchedPhoneLast4;
          }
          
          return false;
        });
      }
      
      // ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ì°¾ê¸° (ì´ë¦„ë§Œìœ¼ë¡œ ë§¤ì¹­, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ëŠ” ë¬´ì‹œ)
      let expectedParticipants = [];
      if (matchedName) {
        expectedParticipants = allParticipants.filter(function(p) {
          const pName = p.user_name.trim();
          const matchedNameTrimmed = matchedName.trim();
          
          // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš° (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
          if (pName === matchedNameTrimmed) {
            return true;
          }
          
          // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
          const pNameHasHangul = /[ê°€-í£]/.test(pName);
          const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
          const pNameHasEnglish = /[a-zA-Z]/.test(pName);
          const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);
          
          // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
          if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
            return false;
          }
          
          // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
          const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
          if (nameMatch) {
            return true;
          }
          
          return false;
        });
      }
      
      // ê¸°ì¡´ paymentDataListì—ì„œ í•´ë‹¹ ì¸ë±ìŠ¤ì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìˆëŠ” ê²½ìš°)
      // paymentDataListê°€ ì¶©ë¶„íˆ í¬ì§€ ì•Šìœ¼ë©´ í™•ì¥
      while (paymentDataList.length <= rowIndex) {
        paymentDataList.push({
          date: '',
          type: '',
          amount: '',
          balance: '',
          transactionType: '',
          content: '',
          memo: '',
          matchedName: '',
          matchedPhoneLast4: '',
          matchedParticipant: null,
          expectedParticipants: [],
          approved: false
        });
      }
      
      const existingItem = paymentDataList[rowIndex] || null;
      const approved = existingItem ? existingItem.approved : false;
      
      // paymentDataList ì—…ë°ì´íŠ¸ (í•´ë‹¹ ì¸ë±ìŠ¤ë§Œ)
      paymentDataList[rowIndex] = {
        date: date,
        type: type,
        amount: amount,
        balance: balance,
        transactionType: transactionType,
        content: content,
        memo: memo,
        matchedName: matchedName,
        matchedPhoneLast4: matchedPhoneLast4,
        matchedParticipant: matchedParticipant,
        expectedParticipants: expectedParticipants,
        approved: approved
      };
      
      // í•´ë‹¹ í–‰ë§Œ ì—…ë°ì´íŠ¸
      updateSinglePaymentRow(row, rowIndex, paymentDataList[rowIndex]);
      
      // localStorageì— ì €ì¥
      savePaymentDataToStorage();
    }
    
    function updateSinglePaymentRow(row, index, item) {
      if (!row || !item) return;
      
      // ë§¤ì¹­ ê²°ê³¼ ì…€ ì—…ë°ì´íŠ¸
      // ì…€ ì¸ë±ìŠ¤: 0=ì—°ë²ˆ, 1=ê±°ë˜ì¼ì‹œ, 2=êµ¬ë¶„, 3=ê±°ë˜ê¸ˆì•¡, 4=ê±°ë˜í›„ì”ì•¡, 5=ê±°ë˜êµ¬ë¶„, 6=ë‚´ìš©, 7=ë©”ëª¨, 8=ë§¤ì¹­ëœì‹ ì²­ì, 9=ì˜ˆìƒë˜ëŠ”ì‹ ì²­ì, 10=ë¹„ê³ , 11=ìƒíƒœ, 12=ì‘ì—…
      const matchCell = row.cells[8];
      const expectedCell = row.cells[9];
      const noteCell = row.cells[10];
      const statusCell = row.cells[11];
      const actionCell = row.cells[12];
      
      if (matchCell) {
        const hasMatch = item.matchedParticipant !== null;
        const hasPhoneLast4 = item.matchedPhoneLast4 !== '';
        
        if (hasMatch) {
          matchCell.innerHTML = '<div class="text-green-600 font-semibold text-sm">âœ“ ' + item.matchedParticipant.user_name + ' (' + formatPhone(item.matchedParticipant.phone) + ')</div>';
          row.className = '';
        } else if (hasPhoneLast4) {
          matchCell.innerHTML = '<div class="text-red-600 text-sm">âœ— ë§¤ì¹­ë˜ì§€ ì•ŠìŒ (' + item.matchedName + item.matchedPhoneLast4 + ')</div>';
          row.className = 'bg-yellow-50';
        } else {
          matchCell.innerHTML = '<div class="text-orange-600 text-sm">âš  ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ì—†ìŒ</div>';
          row.className = 'bg-yellow-50';
        }
      }
      
      if (expectedCell) {
        // matchedParticipantê°€ ì—†ì„ ë•Œë§Œ ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì í‘œì‹œ
        if (!item.matchedParticipant && item.expectedParticipants && item.expectedParticipants.length > 0) {
          if (item.expectedParticipants.length === 1) {
            expectedCell.innerHTML = '<div class="text-blue-600 text-sm">' + item.expectedParticipants[0].user_name + ' (' + formatPhone(item.expectedParticipants[0].phone) + ')</div>';
          } else {
            expectedCell.innerHTML = '<div class="text-orange-600 font-semibold text-sm">âš  ë™ëª…ì´ì¸ ë°œìƒ, ì—°ë½ í›„ ì…ê¸ˆí™•ì¸ í•„ìš”</div>';
          }
        } else {
          expectedCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
        }
      }
      
      if (noteCell) {
        // expectedParticipantsê°€ 2ëª… ì´ìƒì¼ ë•Œë§Œ ë¹„ê³ ë€ í‘œì‹œ
        if (item.expectedParticipants && item.expectedParticipants.length > 1) {
          // ì´ë¯¸ ë§¤ì¹­ëœ ì°¸ê°€ìë¥¼ ì œì™¸í•œ ë™ëª…ì´ì¸ ëª©ë¡
          const unapprovedDuplicates = item.expectedParticipants.filter(function(p) {
            // matchedParticipantê°€ ìˆê³ , ê·¸ ì°¸ê°€ìê°€ ì´ë¯¸ ë§¤ì¹­ëœ ê²½ìš°ëŠ” ì œì™¸
            if (item.matchedParticipant && item.matchedParticipant.id === p.id) {
              return false;
            }
            return true;
          });
          
          if (unapprovedDuplicates.length > 0) {
            let noteHtml = '<div class="text-sm space-y-2">';
            unapprovedDuplicates.forEach(function(p) {
              noteHtml += '<div class="flex items-center justify-between gap-2 p-2 bg-gray-50 rounded border border-gray-200"><span class="text-gray-700">' + p.user_name + ' (' + formatPhone(p.phone) + ')</span><button onclick="approveDuplicateParticipant(' + index + ', ' + p.id + ')" style="background-color: #22c55e; color: white; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-weight: bold; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; white-space: nowrap;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button></div>';
            });
            noteHtml += '</div>';
            noteCell.innerHTML = noteHtml;
          } else {
            // ëª¨ë“  ë™ëª…ì´ì¸ì´ ë§¤ì¹­ëœ ê²½ìš°
            noteCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
          }
        } else {
          // ë™ëª…ì´ì¸ì´ 2ëª… ë¯¸ë§Œì´ë©´ ë¹„ê³ ë€ ë¹„ìš°ê¸°
          noteCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
        }
      }
      
      if (statusCell) {
        statusCell.innerHTML = item.approved ? '<span class="text-green-600 font-semibold text-sm">ìŠ¹ì¸ë¨</span>' : '<span class="text-gray-500 text-sm">ëŒ€ê¸°ì¤‘</span>';
      }
      
      if (actionCell) {
        const approveBtn = !item.approved 
          ? '<button onclick="approvePaymentFromTable(' + index + ')" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button>' 
          : '<span style="background-color: #dcfce7; color: #166534; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; display: inline-block;">âœ“ ìŠ¹ì¸ë¨</span>';
        const deleteBtn = '<button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#dc2626\'" onmouseout="this.style.backgroundColor=\'#ef4444\'">ì‚­ì œ</button>';
        actionCell.innerHTML = '<div class="flex gap-2">' + approveBtn + deleteBtn + '</div>';
      }
    }

    function removePaymentRowFromTable(button) {
      const row = button.closest('tr');
      if (row && confirm('ì´ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        row.remove();
        // paymentDataListì—ì„œë„ ì œê±°
        const tbody = document.getElementById('paymentTableBody');
        if (tbody) {
          const rows = tbody.querySelectorAll('tr');
          const index = Array.from(rows).indexOf(row);
          if (index >= 0 && paymentDataList[index]) {
            paymentDataList.splice(index, 1);
          }
          // ì—°ë²ˆ ì¬ì •ë ¬
          updatePaymentRowNumbers();
          // localStorageì— ì €ì¥
          savePaymentDataToStorage();
        }
      }
    }

    async function approveDuplicateParticipant(paymentIndex, participantId) {
      const item = paymentDataList[paymentIndex];
      if (!item) return;

      // ì„ íƒí•œ ì°¸ê°€ì ì°¾ê¸°
      const selectedParticipant = allParticipants.find(function(p) {
        return p.id === participantId;
      });

      if (!selectedParticipant) {
        alert('ì°¸ê°€ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ë§¤ì¹­ëœ ì°¸ê°€ìë¡œ ì„¤ì •
      item.matchedParticipant = selectedParticipant;
      item.matchedName = selectedParticipant.user_name;
      item.matchedPhoneLast4 = selectedParticipant.phone.slice(-4);
      // ë™ëª…ì´ì¸ ìŠ¹ì¸ í›„ expectedParticipantsëŠ” ìœ ì§€í•˜ë˜, ë¹„ê³  ë€ì€ matchedParticipantê°€ ìˆìœ¼ë©´ í‘œì‹œë˜ì§€ ì•ŠìŒ

      // ì…ê¸ˆ í™•ì¸ ì²˜ë¦¬
      try {
        const response = await fetch('/api/admin/participants/' + selectedParticipant.id + '/payment', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_paid: 1 }),
        });

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }

        item.approved = true;
        
        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        const tbody = document.getElementById('paymentTableBody');
        if (tbody) {
          const rows = tbody.querySelectorAll('tr');
          if (rows[paymentIndex]) {
            updateSinglePaymentRow(rows[paymentIndex], paymentIndex, item);
          }
        }
        
        savePaymentDataToStorage();
        alert('ì…ê¸ˆì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (err) {
        console.error('Error approving payment:', err);
        alert(err.message || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function approvePaymentFromTable(index) {
      const item = paymentDataList[index];
      if (!item) return;

      if (!item.matchedParticipant && item.matchedPhoneLast4) {
        if (!confirm('ë§¤ì¹­ëœ ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.\në‚´ìš©: ' + item.content + '\n\nìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
      } else if (!item.matchedPhoneLast4) {
        if (!confirm('ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.\në‚´ìš©: ' + item.content + '\n\nìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
      }

      if (item.matchedParticipant) {
        try {
          const response = await fetch('/api/admin/participants/' + item.matchedParticipant.id + '/payment', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_paid: 1 }),
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }

          item.approved = true;
          updatePaymentTableWithMatches();
          savePaymentDataToStorage();
          alert('ì…ê¸ˆì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (err) {
          console.error('Error approving payment:', err);
          alert(err.message || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } else {
        item.approved = true;
        updatePaymentTableWithMatches();
        savePaymentDataToStorage();
        alert('ìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì°¸ê°€ì ê´€ë¦¬ì—ì„œ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.');
      }
    }

    // í…Œì´ë¸”ì— ë¶™ì—¬ë„£ê¸° ì§€ì›
    document.addEventListener('DOMContentLoaded', function() {
      const paymentTable = document.getElementById('paymentTable');
      if (paymentTable) {
        paymentTable.addEventListener('paste', function(e) {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text');
          const rows = paste.split('\n').filter(function(row) { return row.trim(); });
          
          if (rows.length === 0) return;

          const tbody = document.getElementById('paymentTableBody');
          if (!tbody) return;

          // í˜„ì¬ í¬ì»¤ìŠ¤ëœ ì…€ ì°¾ê¸°
          const activeElement = document.activeElement;
          if (!activeElement || activeElement.tagName !== 'INPUT') return;

          const currentRow = activeElement.closest('tr');
          if (!currentRow) return;

          const currentInputs = currentRow.querySelectorAll('input[type="text"]');
          const startCol = Array.from(currentInputs).indexOf(activeElement);
          if (startCol < 0) return;

          // ì²« ë²ˆì§¸ í–‰ì˜ ì²« ë²ˆì§¸ ì…€ì— ë¶™ì—¬ë„£ì„ ë•ŒëŠ” í•­ìƒ ì²« ë²ˆì§¸ ì—´ë¶€í„° ì‹œì‘
          const isFirstCell = startCol === 0 && currentRow === tbody.querySelector('tr:first-child');
          const actualStartCol = isFirstCell ? 0 : startCol;

          rows.forEach(function(row, rowIndex) {
            // íƒ­ìœ¼ë¡œ êµ¬ë¶„ (ì—‘ì…€ì€ íƒ­ìœ¼ë¡œ êµ¬ë¶„)
            const values = row.split('\t').map(function(v) { return v.trim(); });
            
            // ë¹ˆ í–‰ì€ ê±´ë„ˆë›°ê¸°
            if (values.length === 0 || (values.length === 1 && !values[0])) return;
            
            let targetRow = currentRow;
            if (rowIndex > 0 || (rowIndex === 0 && isFirstCell)) {
              // ì²« ë²ˆì§¸ í–‰ì˜ ì²« ë²ˆì§¸ ì…€ì— ë¶™ì—¬ë„£ì„ ë•ŒëŠ” ìƒˆ í–‰ë¶€í„° ì‹œì‘
              if (rowIndex === 0 && isFirstCell) {
                // ì²« ë²ˆì§¸ í–‰ì€ í˜„ì¬ í–‰ì— ë®ì–´ì“°ê¸°
                targetRow = currentRow;
              } else if (rowIndex > 0) {
                // ìƒˆ í–‰ ì¶”ê°€
                const newRow = currentRow.cloneNode(true);
                const newInputs = newRow.querySelectorAll('input[type="text"]');
                newInputs.forEach(function(input) { input.value = ''; });
                // ë§¤ì¹­ ê²°ê³¼ ì…€ë“¤ë„ ì´ˆê¸°í™” (ë¹„ê³  ì—´ ì¶”ê°€ë¡œ ì¸ë±ìŠ¤ ë³€ê²½)
                const newCells = newRow.querySelectorAll('td');
                if (newCells.length >= 13) {
                  newCells[8].innerHTML = '<span class="text-sm text-gray-400">-</span>';
                  newCells[9].innerHTML = '<span class="text-sm text-gray-400">-</span>';
                  newCells[10].innerHTML = '<span class="text-sm text-gray-400">-</span>';
                  newCells[11].innerHTML = '<span class="text-sm text-gray-400">ëŒ€ê¸°ì¤‘</span>';
                  newCells[12].innerHTML = '<div class="flex gap-2"><button onclick="approvePaymentFromTable(' + (paymentDataList.length) + ')" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button><button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#dc2626\'" onmouseout="this.style.backgroundColor=\'#ef4444\'">ì‚­ì œ</button></div>';
                }
                tbody.appendChild(newRow);
                targetRow = newRow;
              }
            }

            const inputs = targetRow.querySelectorAll('input[type="text"]');
            values.forEach(function(value, colIndex) {
              const targetCol = actualStartCol + colIndex;
              if (targetCol < inputs.length && value) {
                inputs[targetCol].value = value;
                // ë‚´ìš© í•„ë“œ(ì¸ë±ìŠ¤ 5) ë³€ê²½ ì‹œ ìë™ ë§¤ì¹­
                if (targetCol === 5) {
                  reMatchPaymentFromInput(inputs[targetCol]);
                }
              }
            });
          });

          // ì—°ë²ˆ ì¬ì •ë ¬
          updatePaymentRowNumbers();

          // ë§ˆì§€ë§‰ í–‰ì˜ ë‚´ìš© í•„ë“œì—ì„œ ìë™ ë§¤ì¹­ ì‹¤í–‰
          setTimeout(function() {
            parsePaymentDataFromTable();
            // localStorageì— ì €ì¥
            savePaymentDataToStorage();
          }, 100);
        });
      }
    });

    async function parsePaymentData() {
      const input = document.getElementById('paymentDataInput');
      if (!input) {
        alert('ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const inputValue = input.value.trim();
      if (!inputValue) {
        alert('ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ì°¸ê°€ì ëª©ë¡ ë¡œë“œ
      try {
        const response = await fetch('/api/admin/participants');
        const data = await response.json();
        if (data.success) {
          allParticipants = data.participants || [];
        }
      } catch (err) {
        console.error('Error loading participants:', err);
        alert('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      // ë°ì´í„° íŒŒì‹± (íƒ­ ë˜ëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„)
      const lines = inputValue.split('\n').filter(line => line.trim());
      if (lines.length < 2) {
        alert('í—¤ë”ì™€ ìµœì†Œ 1ê°œì˜ ë°ì´í„° í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      // í—¤ë” íŒŒì‹±
      const headerLine = lines[0];
      const headers = headerLine.split(/\t|,/).map(h => h.trim());
      
      // í—¤ë” ì¸ë±ìŠ¤ ì°¾ê¸°
      const headerMap = {};
      headers.forEach(function(h, i) {
        if (h.includes('ê±°ë˜ì¼ì‹œ') || h.includes('ì¼ì‹œ')) headerMap.date = i;
        if (h.includes('êµ¬ë¶„')) headerMap.type = i;
        if (h.includes('ê±°ë˜ê¸ˆì•¡') || h.includes('ê¸ˆì•¡')) headerMap.amount = i;
        if (h.includes('ê±°ë˜ í›„ ì”ì•¡') || h.includes('ì”ì•¡')) headerMap.balance = i;
        if (h.includes('ê±°ë˜êµ¬ë¶„')) headerMap.transactionType = i;
        if (h.includes('ë‚´ìš©')) headerMap.content = i;
        if (h.includes('ë©”ëª¨')) headerMap.memo = i;
      });

      if (headerMap.content === undefined) {
        alert('"ë‚´ìš©" ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í—¤ë”ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ë°ì´í„° í–‰ íŒŒì‹±
      paymentDataList = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(/\t|,/).map(function(v) { return v.trim(); });
        if (values.length < headers.length) continue;

        const content = values[headerMap.content] || '';
        // ë‚´ìš©ì—ì„œ ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ 4ê°œ ì¶”ì¶œ
        // í˜•ì‹: "ì´ë¦„0000" ë˜ëŠ” "ì´ë¦„ 0000" ë“±
        const nameMatch = content.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
        let matchedName = '';
        let matchedPhoneLast4 = '';
        
        if (nameMatch) {
          matchedName = nameMatch[1].trim();
          matchedPhoneLast4 = nameMatch[2] || '';
        }

        // ì‹ ì²­ì ë§¤ì¹­
        let matchedParticipant = null;
        if (matchedName && matchedPhoneLast4) {
          matchedParticipant = allParticipants.find(function(p) {
            // ì´ë¦„ ë§¤ì¹­: ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš°
            // ë‹¨, í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();
            
            // ì •í™•íˆ ì¼ì¹˜
            if (pName === matchedNameTrimmed) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }
            
            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);
            
            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }
            
            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }
            
            return false;
          });
        }

        // ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ì°¾ê¸° (ì´ë¦„ë§Œìœ¼ë¡œ ë§¤ì¹­, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ëŠ” ë¬´ì‹œ)
        let expectedParticipants = [];
        if (matchedName) {
          expectedParticipants = allParticipants.filter(function(p) {
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();
            
            // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš° (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            if (pName === matchedNameTrimmed) {
              return true;
            }
            
            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);
            
            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }
            
            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              return true;
            }
            
            return false;
          });
        }

        paymentDataList.push({
          date: values[headerMap.date] || '',
          type: values[headerMap.type] || '',
          amount: values[headerMap.amount] || '',
          balance: values[headerMap.balance] || '',
          transactionType: values[headerMap.transactionType] || '',
          content: content,
          memo: values[headerMap.memo] || '',
          matchedName: matchedName,
          matchedPhoneLast4: matchedPhoneLast4,
          matchedParticipant: matchedParticipant,
          expectedParticipants: expectedParticipants,
          approved: false
        });
      }

      displayPaymentData();
    }

    function displayPaymentData() {
      const container = document.getElementById('paymentResults');
      const tbody = document.getElementById('paymentTableBody');
      
      if (!container || !tbody) return;

      container.classList.remove('hidden');
      tbody.innerHTML = '';

      paymentDataList.forEach(function(item, index) {
        const row = document.createElement('tr');
        const hasMatch = item.matchedParticipant !== null;
        const hasPhoneLast4 = item.matchedPhoneLast4 !== '';
        const rowClass = hasMatch ? '' : 'bg-yellow-50';
        
        row.className = rowClass;
        row.innerHTML = `
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.date || ''}" onchange="updatePaymentData(${index}, 'date', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.type || ''}" onchange="updatePaymentData(${index}, 'type', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.amount || ''}" onchange="updatePaymentData(${index}, 'amount', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.balance || ''}" onchange="updatePaymentData(${index}, 'balance', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.transactionType || ''}" onchange="updatePaymentData(${index}, 'transactionType', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.content || ''}" onchange="updatePaymentData(${index}, 'content', this.value); reMatchPayment(${index})" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.memo || ''}" onchange="updatePaymentData(${index}, 'memo', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${hasMatch ? `
              <div class="text-green-600 font-semibold text-sm">
                âœ“ ${item.matchedParticipant.user_name} (${formatPhone(item.matchedParticipant.phone)})
              </div>
            ` : hasPhoneLast4 ? `
              <div class="text-red-600 text-sm">
                âœ— ë§¤ì¹­ë˜ì§€ ì•ŠìŒ (${item.matchedName}${item.matchedPhoneLast4})
              </div>
            ` : `
              <div class="text-orange-600 text-sm">
                âš  ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ì—†ìŒ
              </div>
            `}
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${item.approved ? '<span class="text-green-600 font-semibold text-sm">ìŠ¹ì¸ë¨</span>' : '<span class="text-gray-500 text-sm">ëŒ€ê¸°ì¤‘</span>'}
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${!item.approved ? `
              <button onclick="approvePayment(${index})" class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">
                ìŠ¹ì¸
              </button>
            ` : `
              <span class="text-green-600">âœ“</span>
            `}
            <button onclick="removePaymentRow(${index})" class="ml-1 px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs">
              ì‚­ì œ
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function updatePaymentData(index, field, value) {
      if (paymentDataList[index]) {
        paymentDataList[index][field] = value;
      }
    }

    function reMatchPayment(index) {
      const item = paymentDataList[index];
      if (!item) return;

      const content = item.content || '';
      const nameMatch = content.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
      let matchedName = '';
      let matchedPhoneLast4 = '';
      
      if (nameMatch) {
        matchedName = nameMatch[1].trim();
        matchedPhoneLast4 = nameMatch[2] || '';
      }

      let matchedParticipant = null;
      if (matchedName && matchedPhoneLast4) {
        matchedParticipant = allParticipants.find(function(p) {
          const nameMatch = p.user_name === matchedName || p.user_name.includes(matchedName) || matchedName.includes(p.user_name);
          const phoneLast4 = p.phone.slice(-4);
          return nameMatch && phoneLast4 === matchedPhoneLast4;
        });
      }

      item.matchedName = matchedName;
      item.matchedPhoneLast4 = matchedPhoneLast4;
      item.matchedParticipant = matchedParticipant;
      item.approved = false;

      displayPaymentData();
    }

    function addPaymentRow() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;

      const rowCount = tbody.querySelectorAll('tr').length;
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td class="border border-gray-300 px-2 py-1 text-sm text-center text-gray-500">${rowCount + 1}</td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
        <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
        <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
        <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">ëŒ€ê¸°ì¤‘</td>
        <td class="border border-gray-300 px-2 py-2">
          <div class="flex gap-2">
            <button onclick="approvePaymentFromTable(${rowCount})" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#16a34a'" onmouseout="this.style.backgroundColor='#22c55e'">ìŠ¹ì¸</button>
            <button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">ì‚­ì œ</button>
          </div>
        </td>
      `;
      tbody.appendChild(newRow);
      
      // paymentDataListì— ë¹ˆ í•­ëª© ì¶”ê°€
      paymentDataList.push({
        date: '',
        type: '',
        amount: '',
        balance: '',
        transactionType: '',
        content: '',
        memo: '',
        matchedName: '',
        matchedPhoneLast4: '',
        matchedParticipant: null,
        expectedParticipants: [],
        approved: false
      });
      
      // ìƒˆ í–‰ì˜ ì²« ë²ˆì§¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
      const inputs = newRow.querySelectorAll('input');
      if (inputs.length > 0) inputs[0].focus();
      
      // ì—°ë²ˆ ì¬ì •ë ¬
      updatePaymentRowNumbers();
      // localStorageì— ì €ì¥
      savePaymentDataToStorage();
    }

    function updatePaymentRowNumbers() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;
      
      const rows = tbody.querySelectorAll('tr');
      rows.forEach(function(row, index) {
        const numberCell = row.cells[0];
        if (numberCell) {
          numberCell.textContent = index + 1;
        }
      });
    }

    function resetPaymentTable() {
      if (!confirm('ì…ê¸ˆ ë‚´ì—­ì„ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) {
        return;
      }

      paymentDataList = [];
      localStorage.removeItem('paymentDataList');
      const tbody = document.getElementById('paymentTableBody');
      if (tbody) {
        tbody.innerHTML = `
          <tr>
            <td class="border border-gray-300 px-2 py-1 text-sm text-center text-gray-500">1</td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
            <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
            <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">ëŒ€ê¸°ì¤‘</td>
            <td class="border border-gray-300 px-2 py-2">
              <div class="flex gap-2">
                <button onclick="approvePaymentFromTable(0)" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#16a34a'" onmouseout="this.style.backgroundColor='#22c55e'">ìŠ¹ì¸</button>
                <button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">ì‚­ì œ</button>
              </div>
            </td>
          </tr>
        `;
      }
    }

    function removePaymentRow(index) {
      if (confirm('ì´ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        paymentDataList.splice(index, 1);
        displayPaymentData();
      }
    }

    async function approvePayment(index) {
      const item = paymentDataList[index];
      if (!item) return;

      if (!item.matchedParticipant && item.matchedPhoneLast4) {
        // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° í™•ì¸
        if (!confirm('ë§¤ì¹­ëœ ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.\në‚´ìš©: ' + item.content + '\n\nìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
      } else if (!item.matchedPhoneLast4) {
        // ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ê°€ ì—†ëŠ” ê²½ìš° í™•ì¸
        if (!confirm('ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.\në‚´ìš©: ' + item.content + '\n\nìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
      }

      if (item.matchedParticipant) {
        // ë§¤ì¹­ëœ ì°¸ê°€ìì˜ ì…ê¸ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
        try {
          const response = await fetch('/api/admin/participants/' + item.matchedParticipant.id + '/payment', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_paid: 1 }),
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }

          item.approved = true;
          displayPaymentData();
          alert('ì…ê¸ˆì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (err) {
          console.error('Error approving payment:', err);
          const errorMessage = err.message || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          alert(errorMessage);
        }
      } else {
        // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° ìˆ˜ë™ ìŠ¹ì¸
        item.approved = true;
        displayPaymentData();
        alert('ìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì°¸ê°€ì ê´€ë¦¬ì—ì„œ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.');
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê·¸ë£¹ í‘œì‹œ ì—…ë°ì´íŠ¸
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        updateGroupDisplay();
      });
    } else {
      updateGroupDisplay();
    }

    // QR ì²´í¬ì¸ ê´€ë ¨ ë³€ìˆ˜
    let html5QrCode = null;
    let recentCheckins = [];

    // ì²´í¬ì¸ í†µê³„ ë¡œë“œ
    async function loadCheckinStats() {
      try {
        const response = await fetch('/api/admin/checkin/stats');
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('checkinTotal').textContent = data.stats.total;
          document.getElementById('checkinCount').textContent = data.stats.checkedIn;
          document.getElementById('checkinRemaining').textContent = data.stats.remaining;
        }
      } catch (err) {
        console.error('Error loading check-in stats:', err);
      }
    }

    // QR ìŠ¤ìºë„ˆ ì‹œì‘
    async function startQRScanner() {
      const qrReader = document.getElementById('qrReader');
      const startBtn = document.getElementById('startScannerBtn');
      const stopBtn = document.getElementById('stopScannerBtn');
      const container = document.getElementById('qrScannerContainer');
      
      if (!qrReader || !container) {
        alert('QR ìŠ¤ìºë„ˆ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // html5-qrcode ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
      if (typeof Html5Qrcode === 'undefined') {
        alert('QR ìŠ¤ìºë„ˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        // ì»¨í…Œì´ë„ˆ ë¨¼ì € í‘œì‹œ
        container.classList.remove('hidden');
        startBtn.classList.add('hidden');
        stopBtn.classList.remove('hidden');
        
        // qrReader ë‚´ìš© ì´ˆê¸°í™”
        qrReader.innerHTML = '';
        
        // html5-qrcode ì´ˆê¸°í™”
        html5QrCode = new Html5Qrcode('qrReader');
        
        // ì¹´ë©”ë¼ ì‹œì‘
        await html5QrCode.start(
          { facingMode: 'environment' }, // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          (decodedText, decodedResult) => {
            // QR ì½”ë“œ ìŠ¤ìº” ì„±ê³µ
            handleQRScan(decodedText);
          },
          (errorMessage) => {
            // ìŠ¤ìº” ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œ)
            // console.log('Scan error:', errorMessage);
          }
        );
      } catch (err) {
        console.error('Error starting QR scanner:', err);
        // ì—ëŸ¬ ë°œìƒ ì‹œ UI ë³µì›
        container.classList.add('hidden');
        startBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
        
        if (html5QrCode) {
          try {
            await html5QrCode.stop();
            html5QrCode.clear();
            html5QrCode = null;
          } catch (e) {
            // ë¬´ì‹œ
          }
        }
        
        let errorMsg = 'ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.';
        if (err.message && err.message.includes('Permission')) {
          errorMsg = 'ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
        } else if (err.message && err.message.includes('NotFound')) {
          errorMsg = 'ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
        }
        alert(errorMsg);
      }
    }

    // QR ìŠ¤ìºë„ˆ ì¤‘ì§€
    async function stopQRScanner() {
      const container = document.getElementById('qrScannerContainer');
      const startBtn = document.getElementById('startScannerBtn');
      const stopBtn = document.getElementById('stopScannerBtn');
      
      if (html5QrCode) {
        try {
          await html5QrCode.stop();
          html5QrCode.clear();
          html5QrCode = null;
        } catch (err) {
          console.error('Error stopping QR scanner:', err);
        }
      }

      if (container) {
        container.classList.add('hidden');
        // qrReader ë‚´ìš© ì´ˆê¸°í™”
        const qrReader = document.getElementById('qrReader');
        if (qrReader) qrReader.innerHTML = '';
      }
      if (startBtn) startBtn.classList.remove('hidden');
      if (stopBtn) stopBtn.classList.add('hidden');
    }

    // QR ì½”ë“œ ìŠ¤ìº” ì²˜ë¦¬
    async function handleQRScan(qrData) {
      // ìŠ¤ìº” ì¤‘ì§€ (ì¤‘ë³µ ìŠ¤ìº” ë°©ì§€)
      await stopQRScanner();
      
      // ì²´í¬ì¸ ì²˜ë¦¬
      await processCheckin(qrData);
    }

    // ìˆ˜ë™ ì…ë ¥ ì²˜ë¦¬
    async function processManualCheckin() {
      const input = document.getElementById('manualQRInput');
      if (!input || !input.value.trim()) {
        alert('QR ì½”ë“œ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      await processCheckin(input.value.trim());
      input.value = '';
    }

    // ì²´í¬ì¸ ì²˜ë¦¬
    async function processCheckin(qrData) {
      const resultDiv = document.getElementById('checkinResult');
      if (!resultDiv) return;

      resultDiv.classList.remove('hidden');
      resultDiv.innerHTML = '<p class="text-gray-600">ì²˜ë¦¬ ì¤‘...</p>';
      resultDiv.className = 'mb-4 p-4 rounded-lg bg-gray-50';

      // QR ë°ì´í„° ê²€ì¦
      if (!qrData || !qrData.trim()) {
        resultDiv.className = 'mb-4 p-4 rounded-lg bg-red-50 border border-red-200';
        resultDiv.innerHTML = '<p class="font-semibold text-red-900">QR ì½”ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      try {
        // QR ë°ì´í„°ê°€ JSON ë¬¸ìì—´ì¸ì§€ í™•ì¸
        let qrDataToSend = qrData;
        try {
          // ì´ë¯¸ JSON ë¬¸ìì—´ì¸ì§€ í™•ì¸
          JSON.parse(qrData);
          qrDataToSend = qrData;
        } catch (e) {
          // JSONì´ ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ ì „ì†¡ (ì„œë²„ì—ì„œ ì²˜ë¦¬)
          qrDataToSend = qrData;
        }

        console.log('Sending QR data:', qrDataToSend);

        const response = await fetch('/api/admin/checkin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ qrData: qrDataToSend })
        });

        const data = await response.json();
        
        console.log('Check-in response:', data);

        if (response.ok && data.success) {
          // ì„±ê³µ
          resultDiv.className = 'mb-4 p-4 rounded-lg bg-green-50 border border-green-200';
          if (data.alreadyCheckedIn) {
            resultDiv.innerHTML = `
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <div>
                  <p class="font-semibold text-green-900">${data.message}</p>
                  <p class="text-sm text-green-700">${data.participant.user_name} (${data.participant.phone})</p>
                </div>
              </div>
            `;
          } else {
            resultDiv.innerHTML = `
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <div>
                  <p class="font-semibold text-green-900">${data.message}</p>
                  <p class="text-sm text-green-700">${data.participant.user_name} (${data.participant.phone})</p>
                </div>
              </div>
            `;
          }

          // ìµœê·¼ ì²´í¬ì¸ ëª©ë¡ì— ì¶”ê°€
          addToRecentCheckins(data.participant, data.alreadyCheckedIn);
          
          // í†µê³„ ì—…ë°ì´íŠ¸
          loadCheckinStats();

          // 3ì´ˆ í›„ ë©”ì‹œì§€ ìë™ ìˆ¨ê¹€
          setTimeout(() => {
            resultDiv.classList.add('hidden');
          }, 3000);
        } else {
          // ì‹¤íŒ¨
          resultDiv.className = 'mb-4 p-4 rounded-lg bg-red-50 border border-red-200';
          const errorMsg = data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          resultDiv.innerHTML = `
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
              </svg>
              <div>
                <p class="font-semibold text-red-900">${errorMsg}</p>
                ${data.participant ? `<p class="text-sm text-red-700">${data.participant.user_name} (${data.participant.phone})</p>` : ''}
                <p class="text-xs text-red-600 mt-1">QR ë°ì´í„°: ${qrData.substring(0, 100)}...</p>
              </div>
            </div>
          `;
        }
      } catch (err) {
        console.error('Error processing check-in:', err);
        resultDiv.className = 'mb-4 p-4 rounded-lg bg-red-50 border border-red-200';
        resultDiv.innerHTML = `
          <div>
            <p class="font-semibold text-red-900">ì²´í¬ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
            <p class="text-sm text-red-700 mt-1">${err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
            <p class="text-xs text-red-600 mt-1">QR ë°ì´í„°: ${qrData.substring(0, 100)}...</p>
          </div>
        `;
      }
    }

    // ìµœê·¼ ì²´í¬ì¸ ëª©ë¡ì— ì¶”ê°€
    function addToRecentCheckins(participant, alreadyCheckedIn) {
      const recentDiv = document.getElementById('recentCheckins');
      if (!recentDiv) return;

      const checkinItem = {
        participant: participant,
        timestamp: new Date().toLocaleString('ko-KR'),
        alreadyCheckedIn: alreadyCheckedIn
      };

      recentCheckins.unshift(checkinItem);
      if (recentCheckins.length > 10) {
        recentCheckins = recentCheckins.slice(0, 10);
      }

      // ëª©ë¡ ì—…ë°ì´íŠ¸
      if (recentCheckins.length === 0) {
        recentDiv.innerHTML = '<p class="text-sm text-gray-500 text-center">ì²´í¬ì¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      } else {
        recentDiv.innerHTML = recentCheckins.map(item => `
          <div class="p-3 bg-white rounded-lg border border-gray-200 flex items-center justify-between">
            <div>
              <p class="font-semibold text-gray-900">${item.participant.user_name}</p>
              <p class="text-sm text-gray-600">${item.participant.phone} â€¢ ${item.timestamp}</p>
            </div>
            ${item.alreadyCheckedIn ? 
              '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">ì¤‘ë³µ</span>' : 
              '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">ì™„ë£Œ</span>'
            }
          </div>
        `).join('');
      }
    }
  </script>
</body>
</html>

