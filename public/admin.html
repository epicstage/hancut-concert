<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê´€ë¦¬ì í˜ì´ì§€ - í•œë™í›ˆ í† í¬ì½˜ì„œíŠ¸</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS for Excel Export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#dc2626',
            'primary-dark': '#b91c1c',
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="/styles.css?v=3" />
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    /* í”„ë¦°íŠ¸ ì „ìš© ìŠ¤íƒ€ì¼ - ë„¤ëª¨ë‹‰ 3x3 ìš©ì§€ (ì•½ 76mm x 76mm) */
    @media print {
      @page {
        size: 76mm 76mm;
        margin: 0;
      }
      body * {
        visibility: hidden !important;
      }
      #printArea, #printArea * {
        visibility: visible !important;
      }
      #printArea {
        position: fixed !important;
        left: 0 !important;
        top: 0 !important;
        width: 76mm !important;
        height: 76mm !important;
        padding: 0 !important;
        margin: 0 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        background: white !important;
      }
      #printArea .label-content {
        text-align: center;
        width: 70mm;
      }
      #printArea .print-name {
        font-size: 36pt !important;
        font-weight: 900 !important;
        color: #000 !important;
        margin: 0 0 3mm 0 !important;
        line-height: 1.1 !important;
      }
      #printArea .print-seat {
        font-size: 26pt !important;
        font-weight: 800 !important;
        color: #000 !important;
        margin: 3mm 0 !important;
      }
      #printArea .print-divider {
        border: none !important;
        border-top: 2px solid #000 !important;
        margin: 4mm auto !important;
        width: 50mm !important;
      }
      #printArea .print-event {
        font-size: 11pt !important;
        font-weight: 600 !important;
        color: #333 !important;
        margin: 0 !important;
      }
    }

    /* í”„ë¦°íŠ¸ ì˜ì—­ì€ í™”ë©´ì—ì„œ ìˆ¨ê¹€ */
    #printArea {
      display: none;
    }
  </style>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    th {
      font-weight: 600;
      color: #374151;
    }

    tr:hover {
      background: rgba(0, 0, 0, 0.02);
    }

    .zone-select {
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
    }

    .seat-input {
      width: 80px;
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
    }
  </style>
</head>

<body>
  <div class="min-h-screen bg-gradient-to-br from-red-50 via-white to-sky-50">
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
      <div class="glass-card max-w-md w-full">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
        <form id="loginForm" class="space-y-4">
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
            <input id="password" type="password" class="input-glass" required />
          </div>
          <button type="submit" class="btn-primary-glass w-full" id="loginBtn">ë¡œê·¸ì¸</button>
        </form>
      </div>
    </div>

    <div id="adminScreen" class="hidden">
      <header class="glass-header">
        <div class="max-w-7xl mx-auto px-4 py-4">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <h1 class="text-2xl font-bold text-gray-900">ê´€ë¦¬ì í˜ì´ì§€</h1>
            <button onclick="logoutAdmin()" class="btn-icon text-gray-500 hover:text-red-600" title="ë¡œê·¸ì•„ì›ƒ"
              aria-label="ë¡œê·¸ì•„ì›ƒ" tabindex="0"
              onkeydown="if(event.key==='Enter'||event.key===' ') { event.preventDefault(); logoutAdmin(); }">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
              </svg>
            </button>
          </div>
        </div>
      </header>

      <!-- ëŒ€ì‹œë³´ë“œ ë©”íŠ¸ë¦­ ì¹´ë“œ -->
      <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="metric-card">
            <div class="flex items-center justify-between mb-2">
              <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
              </div>
            </div>
            <p id="totalCount" class="metric-value">0</p>
            <p class="metric-label">ì´ ì‹ ì²­ì</p>
            <div class="progress-bar mt-2">
              <div id="totalProgress" class="progress-fill" style="width: 0%"></div>
            </div>
            <p class="text-xs text-gray-400 mt-1">ëª©í‘œ 1,500ëª…</p>
          </div>

          <div class="metric-card">
            <div class="flex items-center justify-between mb-2">
              <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
            </div>
            <p id="paidCount" class="metric-value text-green-600">0</p>
            <p class="metric-label">ì…ê¸ˆ ì™„ë£Œ</p>
            <div class="progress-bar mt-2">
              <div id="paidProgress" class="progress-fill"
                style="width: 0%; background: linear-gradient(to right, #10b981, #34d399);"></div>
            </div>
            <p id="paidPercent" class="text-xs text-gray-400 mt-1">0%</p>
          </div>

          <div class="metric-card">
            <div class="flex items-center justify-between mb-2">
              <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" />
                </svg>
              </div>
            </div>
            <p id="seatedCount" class="metric-value text-purple-600">0</p>
            <p class="metric-label">ì¢Œì„ ë°°ì •</p>
            <div class="progress-bar mt-2">
              <div id="seatedProgress" class="progress-fill"
                style="width: 0%; background: linear-gradient(to right, #8b5cf6, #a78bfa);"></div>
            </div>
            <p id="seatedPercent" class="text-xs text-gray-400 mt-1">0%</p>
          </div>

          <div class="metric-card">
            <div class="flex items-center justify-between mb-2">
              <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center">
                <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </div>
            </div>
            <p id="checkedInCount" class="metric-value text-orange-600">0</p>
            <p class="metric-label">ì²´í¬ì¸ ì™„ë£Œ</p>
            <div class="progress-bar mt-2">
              <div id="checkedInProgress" class="progress-fill"
                style="width: 0%; background: linear-gradient(to right, #f97316, #fb923c);"></div>
            </div>
            <p id="checkedInPercent" class="text-xs text-gray-400 mt-1">0%</p>
          </div>
        </div>
      </div>

      <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="glass-card mb-6">
          <div class="flex gap-4 border-b border-gray-200">
            <button onclick="showParticipantsTab()" id="participantsTab"
              class="px-4 py-2 font-semibold text-red-600 border-b-2 border-red-600">
              ì°¸ê°€ì ê´€ë¦¬
            </button>
            <button onclick="showPaymentTab()" id="paymentTab"
              class="px-4 py-2 font-semibold text-gray-600 hover:text-red-600">
              ì…ê¸ˆí™•ì¸
            </button>
            <button onclick="showInquiriesTab()" id="inquiriesTab"
              class="px-4 py-2 font-semibold text-gray-600 hover:text-red-600 relative">
              ë¬¸ì˜ ê´€ë¦¬
              <span id="unansweredBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[1.25rem] text-center">0</span>
            </button>
            <button onclick="showCheckinTab()" id="checkinTab"
              class="px-4 py-2 font-semibold text-gray-600 hover:text-red-600">
              QR ì²´í¬ì¸
            </button>
            <button onclick="showStoriesTab()" id="storiesTab"
              class="px-4 py-2 font-semibold text-gray-600 hover:text-red-600 relative">
              ì‚¬ì—° ê´€ë¦¬
              <span id="unreadStoriesBadge" class="hidden absolute -top-1 -right-1 bg-orange-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[1.25rem] text-center">0</span>
            </button>
          </div>
        </div>

        <!-- ì°¸ê°€ì ê´€ë¦¬ íƒ­ -->
        <div id="participantsSection">
          <!-- ì¢Œì„ ë°°ì • íŒ¨ë„ -->
          <div class="glass-card mb-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">ì¢Œì„ ë°°ì •</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ê·¸ë£¹ í˜•íƒœ</label>
                <select id="groupType" class="input-glass" onchange="updateGroupDisplay()">
                  <option value="korean">ê°€ë‚˜ë‹¤ (ê°€,ë‚˜,ë‹¤...)</option>
                  <option value="alphabet">ì•ŒíŒŒë²³ (A,B,C...)</option>
                  <option value="number">ìˆ«ì (1,2,3...)</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ê·¸ë£¹ ê°œìˆ˜</label>
                <input type="number" id="groupCount" class="input-glass" placeholder="14" value="14" min="1" max="26"
                  onchange="updateGroupDisplay()" />
                <p class="text-xs text-gray-500 mt-1" id="groupDisplay">ê°€,ë‚˜,ë‹¤,ë¼,ë§ˆ,ë°”,ì‚¬,ì•„,ì,ì°¨,ì¹´,íƒ€,íŒŒ,í•˜</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ê·¸ë£¹ë‹¹ ì—´ ìˆ˜</label>
                <input type="number" id="rowsPerGroup" class="input-glass" placeholder="10" value="10" min="1" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ì—´ë‹¹ ì¢Œì„ ìˆ˜</label>
                <input type="number" id="seatsPerRow" class="input-glass" placeholder="20" value="20" min="1" />
              </div>
            </div>
            <div class="flex gap-3 flex-wrap mb-4">
              <button onclick="randomAssignSeats()" class="btn-primary-glass px-6">
                ëœë¤ ë°°ì •
              </button>
              <button onclick="ageBasedAssignSeats()" class="btn-primary-glass px-6">
                ì—°ë ¹ëŒ€ ê³ ë ¤ ë°°ì •
              </button>
              <button onclick="resetAllSeats()" class="btn-secondary-glass px-6"
                style="background: rgba(239, 68, 68, 0.1); color: #dc2626; border-color: rgba(220, 38, 38, 0.3);">
                ì „ì²´ ì´ˆê¸°í™”
              </button>
            </div>
            <p class="text-sm text-gray-500">ì…ê¸ˆ ì™„ë£Œëœ ì°¸ê°€ìë“¤ì—ê²Œ ìë™ìœ¼ë¡œ ì¢Œì„ì„ ë°°ì •í•©ë‹ˆë‹¤. ì—°ë ¹ëŒ€ ê³ ë ¤ ë°°ì •ì€ 00ë…„ëŒ€ìƒ â†’ 90ë…„ëŒ€ìƒ â†’ 80ë…„ëŒ€ìƒ ìˆœìœ¼ë¡œ ì•ì¢Œì„ì—
              ë°°ì •ë©ë‹ˆë‹¤.</p>
          </div>

          <div class="glass-card mb-6">
            <div class="flex gap-3 items-center">
              <div class="relative flex-1 min-w-0">
                <input type="text" id="searchInput" class="input-glass pl-10 w-full" placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰..." />
                <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none"
                  stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <button onclick="loadParticipants(1, true)" title="ìƒˆë¡œê³ ì¹¨"
                style="background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); color: #374151; font-weight: 600; padding: 0.75rem 1rem; border-radius: 0.75rem; font-size: 0.875rem; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease; white-space: nowrap; flex-shrink: 0; display: flex; align-items: center; gap: 0.5rem;"
                onmouseover="this.style.background='rgba(255, 255, 255, 0.8)'; this.style.transform='scale(1.02)'"
                onmouseout="this.style.background='rgba(255, 255, 255, 0.6)'; this.style.transform='scale(1)'">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span class="hidden md:inline">ìƒˆë¡œê³ ì¹¨</span>
              </button>
              <button onclick="downloadExcel()" class="btn-primary-glass px-6 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
              </button>
            </div>
          </div>

          <div class="glass-card overflow-x-auto">
            <div id="loading" class="text-center py-8 text-gray-500">ë¡œë”© ì¤‘...</div>
            <table id="participantsTable" class="hidden">
              <thead>
                <tr>
                  <th class="text-center" style="width: 60px;">
                    ì—°ë²ˆ
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('user_name')">
                    ì´ë¦„
                    <span class="sort-icon ml-1" id="sort-icon-user_name"></span>
                  </th>
                  <th>
                    ëŒ€ë¦¬ì‹ ì²­
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('phone')">
                    ì „í™”ë²ˆí˜¸
                    <span class="sort-icon ml-1" id="sort-icon-phone"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('ssn_first')">
                    ì£¼ë¯¼ë²ˆí˜¸ ì•ìë¦¬
                    <span class="sort-icon ml-1" id="sort-icon-ssn_first"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('is_paid')">
                    ì…ê¸ˆ ìƒíƒœ
                    <span class="sort-icon ml-1" id="sort-icon-is_paid"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('is_checked_in')">
                    ì…ì¥ í™•ì¸
                    <span class="sort-icon ml-1" id="sort-icon-is_checked_in"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('seat_group')">
                    ì¢Œì„ ê·¸ë£¹
                    <span class="sort-icon ml-1" id="sort-icon-seat_group"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('seat_row')">
                    ì—´
                    <span class="sort-icon ml-1" id="sort-icon-seat_row"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('seat_number')">
                    ì¢Œì„ë²ˆí˜¸
                    <span class="sort-icon ml-1" id="sort-icon-seat_number"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('seat_full')">
                    ì „ì²´ ì¢Œì„
                    <span class="sort-icon ml-1" id="sort-icon-seat_full"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('created_at')">
                    ì‹ ì²­ ì¼ì‹œ
                    <span class="sort-icon ml-1" id="sort-icon-created_at"></span>
                  </th>
                  <th>ì‘ì—…</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
            <div id="emptyMessage" class="hidden text-center py-8 text-gray-500"></div>
          </div>
          <div id="paginationContainer" class="flex justify-center items-center gap-2 mt-4"></div>
          <div class="mt-4 text-sm text-gray-600" id="countText"></div>
        </div>

        <!-- ì…ê¸ˆí™•ì¸ íƒ­ -->
        <div id="paymentSection" class="hidden">
          <div class="glass-card mb-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">ì…ê¸ˆ ë‚´ì—­ í™•ì¸</h3>
            <p class="text-sm text-gray-600 mb-4">ì—‘ì…€ì—ì„œ ë°ì´í„°ë¥¼ ë³µì‚¬(Ctrl+C)í•œ í›„ ì•„ë˜ í…Œì´ë¸”ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</p>

            <div id="paymentTableContainer" class="overflow-x-auto mb-4">
              <table id="paymentTable" class="w-full border-collapse border border-gray-300 bg-white">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ì—°ë²ˆ</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ê±°ë˜ì¼ì‹œ</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">êµ¬ë¶„</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ê±°ë˜ê¸ˆì•¡</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ê±°ë˜ í›„ ì”ì•¡</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ê±°ë˜êµ¬ë¶„</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ë‚´ìš©</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ë©”ëª¨</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ë§¤ì¹­ëœ ì‹ ì²­ì</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ë¹„ê³ </th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ìƒíƒœ</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">ì‘ì—…</th>
                  </tr>
                </thead>
                <tbody id="paymentTableBody">
                  <!-- ë¹ˆ í–‰ í•˜ë‚˜ ì¶”ê°€ -->
                  <tr>
                    <td class="border border-gray-300 px-2 py-1 text-sm text-center text-gray-500">1</td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text"
                        class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" />
                    </td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text"
                        class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" />
                    </td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text"
                        class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" />
                    </td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text"
                        class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" />
                    </td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text"
                        class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" />
                    </td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text"
                        class="w-full border-0 bg-transparent text-sm"
                        onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text"
                        class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" />
                    </td>
                    <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
                    <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
                    <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
                    <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">ëŒ€ê¸°ì¤‘</td>
                    <td class="border border-gray-300 px-2 py-2">
                      <div class="flex gap-2">
                        <button onclick="approvePaymentFromTable(0)"
                          style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;"
                          onmouseover="this.style.backgroundColor='#16a34a'"
                          onmouseout="this.style.backgroundColor='#22c55e'">ìŠ¹ì¸</button>
                        <button onclick="removePaymentRowFromTable(this)"
                          style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;"
                          onmouseover="this.style.backgroundColor='#dc2626'"
                          onmouseout="this.style.backgroundColor='#ef4444'">ì‚­ì œ</button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="flex gap-3 flex-wrap">
              <button onclick="addPaymentRow()"
                style="background-color: #475569; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; box-shadow: 0 10px 15px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; border: none;"
                onmouseover="this.style.backgroundColor='#334155'" onmouseout="this.style.backgroundColor='#475569'">
                + í–‰ ì¶”ê°€
              </button>
              <button onclick="savePaymentData()"
                style="background-color: #3b82f6; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; box-shadow: 0 10px 15px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; border: none;"
                onmouseover="this.style.backgroundColor='#2563eb'" onmouseout="this.style.backgroundColor='#3b82f6'">
                ğŸ’¾ ì €ì¥í•˜ê¸°
              </button>
              <button onclick="resetPaymentTable()"
                style="background-color: #f97316; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; box-shadow: 0 10px 15px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; border: none;"
                onmouseover="this.style.backgroundColor='#ea580c'" onmouseout="this.style.backgroundColor='#f97316'">
                ğŸ—‘ï¸ ì´ˆê¸°í™”
              </button>
            </div>
          </div>
        </div>

        <!-- QR ì²´í¬ì¸ íƒ­ -->
        <div id="checkinSection" class="hidden">
          <div class="glass-card mb-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-gray-900">QR ì½”ë“œ ì²´í¬ì¸</h3>
              <div class="flex gap-2">
                <button onclick="resetAllCheckins()" class="btn-secondary-glass px-4 flex items-center gap-2 text-red-600 hover:bg-red-50">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                  </svg>
                  ì „ì²´ ì´ˆê¸°í™”
                </button>
                <button onclick="openCheckinPopup()" class="btn-primary-glass px-6 flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                  </svg>
                  ì²´í¬ì¸ íŒì—… ì—´ê¸°
                </button>
              </div>
            </div>

            <!-- í†µê³„ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <div class="text-sm text-blue-600 mb-1">ì…ê¸ˆ ì™„ë£Œ ì¸ì›</div>
                <div class="text-2xl font-bold text-blue-900" id="checkinTotal">0</div>
              </div>
              <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <div class="text-sm text-green-600 mb-1">ì…ì¥ í™•ì¸</div>
                <div class="text-2xl font-bold text-green-900" id="checkinCount">0</div>
              </div>
              <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                <div class="text-sm text-orange-600 mb-1">ë‚¨ì€ ì¸ì›</div>
                <div class="text-2xl font-bold text-orange-900" id="checkinRemaining">0</div>
              </div>
            </div>

            <!-- QR ì½”ë“œ ìŠ¤ìºë„ˆ -->
            <div class="mb-6">
              <div class="flex gap-4 mb-4">
                <button onclick="startQRScanner()" id="startScannerBtn" class="btn-primary-glass px-6">
                  ì¹´ë©”ë¼ ìŠ¤ìº” ì‹œì‘
                </button>
                <button onclick="stopQRScanner()" id="stopScannerBtn" class="btn-secondary-glass px-6 hidden">
                  ìŠ¤ìº” ì¤‘ì§€
                </button>
                <button onclick="loadCheckinStats()" class="btn-secondary-glass px-6">
                  í†µê³„ ìƒˆë¡œê³ ì¹¨
                </button>
              </div>

              <div id="qrScannerContainer" class="hidden mb-4">
                <div id="qrReader" class="max-w-md mx-auto bg-white p-4 rounded-lg border border-gray-300"
                  style="min-height: 300px; position: relative;"></div>
                <p class="text-sm text-gray-600 text-center mt-2">QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶°ì£¼ì„¸ìš”</p>
              </div>

              <!-- ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì…ë ¥ -->
              <div class="mb-4 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
                <label class="block text-sm font-medium text-green-700 mb-2">
                  <span class="inline-flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h2m10 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                    </svg>
                    ë°”ì½”ë“œ ìŠ¤ìºë„ˆ (ìë™ ì²´í¬ì¸)
                  </span>
                </label>
                <input type="text" id="barcodeScannerInput"
                  class="input-glass w-full text-lg font-mono"
                  placeholder="ë°”ì½”ë“œ ìŠ¤ìºë„ˆë¡œ ìŠ¤ìº”í•˜ì„¸ìš” (ì´ í•„ë“œì— í¬ì»¤ìŠ¤ ìœ ì§€)"
                  autocomplete="off"
                  autofocus />
                <div class="flex items-center gap-4 mt-2 flex-wrap">
                  <label class="flex items-center gap-2 text-sm text-green-700 cursor-pointer">
                    <input type="checkbox" id="autoFocusScanner" checked class="w-4 h-4" />
                    ìë™ í¬ì»¤ìŠ¤ ìœ ì§€
                  </label>
                  <label class="flex items-center gap-2 text-sm text-blue-700 cursor-pointer">
                    <input type="checkbox" id="autoPrintCheckin" class="w-4 h-4" checked />
                    ì²´í¬ì¸ ì‹œ ìë™ í”„ë¦°íŠ¸
                  </label>
                  <span id="scannerStatus" class="text-sm text-green-600 font-medium">ëŒ€ê¸° ì¤‘...</span>
                </div>
              </div>

              <!-- ìˆ˜ë™ ì…ë ¥ -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">QR ì½”ë“œ ë°ì´í„° ì§ì ‘ ì…ë ¥</label>
                <div class="flex gap-2">
                  <input type="text" id="manualQRInput" class="input-glass flex-1" placeholder="QR ì½”ë“œ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ ì…ë ¥í•˜ì„¸ìš”"
                    onkeypress="if(event.key==='Enter') processManualCheckin()" />
                  <button onclick="processManualCheckin()" class="btn-primary-glass px-6">
                    í™•ì¸
                  </button>
                </div>
              </div>

              <!-- ê²°ê³¼ ë©”ì‹œì§€ -->
              <div id="checkinResult" class="hidden mb-4 p-4 rounded-lg"></div>

              <!-- ìµœê·¼ ì²´í¬ì¸ ë‚´ì—­ -->
              <div class="mt-6">
                <h4 class="text-md font-bold text-gray-900 mb-3">ìµœê·¼ ì²´í¬ì¸ ë‚´ì—­</h4>
                <div id="recentCheckins" class="space-y-2 max-h-64 overflow-y-auto">
                  <p class="text-sm text-gray-500 text-center">ì²´í¬ì¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ë¬¸ì˜ ê´€ë¦¬ íƒ­ -->
        <div id="inquiriesSection" class="hidden">
          <div class="glass-card mb-6">
            <div class="flex justify-between items-center mb-4">
              <div class="relative flex-1 min-w-0">
                <input type="text" id="inquirySearchInput" class="input-glass pl-10 w-full"
                  placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰..." />
                <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none"
                  stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <div class="flex gap-2 ml-3">
                <select id="inquiryFilter" onchange="filterInquiries(this.value)" class="input-glass">
                  <option value="all">ì „ì²´ ë¬¸ì˜</option>
                  <option value="unanswered">ë¯¸ì‘ë‹µ ë¬¸ì˜</option>
                  <option value="answered">ë‹µë³€ ì™„ë£Œ</option>
                </select>
                <button onclick="loadInquiries()" class="btn-secondary-glass px-6 flex items-center gap-2" title="ìƒˆë¡œê³ ì¹¨">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  <span class="hidden md:inline">ìƒˆë¡œê³ ì¹¨</span>
                </button>
              </div>
            </div>
          </div>

          <div class="glass-card overflow-x-auto">
            <div id="inquiryLoading" class="text-center py-8 text-gray-500">ë¡œë”© ì¤‘...</div>
            <div id="inquiriesList" class="hidden space-y-4"></div>
            <div id="inquiryEmptyMessage" class="hidden text-center py-8 text-gray-500"></div>
          </div>

          <div class="mt-4 text-sm text-gray-600" id="inquiryCountText"></div>
        </div>

        <!-- ì‚¬ì—° ê´€ë¦¬ íƒ­ -->
        <div id="storiesSection" class="hidden">
          <div class="glass-card mb-6">
            <div class="flex justify-between items-center mb-4">
              <div class="relative flex-1 min-w-0">
                <input type="text" id="storySearchInput" class="input-glass pl-10 w-full"
                  placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰..." oninput="filterStories()" />
                <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none"
                  stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <div class="flex gap-2 ml-3">
                <select id="storyFilter" onchange="filterStories()" class="input-glass">
                  <option value="all">ì „ì²´ ì‚¬ì—°</option>
                  <option value="unread">ì•ˆ ì½ì€ ì‚¬ì—°</option>
                  <option value="read">ì½ì€ ì‚¬ì—°</option>
                </select>
                <button onclick="exportStoriesToExcel()" class="btn-secondary-glass px-4 flex items-center gap-2" title="ì—‘ì…€ ë‹¤ìš´ë¡œë“œ">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <span class="hidden md:inline">ì—‘ì…€</span>
                </button>
                <button onclick="loadStories()" class="btn-secondary-glass px-6 flex items-center gap-2" title="ìƒˆë¡œê³ ì¹¨">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  <span class="hidden md:inline">ìƒˆë¡œê³ ì¹¨</span>
                </button>
              </div>
            </div>
          </div>

          <div class="glass-card overflow-x-auto">
            <div id="storyLoading" class="text-center py-8 text-gray-500">ë¡œë”© ì¤‘...</div>
            <div id="storiesList" class="hidden space-y-4"></div>
            <div id="storyEmptyMessage" class="hidden text-center py-8 text-gray-500"></div>
          </div>

          <div class="mt-4 text-sm text-gray-600" id="storyCountText"></div>
        </div>
      </main>

      <!-- í‘¸í„° (ë‚˜ì¤‘ì— ë°°í¬ì‚¬/ìš´ì˜ì‚¬ ì •ë³´ ì¶”ê°€ ì˜ˆì •) -->
      <footer class="mt-16 py-8 border-t border-white/20">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-600">
          <!-- ë°°í¬ì‚¬/ìš´ì˜ì‚¬ ì •ë³´ëŠ” ì¶”í›„ ì¶”ê°€ ì˜ˆì • -->
        </div>
      </footer>
    </div>
  </div>

  <script>
    let participants = [];
    let isAuthenticated = false;
    let adminToken = null; // JWT í† í° ì €ì¥
    let currentSort = 'created_at';
    let currentOrder = 'desc';
    let currentPage = 1;
    let itemsPerPage = 50;
    let totalItems = 0;
    let inquiryFilterState = 'all';
    let filteredParticipants = [];
    let participantsCache = null;
    let participantsCacheTime = null;
    const CACHE_DURATION = 30000; // 30ì´ˆ ìºì‹œ
    let savePaymentDataTimeout = null; // localStorage ì €ì¥ debounceìš©
    let searchDebounceTimeout = null; // ê²€ìƒ‰ debounceìš©
    const SEARCH_DEBOUNCE_MS = 300; // ê²€ìƒ‰ debounce ì‹œê°„ (300ms)

    // ì¸ì¦ëœ API í˜¸ì¶œì„ ìœ„í•œ í—¬í¼ í•¨ìˆ˜
    function authFetch(url, options = {}) {
      if (!adminToken) {
        return Promise.reject(new Error('ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.'));
      }
      const headers = {
        'Content-Type': 'application/json',
        'x-admin-token': adminToken,
        ...(options.headers || {})
      };
      return fetch(url, { ...options, headers });
    }

    // Debounce ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showError(message) {
      alert('ì˜¤ë¥˜: ' + message);
      console.error(message);
    }

    function showSuccess(message) {
      alert(message);
    }

    // ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜
    async function performLogin() {
      console.log('performLogin called');

      const loginBtn = document.getElementById('loginBtn');

      try {
        const passwordInput = document.getElementById('password');
        if (!passwordInput) {
          alert('ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          console.error('Password input element not found');
          return false;
        }

        const password = passwordInput.value.trim();

        if (!password) {
          alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          passwordInput.focus();
          return false;
        }

        // ë¡œê·¸ì¸ ë²„íŠ¼ ë¹„í™œì„±í™”
        if (loginBtn) {
          loginBtn.disabled = true;
          loginBtn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
        }

        // ì„œë²„ APIë¡œ ë¡œê·¸ì¸
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        if (data.success && data.token) {
          console.log('Login successful, token received');
          adminToken = data.token;
          isAuthenticated = true;

          // í† í°ì„ sessionStorageì— ì €ì¥ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œì—ë„ ìœ ì§€)
          sessionStorage.setItem('adminToken', adminToken);

          const loginScreen = document.getElementById('loginScreen');
          const adminScreen = document.getElementById('adminScreen');

          if (loginScreen) loginScreen.classList.add('hidden');
          if (adminScreen) adminScreen.classList.remove('hidden');

          loadParticipants();
          return true;
        } else {
          throw new Error('í† í°ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('Login error:', error);
        alert(error.message || 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        const passwordInput = document.getElementById('password');
        if (passwordInput) {
          passwordInput.value = '';
          passwordInput.focus();
        }
        return false;
      } finally {
        if (loginBtn) {
          loginBtn.disabled = false;
          loginBtn.textContent = 'ë¡œê·¸ì¸';
        }
      }
    }

    // DOMì´ ë¡œë“œëœ í›„ ì‹¤í–‰
    function initAdmin() {
      const loginScreen = document.getElementById('loginScreen');
      const adminScreen = document.getElementById('adminScreen');
      const loginForm = document.getElementById('loginForm');
      const searchInput = document.getElementById('searchInput');

      console.log('Initializing admin page...');

      // sessionStorageì—ì„œ í† í° ë³µì› ì‹œë„
      const savedToken = sessionStorage.getItem('adminToken');
      if (savedToken) {
        adminToken = savedToken;
        isAuthenticated = true;
        console.log('Restored token from sessionStorage');

        // í† í°ì´ ìœ íš¨í•œì§€ í™•ì¸ (API í˜¸ì¶œ)
        authFetch('/api/admin/participants')
          .then(response => {
            if (response.ok) {
              // í† í° ìœ íš¨ - ê´€ë¦¬ì í™”ë©´ í‘œì‹œ
              if (loginScreen) loginScreen.classList.add('hidden');
              if (adminScreen) adminScreen.classList.remove('hidden');
              loadParticipants();
            } else {
              // í† í° ë§Œë£Œ - ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
              sessionStorage.removeItem('adminToken');
              adminToken = null;
              isAuthenticated = false;
            }
          })
          .catch(() => {
            // ì—ëŸ¬ - ë¡œê·¸ì¸ í™”ë©´ ìœ ì§€
            sessionStorage.removeItem('adminToken');
            adminToken = null;
            isAuthenticated = false;
          });
      }

      if (!loginForm) {
        console.error('Login form not found');
        return;
      }

      // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      loginForm.addEventListener('submit', function (e) {
        e.preventDefault();
        e.stopPropagation();
        performLogin();
        return false;
      });

      // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ë°±ì—…)
      const loginBtn = document.getElementById('loginBtn');
      if (loginBtn) {
        loginBtn.addEventListener('click', function (e) {
          e.preventDefault();
          performLogin();
          return false;
        });
      }

      if (searchInput) {
        // Debounce ì ìš©ëœ ê²€ìƒ‰ (300ms)
        const debouncedFilter = debounce(() => {
          loadParticipants(1); // ê²€ìƒ‰ ì‹œ ì²« í˜ì´ì§€ë¡œ ì´ë™
        }, SEARCH_DEBOUNCE_MS);

        searchInput.addEventListener('input', debouncedFilter);
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAdmin);
    } else {
      // DOMì´ ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì¦‰ì‹œ ì‹¤í–‰
      initAdmin();
    }

    async function loadParticipants(page = 1, forceRefresh = false) {
      // ìºì‹œ í™•ì¸ (ì „ì²´ ì°¸ê°€ì ëª©ë¡ì—ë§Œ ì ìš©, ê²€ìƒ‰/ì •ë ¬/í˜ì´ì§€ë„¤ì´ì…˜ì—ëŠ” ì ìš© ì•ˆí•¨)
      const now = Date.now();
      if (!forceRefresh && !document.getElementById('searchInput').value && currentSort === 'created_at' && currentOrder === 'desc' && page === 1 && participantsCache && participantsCacheTime && (now - participantsCacheTime) < CACHE_DURATION) {
        participants = participantsCache;
        filteredParticipants = participants; // This line might be redundant if pagination is handled by backend
        updateStatistics();
        displayParticipants(participants); // Display cached data
        return;
      }

      const loading = document.getElementById('loading');
      if (loading) loading.classList.remove('hidden');

      try {
        const search = document.getElementById('searchInput').value;
        // forceRefresh ì‹œ ìºì‹œ ë²„ìŠ¤íŒ…
        const cacheBuster = forceRefresh ? `&_t=${Date.now()}` : '';
        let url = `/api/admin/participants?page=${page}&limit=${itemsPerPage}&sort=${currentSort}&order=${currentOrder}${cacheBuster}`;
        if (search) {
          url += `&search=${encodeURIComponent(search)}`;
        }

        const response = await authFetch(url);

        if (!response.ok) {
          if (response.status === 401) {
            // ì¸ì¦ ë§Œë£Œ - ë‹¤ì‹œ ë¡œê·¸ì¸ í•„ìš”
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            sessionStorage.removeItem('adminToken');
            adminToken = null;
            isAuthenticated = false;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminScreen').classList.add('hidden');
            return;
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
          participants = data.participants || [];
          filteredParticipants = participants; // For consistency, though backend handles filtering
          currentPage = data.pagination.page;
          totalItems = data.pagination.total;

          // Cache only if it's the initial load without search/sort/pagination
          if (!search && currentSort === 'created_at' && currentOrder === 'desc' && page === 1) {
            participantsCache = participants;
            participantsCacheTime = now;
          }

          updateStatistics();
          displayParticipants(participants);
          renderPagination(data.pagination);
          updateSortIcons();
        } else {
          console.error('API error:', data.error);
          const errorMsg = data.details ? `${data.error} (${data.details})` : (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
          showError('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + errorMsg);
        }
      } catch (err) {
        console.error('Error loading participants:', err);
        showError('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + err.message);
      } finally {
        if (loading) loading.classList.add('hidden');
      }
    }

    function sortParticipants(column) {
      if (currentSort === column) {
        currentOrder = currentOrder === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort = column;
        currentOrder = 'desc';
      }
      loadParticipants(1); // ì •ë ¬ ì‹œ ì²« í˜ì´ì§€ë¡œ ì´ë™
    }

    function updateSortIcons() {
      document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.innerHTML = '';
        icon.style.color = '';
      });
      const icon = document.getElementById(`sort-icon-${currentSort}`);
      if (icon) {
        icon.innerHTML = currentOrder === 'asc' ? ' â–²' : ' â–¼';
        icon.style.color = '#dc2626';
      }
    }

    function renderPagination(pagination) {
      let container = document.getElementById('paginationContainer');
      if (!container) {
        // If container doesn't exist, create it below the participants table
        const participantsSection = document.getElementById('participantsSection');
        if (participantsSection) {
          container = document.createElement('div');
          container.id = 'paginationContainer';
          container.className = 'flex justify-center items-center gap-2 mt-4';
          participantsSection.appendChild(container);
        } else {
          console.error('Participants section not found, cannot render pagination.');
          return;
        }
      }

      container.innerHTML = '';

      // ì´ì „ ë²„íŠ¼
      const prevBtn = document.createElement('button');
      prevBtn.className = `px-3 py-1 rounded ${pagination.hasPrev ? 'bg-gray-200 hover:bg-gray-300' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`;
      prevBtn.innerText = 'ì´ì „';
      prevBtn.disabled = !pagination.hasPrev;
      prevBtn.onclick = () => loadParticipants(pagination.page - 1);
      container.appendChild(prevBtn);

      // ë‹¤ìŒ ë²„íŠ¼
      const nextBtn = document.createElement('button');
      nextBtn.className = `px-3 py-1 rounded ${pagination.hasNext ? 'bg-gray-200 hover:bg-gray-300' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`;
      nextBtn.innerText = 'ë‹¤ìŒ';
      nextBtn.disabled = !pagination.hasNext;
      nextBtn.onclick = () => loadParticipants(pagination.page + 1);
      container.appendChild(nextBtn);
    }

    function downloadExcel() {
      if (!participants || participants.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ì—‘ì…€ìš© ë°ì´í„° ë³€í™˜
      const data = participants.map(p => ({
        'ID': p.id,
        'ì‹ ì²­ì¼ì‹œ': formatDateTime(p.created_at),
        'ì´ë¦„': p.user_name,
        'ì „í™”ë²ˆí˜¸': formatPhone(p.phone),
        'ìƒë…„ì›”ì¼(ì•ìë¦¬)': p.ssn_first || '-',
        'í‹°ì¼“ìˆ˜': p.ticket_count,
        'ë™ë°˜ì ì´ë¦„': p.guest2_name || '-',
        'ë™ë°˜ì ì „í™”ë²ˆí˜¸': p.guest2_phone ? formatPhone(p.guest2_phone) : '-',
        'ë™ë°˜ì ìƒë…„ì›”ì¼': p.guest2_ssn_first || '-',
        'ì¢Œì„(ë³¸ì¸)': p.seat_full || '-',
        'ì¢Œì„(ë™ë°˜ì)': p.seat_full_2 || '-',
        'ì…ê¸ˆìƒíƒœ': p.is_paid ? 'ì…ê¸ˆì™„ë£Œ' : 'ëŒ€ê¸°',
        'ì²´í¬ì¸': p.is_checked_in ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ'
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ì°¸ê°€ìëª©ë¡");

      const date = new Date().toISOString().split('T')[0];
      XLSX.writeFile(wb, `í•œì»·ì½˜ì„œíŠ¸_ì°¸ê°€ìëª©ë¡_${date}.xlsx`);
    }

    function updateStatistics() {
      const totalCountEl = document.getElementById('totalCount');
      const paidCountEl = document.getElementById('paidCount');
      const seatedCountEl = document.getElementById('seatedCount');
      const checkedInCountEl = document.getElementById('checkedInCount');

      if (!totalCountEl || !paidCountEl) return;

      // ì „ì²´ ì‹ ì²­ ì¸ì›ìˆ˜ (1ì¸ ì‹ ì²­ì€ 1ëª…, 2ì¸ ì‹ ì²­ì€ 2ëª…ìœ¼ë¡œ ê³„ì‚°)
      let totalCount = 0;
      let paidCount = 0;
      let seatedCount = 0;
      let checkedInCount = 0;

      participants.forEach(function (p) {
        const ticketCount = p.ticket_count || 1;
        totalCount += ticketCount;

        // ì…ê¸ˆ ì™„ë£Œëœ ê²½ìš°
        if (p.is_paid) {
          paidCount += ticketCount;
        }

        // ì¢Œì„ ë°°ì •ëœ ê²½ìš°
        if (p.seat_full) {
          seatedCount += ticketCount;
        }

        // ì²´í¬ì¸ ì™„ë£Œëœ ê²½ìš°
        if (p.is_checked_in) {
          checkedInCount += ticketCount;
        }
      });

      const maxParticipants = 1500;

      // ì´ ì‹ ì²­ì
      totalCountEl.textContent = totalCount.toLocaleString();
      const totalProgress = document.getElementById('totalProgress');
      if (totalProgress) {
        totalProgress.style.width = Math.min((totalCount / maxParticipants) * 100, 100) + '%';
      }

      // ì…ê¸ˆ ì™„ë£Œ
      paidCountEl.textContent = paidCount.toLocaleString();
      const paidProgress = document.getElementById('paidProgress');
      const paidPercent = document.getElementById('paidPercent');
      if (paidProgress && totalCount > 0) {
        const paidPct = (paidCount / totalCount) * 100;
        paidProgress.style.width = paidPct + '%';
        if (paidPercent) paidPercent.textContent = paidPct.toFixed(1) + '%';
      }

      // ì¢Œì„ ë°°ì •
      if (seatedCountEl) {
        seatedCountEl.textContent = seatedCount.toLocaleString();
        const seatedProgress = document.getElementById('seatedProgress');
        const seatedPercent = document.getElementById('seatedPercent');
        if (seatedProgress && paidCount > 0) {
          const seatedPct = (seatedCount / paidCount) * 100;
          seatedProgress.style.width = seatedPct + '%';
          if (seatedPercent) seatedPercent.textContent = seatedPct.toFixed(1) + '%';
        }
      }

      // ì²´í¬ì¸ ì™„ë£Œ
      if (checkedInCountEl) {
        checkedInCountEl.textContent = checkedInCount.toLocaleString();
        const checkedInProgress = document.getElementById('checkedInProgress');
        const checkedInPercent = document.getElementById('checkedInPercent');
        if (checkedInProgress && paidCount > 0) {
          const checkedInPct = (checkedInCount / paidCount) * 100;
          checkedInProgress.style.width = checkedInPct + '%';
          if (checkedInPercent) checkedInPercent.textContent = checkedInPct.toFixed(1) + '%';
        }
      }
    }

    function displayParticipants(list) {
      const tableBody = document.getElementById('tableBody');
      const table = document.getElementById('participantsTable');
      const loading = document.getElementById('loading');
      const emptyMessage = document.getElementById('emptyMessage');
      const countText = document.getElementById('countText');

      loading.classList.add('hidden');

      if (list.length === 0) {
        table.classList.add('hidden');
        emptyMessage.classList.remove('hidden');
        emptyMessage.textContent = document.getElementById('searchInput').value ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.';
        countText.textContent = '';
        return;
      }

      table.classList.remove('hidden');
      emptyMessage.classList.add('hidden');

      // ì‹¤ì œ ì°¸ê°€ì ìˆ˜ ê³„ì‚° (ticket_count í•©ì‚°)
      let totalCount = 0;
      list.forEach(function (p) {
        const ticketCount = p.ticket_count || 1;
        totalCount += ticketCount;
      });
      countText.textContent = `ì´ ${totalItems}ëª… (í˜„ì¬ í˜ì´ì§€ ${list.length}ëª…)`;

      // ì°¸ê°€ì ëª©ë¡ì„ í‰íƒ„í™”í•˜ì—¬ 2ë²ˆì§¸ ì°¸ê°€ìë„ ë³„ë„ í–‰ìœ¼ë¡œ í‘œì‹œ
      const flattenedList = [];
      list.forEach(p => {
        // 1ë²ˆì§¸ ì°¸ê°€ì í–‰
        flattenedList.push({
          ...p,
          is_guest: false,
          display_name: p.user_name,
          display_phone: p.phone,
          display_ssn: p.ssn_first,
          original_id: p.id,
          representative_name: '', // 1ì¸ ì‹ ì²­ìëŠ” ëŒ€ë¦¬ì‹ ì²­ ì—†ìŒ
          display_seat: p.seat_full || '-', // ì²« ë²ˆì§¸ ì¢Œì„
          display_checked_in: p.is_checked_in || false // ì…ì¥ í™•ì¸ ìƒíƒœ
        });

        // 2ë²ˆì§¸ ì°¸ê°€ìê°€ ìˆëŠ” ê²½ìš° (2ì¸ ì‹ ì²­)
        // ticket_countê°€ 2ì´ê±°ë‚˜, guest2_nameì´ ìˆìœ¼ë©´ 2ì¸ ì‹ ì²­
        const isTwoPerson = (p.ticket_count === 2) || p.guest2_name;

        if (isTwoPerson) {
          // 2ë²ˆì§¸ ì°¸ê°€ì í–‰ ì¶”ê°€
          // ì´ë¦„: guest2_nameì´ ìˆìœ¼ë©´ ì‹¤ì œ ì´ë¦„, ì—†ìœ¼ë©´ "ì²«ë²ˆì§¸ì‹ ì²­ì_2" í˜•ì‹
          // ëŒ€ë¦¬ì‹ ì²­: ì²« ë²ˆì§¸ ì‹ ì²­ìì˜ ì´ë¦„
          // ì¢Œì„: ë‘ ë²ˆì§¸ ì¢Œì„ (seat_full_2)
          flattenedList.push({
            ...p,
            is_guest: true,
            display_name: p.guest2_name || `${p.user_name}_2`,
            display_phone: p.guest2_phone || p.phone,
            display_ssn: p.guest2_ssn_first || p.ssn_first || '-',
            original_id: p.id,
            is_guest2_pending: !p.guest2_name, // ì•„ì§ ì…ë ¥ ì•ˆë¨
            representative_name: p.user_name, // ëŒ€ë¦¬ì‹ ì²­ì ì´ë¦„ (ì²« ë²ˆì§¸ ì‹ ì²­ì)
            display_seat: p.seat_full_2 || '-', // ë‘ ë²ˆì§¸ ì¢Œì„
            display_checked_in: p.is_checked_in_2 || false // ë‘ ë²ˆì§¸ ì°¸ê°€ì ì…ì¥ í™•ì¸ ìƒíƒœ
          });
        }
      });

      tableBody.innerHTML = flattenedList.map((p, index) => {
        const rowClass = p.is_guest2_pending ? 'opacity-60' : '';

        return `
        <tr class="${rowClass}">
          <td class="text-center text-gray-500">${(currentPage - 1) * itemsPerPage + index + 1}</td>
          <td>${p.display_name}${p.is_guest2_pending ? ' <span class="text-xs text-gray-400">(ì…ë ¥ ëŒ€ê¸°)</span>' : ''}</td>
          <td>${p.representative_name || '-'}</td>
          <td>${formatPhone(p.display_phone)}</td>
          <td>${p.display_ssn || '-'}</td>
          <td>
            <label class="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                ${p.is_paid ? 'checked' : ''}
                onchange="togglePayment(${p.original_id}, ${p.is_paid})"
                style="width: 1.25rem; height: 1.25rem;"
              />
              <span class="${p.is_paid ? 'text-red-600 font-medium' : 'text-gray-500'}">
                ${p.is_paid ? 'ì…ê¸ˆ ì™„ë£Œ' : 'ì…ê¸ˆ ëŒ€ê¸°'}
              </span>
            </label>
          </td>
          <td>
            <div class="flex items-center gap-1">
              <span class="${p.display_checked_in ? 'text-green-600 font-medium' : 'text-gray-400'}">
                ${p.display_checked_in ? 'âœ“ ì…ì¥ì™„ë£Œ' : '-'}
              </span>
              ${p.display_checked_in ? `
                <button onclick="resetCheckin(${p.original_id})" class="text-xs text-red-500 hover:text-red-700 ml-1" title="ì²´í¬ì¸ ì´ˆê¸°í™”">
                  âœ•
                </button>
              ` : ''}
            </div>
          </td>
          <td>
            <select class="zone-select seat-group-select" id="group-${p.original_id}${p.is_guest ? '-2' : ''}" onchange="updateSeat(${p.original_id}, ${p.is_guest ? 'true' : 'false'})" data-current-value="${p.seat_group || ''}">
              <option value="">ì„ íƒ</option>
              ${getCurrentGroupOptions(p.seat_group)}
            </select>
          </td>
          <td>
            <input
              type="text"
              class="seat-input"
              id="row-${p.original_id}${p.is_guest ? '-2' : ''}"
              value="${p.seat_row || ''}"
              placeholder="ì—´"
              onchange="updateSeat(${p.original_id}, ${p.is_guest ? 'true' : 'false'})"
            />
          </td>
          <td>
            <input
              type="text"
              class="seat-input"
              id="seat-${p.original_id}${p.is_guest ? '-2' : ''}"
              value="${p.seat_number || ''}"
              placeholder="ë²ˆí˜¸"
              onchange="updateSeat(${p.original_id}, ${p.is_guest ? 'true' : 'false'})"
            />
          </td>
          <td class="font-semibold text-red-600">${p.display_seat || p.seat_full || '-'}</td>
          <td class="text-sm text-gray-600">${formatDateTime(p.created_at)}</td>
          <td>
            <div class="flex gap-2">
              ${p.seat_full && !p.is_guest ? `
                <button 
                  onclick="resetParticipantSeat(${p.original_id}, '${p.display_name}')" 
                  class="p-2 text-orange-600 hover:text-orange-700 hover:bg-orange-50 rounded transition-colors"
                  title="ì¢Œì„ ì´ˆê¸°í™”"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                </button>
              ` : ''}
              <button 
                onclick="deleteParticipant(${p.original_id}, '${p.display_name}')" 
                class="p-2 text-red-600 hover:text-red-700 hover:bg-red-50 rounded transition-colors"
                title="ì‚­ì œ"
                ${p.is_guest ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `;
      }).join('');
    }

    async function togglePayment(id, currentStatus) {
      try {
        const newStatus = currentStatus ? false : true; // 0->true, 1->false
        const response = await authFetch(`/api/admin/participants/${id}/payment`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_paid: newStatus }),
        });

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || 'ì…ê¸ˆ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
        }
        if (data.success) {
          // ìºì‹œ ë¬´íš¨í™” í›„ ìƒˆë¡œê³ ì¹¨
          participantsCache = null;
          participantsCacheTime = null;
          loadParticipants(currentPage, true); // ê°•ì œ ìƒˆë¡œê³ ì¹¨
        }
      } catch (err) {
        console.error('togglePayment error:', err);
        alert('ì…ê¸ˆ ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (err.message || ''));
      }
    }

    async function updateSeat(id, isGuest) {
      const idSuffix = isGuest ? '-2' : '';
      const group = document.getElementById(`group-${id}${idSuffix}`)?.value || '';
      const row = document.getElementById(`row-${id}${idSuffix}`)?.value || '';
      const number = document.getElementById(`seat-${id}${idSuffix}`)?.value || '';

      try {
        const response = await authFetch(`/api/admin/participants/${id}/seat`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            seat_group: group,
            seat_row: row,
            seat_number: number,
            is_guest: isGuest || false
          }),
        });

        const data = await response.json();
        if (data.success) {
          loadParticipants(currentPage); // í˜„ì¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
          alert(data.error || 'ì¢Œì„ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Error updating seat:', err);
        alert('ì¢Œì„ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ê·¸ë£¹ ì´ë¦„ ìƒì„± í•¨ìˆ˜
    function getGroupNames(type, count) {
      const koreanNames = ['ê°€', 'ë‚˜', 'ë‹¤', 'ë¼', 'ë§ˆ', 'ë°”', 'ì‚¬', 'ì•„', 'ì', 'ì°¨', 'ì¹´', 'íƒ€', 'íŒŒ', 'í•˜'];
      const alphabetNames = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
      const numberNames = Array.from({ length: 26 }, (_, i) => String(i + 1));

      let baseNames;
      switch (type) {
        case 'alphabet':
          baseNames = alphabetNames;
          break;
        case 'number':
          baseNames = numberNames;
          break;
        case 'korean':
        default:
          baseNames = koreanNames;
          break;
      }

      return baseNames.slice(0, Math.min(count, baseNames.length));
    }

    // í˜„ì¬ ê·¸ë£¹ ì˜µì…˜ HTML ìƒì„±
    function getCurrentGroupOptions(selectedValue) {
      const groupType = document.getElementById('groupType')?.value || 'korean';
      const groupCount = parseInt(document.getElementById('groupCount')?.value) || 14;
      const groups = getGroupNames(groupType, groupCount);

      return groups.map(g =>
        `<option value="${g}" ${selectedValue === g ? 'selected' : ''}>${g}</option>`
      ).join('');
    }

    // ëª¨ë“  ì¢Œì„ ê·¸ë£¹ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    function updateSeatGroupDropdowns() {
      const selects = document.querySelectorAll('.seat-group-select');
      selects.forEach(select => {
        const currentValue = select.dataset.currentValue || select.value;
        const optionsHtml = '<option value="">ì„ íƒ</option>' + getCurrentGroupOptions(currentValue);
        select.innerHTML = optionsHtml;
      });
    }

    function updateGroupDisplay() {
      const groupType = document.getElementById('groupType').value || 'korean';
      const groupCount = parseInt(document.getElementById('groupCount').value) || 14;
      const selectedGroups = getGroupNames(groupType, groupCount);
      document.getElementById('groupDisplay').textContent = selectedGroups.join(',');

      // ì¢Œì„ ì„ íƒ ë“œë¡­ë‹¤ìš´ë„ ì—…ë°ì´íŠ¸
      updateSeatGroupDropdowns();
    }


    // ì¢Œì„ ë°°ì • ê³µí†µ ë¡œì§
    function getSeatAssignmentParams() {
      const groupType = document.getElementById('groupType').value || 'korean';
      const groupCount = parseInt(document.getElementById('groupCount').value) || 14;
      const rowsPerGroup = parseInt(document.getElementById('rowsPerGroup').value);
      const seatsPerRow = parseInt(document.getElementById('seatsPerRow').value);

      if (!groupCount || !rowsPerGroup || !seatsPerRow) {
        return null;
      }

      const groups = getGroupNames(groupType, groupCount);

      return { groupType, groupCount, rowsPerGroup, seatsPerRow, groups };
    }

    async function assignSeatsCommon(endpoint, confirmMessage) {
      const params = getSeatAssignmentParams();
      if (!params) {
        showError('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        const response = await authFetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            groups: params.groups,
            rowsPerGroup: params.rowsPerGroup,
            seatsPerRow: params.seatsPerRow
          }),
        });

        const data = await response.json();
        if (data.success) {
          showSuccess(data.message);
          loadParticipants(currentPage); // í˜„ì¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
          showError(data.error || 'ì¢Œì„ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Seat assignment error:', err);
        showError('ì¢Œì„ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function randomAssignSeats() {
      const params = getSeatAssignmentParams();
      if (!params) {
        showError('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const confirmMessage = `ì…ê¸ˆ ì™„ë£Œëœ ì°¸ê°€ìë“¤ì—ê²Œ ëœë¤ìœ¼ë¡œ ì¢Œì„ì„ ë°°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê·¸ë£¹: ${params.groups.join(', ')}\nê·¸ë£¹ë‹¹ ì—´ ìˆ˜: ${params.rowsPerGroup}\nì—´ë‹¹ ì¢Œì„ ìˆ˜: ${params.seatsPerRow}`;
      await assignSeatsCommon('/api/admin/participants/random-seats', confirmMessage);
    }

    async function resetParticipantSeat(id, userName) {
      const confirmMessage = userName
        ? `"${userName}" ì°¸ê°€ìì˜ ì¢Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
        : 'ì´ ì°¸ê°€ìì˜ ì¢Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';

      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        const response = await authFetch(`/api/admin/participants/${id}/seat`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (data.success) {
          alert('ì¢Œì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadParticipants(currentPage); // í˜„ì¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
          alert(data.error || 'ì¢Œì„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Reset seat error:', err);
        alert('ì¢Œì„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì²´í¬ì¸ ì´ˆê¸°í™”
    async function resetCheckin(participantId) {
      if (!confirm('ì´ ì°¸ê°€ìì˜ ì²´í¬ì¸ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const response = await authFetch(`/api/admin/checkin/participant/${participantId}`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (data.success) {
          alert(data.message);
          loadParticipants(currentPage);
          loadCheckinStats();
        } else {
          alert(data.error || 'ì²´í¬ì¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Reset checkin error:', err);
        alert('ì²´í¬ì¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function deleteParticipant(id, userName) {
      const confirmMessage = userName
        ? `"${userName}" ì°¸ê°€ì ì •ë³´ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
        : 'ì´ ì°¸ê°€ì ì •ë³´ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';

      if (!confirm(confirmMessage)) return;

      try {
        const response = await authFetch(`/api/admin/participants/${id}`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (data.success) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadParticipants(currentPage); // í˜„ì¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
          alert(data.error || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Delete error:', err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }

    async function ageBasedAssignSeats() {
      const params = getSeatAssignmentParams();
      if (!params) {
        showError('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const confirmMessage = `ì…ê¸ˆ ì™„ë£Œëœ ì°¸ê°€ìë“¤ì—ê²Œ ì—°ë ¹ëŒ€ë³„ë¡œ ì¢Œì„ì„ ë°°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n00ë…„ëŒ€ìƒ â†’ 90ë…„ëŒ€ìƒ â†’ 80ë…„ëŒ€ìƒ ìˆœìœ¼ë¡œ ì•ì¢Œì„ì— ë°°ì •ë©ë‹ˆë‹¤.\n\nê·¸ë£¹: ${params.groups.join(', ')}\nê·¸ë£¹ë‹¹ ì—´ ìˆ˜: ${params.rowsPerGroup}\nì—´ë‹¹ ì¢Œì„ ìˆ˜: ${params.seatsPerRow}`;
      await assignSeatsCommon('/api/admin/participants/age-based-seats', confirmMessage);
    }

    async function resetAllSeats() {
      if (!confirm('ëª¨ë“  ì°¸ê°€ìì˜ ì¢Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
      }

      try {
        const response = await authFetch('/api/admin/participants/reset-seats', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        const data = await response.json();
        if (data.success) {
          alert(data.message || 'ëª¨ë“  ì¢Œì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadParticipants(currentPage); // í˜„ì¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
          alert(data.error || 'ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Reset seats error:', err);
        alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function formatPhone(value) {
      if (!value) return '-';
      const cleaned = value.replace(/\D/g, '');
      if (cleaned.length <= 3) return cleaned;
      if (cleaned.length <= 7) return `${cleaned.slice(0, 3)}-${cleaned.slice(3)}`;
      return `${cleaned.slice(0, 3)}-${cleaned.slice(3, 7)}-${cleaned.slice(7, 11)}`;
    }

    function formatDateTime(dateTimeStr) {
      if (!dateTimeStr) return '-';
      try {
        // YYYY-MM-DD HH:mm:ss í˜•ì‹ì„ íŒŒì‹±
        const dateStr = dateTimeStr.replace(' ', 'T');
        const date = new Date(dateStr);
        // í•œêµ­ ì‹œê°„ëŒ€ë¡œ í‘œì‹œ
        return date.toLocaleString('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false,
          timeZone: 'Asia/Seoul'
        });
      } catch (e) {
        return dateTimeStr;
      }
    }

    // íƒ­ ì „í™˜ í•¨ìˆ˜
    function resetAllTabStyles() {
      const tabs = ['participantsTab', 'paymentTab', 'inquiriesTab', 'checkinTab', 'storiesTab'];
      const sections = ['participantsSection', 'paymentSection', 'inquiriesSection', 'checkinSection', 'storiesSection'];
      tabs.forEach(tab => {
        const el = document.getElementById(tab);
        if (el) {
          el.classList.remove('text-red-600', 'border-b-2', 'border-red-600');
          el.classList.add('text-gray-600');
        }
      });
      sections.forEach(section => {
        const el = document.getElementById(section);
        if (el) el.classList.add('hidden');
      });
    }

    function showParticipantsTab() {
      resetAllTabStyles();
      document.getElementById('participantsSection').classList.remove('hidden');
      document.getElementById('participantsTab').classList.add('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('participantsTab').classList.remove('text-gray-600');
      // íƒ­ ì „í™˜ ì‹œ í•­ìƒ ìµœì‹  ë°ì´í„° ë¡œë“œ (ìºì‹œ ë¬´ì‹œ)
      loadParticipants(1, true);
    }

    function showPaymentTab() {
      resetAllTabStyles();
      document.getElementById('paymentSection').classList.remove('hidden');
      document.getElementById('paymentTab').classList.add('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('paymentTab').classList.remove('text-gray-600');

      // ì €ì¥ëœ ë°ì´í„° ë³µì›
      if (paymentDataList.length === 0) {
        loadPaymentDataFromStorage();
      }
    }

    function showInquiriesTab() {
      resetAllTabStyles();
      document.getElementById('inquiriesSection').classList.remove('hidden');
      document.getElementById('inquiriesTab').classList.add('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('inquiriesTab').classList.remove('text-gray-600');
      loadInquiries();
    }

    function showCheckinTab() {
      resetAllTabStyles();
      document.getElementById('checkinSection').classList.remove('hidden');
      document.getElementById('checkinTab').classList.add('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('checkinTab').classList.remove('text-gray-600');

      // ì²´í¬ì¸ í†µê³„ ë° ìµœê·¼ ê¸°ë¡ ë¡œë“œ
      loadCheckinStats();
      loadRecentCheckins();

      // ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì´ˆê¸°í™” ë° í¬ì»¤ìŠ¤
      initBarcodeScanner();
    }

    function showStoriesTab() {
      resetAllTabStyles();
      document.getElementById('storiesSection').classList.remove('hidden');
      document.getElementById('storiesTab').classList.add('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('storiesTab').classList.remove('text-gray-600');
      loadStories();
    }

    // ë¬¸ì˜ ëª©ë¡ ë¡œë“œ
    let inquiries = [];
    let filteredInquiries = [];

    async function loadInquiries() {
      const loading = document.getElementById('inquiryLoading');
      if (loading) loading.classList.remove('hidden');

      try {
        const response = await authFetch('/api/admin/inquiries');

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
          inquiries = data.inquiries || [];
          updateUnansweredBadge(); // ë¯¸ë‹µë³€ ë°°ì§€ ì—…ë°ì´íŠ¸
          filterInquiries(inquiryFilterState); // Apply current filter state
        } else {
          console.error('API error:', data.error);
          alert('ë¬¸ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (err) {
        console.error('Error loading inquiries:', err);
        alert('ë¬¸ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      } finally {
        if (loading) loading.classList.add('hidden');
      }
    }

    // ë¯¸ë‹µë³€ ë¬¸ì˜ ê°œìˆ˜ ë°°ì§€ ì—…ë°ì´íŠ¸
    function updateUnansweredBadge() {
      const unansweredCount = inquiries.filter(inq => !inq.is_answered).length;
      const badge = document.getElementById('unansweredBadge');
      if (badge) {
        if (unansweredCount > 0) {
          badge.textContent = unansweredCount > 99 ? '99+' : unansweredCount;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }

    function filterInquiries(filter) {
      inquiryFilterState = filter; // Update filter state
      const searchInput = document.getElementById('inquirySearchInput');
      const search = searchInput ? searchInput.value.toLowerCase() : '';

      let tempFiltered = inquiries;

      if (filter === 'unanswered') {
        tempFiltered = tempFiltered.filter(inq => !inq.is_answered);
      } else if (filter === 'answered') {
        tempFiltered = tempFiltered.filter(inq => inq.is_answered);
      }

      if (search) {
        tempFiltered = tempFiltered.filter(i =>
          i.user_name.toLowerCase().includes(search) ||
          i.phone.includes(search) ||
          i.content.toLowerCase().includes(search)
        );
      }

      filteredInquiries = tempFiltered;
      displayInquiries(filteredInquiries);
    }

    function displayInquiries(list) {
      const inquiriesList = document.getElementById('inquiriesList');
      const loading = document.getElementById('inquiryLoading');
      const emptyMessage = document.getElementById('inquiryEmptyMessage');
      const countText = document.getElementById('inquiryCountText');

      loading.classList.add('hidden');

      if (list.length === 0) {
        inquiriesList.classList.add('hidden');
        emptyMessage.classList.remove('hidden');
        emptyMessage.textContent = document.getElementById('inquirySearchInput').value ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.';
        countText.textContent = '';
        return;
      }

      inquiriesList.classList.remove('hidden');
      emptyMessage.classList.add('hidden');
      countText.textContent = `ì´ ${list.length}ê±´`;

      inquiriesList.innerHTML = list.map(inq => `
        <div class="glass-card p-6 ${inq.is_answered ? 'bg-green-50/50' : 'bg-white'}">
          <div class="flex justify-between items-start mb-4">
            <div>
              <div class="flex items-center gap-3 mb-2">
                <span class="font-semibold text-gray-900">${inq.user_name}</span>
                <span class="text-sm text-gray-500">${formatPhone(inq.phone)}</span>
                <span class="text-xs text-gray-400">${formatDateTime(inq.created_at)}</span>
              </div>
              ${inq.is_answered ? '<span class="badge-green text-xs">ë‹µë³€ ì™„ë£Œ</span>' : '<span class="badge-red text-xs">ë‹µë³€ ëŒ€ê¸°</span>'}
            </div>
            <button 
              onclick="deleteInquiry(${inq.id}, '${inq.user_name}')" 
              class="p-2 text-red-600 hover:text-red-700 hover:bg-red-50 rounded transition-colors"
              title="ì‚­ì œ"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
          
          <div class="mb-4">
            <p class="text-sm font-medium text-gray-700 mb-2">ë¬¸ì˜ë‚´ìš©</p>
            <p class="text-gray-900 whitespace-pre-wrap">${inq.content}</p>
          </div>

          ${inq.is_answered ? `
            <div class="mt-4 pt-4 border-t border-gray-200">
              <p class="text-sm font-medium text-gray-700 mb-2">ë‹µë³€</p>
              <p class="text-gray-900 whitespace-pre-wrap">${inq.answer}</p>
              <p class="text-xs text-gray-400 mt-2">ë‹µë³€ì¼ì‹œ: ${formatDateTime(inq.answered_at)}</p>
            </div>
          ` : `
            <div class="mt-4 pt-4 border-t border-gray-200">
              <textarea
                id="answer-${inq.id}"
                class="input-glass w-full"
                rows="3"
                placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..."
              ></textarea>
              <button 
                onclick="submitAnswer(${inq.id})" 
                class="btn-primary-glass mt-2"
              >
                ë‹µë³€ ë“±ë¡
              </button>
            </div>
          `}
        </div>
      `).join('');

      // ê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      const inquirySearchInput = document.getElementById('inquirySearchInput');
      if (inquirySearchInput) {
        // Debounce ì ìš©ëœ ê²€ìƒ‰ (300ms)
        const debouncedInquiryFilter = debounce(() => {
          filterInquiries(inquiryFilterState);
        }, SEARCH_DEBOUNCE_MS);
        inquirySearchInput.removeEventListener('input', debouncedInquiryFilter); // Prevent multiple listeners
        inquirySearchInput.addEventListener('input', debouncedInquiryFilter);
      }
    }

    async function submitAnswer(id) {
      const answerInput = document.getElementById(`answer-${id}`);
      if (!answerInput || !answerInput.value.trim()) {
        alert('ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const response = await authFetch(`/api/admin/inquiries/${id}/answer`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ answer: answerInput.value.trim() }),
        });

        const data = await response.json();
        if (data.success) {
          alert('ë‹µë³€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadInquiries();
        } else {
          alert(data.error || 'ë‹µë³€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Submit answer error:', err);
        alert('ë‹µë³€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function deleteInquiry(id, userName) {
      if (!confirm(`"${userName}"ë‹˜ì˜ ë¬¸ì˜ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
      }

      try {
        const response = await authFetch(`/api/admin/inquiries/${id}`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (data.success) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadInquiries();
        } else {
          alert(data.error || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Delete inquiry error:', err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ========== ì‚¬ì—° ê´€ë¦¬ ==========
    let stories = [];
    let filteredStories = [];

    async function loadStories() {
      const loading = document.getElementById('storyLoading');
      if (loading) loading.classList.remove('hidden');

      try {
        const response = await authFetch('/api/stories?limit=100');

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
          stories = data.stories || [];
          updateUnreadStoriesBadge();
          filterStories();
        } else {
          console.error('API error:', data.error);
          alert('ì‚¬ì—° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (err) {
        console.error('Error loading stories:', err);
        alert('ì‚¬ì—° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        if (loading) loading.classList.add('hidden');
      }
    }

    function updateUnreadStoriesBadge() {
      const unreadCount = stories.filter(s => !s.is_read).length;
      const badge = document.getElementById('unreadStoriesBadge');
      if (badge) {
        if (unreadCount > 0) {
          badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }

    function filterStories() {
      const filter = document.getElementById('storyFilter')?.value || 'all';
      const searchTerm = document.getElementById('storySearchInput')?.value?.toLowerCase() || '';

      filteredStories = stories.filter(story => {
        // í•„í„° ì ìš©
        if (filter === 'unread' && story.is_read) return false;
        if (filter === 'read' && !story.is_read) return false;

        // ê²€ìƒ‰ì–´ ì ìš©
        if (searchTerm) {
          const name = (story.name || '').toLowerCase();
          const phone = (story.phone || '').replace(/\D/g, '');
          const searchPhone = searchTerm.replace(/\D/g, '');
          if (!name.includes(searchTerm) && !phone.includes(searchPhone)) {
            return false;
          }
        }

        return true;
      });

      renderStories();
    }

    function renderStories() {
      const list = document.getElementById('storiesList');
      const emptyMessage = document.getElementById('storyEmptyMessage');
      const countText = document.getElementById('storyCountText');
      const loading = document.getElementById('storyLoading');

      if (loading) loading.classList.add('hidden');

      if (filteredStories.length === 0) {
        if (list) list.classList.add('hidden');
        if (emptyMessage) {
          emptyMessage.textContent = stories.length === 0 ? 'ë“±ë¡ëœ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤.' : 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
          emptyMessage.classList.remove('hidden');
        }
        if (countText) countText.textContent = '';
        return;
      }

      if (emptyMessage) emptyMessage.classList.add('hidden');
      if (list) list.classList.remove('hidden');

      const unreadCount = stories.filter(s => !s.is_read).length;
      if (countText) {
        countText.textContent = `ì „ì²´ ${stories.length}ê±´ (ì•ˆ ì½ìŒ ${unreadCount}ê±´) | í‘œì‹œ ${filteredStories.length}ê±´`;
      }

      list.innerHTML = filteredStories.map(story => `
        <div class="p-4 rounded-xl ${story.is_read ? 'bg-gray-50' : 'bg-orange-50 border-l-4 border-orange-400'}">
          <div class="flex justify-between items-start mb-2">
            <div class="flex items-center gap-3">
              <span class="font-semibold text-gray-900">${story.name}</span>
              <span class="text-sm text-gray-500">${formatPhone(story.phone)}</span>
              ${story.is_read ? '<span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded">ì½ìŒ</span>' : '<span class="text-xs bg-orange-500 text-white px-2 py-0.5 rounded">ì•ˆ ì½ìŒ</span>'}
            </div>
            <span class="text-xs text-gray-400">${formatDateTime(story.created_at)}</span>
          </div>
          ${story.title ? `<p class="font-medium text-gray-800 mb-2">${escapeHtml(story.title)}</p>` : ''}
          <div class="text-gray-700 text-sm whitespace-pre-wrap bg-white p-3 rounded-lg border border-gray-100 max-h-40 overflow-y-auto">${escapeHtml(story.content)}</div>
          <div class="flex gap-2 mt-3">
            ${!story.is_read ? `
              <button onclick="markStoryAsRead(${story.id})" class="text-sm text-blue-600 hover:text-blue-800">
                ì½ìŒ í‘œì‹œ
              </button>
            ` : ''}
            <button onclick="deleteStory(${story.id}, '${story.name}')" class="text-sm text-red-600 hover:text-red-800">
              ì‚­ì œ
            </button>
          </div>
        </div>
      `).join('');
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function markStoryAsRead(id) {
      try {
        const response = await authFetch(`/api/stories/${id}/read`, {
          method: 'PUT',
        });

        const data = await response.json();
        if (data.success) {
          // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
          const story = stories.find(s => s.id === id);
          if (story) story.is_read = 1;
          updateUnreadStoriesBadge();
          filterStories();
        } else {
          alert(data.error || 'ì½ìŒ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Mark story as read error:', err);
        alert('ì½ìŒ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function deleteStory(id, userName) {
      if (!confirm(`"${userName}"ë‹˜ì˜ ì‚¬ì—°ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
      }

      try {
        const response = await authFetch(`/api/stories/${id}`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (data.success) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadStories();
        } else {
          alert(data.error || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Delete story error:', err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function exportStoriesToExcel() {
      if (stories.length === 0) {
        alert('ë‚´ë³´ë‚¼ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const data = stories.map(story => ({
        'ì´ë¦„': story.name,
        'ì—°ë½ì²˜': formatPhone(story.phone),
        'ì œëª©': story.title || '',
        'ë‚´ìš©': story.content,
        'ì½ìŒì—¬ë¶€': story.is_read ? 'ì½ìŒ' : 'ì•ˆ ì½ìŒ',
        'ë“±ë¡ì¼ì‹œ': formatDateTime(story.created_at)
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'ì‚¬ì—°ëª©ë¡');

      const today = new Date().toISOString().slice(0, 10);
      XLSX.writeFile(wb, `í•œë™í›ˆí† í¬ì½˜ì„œíŠ¸_ì‚¬ì—°_${today}.xlsx`);
    }

    // ì…ê¸ˆ ë°ì´í„° íŒŒì‹± ë° ë§¤ì¹­
    let paymentDataList = [];
    let allParticipants = [];

    // ì „ì²´ ì°¸ê°€ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
    async function reloadAllParticipants() {
      try {
        // ìºì‹œ ë²„ìŠ¤íŒ…ì„ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
        const timestamp = Date.now();
        const response = await authFetch(`/api/admin/participants?limit=9999&_t=${timestamp}`);
        const data = await response.json();
        if (data.success) {
          allParticipants = data.participants || [];
          console.log('[Payment] Reloaded allParticipants:', allParticipants.length, 'paid:', allParticipants.filter(p => p.is_paid).length);
        }
      } catch (err) {
        console.error('Error reloading allParticipants:', err);
      }
    }

    // localStorageì— ì…ê¸ˆ ë°ì´í„° ì €ì¥ (debounce ì ìš©)
    function savePaymentDataToStorage() {
      // ì´ì „ íƒ€ì´ë¨¸ ì·¨ì†Œ
      if (savePaymentDataTimeout) {
        clearTimeout(savePaymentDataTimeout);
      }

      // 500ms í›„ ì €ì¥ (debounce)
      savePaymentDataTimeout = setTimeout(function () {
        try {
          // matchedParticipantëŠ” ê°ì²´ì´ë¯€ë¡œ IDë§Œ ì €ì¥
          const dataToSave = paymentDataList.map(function (item) {
            return {
              date: item.date,
              type: item.type,
              amount: item.amount,
              balance: item.balance,
              transactionType: item.transactionType,
              content: item.content,
              memo: item.memo,
              matchedName: item.matchedName,
              matchedPhoneLast4: item.matchedPhoneLast4,
              matchedParticipantId: item.matchedParticipant ? item.matchedParticipant.id : null,
              expectedParticipantIds: item.expectedParticipants ? item.expectedParticipants.map(function (p) { return p.id; }) : [],
              approved: item.approved
            };
          });
          localStorage.setItem('paymentDataList', JSON.stringify(dataToSave));
        } catch (err) {
          console.error('Error saving payment data to storage:', err);
        }
      }, 500);
    }

    // localStorageì—ì„œ ì…ê¸ˆ ë°ì´í„° ë³µì›
    function loadPaymentDataFromStorage() {
      try {
        const saved = localStorage.getItem('paymentDataList');
        if (!saved) return false;

        const savedData = JSON.parse(saved);
        if (!Array.isArray(savedData) || savedData.length === 0) return false;

        // ì°¸ê°€ì ëª©ë¡ ë¡œë“œ (ë§¤ì¹­ì„ ìœ„í•´ í•„ìš”)
        authFetch('/api/admin/participants?limit=9999') // ëª¨ë“  ì°¸ê°€ì ë¡œë“œ
          .then(function (response) { return response.json(); })
          .then(function (data) {
            if (data.success) {
              allParticipants = data.participants || [];

              // ì €ì¥ëœ ë°ì´í„° ë³µì› (matchedParticipantì™€ expectedParticipantsëŠ” IDë¡œ ë³µì›)
              paymentDataList = savedData.map(function (item) {
                let matchedParticipant = null;
                if (item.matchedParticipantId) {
                  matchedParticipant = allParticipants.find(function (p) {
                    return p.id === item.matchedParticipantId;
                  });
                }

                let expectedParticipants = [];
                if (item.expectedParticipantIds && item.expectedParticipantIds.length > 0) {
                  expectedParticipants = allParticipants.filter(function (p) {
                    return item.expectedParticipantIds.indexOf(p.id) !== -1;
                  });
                }

                return {
                  date: item.date || '',
                  type: item.type || '',
                  amount: item.amount || '',
                  balance: item.balance || '',
                  transactionType: item.transactionType || '',
                  content: item.content || '',
                  memo: item.memo || '',
                  matchedName: item.matchedName || '',
                  matchedPhoneLast4: item.matchedPhoneLast4 || '',
                  matchedParticipant: matchedParticipant,
                  expectedParticipants: expectedParticipants,
                  approved: item.approved || false
                };
              });

              // í…Œì´ë¸”ì— ë³µì›ëœ ë°ì´í„° í‘œì‹œ
              restorePaymentTableFromData();
            }
          })
          .catch(function (err) {
            console.error('Error loading participants for payment data:', err);
          });

        return true;
      } catch (err) {
        console.error('Error loading payment data from storage:', err);
        return false;
      }
    }

    // ì €ì¥ëœ ë°ì´í„°ë¥¼ í…Œì´ë¸”ì— ë³µì›
    function restorePaymentTableFromData() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody || paymentDataList.length === 0) return;

      tbody.innerHTML = '';

      paymentDataList.forEach(function (item, index) {
        const row = document.createElement('tr');
        const hasMatch = item.matchedParticipant !== null;
        const hasPhoneLast4 = item.matchedPhoneLast4 !== '';

        row.className = hasMatch ? '' : 'bg-yellow-50';
        row.innerHTML = `
          <td class="border border-gray-300 px-2 py-1 text-sm text-center text-gray-500">${index + 1}</td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.date || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.type || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.amount || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.balance || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.transactionType || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.content || ''}" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.memo || ''}" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1">
            ${hasMatch ? `
              <div class="text-green-600 font-semibold text-sm">
                âœ“ ${item.matchedParticipant.user_name} (${formatPhone(item.matchedParticipant.phone)})
              </div>
            ` : hasPhoneLast4 ? `
              <div class="text-red-600 text-sm">
                âœ— ë§¤ì¹­ë˜ì§€ ì•ŠìŒ (${item.matchedName}${item.matchedPhoneLast4})
              </div>
            ` : `
              <div class="text-orange-600 text-sm">
                âš  ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ì—†ìŒ
              </div>
            `}
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${!item.matchedParticipant && item.expectedParticipants && item.expectedParticipants.length > 0 ? (
            item.expectedParticipants.length === 1 ? `
                <div class="text-blue-600 text-sm">
                  ${item.expectedParticipants[0].user_name} (${formatPhone(item.expectedParticipants[0].phone)})
                </div>
              ` : `
                <div class="text-orange-600 font-semibold text-sm">
                  âš  ë™ëª…ì´ì¸ ë°œìƒ, ì—°ë½ í›„ ì…ê¸ˆí™•ì¸ í•„ìš”
                </div>
              `
          ) : '<span class="text-gray-400 text-sm">-</span>'}
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${item.expectedParticipants && item.expectedParticipants.length > 1 ? (() => {
            // expectedParticipantsê°€ 2ëª… ì´ìƒì¼ ë•Œë§Œ ë™ëª…ì´ì¸ ëª©ë¡ í‘œì‹œ
            // ì´ë¯¸ ë§¤ì¹­ëœ ì°¸ê°€ìë¥¼ ì œì™¸í•œ ë™ëª…ì´ì¸ ëª©ë¡
            const unapprovedDuplicates = item.expectedParticipants.filter(function (p) {
              if (item.matchedParticipant && item.matchedParticipant.id === p.id) {
                return false;
              }
              return true;
            });

            if (unapprovedDuplicates.length > 0) {
              return '<div class="text-sm space-y-2">' + unapprovedDuplicates.map(function (p, pIndex) {
                return '<div class="flex items-center justify-between gap-2 p-2 bg-gray-50 rounded border border-gray-200"><span class="text-gray-700">' + p.user_name + ' (' + formatPhone(p.phone) + ')</span><button onclick="approveDuplicateParticipant(' + index + ', ' + p.id + ')" style="background-color: #22c55e; color: white; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-weight: bold; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; white-space: nowrap;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button></div>';
              }).join('') + '</div>';
            } else {
              return '<span class="text-gray-400 text-sm">-</span>';
            }
          })() : '<span class="text-gray-400 text-sm">-</span>'}
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${item.approved ? '<span class="text-green-600 font-semibold text-sm">ìŠ¹ì¸ë¨</span>' : '<span class="text-gray-500 text-sm">ëŒ€ê¸°ì¤‘</span>'}
          </td>
          <td class="border border-gray-300 px-2 py-2">
            <div class="flex gap-2">
              ${!item.approved ? `
                <button onclick="approvePaymentFromTable(${index})" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#16a34a'" onmouseout="this.style.backgroundColor='#22c55e'">
                  ìŠ¹ì¸
                </button>
              ` : `
                <span style="background-color: #dcfce7; color: #166534; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; display: inline-block;">âœ“ ìŠ¹ì¸ë¨</span>
              `}
              <button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">
                ì‚­ì œ
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // ì…ê¸ˆ ë°ì´í„° ì €ì¥í•˜ê¸°
    async function savePaymentData() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;

      // ì°¸ê°€ì ëª©ë¡ì´ ì—†ìœ¼ë©´ ë¨¼ì € ë¡œë“œ
      if (allParticipants.length === 0) {
        try {
          const response = await authFetch('/api/admin/participants?limit=9999'); // ëª¨ë“  ì°¸ê°€ì ë¡œë“œ
          const data = await response.json();
          if (data.success) {
            allParticipants = data.participants || [];
          }
        } catch (err) {
          console.error('Error loading participants:', err);
          alert('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return;
        }
      }

      // í…Œì´ë¸”ì—ì„œ ì§ì ‘ ë°ì´í„°ë¥¼ ì½ì–´ì„œ paymentDataList ì—…ë°ì´íŠ¸
      const rows = tbody.querySelectorAll('tr');
      const updatedList = [];

      rows.forEach(function (row, rowIndex) {
        const inputs = row.querySelectorAll('input[type="text"]');
        if (inputs.length < 7) return;

        const date = inputs[0].value.trim();
        const type = inputs[1].value.trim();
        const amount = inputs[2].value.trim();
        const balance = inputs[3].value.trim();
        const transactionType = inputs[4].value.trim();
        const content = inputs[5].value.trim();
        const memo = inputs[6].value.trim();

        // ë¹ˆ í–‰ì€ ì œì™¸
        if (!date && !type && !amount && !content) return;

        // ê¸°ì¡´ paymentDataListì—ì„œ í•´ë‹¹ ì¸ë±ìŠ¤ì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìˆëŠ” ê²½ìš°)
        // paymentDataListê°€ ì¶©ë¶„íˆ í¬ì§€ ì•Šìœ¼ë©´ í™•ì¥
        while (paymentDataList.length <= rowIndex) {
          paymentDataList.push({
            date: '',
            type: '',
            amount: '',
            balance: '',
            transactionType: '',
            content: '',
            memo: '',
            matchedName: '',
            matchedPhoneLast4: '',
            matchedParticipant: null,
            expectedParticipants: [],
            approved: false
          });
        }
        const existingItem = paymentDataList[rowIndex] || null;

        // ë‚´ìš© ë˜ëŠ” ë©”ëª¨ì—ì„œ ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ 4ê°œ ì¶”ì¶œ
        // ë©”ëª¨ë€ì„ ìš°ì„  í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ë‚´ìš©ë€ì—ì„œ ì¶”ì¶œ
        let matchedName = '';
        let matchedPhoneLast4 = '';

        // ë©”ëª¨ë€ì—ì„œ ë¨¼ì € ì‹œë„ (ì• ê³µë°± ë¬´ì‹œ)
        const memoTrimmed = memo.trim();
        const memoMatch = memoTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
        if (memoMatch && memoMatch[1].trim()) {
          matchedName = memoMatch[1].trim();
          matchedPhoneLast4 = memoMatch[2] || '';
        }

        // ë©”ëª¨ë€ì—ì„œ ì´ë¦„ì„ ëª» ì°¾ì•˜ìœ¼ë©´ ë‚´ìš©ë€ì—ì„œ ì‹œë„ (ì• ê³µë°± ë¬´ì‹œ)
        if (!matchedName) {
          const contentTrimmed = content.trim();
          const contentMatch = contentTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
          if (contentMatch) {
            matchedName = contentMatch[1].trim();
            matchedPhoneLast4 = contentMatch[2] || '';
          }
        }

        // ì‹ ì²­ì ë§¤ì¹­
        let matchedParticipant = null;
        if (matchedName && matchedPhoneLast4) {
          matchedParticipant = allParticipants.find(function (p) {
            // ì´ë¦„ ë§¤ì¹­: ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš°
            // ë‹¨, í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();

            // ì •í™•íˆ ì¼ì¹˜
            if (pName === matchedNameTrimmed) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }

            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }

            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }

            return false;
          });
        }

        // ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ì°¾ê¸° (ì´ë¦„ë§Œìœ¼ë¡œ ë§¤ì¹­, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ëŠ” ë¬´ì‹œ)
        let expectedParticipants = [];
        if (matchedName) {
          expectedParticipants = allParticipants.filter(function (p) {
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();

            // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš° (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            if (pName === matchedNameTrimmed) {
              return true;
            }

            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }

            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              return true;
            }

            return false;
          });
        }

        // ê¸°ì¡´ ë°ì´í„°ì˜ approved ìƒíƒœ ìœ ì§€ (ì—†ìœ¼ë©´ false)
        const approved = existingItem ? existingItem.approved : false;

        updatedList.push({
          date: date,
          type: type,
          amount: amount,
          balance: balance,
          transactionType: transactionType,
          content: content,
          memo: memo,
          matchedName: matchedName,
          matchedPhoneLast4: matchedPhoneLast4,
          matchedParticipant: matchedParticipant,
          expectedParticipants: expectedParticipants,
          approved: approved
        });
      });

      if (updatedList.length === 0) {
        alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // paymentDataList ì—…ë°ì´íŠ¸
      paymentDataList = updatedList;

      // localStorageì— ì €ì¥
      savePaymentDataToStorage();

      // í…Œì´ë¸” ì—…ë°ì´íŠ¸
      updatePaymentTableWithMatches();

      alert('ì…ê¸ˆ ë‚´ì—­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // í…Œì´ë¸”ì—ì„œ ë°ì´í„° ì½ê¸° ë° ë§¤ì¹­
    async function parsePaymentDataFromTable() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;

      // ì°¸ê°€ì ëª©ë¡ ë¡œë“œ
      try {
        const response = await authFetch('/api/admin/participants');
        const data = await response.json();
        if (data.success) {
          allParticipants = data.participants || [];
        }
      } catch (err) {
        console.error('Error loading participants:', err);
        alert('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      const rows = tbody.querySelectorAll('tr');
      paymentDataList = [];

      rows.forEach(function (row) {
        const inputs = row.querySelectorAll('input[type="text"]');
        if (inputs.length < 7) return;

        const date = inputs[0].value.trim();
        const type = inputs[1].value.trim();
        const amount = inputs[2].value.trim();
        const balance = inputs[3].value.trim();
        const transactionType = inputs[4].value.trim();
        const content = inputs[5].value.trim();
        const memo = inputs[6].value.trim();

        // ë¹ˆ í–‰ì€ ì œì™¸
        if (!date && !type && !amount && !content) return;

        // ë‚´ìš© ë˜ëŠ” ë©”ëª¨ì—ì„œ ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ 4ê°œ ì¶”ì¶œ
        // ë©”ëª¨ë€ì„ ìš°ì„  í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ë‚´ìš©ë€ì—ì„œ ì¶”ì¶œ
        let matchedName = '';
        let matchedPhoneLast4 = '';

        // ë©”ëª¨ë€ì—ì„œ ë¨¼ì € ì‹œë„ (ì• ê³µë°± ë¬´ì‹œ)
        const memoTrimmed = memo.trim();
        const memoMatch = memoTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
        if (memoMatch && memoMatch[1].trim()) {
          matchedName = memoMatch[1].trim();
          matchedPhoneLast4 = memoMatch[2] || '';
        }

        // ë©”ëª¨ë€ì—ì„œ ì´ë¦„ì„ ëª» ì°¾ì•˜ìœ¼ë©´ ë‚´ìš©ë€ì—ì„œ ì‹œë„ (ì• ê³µë°± ë¬´ì‹œ)
        if (!matchedName) {
          const contentTrimmed = content.trim();
          const contentMatch = contentTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
          if (contentMatch) {
            matchedName = contentMatch[1].trim();
            matchedPhoneLast4 = contentMatch[2] || '';
          }
        }

        // ì‹ ì²­ì ë§¤ì¹­
        let matchedParticipant = null;
        if (matchedName && matchedPhoneLast4) {
          matchedParticipant = allParticipants.find(function (p) {
            // ì´ë¦„ ë§¤ì¹­: ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš°
            // ë‹¨, í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();

            // ì •í™•íˆ ì¼ì¹˜
            if (pName === matchedNameTrimmed) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }

            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }

            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }

            return false;
          });
        }

        // ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ì°¾ê¸° (ì´ë¦„ë§Œìœ¼ë¡œ ë§¤ì¹­, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ëŠ” ë¬´ì‹œ)
        let expectedParticipants = [];
        if (matchedName) {
          expectedParticipants = allParticipants.filter(function (p) {
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();

            // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš° (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            if (pName === matchedNameTrimmed) {
              return true;
            }

            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }

            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              return true;
            }

            return false;
          });
        }

        // ê¸°ì¡´ paymentDataListì—ì„œ í•´ë‹¹ ì¸ë±ìŠ¤ì˜ approved ìƒíƒœ í™•ì¸
        const currentIndex = paymentDataList.length;
        const existingItem = paymentDataList[currentIndex] || null;
        const approved = existingItem ? existingItem.approved : false;

        paymentDataList.push({
          date: date,
          type: type,
          amount: amount,
          balance: balance,
          transactionType: transactionType,
          content: content,
          memo: memo,
          matchedName: matchedName,
          matchedPhoneLast4: matchedPhoneLast4,
          matchedParticipant: matchedParticipant,
          expectedParticipants: expectedParticipants,
          approved: approved
        });
      });

      // ë§¤ì¹­ ê²°ê³¼ë¥¼ í…Œì´ë¸”ì— ë°˜ì˜
      updatePaymentTableWithMatches();
      // localStorageì— ì €ì¥
      savePaymentDataToStorage();
    }

    function updatePaymentTableWithMatches() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;

      const rows = tbody.querySelectorAll('tr');
      rows.forEach(function (row, index) {
        const item = paymentDataList[index];
        if (!item) return;

        // ì—°ë²ˆ ì—…ë°ì´íŠ¸ (ì²« ë²ˆì§¸ ì…€)
        const numberCell = row.cells[0];
        if (numberCell) {
          numberCell.textContent = index + 1;
        }

        // ë§¤ì¹­ ê²°ê³¼ ì…€ ì—…ë°ì´íŠ¸
        // ì…€ ì¸ë±ìŠ¤: 0=ì—°ë²ˆ, 1=ê±°ë˜ì¼ì‹œ, 2=êµ¬ë¶„, 3=ê±°ë˜ê¸ˆì•¡, 4=ê±°ë˜í›„ì”ì•¡, 5=ê±°ë˜êµ¬ë¶„, 6=ë‚´ìš©, 7=ë©”ëª¨, 8=ë§¤ì¹­ëœì‹ ì²­ì, 9=ì˜ˆìƒë˜ëŠ”ì‹ ì²­ì, 10=ë¹„ê³ , 11=ìƒíƒœ, 12=ì‘ì—…
        const matchCell = row.cells[8];
        const expectedCell = row.cells[9];
        const noteCell = row.cells[10];
        const statusCell = row.cells[11];
        const actionCell = row.cells[12];

        if (matchCell) {
          const hasMatch = item.matchedParticipant !== null;
          const hasPhoneLast4 = item.matchedPhoneLast4 !== '';

          if (hasMatch) {
            matchCell.innerHTML = '<div class="text-green-600 font-semibold text-sm">âœ“ ' + item.matchedParticipant.user_name + ' (' + formatPhone(item.matchedParticipant.phone) + ')</div>';
            row.className = '';
          } else if (hasPhoneLast4) {
            matchCell.innerHTML = '<div class="text-red-600 text-sm">âœ— ë§¤ì¹­ë˜ì§€ ì•ŠìŒ (' + item.matchedName + item.matchedPhoneLast4 + ')</div>';
            row.className = 'bg-yellow-50';
          } else {
            matchCell.innerHTML = '<div class="text-orange-600 text-sm">âš  ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ì—†ìŒ</div>';
            row.className = 'bg-yellow-50';
          }
        }

        if (expectedCell) {
          // matchedParticipantê°€ ì—†ì„ ë•Œë§Œ ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì í‘œì‹œ
          if (!item.matchedParticipant && item.expectedParticipants && item.expectedParticipants.length > 0) {
            if (item.expectedParticipants.length === 1) {
              expectedCell.innerHTML = '<div class="text-blue-600 text-sm">' + item.expectedParticipants[0].user_name + ' (' + formatPhone(item.expectedParticipants[0].phone) + ')</div>';
            } else {
              expectedCell.innerHTML = '<div class="text-orange-600 font-semibold text-sm">âš  ë™ëª…ì´ì¸ ë°œìƒ, ì—°ë½ í›„ ì…ê¸ˆí™•ì¸ í•„ìš”</div>';
            }
          } else {
            expectedCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
          }
        }

        if (noteCell) {
          // expectedParticipantsê°€ 2ëª… ì´ìƒì¼ ë•Œ ë¹„ê³  ë€ì— ë™ëª…ì´ì¸ ëª©ë¡ í‘œì‹œ
          // matchedParticipantê°€ ìˆì–´ë„ ë™ëª…ì´ì¸ì´ ìˆìœ¼ë©´ í‘œì‹œ (ì´ë¯¸ ìŠ¹ì¸ëœ ì°¸ê°€ìëŠ” ì œì™¸)
          if (item.expectedParticipants && item.expectedParticipants.length > 1) {
            // ì´ë¯¸ ìŠ¹ì¸ëœ ì°¸ê°€ìë¥¼ ì œì™¸í•œ ë™ëª…ì´ì¸ ëª©ë¡
            const unapprovedDuplicates = item.expectedParticipants.filter(function (p) {
              // matchedParticipantê°€ ìˆê³ , ê·¸ ì°¸ê°€ìê°€ ì´ë¯¸ ìŠ¹ì¸ëœ ê²½ìš°ëŠ” ì œì™¸
              if (item.matchedParticipant && item.matchedParticipant.id === p.id) {
                return false;
              }
              return true;
            });

            if (unapprovedDuplicates.length > 0) {
              let noteHtml = '<div class="text-sm space-y-2">';
              unapprovedDuplicates.forEach(function (p) {
                noteHtml += '<div class="flex items-center justify-between gap-2 p-2 bg-gray-50 rounded border border-gray-200"><span class="text-gray-700">' + p.user_name + ' (' + formatPhone(p.phone) + ')</span><button onclick="approveDuplicateParticipant(' + index + ', ' + p.id + ')" style="background-color: #22c55e; color: white; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-weight: bold; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; white-space: nowrap;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button></div>';
              });
              noteHtml += '</div>';
              noteCell.innerHTML = noteHtml;
            } else {
              // ëª¨ë“  ë™ëª…ì´ì¸ì´ ìŠ¹ì¸ëœ ê²½ìš°
              noteCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
            }
          } else {
            noteCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
          }
        }

        if (statusCell) {
          statusCell.innerHTML = item.approved ? '<span class="text-green-600 font-semibold text-sm">ìŠ¹ì¸ë¨</span>' : '<span class="text-gray-500 text-sm">ëŒ€ê¸°ì¤‘</span>';
        }

        if (actionCell) {
          const approveBtn = !item.approved
            ? '<button onclick="approvePaymentFromTable(' + index + ')" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button>'
            : '<span style="background-color: #dcfce7; color: #166534; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; display: inline-block;">âœ“ ìŠ¹ì¸ë¨</span>';
          const deleteBtn = '<button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#dc2626\'" onmouseout="this.style.backgroundColor=\'#ef4444\'">ì‚­ì œ</button>';
          actionCell.innerHTML = '<div class="flex gap-2">' + approveBtn + deleteBtn + '</div>';
        }
      });
    }

    function updatePaymentDataFromInput(input) {
      // í…Œì´ë¸”ì—ì„œ ì§ì ‘ ì…ë ¥ ì‹œ paymentDataList ì—…ë°ì´íŠ¸ëŠ” savePaymentData()ì—ì„œ ì²˜ë¦¬
      // ì—¬ê¸°ì„œëŠ” ì¦‰ì‹œ ì €ì¥í•˜ì§€ ì•Šê³ , ì €ì¥ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ í•œ ë²ˆì— ì²˜ë¦¬
    }

    async function reMatchPaymentFromInput(input) {
      // ë‚´ìš© í•„ë“œ ë³€ê²½ ì‹œ ìë™ ì¬ë§¤ì¹­
      const row = input.closest('tr');
      if (!row) return;

      // ì°¸ê°€ì ëª©ë¡ ë¡œë“œ (ì—†ìœ¼ë©´)
      if (allParticipants.length === 0) {
        try {
          const response = await authFetch('/api/admin/participants');
          const data = await response.json();
          if (data.success) {
            allParticipants = data.participants || [];
          }
        } catch (err) {
          console.error('Error loading participants:', err);
          return;
        }
      }

      // í–‰ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;
      const rows = tbody.querySelectorAll('tr');
      const rowIndex = Array.from(rows).indexOf(row);
      if (rowIndex < 0) return;

      // í•´ë‹¹ í–‰ì˜ ëª¨ë“  ì…ë ¥ê°’ ì½ê¸°
      const inputs = row.querySelectorAll('input[type="text"]');
      if (inputs.length < 7) return;

      const date = inputs[0].value.trim();
      const type = inputs[1].value.trim();
      const amount = inputs[2].value.trim();
      const balance = inputs[3].value.trim();
      const transactionType = inputs[4].value.trim();
      const content = inputs[5].value.trim();
      const memo = inputs[6].value.trim();

      // ë‚´ìš© ë˜ëŠ” ë©”ëª¨ì—ì„œ ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ 4ê°œ ì¶”ì¶œ
      // ë©”ëª¨ë€ì„ ìš°ì„  í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ë‚´ìš©ë€ì—ì„œ ì¶”ì¶œ
      let matchedName = '';
      let matchedPhoneLast4 = '';

      // ë©”ëª¨ë€ì—ì„œ ë¨¼ì € ì‹œë„
      const memoMatch = memo.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
      if (memoMatch && memoMatch[1].trim()) {
        matchedName = memoMatch[1].trim();
        matchedPhoneLast4 = memoMatch[2] || '';
      }

      // ë©”ëª¨ë€ì—ì„œ ì´ë¦„ì„ ëª» ì°¾ì•˜ìœ¼ë©´ ë‚´ìš©ë€ì—ì„œ ì‹œë„
      if (!matchedName) {
        const contentMatch = content.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
        if (contentMatch) {
          matchedName = contentMatch[1].trim();
          matchedPhoneLast4 = contentMatch[2] || '';
        }
      }

      // ì‹ ì²­ì ë§¤ì¹­
      let matchedParticipant = null;
      if (matchedName && matchedPhoneLast4) {
        matchedParticipant = allParticipants.find(function (p) {
          // ì´ë¦„ ë§¤ì¹­: ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš°
          // ë‹¨, í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
          const pName = p.user_name.trim();
          const matchedNameTrimmed = matchedName.trim();

          // ì •í™•íˆ ì¼ì¹˜
          if (pName === matchedNameTrimmed) {
            const phoneLast4 = p.phone.slice(-4);
            return phoneLast4 === matchedPhoneLast4;
          }

          // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ)
          const pNameHasHangul = /[ê°€-í£]/.test(pName);
          const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
          const pNameHasEnglish = /[a-zA-Z]/.test(pName);
          const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

          // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
          if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
            return false;
          }

          // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸
          const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
          if (nameMatch) {
            const phoneLast4 = p.phone.slice(-4);
            return phoneLast4 === matchedPhoneLast4;
          }

          return false;
        });
      }

      // ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ì°¾ê¸° (ì´ë¦„ë§Œìœ¼ë¡œ ë§¤ì¹­, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ëŠ” ë¬´ì‹œ)
      let expectedParticipants = [];
      if (matchedName) {
        expectedParticipants = allParticipants.filter(function (p) {
          const pName = p.user_name.trim();
          const matchedNameTrimmed = matchedName.trim();

          // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš° (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
          if (pName === matchedNameTrimmed) {
            return true;
          }

          // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
          const pNameHasHangul = /[ê°€-í£]/.test(pName);
          const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
          const pNameHasEnglish = /[a-zA-Z]/.test(pName);
          const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

          // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
          if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
            return false;
          }

          // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
          const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
          if (nameMatch) {
            return true;
          }

          return false;
        });
      }

      // ê¸°ì¡´ paymentDataListì—ì„œ í•´ë‹¹ ì¸ë±ìŠ¤ì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìˆëŠ” ê²½ìš°)
      // paymentDataListê°€ ì¶©ë¶„íˆ í¬ì§€ ì•Šìœ¼ë©´ í™•ì¥
      while (paymentDataList.length <= rowIndex) {
        paymentDataList.push({
          date: '',
          type: '',
          amount: '',
          balance: '',
          transactionType: '',
          content: '',
          memo: '',
          matchedName: '',
          matchedPhoneLast4: '',
          matchedParticipant: null,
          expectedParticipants: [],
          approved: false
        });
      }

      const existingItem = paymentDataList[rowIndex] || null;
      const approved = existingItem ? existingItem.approved : false;

      // paymentDataList ì—…ë°ì´íŠ¸ (í•´ë‹¹ ì¸ë±ìŠ¤ë§Œ)
      paymentDataList[rowIndex] = {
        date: date,
        type: type,
        amount: amount,
        balance: balance,
        transactionType: transactionType,
        content: content,
        memo: memo,
        matchedName: matchedName,
        matchedPhoneLast4: matchedPhoneLast4,
        matchedParticipant: matchedParticipant,
        expectedParticipants: expectedParticipants,
        approved: approved
      };

      // í•´ë‹¹ í–‰ë§Œ ì—…ë°ì´íŠ¸
      updateSinglePaymentRow(row, rowIndex, paymentDataList[rowIndex]);

      // localStorageì— ì €ì¥
      savePaymentDataToStorage();
    }

    function updateSinglePaymentRow(row, index, item) {
      if (!row || !item) return;

      // ë§¤ì¹­ ê²°ê³¼ ì…€ ì—…ë°ì´íŠ¸
      // ì…€ ì¸ë±ìŠ¤: 0=ì—°ë²ˆ, 1=ê±°ë˜ì¼ì‹œ, 2=êµ¬ë¶„, 3=ê±°ë˜ê¸ˆì•¡, 4=ê±°ë˜í›„ì”ì•¡, 5=ê±°ë˜êµ¬ë¶„, 6=ë‚´ìš©, 7=ë©”ëª¨, 8=ë§¤ì¹­ëœì‹ ì²­ì, 9=ì˜ˆìƒë˜ëŠ”ì‹ ì²­ì, 10=ë¹„ê³ , 11=ìƒíƒœ, 12=ì‘ì—…
      const matchCell = row.cells[8];
      const expectedCell = row.cells[9];
      const noteCell = row.cells[10];
      const statusCell = row.cells[11];
      const actionCell = row.cells[12];

      if (matchCell) {
        const hasMatch = item.matchedParticipant !== null;
        const hasPhoneLast4 = item.matchedPhoneLast4 !== '';

        if (hasMatch) {
          matchCell.innerHTML = '<div class="text-green-600 font-semibold text-sm">âœ“ ' + item.matchedParticipant.user_name + ' (' + formatPhone(item.matchedParticipant.phone) + ')</div>';
          row.className = '';
        } else if (hasPhoneLast4) {
          matchCell.innerHTML = '<div class="text-red-600 text-sm">âœ— ë§¤ì¹­ë˜ì§€ ì•ŠìŒ (' + item.matchedName + item.matchedPhoneLast4 + ')</div>';
          row.className = 'bg-yellow-50';
        } else {
          matchCell.innerHTML = '<div class="text-orange-600 text-sm">âš  ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ì—†ìŒ</div>';
          row.className = 'bg-yellow-50';
        }
      }

      if (expectedCell) {
        // matchedParticipantê°€ ì—†ì„ ë•Œë§Œ ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì í‘œì‹œ
        if (!item.matchedParticipant && item.expectedParticipants && item.expectedParticipants.length > 0) {
          if (item.expectedParticipants.length === 1) {
            expectedCell.innerHTML = '<div class="text-blue-600 text-sm">' + item.expectedParticipants[0].user_name + ' (' + formatPhone(item.expectedParticipants[0].phone) + ')</div>';
          } else {
            expectedCell.innerHTML = '<div class="text-orange-600 font-semibold text-sm">âš  ë™ëª…ì´ì¸ ë°œìƒ, ì—°ë½ í›„ ì…ê¸ˆí™•ì¸ í•„ìš”</div>';
          }
        } else {
          expectedCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
        }
      }

      if (noteCell) {
        // expectedParticipantsê°€ 2ëª… ì´ìƒì¼ ë•Œë§Œ ë¹„ê³ ë€ í‘œì‹œ
        if (item.expectedParticipants && item.expectedParticipants.length > 1) {
          // ì´ë¯¸ ë§¤ì¹­ëœ ì°¸ê°€ìë¥¼ ì œì™¸í•œ ë™ëª…ì´ì¸ ëª©ë¡
          const unapprovedDuplicates = item.expectedParticipants.filter(function (p) {
            // matchedParticipantê°€ ìˆê³ , ê·¸ ì°¸ê°€ìê°€ ì´ë¯¸ ë§¤ì¹­ëœ ê²½ìš°ëŠ” ì œì™¸
            if (item.matchedParticipant && item.matchedParticipant.id === p.id) {
              return false;
            }
            return true;
          });

          if (unapprovedDuplicates.length > 0) {
            let noteHtml = '<div class="text-sm space-y-2">';
            unapprovedDuplicates.forEach(function (p) {
              noteHtml += '<div class="flex items-center justify-between gap-2 p-2 bg-gray-50 rounded border border-gray-200"><span class="text-gray-700">' + p.user_name + ' (' + formatPhone(p.phone) + ')</span><button onclick="approveDuplicateParticipant(' + index + ', ' + p.id + ')" style="background-color: #22c55e; color: white; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-weight: bold; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; white-space: nowrap;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button></div>';
            });
            noteHtml += '</div>';
            noteCell.innerHTML = noteHtml;
          } else {
            // ëª¨ë“  ë™ëª…ì´ì¸ì´ ë§¤ì¹­ëœ ê²½ìš°
            noteCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
          }
        } else {
          // ë™ëª…ì´ì¸ì´ 2ëª… ë¯¸ë§Œì´ë©´ ë¹„ê³ ë€ ë¹„ìš°ê¸°
          noteCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
        }
      }

      if (statusCell) {
        statusCell.innerHTML = item.approved ? '<span class="text-green-600 font-semibold text-sm">ìŠ¹ì¸ë¨</span>' : '<span class="text-gray-500 text-sm">ëŒ€ê¸°ì¤‘</span>';
      }

      if (actionCell) {
        const approveBtn = !item.approved
          ? '<button onclick="approvePaymentFromTable(' + index + ')" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button>'
          : '<div class="flex items-center gap-2"><span style="background-color: #dcfce7; color: #166534; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; display: inline-block;">âœ“ ìŠ¹ì¸ë¨</span><button onclick="cancelPaymentFromTable(' + index + ')" style="background-color: #fca5a5; color: #991b1b; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#f87171\'" onmouseout="this.style.backgroundColor=\'#fca5a5\'">ì·¨ì†Œ</button></div>';
        const deleteBtn = '<button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#dc2626\'" onmouseout="this.style.backgroundColor=\'#ef4444\'">ì‚­ì œ</button>';
        actionCell.innerHTML = '<div class="flex gap-2">' + approveBtn + deleteBtn + '</div>';
      }
    }

    function removePaymentRowFromTable(button) {
      const row = button.closest('tr');
      if (row && confirm('ì´ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        row.remove();
        // paymentDataListì—ì„œë„ ì œê±°
        const tbody = document.getElementById('paymentTableBody');
        if (tbody) {
          const rows = tbody.querySelectorAll('tr');
          const index = Array.from(rows).indexOf(row);
          if (index >= 0 && paymentDataList[index]) {
            paymentDataList.splice(index, 1);
          }
          // ì—°ë²ˆ ì¬ì •ë ¬
          updatePaymentRowNumbers();
          // localStorageì— ì €ì¥
          savePaymentDataToStorage();
        }
      }
    }

    async function approveDuplicateParticipant(paymentIndex, participantId) {
      const item = paymentDataList[paymentIndex];
      if (!item) return;

      // ì„ íƒí•œ ì°¸ê°€ì ì°¾ê¸°
      const selectedParticipant = allParticipants.find(function (p) {
        return p.id === participantId;
      });

      if (!selectedParticipant) {
        alert('ì°¸ê°€ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ë§¤ì¹­ëœ ì°¸ê°€ìë¡œ ì„¤ì •
      item.matchedParticipant = selectedParticipant;
      item.matchedName = selectedParticipant.user_name;
      item.matchedPhoneLast4 = selectedParticipant.phone.slice(-4);
      // ë™ëª…ì´ì¸ ìŠ¹ì¸ í›„ expectedParticipantsëŠ” ìœ ì§€í•˜ë˜, ë¹„ê³  ë€ì€ matchedParticipantê°€ ìˆìœ¼ë©´ í‘œì‹œë˜ì§€ ì•ŠìŒ

      // ì…ê¸ˆ í™•ì¸ ì²˜ë¦¬
      try {
        const response = await authFetch('/api/admin/participants/' + selectedParticipant.id + '/payment', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_paid: true }),
        });

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }

        item.approved = true;

        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        const tbody = document.getElementById('paymentTableBody');
        if (tbody) {
          const rows = tbody.querySelectorAll('tr');
          if (rows[paymentIndex]) {
            updateSinglePaymentRow(rows[paymentIndex], paymentIndex, item);
          }
        }

        savePaymentDataToStorage();
        alert('ì…ê¸ˆì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (err) {
        console.error('Error approving payment:', err);
        alert(err.message || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function approvePaymentFromTable(index) {
      const item = paymentDataList[index];
      if (!item) return;

      if (!item.matchedParticipant && item.matchedPhoneLast4) {
        if (!confirm('ë§¤ì¹­ëœ ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.\në‚´ìš©: ' + item.content + '\n\nìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
      } else if (!item.matchedPhoneLast4) {
        if (!confirm('ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.\në‚´ìš©: ' + item.content + '\n\nìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
      }

      if (item.matchedParticipant) {
        try {
          console.log('Approving payment for participant:', item.matchedParticipant.id);
          const response = await authFetch('/api/admin/participants/' + item.matchedParticipant.id + '/payment', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_paid: true }),
          });

          const data = await response.json();
          console.log('Payment approval response:', data);

          if (!response.ok || !data.success) {
            throw new Error(data.error || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }

          item.approved = true;

          // ìºì‹œ ë¬´íš¨í™”
          participantsCache = null;
          participantsCacheTime = null;

          // ì „ì²´ ì°¸ê°€ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ë§¤ì¹­ ë° í†µê³„ ë™ê¸°í™”)
          await reloadAllParticipants();

          updatePaymentTableWithMatches();
          savePaymentDataToStorage();

          // ì°¸ê°€ì ê´€ë¦¬ íƒ­ë„ ê°±ì‹ 
          loadParticipants(currentPage, true);

          alert('ì…ê¸ˆì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (err) {
          console.error('Error approving payment:', err);
          alert(err.message || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } else {
        item.approved = true;

        // ì°¸ê°€ì ëª©ë¡ ìƒíƒœ ì—…ë°ì´íŠ¸ (UI ë™ê¸°í™”)
        if (item.matchedParticipant) {
          const participant = allParticipants.find(p => p.id === item.matchedParticipant.id);
          if (participant) {
            participant.is_paid = 1;
          }
        }
        // ìºì‹œ ë¬´íš¨í™”
        participantsCache = null;
        participantsCacheTime = null;

        updatePaymentTableWithMatches();
        savePaymentDataToStorage();
        alert('ìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì°¸ê°€ì ê´€ë¦¬ì—ì„œ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.');
      }
    }

    async function cancelPaymentFromTable(index) {
      const item = paymentDataList[index];
      if (!item) return;

      if (!confirm('ì…ê¸ˆ ìŠ¹ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      if (item.matchedParticipant) {
        try {
          const response = await authFetch('/api/admin/participants/' + item.matchedParticipant.id + '/payment', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_paid: false }),
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || 'ì…ê¸ˆ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }

          item.approved = false;

          // ì°¸ê°€ì ëª©ë¡ ìƒíƒœ ì—…ë°ì´íŠ¸ (UI ë™ê¸°í™”)
          const participant = allParticipants.find(p => p.id === item.matchedParticipant.id);
          if (participant) {
            participant.is_paid = 0;
          }
          // ìºì‹œ ë¬´íš¨í™”
          participantsCache = null;
          participantsCacheTime = null;

          updatePaymentTableWithMatches();
          savePaymentDataToStorage();
          alert('ì…ê¸ˆ ìŠ¹ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (err) {
          console.error('Error canceling payment:', err);
          alert(err.message || 'ì…ê¸ˆ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } else {
        // ë§¤ì¹­ëœ ì°¸ê°€ìê°€ ì—†ëŠ” ê²½ìš° (ìˆ˜ë™ ìŠ¹ì¸ ì·¨ì†Œ)
        item.approved = false;
        updatePaymentTableWithMatches();
        savePaymentDataToStorage();
        alert('ìŠ¹ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    }

    // í…Œì´ë¸”ì— ë¶™ì—¬ë„£ê¸° ì§€ì›
    document.addEventListener('DOMContentLoaded', function () {
      const paymentTable = document.getElementById('paymentTable');
      if (paymentTable) {
        paymentTable.addEventListener('paste', function (e) {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text');
          const rows = paste.split('\n').filter(function (row) { return row.trim(); });

          if (rows.length === 0) return;

          const tbody = document.getElementById('paymentTableBody');
          if (!tbody) return;

          // í˜„ì¬ í¬ì»¤ìŠ¤ëœ ì…€ ì°¾ê¸°
          const activeElement = document.activeElement;
          if (!activeElement || activeElement.tagName !== 'INPUT') return;

          const currentRow = activeElement.closest('tr');
          if (!currentRow) return;

          const currentInputs = currentRow.querySelectorAll('input[type="text"]');
          const startCol = Array.from(currentInputs).indexOf(activeElement);
          if (startCol < 0) return;

          // ì²« ë²ˆì§¸ í–‰ì˜ ì²« ë²ˆì§¸ ì…€ì— ë¶™ì—¬ë„£ì„ ë•ŒëŠ” í•­ìƒ ì²« ë²ˆì§¸ ì—´ë¶€í„° ì‹œì‘
          const isFirstCell = startCol === 0 && currentRow === tbody.querySelector('tr:first-child');
          const actualStartCol = isFirstCell ? 0 : startCol;

          rows.forEach(function (row, rowIndex) {
            // íƒ­ìœ¼ë¡œ êµ¬ë¶„ (ì—‘ì…€ì€ íƒ­ìœ¼ë¡œ êµ¬ë¶„)
            const values = row.split('\t').map(function (v) { return v.trim(); });

            // ë¹ˆ í–‰ì€ ê±´ë„ˆë›°ê¸°
            if (values.length === 0 || (values.length === 1 && !values[0])) return;

            let targetRow = currentRow;
            if (rowIndex > 0 || (rowIndex === 0 && isFirstCell)) {
              // ì²« ë²ˆì§¸ í–‰ì˜ ì²« ë²ˆì§¸ ì…€ì— ë¶™ì—¬ë„£ì„ ë•ŒëŠ” ìƒˆ í–‰ë¶€í„° ì‹œì‘
              if (rowIndex === 0 && isFirstCell) {
                // ì²« ë²ˆì§¸ í–‰ì€ í˜„ì¬ í–‰ì— ë®ì–´ì“°ê¸°
                targetRow = currentRow;
              } else if (rowIndex > 0) {
                // ìƒˆ í–‰ ì¶”ê°€
                const newRow = currentRow.cloneNode(true);
                const newInputs = newRow.querySelectorAll('input[type="text"]');
                newInputs.forEach(function (input) { input.value = ''; });
                // ë§¤ì¹­ ê²°ê³¼ ì…€ë“¤ë„ ì´ˆê¸°í™” (ë¹„ê³  ì—´ ì¶”ê°€ë¡œ ì¸ë±ìŠ¤ ë³€ê²½)
                const newCells = newRow.querySelectorAll('td');
                if (newCells.length >= 13) {
                  newCells[8].innerHTML = '<span class="text-sm text-gray-400">-</span>';
                  newCells[9].innerHTML = '<span class="text-sm text-gray-400">-</span>';
                  newCells[10].innerHTML = '<span class="text-sm text-gray-400">-</span>';
                  newCells[11].innerHTML = '<span class="text-sm text-gray-400">ëŒ€ê¸°ì¤‘</span>';
                  newCells[12].innerHTML = '<div class="flex gap-2"><button onclick="approvePaymentFromTable(' + (paymentDataList.length) + ')" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button><button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#dc2626\'" onmouseout="this.style.backgroundColor=\'#ef4444\'">ì‚­ì œ</button></div>';
                }
                tbody.appendChild(newRow);
                targetRow = newRow;
              }
            }

            const inputs = targetRow.querySelectorAll('input[type="text"]');
            values.forEach(function (value, colIndex) {
              const targetCol = actualStartCol + colIndex;
              if (targetCol < inputs.length && value) {
                inputs[targetCol].value = value;
                // ë‚´ìš© í•„ë“œ(ì¸ë±ìŠ¤ 5) ë³€ê²½ ì‹œ ìë™ ë§¤ì¹­
                if (targetCol === 5) {
                  reMatchPaymentFromInput(inputs[targetCol]);
                }
              }
            });
          });

          // ì—°ë²ˆ ì¬ì •ë ¬
          updatePaymentRowNumbers();

          // ë§ˆì§€ë§‰ í–‰ì˜ ë‚´ìš© í•„ë“œì—ì„œ ìë™ ë§¤ì¹­ ì‹¤í–‰
          setTimeout(function () {
            parsePaymentDataFromTable();
            // localStorageì— ì €ì¥
            savePaymentDataToStorage();
          }, 100);
        });
      }
    });

    async function parsePaymentData() {
      const input = document.getElementById('paymentDataInput');
      if (!input) {
        alert('ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const inputValue = input.value.trim();
      if (!inputValue) {
        alert('ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ì°¸ê°€ì ëª©ë¡ ë¡œë“œ
      try {
        const response = await authFetch('/api/admin/participants');
        const data = await response.json();
        if (data.success) {
          allParticipants = data.participants || [];
        }
      } catch (err) {
        console.error('Error loading participants:', err);
        alert('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      // ë°ì´í„° íŒŒì‹± (íƒ­ ë˜ëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„)
      const lines = inputValue.split('\n').filter(line => line.trim());
      if (lines.length < 2) {
        alert('í—¤ë”ì™€ ìµœì†Œ 1ê°œì˜ ë°ì´í„° í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      // í—¤ë” íŒŒì‹±
      const headerLine = lines[0];
      const headers = headerLine.split(/\t|,/).map(h => h.trim());

      // í—¤ë” ì¸ë±ìŠ¤ ì°¾ê¸°
      const headerMap = {};
      headers.forEach(function (h, i) {
        if (h.includes('ê±°ë˜ì¼ì‹œ') || h.includes('ì¼ì‹œ')) headerMap.date = i;
        if (h.includes('êµ¬ë¶„')) headerMap.type = i;
        if (h.includes('ê±°ë˜ê¸ˆì•¡') || h.includes('ê¸ˆì•¡')) headerMap.amount = i;
        if (h.includes('ê±°ë˜ í›„ ì”ì•¡') || h.includes('ì”ì•¡')) headerMap.balance = i;
        if (h.includes('ê±°ë˜êµ¬ë¶„')) headerMap.transactionType = i;
        if (h.includes('ë‚´ìš©')) headerMap.content = i;
        if (h.includes('ë©”ëª¨')) headerMap.memo = i;
      });

      if (headerMap.content === undefined) {
        alert('"ë‚´ìš©" ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í—¤ë”ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ë°ì´í„° í–‰ íŒŒì‹±
      paymentDataList = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(/\t|,/).map(function (v) { return v.trim(); });
        if (values.length < headers.length) continue;

        const content = values[headerMap.content] || '';
        const memo = headerMap.memo !== undefined ? (values[headerMap.memo] || '') : '';

        // ë©”ëª¨ë€ì—ì„œ ë¨¼ì € ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ 4ê°œ ì¶”ì¶œ ì‹œë„
        // í˜•ì‹: "ì´ë¦„0000" ë˜ëŠ” "ì´ë¦„ 0000" ë“±
        let matchedName = '';
        let matchedPhoneLast4 = '';

        // ë©”ëª¨ë€ì—ì„œ ë¨¼ì € ì‹œë„ (ì• ê³µë°± ë¬´ì‹œ)
        const memoTrimmed = memo.trim();
        const memoMatch = memoTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
        if (memoMatch && memoMatch[1].trim()) {
          matchedName = memoMatch[1].trim();
          matchedPhoneLast4 = memoMatch[2] || '';
        }

        // ë©”ëª¨ë€ì—ì„œ ì´ë¦„ì„ ëª» ì°¾ì•˜ìœ¼ë©´ ë‚´ìš©ë€ì—ì„œ ì‹œë„ (ì• ê³µë°± ë¬´ì‹œ)
        if (!matchedName) {
          const contentTrimmed = content.trim();
          const contentMatch = contentTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
          if (contentMatch) {
            matchedName = contentMatch[1].trim();
            matchedPhoneLast4 = contentMatch[2] || '';
          }
        }

        // ì‹ ì²­ì ë§¤ì¹­
        let matchedParticipant = null;
        if (matchedName && matchedPhoneLast4) {
          matchedParticipant = allParticipants.find(function (p) {
            // ì´ë¦„ ë§¤ì¹­: ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš°
            // ë‹¨, í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();

            // ì •í™•íˆ ì¼ì¹˜
            if (pName === matchedNameTrimmed) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }

            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }

            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }

            return false;
          });
        }

        // ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ì°¾ê¸° (ì´ë¦„ë§Œìœ¼ë¡œ ë§¤ì¹­, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ëŠ” ë¬´ì‹œ)
        let expectedParticipants = [];
        if (matchedName) {
          expectedParticipants = allParticipants.filter(function (p) {
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();

            // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš° (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            if (pName === matchedNameTrimmed) {
              return true;
            }

            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }

            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              return true;
            }

            return false;
          });
        }

        paymentDataList.push({
          date: values[headerMap.date] || '',
          type: values[headerMap.type] || '',
          amount: values[headerMap.amount] || '',
          balance: values[headerMap.balance] || '',
          transactionType: values[headerMap.transactionType] || '',
          content: content,
          memo: values[headerMap.memo] || '',
          matchedName: matchedName,
          matchedPhoneLast4: matchedPhoneLast4,
          matchedParticipant: matchedParticipant,
          expectedParticipants: expectedParticipants,
          approved: false
        });
      }

      displayPaymentData();
    }

    function displayPaymentData() {
      const container = document.getElementById('paymentResults');
      const tbody = document.getElementById('paymentTableBody');

      if (!container || !tbody) return;

      container.classList.remove('hidden');
      tbody.innerHTML = '';

      paymentDataList.forEach(function (item, index) {
        const row = document.createElement('tr');
        const hasMatch = item.matchedParticipant !== null;
        const hasPhoneLast4 = item.matchedPhoneLast4 !== '';
        const rowClass = hasMatch ? '' : 'bg-yellow-50';

        row.className = rowClass;
        row.innerHTML = `
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.date || ''}" onchange="updatePaymentData(${index}, 'date', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.type || ''}" onchange="updatePaymentData(${index}, 'type', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.amount || ''}" onchange="updatePaymentData(${index}, 'amount', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.balance || ''}" onchange="updatePaymentData(${index}, 'balance', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.transactionType || ''}" onchange="updatePaymentData(${index}, 'transactionType', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.content || ''}" onchange="updatePaymentData(${index}, 'content', this.value); reMatchPayment(${index})" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.memo || ''}" onchange="updatePaymentData(${index}, 'memo', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${hasMatch ? `
              <div class="text-green-600 font-semibold text-sm">
                âœ“ ${item.matchedParticipant.user_name} (${formatPhone(item.matchedParticipant.phone)})
              </div>
            ` : hasPhoneLast4 ? `
              <div class="text-red-600 text-sm">
                âœ— ë§¤ì¹­ë˜ì§€ ì•ŠìŒ (${item.matchedName}${item.matchedPhoneLast4})
              </div>
            ` : `
              <div class="text-orange-600 text-sm">
                âš  ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ì—†ìŒ
              </div>
            `}
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${item.approved ? '<span class="text-green-600 font-semibold text-sm">ìŠ¹ì¸ë¨</span>' : '<span class="text-gray-500 text-sm">ëŒ€ê¸°ì¤‘</span>'}
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${!item.approved ? `
              <button onclick="approvePayment(${index})" class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">
                ìŠ¹ì¸
              </button>
            ` : `
              <span class="text-green-600">âœ“</span>
            `}
            <button onclick="removePaymentRow(${index})" class="ml-1 px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs">
              ì‚­ì œ
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function updatePaymentData(index, field, value) {
      if (paymentDataList[index]) {
        paymentDataList[index][field] = value;
      }
    }

    function reMatchPayment(index) {
      const item = paymentDataList[index];
      if (!item) return;

      const content = item.content || '';
      const nameMatch = content.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
      let matchedName = '';
      let matchedPhoneLast4 = '';

      if (nameMatch) {
        matchedName = nameMatch[1].trim();
        matchedPhoneLast4 = nameMatch[2] || '';
      }

      let matchedParticipant = null;
      if (matchedName && matchedPhoneLast4) {
        matchedParticipant = allParticipants.find(function (p) {
          const nameMatch = p.user_name === matchedName || p.user_name.includes(matchedName) || matchedName.includes(p.user_name);
          const phoneLast4 = p.phone.slice(-4);
          return nameMatch && phoneLast4 === matchedPhoneLast4;
        });
      }

      item.matchedName = matchedName;
      item.matchedPhoneLast4 = matchedPhoneLast4;
      item.matchedParticipant = matchedParticipant;
      item.approved = false;

      displayPaymentData();
    }

    function addPaymentRow() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;

      const rowCount = tbody.querySelectorAll('tr').length;
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td class="border border-gray-300 px-2 py-1 text-sm text-center text-gray-500">${rowCount + 1}</td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
        <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
        <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
        <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">ëŒ€ê¸°ì¤‘</td>
        <td class="border border-gray-300 px-2 py-2">
          <div class="flex gap-2">
            <button onclick="approvePaymentFromTable(${rowCount})" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#16a34a'" onmouseout="this.style.backgroundColor='#22c55e'">ìŠ¹ì¸</button>
            <button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">ì‚­ì œ</button>
          </div>
        </td>
      `;
      tbody.appendChild(newRow);

      // paymentDataListì— ë¹ˆ í•­ëª© ì¶”ê°€
      paymentDataList.push({
        date: '',
        type: '',
        amount: '',
        balance: '',
        transactionType: '',
        content: '',
        memo: '',
        matchedName: '',
        matchedPhoneLast4: '',
        matchedParticipant: null,
        expectedParticipants: [],
        approved: false
      });

      // ìƒˆ í–‰ì˜ ì²« ë²ˆì§¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
      const inputs = newRow.querySelectorAll('input');
      if (inputs.length > 0) inputs[0].focus();

      // ì—°ë²ˆ ì¬ì •ë ¬
      updatePaymentRowNumbers();
      // localStorageì— ì €ì¥
      savePaymentDataToStorage();
    }

    function updatePaymentRowNumbers() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;

      const rows = tbody.querySelectorAll('tr');
      rows.forEach(function (row, index) {
        const numberCell = row.cells[0];
        if (numberCell) {
          numberCell.textContent = index + 1;
        }
      });
    }

    function resetPaymentTable() {
      if (!confirm('ì…ê¸ˆ ë‚´ì—­ì„ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) {
        return;
      }

      paymentDataList = [];
      localStorage.removeItem('paymentDataList');
      const tbody = document.getElementById('paymentTableBody');
      if (tbody) {
        tbody.innerHTML = `
          <tr>
            <td class="border border-gray-300 px-2 py-1 text-sm text-center text-gray-500">1</td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
            <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
            <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">ëŒ€ê¸°ì¤‘</td>
            <td class="border border-gray-300 px-2 py-2">
              <div class="flex gap-2">
                <button onclick="approvePaymentFromTable(0)" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#16a34a'" onmouseout="this.style.backgroundColor='#22c55e'">ìŠ¹ì¸</button>
                <button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">ì‚­ì œ</button>
              </div>
            </td>
          </tr>
        `;
      }
    }

    function removePaymentRow(index) {
      if (confirm('ì´ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        paymentDataList.splice(index, 1);
        displayPaymentData();
      }
    }

    async function approvePayment(index) {
      const item = paymentDataList[index];
      if (!item) return;

      if (!item.matchedParticipant && item.matchedPhoneLast4) {
        // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° í™•ì¸
        if (!confirm('ë§¤ì¹­ëœ ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.\në‚´ìš©: ' + item.content + '\n\nìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
      } else if (!item.matchedPhoneLast4) {
        // ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ê°€ ì—†ëŠ” ê²½ìš° í™•ì¸
        if (!confirm('ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.\në‚´ìš©: ' + item.content + '\n\nìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
      }

      if (item.matchedParticipant) {
        // ë§¤ì¹­ëœ ì°¸ê°€ìì˜ ì…ê¸ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
        try {
          const response = await authFetch('/api/admin/participants/' + item.matchedParticipant.id + '/payment', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_paid: true }),
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }

          item.approved = true;

          // ìºì‹œ ë¬´íš¨í™” ë° ì „ì²´ ì°¸ê°€ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          participantsCache = null;
          participantsCacheTime = null;
          await reloadAllParticipants();

          displayPaymentData();
          loadParticipants(currentPage, true);
          alert('ì…ê¸ˆì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (err) {
          console.error('Error approving payment:', err);
          const errorMessage = err.message || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          alert(errorMessage);
        }
      } else {
        // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° ìˆ˜ë™ ìŠ¹ì¸
        item.approved = true;
        displayPaymentData();
        alert('ìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì°¸ê°€ì ê´€ë¦¬ì—ì„œ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.');
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê·¸ë£¹ í‘œì‹œ ì—…ë°ì´íŠ¸
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function () {
        updateGroupDisplay();
      });
    } else {
      updateGroupDisplay();
    }

    // QR ì²´í¬ì¸ ê´€ë ¨ ë³€ìˆ˜
    let html5QrCode = null;
    let recentCheckins = [];
    let barcodeScannerTimeout = null;
    let isProcessingBarcode = false;

    // ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì´ˆê¸°í™”
    function initBarcodeScanner() {
      const scannerInput = document.getElementById('barcodeScannerInput');
      if (!scannerInput) return;

      // ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì…ë ¥ ì²˜ë¦¬ (Enter í‚¤ ë˜ëŠ” íƒ€ì´ë¨¸)
      scannerInput.addEventListener('input', function(e) {
        // ì´ì „ íƒ€ì´ë¨¸ ì·¨ì†Œ
        if (barcodeScannerTimeout) {
          clearTimeout(barcodeScannerTimeout);
        }

        // 50ms í›„ì— ìë™ ì²˜ë¦¬ (ë°”ì½”ë“œ ìŠ¤ìºë„ˆëŠ” ë¹ ë¥´ê²Œ ì…ë ¥ í›„ ì™„ë£Œë¨)
        barcodeScannerTimeout = setTimeout(() => {
          if (scannerInput.value.trim() && !isProcessingBarcode) {
            processBarcodeInput();
          }
        }, 100);
      });

      // Enter í‚¤ ì²˜ë¦¬
      scannerInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (barcodeScannerTimeout) {
            clearTimeout(barcodeScannerTimeout);
          }
          if (scannerInput.value.trim() && !isProcessingBarcode) {
            processBarcodeInput();
          }
        }
      });

      // í¬ì»¤ìŠ¤ ìœ ì§€
      scannerInput.addEventListener('blur', function() {
        const autoFocus = document.getElementById('autoFocusScanner');
        if (autoFocus && autoFocus.checked) {
          setTimeout(() => {
            scannerInput.focus();
          }, 100);
        }
      });

      // ì´ˆê¸° í¬ì»¤ìŠ¤
      setTimeout(() => scannerInput.focus(), 500);
    }

    // ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì…ë ¥ ì²˜ë¦¬
    async function processBarcodeInput() {
      const scannerInput = document.getElementById('barcodeScannerInput');
      const statusEl = document.getElementById('scannerStatus');
      const qrData = scannerInput.value.trim();

      if (!qrData || isProcessingBarcode) return;

      isProcessingBarcode = true;
      statusEl.textContent = 'ì²˜ë¦¬ ì¤‘...';
      statusEl.className = 'text-sm text-yellow-600 font-medium';

      try {
        await processCheckin(qrData);
        statusEl.textContent = 'ìŠ¤ìº” ì„±ê³µ!';
        statusEl.className = 'text-sm text-green-600 font-medium';

        // ì„±ê³µ í›„ 3ì´ˆ ë’¤ ëŒ€ê¸° ìƒíƒœë¡œ
        setTimeout(() => {
          statusEl.textContent = 'ëŒ€ê¸° ì¤‘...';
          statusEl.className = 'text-sm text-green-600 font-medium';
        }, 3000);
      } catch (err) {
        statusEl.textContent = 'ìŠ¤ìº” ì‹¤íŒ¨: ' + (err.message || 'ì˜¤ë¥˜ ë°œìƒ');
        statusEl.className = 'text-sm text-red-600 font-medium';

        setTimeout(() => {
          statusEl.textContent = 'ëŒ€ê¸° ì¤‘...';
          statusEl.className = 'text-sm text-green-600 font-medium';
        }, 3000);
      } finally {
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ë° í¬ì»¤ìŠ¤
        scannerInput.value = '';
        scannerInput.focus();
        isProcessingBarcode = false;
      }
    }

    // í˜„ì¬ ì¸ì‡„ ì¤‘ì¸ì§€ ì¶”ì  (ë¬´í•œ ì¸ì‡„ ë°©ì§€)
    let isPrinting = false;
    let printQueue = [];

    // ì¸ì‡„ ì™„ë£Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•œ ë²ˆë§Œ ë“±ë¡)
    window.addEventListener('afterprint', function() {
      console.log('Print completed or cancelled');
      isPrinting = false;

      // íì— ëŒ€ê¸° ì¤‘ì¸ ì¸ì‡„ê°€ ìˆìœ¼ë©´ ë‹¤ìŒ ì¸ì‡„ ì‹¤í–‰
      if (printQueue.length > 0) {
        const next = printQueue.shift();
        setTimeout(() => printCheckinLabel(next.name, next.seat), 500);
      }
    });

    // ë„¤ëª¨ë‹‰ í”„ë¦°í„°ë¡œ ì´ë¦„í‘œ ì¶œë ¥
    function printCheckinLabel(name, seat) {
      // ì´ë¯¸ ì¸ì‡„ ì¤‘ì´ë©´ íì— ì¶”ê°€
      if (isPrinting) {
        console.log('Already printing, adding to queue...');
        // ì¤‘ë³µ ë°©ì§€: ê°™ì€ ì´ë¦„ì´ íì— ì—†ì„ ë•Œë§Œ ì¶”ê°€
        if (!printQueue.some(p => p.name === name && p.seat === seat)) {
          printQueue.push({ name, seat });
        }
        return;
      }

      isPrinting = true;

      // í”„ë¦°íŠ¸ ì˜ì—­ ì—…ë°ì´íŠ¸
      const printName = document.getElementById('printName');
      const printSeat = document.getElementById('printSeat');

      if (printName && printSeat) {
        printName.textContent = name;
        printSeat.textContent = seat || 'ì¢Œì„ ë¯¸ë°°ì •';
      }

      // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ì¸ì‡„ ì‹¤í–‰
      setTimeout(() => {
        window.print();
      }, 100);
    }

    // ì²´í¬ì¸ íŒì—… ì—´ê¸°
    function openCheckinPopup() {
      // adminToken ë³€ìˆ˜ ë˜ëŠ” sessionStorageì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
      const token = adminToken || sessionStorage.getItem('adminToken') || '';
      if (!token) {
        alert('ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        return;
      }
      const url = `/checkin.html?token=${encodeURIComponent(token)}`;
      const popup = window.open(url, 'checkin_popup', 'width=800,height=900,scrollbars=yes,resizable=yes');
      if (popup) {
        popup.focus();
      } else {
        alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”.');
      }
    }

    // ì²´í¬ì¸ í†µê³„ ë¡œë“œ
    // ì „ì²´ ì²´í¬ì¸ ì´ˆê¸°í™”
    async function resetAllCheckins() {
      const checkedInCount = document.getElementById('checkinCount').textContent;

      if (!confirm(`ì •ë§ë¡œ ëª¨ë“  ì²´í¬ì¸ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní˜„ì¬ ì²´í¬ì¸ëœ ì¸ì›: ${checkedInCount}ëª…\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
      }

      // ì´ì¤‘ í™•ì¸
      const confirmText = prompt('ì •ë§ë¡œ ì´ˆê¸°í™”í•˜ë ¤ë©´ "ì´ˆê¸°í™”"ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (confirmText !== 'ì´ˆê¸°í™”') {
        alert('ì´ˆê¸°í™”ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        return;
      }

      try {
        const response = await authFetch('/api/admin/checkin/reset-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ confirmToken: 'RESET_ALL_CHECKINS_CONFIRM' })
        });

        const data = await response.json();

        if (data.success) {
          alert(data.message);
          // í†µê³„ ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          loadCheckinStats();
          recentCheckins = [];
          displayRecentCheckins();
          // ì°¸ê°€ì ëª©ë¡ë„ ê°±ì‹ 
          participantsCache = null;
          participantsCacheTime = null;
          loadParticipants(currentPage, true);
        } else {
          throw new Error(data.error || 'ì´ˆê¸°í™” ì‹¤íŒ¨');
        }
      } catch (err) {
        console.error('Error resetting all check-ins:', err);
        alert('ì²´í¬ì¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
      }
    }

    async function loadCheckinStats() {
      try {
        const response = await authFetch('/api/admin/checkin/stats');
        const data = await response.json();

        if (data.success) {
          document.getElementById('checkinTotal').textContent = data.stats.total;
          document.getElementById('checkinCount').textContent = data.stats.checkedIn;
          document.getElementById('checkinRemaining').textContent = data.stats.remaining;
        }
      } catch (err) {
        console.error('Error loading check-in stats:', err);
      }
    }

    // QR ìŠ¤ìºë„ˆ ì‹œì‘
    async function startQRScanner() {
      const qrReader = document.getElementById('qrReader');
      const startBtn = document.getElementById('startScannerBtn');
      const stopBtn = document.getElementById('stopScannerBtn');
      const container = document.getElementById('qrScannerContainer');

      if (!qrReader || !container) {
        alert('QR ìŠ¤ìºë„ˆ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // html5-qrcode ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
      if (typeof Html5Qrcode === 'undefined') {
        alert('QR ìŠ¤ìºë„ˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        // ì»¨í…Œì´ë„ˆ ë¨¼ì € í‘œì‹œ
        container.classList.remove('hidden');
        startBtn.classList.add('hidden');
        stopBtn.classList.remove('hidden');

        // qrReader ë‚´ìš© ì´ˆê¸°í™”
        qrReader.innerHTML = '';

        // html5-qrcode ì´ˆê¸°í™”
        html5QrCode = new Html5Qrcode('qrReader');

        // ì¹´ë©”ë¼ ì‹œì‘
        await html5QrCode.start(
          { facingMode: 'environment' }, // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          (decodedText, decodedResult) => {
            // QR ì½”ë“œ ìŠ¤ìº” ì„±ê³µ
            handleQRScan(decodedText);
          },
          (errorMessage) => {
            // ìŠ¤ìº” ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œ)
            // console.log('Scan error:', errorMessage);
          }
        );
      } catch (err) {
        console.error('Error starting QR scanner:', err);
        // ì—ëŸ¬ ë°œìƒ ì‹œ UI ë³µì›
        container.classList.add('hidden');
        startBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');

        if (html5QrCode) {
          try {
            await html5QrCode.stop();
            html5QrCode.clear();
            html5QrCode = null;
          } catch (e) {
            // ë¬´ì‹œ
          }
        }

        let errorMsg = 'ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.';
        if (err.message && err.message.includes('Permission')) {
          errorMsg = 'ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
        } else if (err.message && err.message.includes('NotFound')) {
          errorMsg = 'ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
        }
        alert(errorMsg);
      }
    }

    // QR ìŠ¤ìºë„ˆ ì¤‘ì§€
    async function stopQRScanner() {
      const container = document.getElementById('qrScannerContainer');
      const startBtn = document.getElementById('startScannerBtn');
      const stopBtn = document.getElementById('stopScannerBtn');

      if (html5QrCode) {
        try {
          await html5QrCode.stop();
          html5QrCode.clear();
          html5QrCode = null;
        } catch (err) {
          console.error('Error stopping QR scanner:', err);
        }
      }

      if (container) {
        container.classList.add('hidden');
        // qrReader ë‚´ìš© ì´ˆê¸°í™”
        const qrReader = document.getElementById('qrReader');
        if (qrReader) qrReader.innerHTML = '';
      }
      if (startBtn) startBtn.classList.remove('hidden');
      if (stopBtn) stopBtn.classList.add('hidden');
    }

    // QR ì½”ë“œ ìŠ¤ìº” ì²˜ë¦¬
    async function handleQRScan(qrData) {
      // ìŠ¤ìº” ì¤‘ì§€ (ì¤‘ë³µ ìŠ¤ìº” ë°©ì§€)
      await stopQRScanner();

      // ì²´í¬ì¸ ì²˜ë¦¬
      await processCheckin(qrData);
    }

    // ìˆ˜ë™ ì…ë ¥ ì²˜ë¦¬
    async function processManualCheckin() {
      const input = document.getElementById('manualQRInput');
      if (!input || !input.value.trim()) {
        alert('QR ì½”ë“œ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      await processCheckin(input.value.trim());
      input.value = '';
    }

    // ì²´í¬ì¸ ì²˜ë¦¬
    async function processCheckin(qrData) {
      const resultDiv = document.getElementById('checkinResult');
      if (!resultDiv) return;

      resultDiv.classList.remove('hidden');
      resultDiv.innerHTML = '<p class="text-gray-600">ì²˜ë¦¬ ì¤‘...</p>';
      resultDiv.className = 'mb-4 p-4 rounded-lg bg-gray-50';

      // QR ë°ì´í„° ê²€ì¦
      if (!qrData || !qrData.trim()) {
        resultDiv.className = 'mb-4 p-4 rounded-lg bg-red-50 border border-red-200';
        resultDiv.innerHTML = '<p class="font-semibold text-red-900">QR ì½”ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      try {
        // í•œê¸€ ìíŒ -> ì˜ë¬¸ ìíŒ ë³€í™˜ ë§µ
        const korToEngMap = {
          'ã…‚': 'q', 'ã…ˆ': 'w', 'ã„·': 'e', 'ã„±': 'r', 'ã……': 't', 'ã…›': 'y', 'ã…•': 'u', 'ã…‘': 'i', 'ã…': 'o', 'ã…”': 'p',
          'ã…': 'a', 'ã„´': 's', 'ã…‡': 'd', 'ã„¹': 'f', 'ã…': 'g', 'ã…—': 'h', 'ã…“': 'j', 'ã…': 'k', 'ã…£': 'l',
          'ã…‹': 'z', 'ã…Œ': 'x', 'ã…Š': 'c', 'ã…': 'v', 'ã… ': 'b', 'ã…œ': 'n', 'ã…¡': 'm',
          'ã…ƒ': 'Q', 'ã…‰': 'W', 'ã„¸': 'E', 'ã„²': 'R', 'ã…†': 'T', 'ã…’': 'O', 'ã…–': 'P'
        };

        // í•œê¸€ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì˜ë¬¸ìœ¼ë¡œ ë³€í™˜
        let convertedData = qrData;
        if (/[ã„±-ã…ã…-ã…£]/.test(qrData)) {
          convertedData = qrData.split('').map(char => korToEngMap[char] || char).join('');
          console.log('Converted Korean to English:', qrData, '->', convertedData);
        }

        // QR ë°ì´í„°ê°€ JSON ë¬¸ìì—´ì¸ì§€ í™•ì¸
        let qrDataToSend = convertedData;
        try {
          // ì´ë¯¸ JSON ë¬¸ìì—´ì¸ì§€ í™•ì¸
          JSON.parse(convertedData);
          qrDataToSend = convertedData;
        } catch (e) {
          // JSONì´ ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ ì „ì†¡ (ì„œë²„ì—ì„œ ì²˜ë¦¬)
          qrDataToSend = convertedData;
        }

        console.log('Sending QR data:', qrDataToSend);

        const response = await authFetch('/api/admin/checkin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ qrData: qrDataToSend })
        });

        const data = await response.json();

        console.log('Check-in response:', data);

        if (response.ok && data.success) {
          // ì„±ê³µ
          resultDiv.className = 'mb-4 p-4 rounded-lg bg-green-50 border border-green-200';
          if (data.alreadyCheckedIn) {
            resultDiv.innerHTML = `
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <div>
                  <p class="font-semibold text-green-900">${data.message}</p>
                  <p class="text-sm text-green-700">${data.participant.user_name} (${data.participant.phone})</p>
                </div>
              </div>
            `;
          } else {
            resultDiv.innerHTML = `
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <div>
                  <p class="font-semibold text-green-900">${data.message}</p>
                  <p class="text-sm text-green-700">${data.participant.user_name} (${data.participant.phone})</p>
                </div>
              </div>
            `;
          }

          // ìµœê·¼ ì²´í¬ì¸ ëª©ë¡ì— ì¶”ê°€
          addToRecentCheckins(data.participant, data.alreadyCheckedIn);

          // í†µê³„ ì—…ë°ì´íŠ¸
          loadCheckinStats();

          // ìë™ í”„ë¦°íŠ¸ (ì´ë¯¸ ì²´í¬ì¸ëœ ê²½ìš°ëŠ” í”„ë¦°íŠ¸í•˜ì§€ ì•ŠìŒ)
          const autoPrint = document.getElementById('autoPrintCheckin');
          if (autoPrint && autoPrint.checked && !data.alreadyCheckedIn) {
            const seatInfo = data.participant.seat_full || 'ì¢Œì„ ë¯¸ë°°ì •';
            printCheckinLabel(data.participant.user_name, seatInfo);
          }

          // 3ì´ˆ í›„ ë©”ì‹œì§€ ìë™ ìˆ¨ê¹€
          setTimeout(() => {
            resultDiv.classList.add('hidden');
          }, 3000);
        } else {
          // ì‹¤íŒ¨
          resultDiv.className = 'mb-4 p-4 rounded-lg bg-red-50 border border-red-200';
          const errorMsg = data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          resultDiv.innerHTML = `
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
              </svg>
              <div>
                <p class="font-semibold text-red-900">${errorMsg}</p>
                ${data.participant ? `<p class="text-sm text-red-700">${data.participant.user_name} (${data.participant.phone})</p>` : ''}
                <p class="text-xs text-red-600 mt-1">QR ë°ì´í„°: ${qrData.substring(0, 100)}...</p>
              </div>
            </div>
          `;
        }
      } catch (err) {
        console.error('Error processing check-in:', err);
        resultDiv.className = 'mb-4 p-4 rounded-lg bg-red-50 border border-red-200';
        resultDiv.innerHTML = `
          <div>
            <p class="font-semibold text-red-900">ì²´í¬ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
            <p class="text-sm text-red-700 mt-1">${err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
            <p class="text-xs text-red-600 mt-1">QR ë°ì´í„°: ${qrData.substring(0, 100)}...</p>
          </div>
        `;
      }
    }

    // ìµœê·¼ ì²´í¬ì¸ ëª©ë¡ì— ì¶”ê°€
    function addToRecentCheckins(participant, alreadyCheckedIn) {
      const recentDiv = document.getElementById('recentCheckins');
      if (!recentDiv) return;

      const checkinItem = {
        participant: participant,
        timestamp: new Date().toLocaleString('ko-KR'),
        alreadyCheckedIn: alreadyCheckedIn
      };

      recentCheckins.unshift(checkinItem);
      if (recentCheckins.length > 10) {
        recentCheckins = recentCheckins.slice(0, 10);
      }

      displayRecentCheckins();
    }

    // ìµœê·¼ ì²´í¬ì¸ ë‚´ì—­ í‘œì‹œ
    function displayRecentCheckins() {
      const recentDiv = document.getElementById('recentCheckins');
      if (!recentDiv) return;

      if (recentCheckins.length === 0) {
        recentDiv.innerHTML = '<p class="text-sm text-gray-500 text-center">ì²´í¬ì¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      } else {
        recentDiv.innerHTML = recentCheckins.map(item => `
          <div class="p-3 bg-white rounded-lg border border-gray-200 flex items-center justify-between">
            <div>
              <p class="font-semibold text-gray-900">${item.participant.user_name}</p>
              <p class="text-sm text-gray-600">${item.participant.seat_full || ''} â€¢ ${item.timestamp}</p>
            </div>
            ${item.alreadyCheckedIn ?
            '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">ì¤‘ë³µ</span>' :
            '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">ì™„ë£Œ</span>'
          }
          </div>
        `).join('');
      }
    }

    // ì„œë²„ì—ì„œ ìµœê·¼ ì²´í¬ì¸ ê¸°ë¡ ë¡œë“œ
    async function loadRecentCheckins() {
      try {
        const response = await authFetch('/api/admin/checkin/recent?limit=20');
        const data = await response.json();

        if (data.success && data.records) {
          recentCheckins = data.records.map(record => ({
            participant: {
              id: record.participant_id,
              user_name: record.user_name,
              phone: record.phone,
              seat_full: record.seat_full
            },
            timestamp: new Date(record.checked_in_at).toLocaleString('ko-KR'),
            alreadyCheckedIn: false
          }));
          displayRecentCheckins();
        }
      } catch (err) {
        console.error('Error loading recent checkins:', err);
      }
    }
  </script>

  <!-- í”„ë¦°íŠ¸ ì˜ì—­ (ë„¤ëª¨ë‹‰ 3x3 ìš©ì§€ìš©) -->
  <div id="printArea">
    <div class="label-content" style="text-align: center; font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;">
      <p id="printName" class="print-name"></p>
      <p id="printSeat" class="print-seat"></p>
      <hr class="print-divider" />
      <p class="print-event">í•œë™í›ˆ í† í¬ì½˜ì„œíŠ¸</p>
    </div>
  </div>
</body>

</html>