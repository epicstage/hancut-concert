<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê´€ë¦¬ì í˜ì´ì§€ - í•œë™í›ˆ í† í¬ì½˜ì„œíŠ¸</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS for Excel Export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#dc2626',
            'primary-dark': '#b91c1c',
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="/styles.css?v=3" />
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    /* í”„ë¦°íŠ¸ ì „ìš© ìŠ¤íƒ€ì¼ - ë„¤ëª¨ë‹‰ 3x3 ìš©ì§€ (ì•½ 76mm x 76mm) */
    @media print {
      @page {
        size: 76mm 76mm;
        margin: 0;
      }
      body * {
        visibility: hidden !important;
      }
      #printArea, #printArea * {
        visibility: visible !important;
      }
      #printArea {
        position: fixed !important;
        left: 0 !important;
        top: 0 !important;
        width: 76mm !important;
        height: 76mm !important;
        padding: 0 !important;
        margin: 0 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        background: white !important;
      }
      #printArea .label-content {
        text-align: center;
        width: 70mm;
      }
      #printArea .print-name {
        font-size: 36pt !important;
        font-weight: 900 !important;
        color: #000 !important;
        margin: 0 0 3mm 0 !important;
        line-height: 1.1 !important;
      }
      #printArea .print-seat {
        font-size: 26pt !important;
        font-weight: 800 !important;
        color: #000 !important;
        margin: 3mm 0 !important;
      }
      #printArea .print-divider {
        border: none !important;
        border-top: 2px solid #000 !important;
        margin: 4mm auto !important;
        width: 50mm !important;
      }
      #printArea .print-event {
        font-size: 11pt !important;
        font-weight: 600 !important;
        color: #333 !important;
        margin: 0 !important;
      }
    }

    /* í”„ë¦°íŠ¸ ì˜ì—­ì€ í™”ë©´ì—ì„œ ìˆ¨ê¹€ */
    #printArea {
      display: none;
    }
  </style>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    th {
      font-weight: 600;
      color: #374151;
    }

    tr:hover {
      background: rgba(0, 0, 0, 0.02);
    }

    .zone-select {
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
    }

    .seat-input {
      width: 80px;
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
    }
  </style>
</head>

<body>
  <div class="min-h-screen bg-gradient-to-br from-red-50 via-white to-sky-50">
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
      <div class="glass-card max-w-md w-full">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
        <form id="loginForm" class="space-y-4">
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
            <input id="password" type="password" class="input-glass" required />
          </div>
          <button type="submit" class="btn-primary-glass w-full" id="loginBtn">ë¡œê·¸ì¸</button>
        </form>
      </div>
    </div>

    <div id="adminScreen" class="hidden">
      <header class="glass-header">
        <div class="max-w-7xl mx-auto px-4 py-4">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <h1 class="text-2xl font-bold text-gray-900">ê´€ë¦¬ì í˜ì´ì§€</h1>
            <button onclick="logoutAdmin()" class="btn-icon text-gray-500 hover:text-red-600" title="ë¡œê·¸ì•„ì›ƒ"
              aria-label="ë¡œê·¸ì•„ì›ƒ" tabindex="0"
              onkeydown="if(event.key==='Enter'||event.key===' ') { event.preventDefault(); logoutAdmin(); }">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
              </svg>
            </button>
          </div>
        </div>
      </header>

      <!-- ì‹ ì²­ ì˜¤í”ˆ/ë§ˆê° ì»¨íŠ¸ë¡¤ -->
      <div class="max-w-7xl mx-auto px-4 pt-6">
        <div class="glass-card mb-6 flex items-center justify-between flex-wrap gap-4">
          <div class="flex items-center gap-6">
            <div class="flex items-center gap-3">
              <div id="openStatusIcon" class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center">
                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
              </div>
              <div>
                <p class="text-sm text-gray-500">ì‹ ì²­ ìƒíƒœ</p>
                <p id="openStatusText" class="text-lg font-bold text-gray-400">í™•ì¸ ì¤‘...</p>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button id="openBtn" onclick="toggleOpen(true)" class="px-6 py-3 rounded-xl font-semibold bg-green-500 hover:bg-green-600 text-white transition-colors hidden">
              ì‹ ì²­ ì˜¤í”ˆ
            </button>
            <button id="closeBtn" onclick="toggleOpen(false)" class="px-6 py-3 rounded-xl font-semibold bg-red-500 hover:bg-red-600 text-white transition-colors hidden">
              ì‹ ì²­ ë§ˆê°
            </button>
          </div>
        </div>
      </div>

      <!-- ëŒ€ì‹œë³´ë“œ ë©”íŠ¸ë¦­ ì¹´ë“œ -->
      <div class="max-w-7xl mx-auto px-4 pb-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="metric-card">
            <div class="flex items-center justify-between mb-2">
              <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
              </div>
            </div>
            <p id="totalCount" class="metric-value">0</p>
            <p class="metric-label">ì´ ì‹ ì²­ì</p>
            <div class="progress-bar mt-2">
              <div id="totalProgress" class="progress-fill" style="width: 0%"></div>
            </div>
            <p class="text-xs text-gray-400 mt-1">ëª©í‘œ 1,500ëª…</p>
          </div>

          <div class="metric-card">
            <div class="flex items-center justify-between mb-2">
              <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
            </div>
            <p id="paidCount" class="metric-value text-green-600">0</p>
            <p class="metric-label">ì…ê¸ˆ ì™„ë£Œ</p>
            <div class="progress-bar mt-2">
              <div id="paidProgress" class="progress-fill"
                style="width: 0%; background: linear-gradient(to right, #10b981, #34d399);"></div>
            </div>
            <p id="paidPercent" class="text-xs text-gray-400 mt-1">0%</p>
          </div>

          <div class="metric-card">
            <div class="flex items-center justify-between mb-2">
              <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" />
                </svg>
              </div>
            </div>
            <p id="seatedCount" class="metric-value text-purple-600">0</p>
            <p class="metric-label">ì¢Œì„ ë°°ì •</p>
            <div class="progress-bar mt-2">
              <div id="seatedProgress" class="progress-fill"
                style="width: 0%; background: linear-gradient(to right, #8b5cf6, #a78bfa);"></div>
            </div>
            <p id="seatedPercent" class="text-xs text-gray-400 mt-1">0%</p>
          </div>

          <div class="metric-card">
            <div class="flex items-center justify-between mb-2">
              <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center">
                <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </div>
            </div>
            <p id="checkedInCount" class="metric-value text-orange-600">0</p>
            <p class="metric-label">ì²´í¬ì¸ ì™„ë£Œ</p>
            <div class="progress-bar mt-2">
              <div id="checkedInProgress" class="progress-fill"
                style="width: 0%; background: linear-gradient(to right, #f97316, #fb923c);"></div>
            </div>
            <p id="checkedInPercent" class="text-xs text-gray-400 mt-1">0%</p>
          </div>
        </div>
      </div>

      <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="glass-card mb-6">
          <div class="flex gap-4 border-b border-gray-200">
            <button onclick="showParticipantsTab()" id="participantsTab"
              class="px-4 py-2 font-semibold text-red-600 border-b-2 border-red-600">
              ì°¸ê°€ì ê´€ë¦¬
            </button>
            <button onclick="showPaymentTab()" id="paymentTab"
              class="px-4 py-2 font-semibold text-gray-600 hover:text-red-600">
              ì…ê¸ˆí™•ì¸
            </button>
            <button onclick="showInquiriesTab()" id="inquiriesTab"
              class="px-4 py-2 font-semibold text-gray-600 hover:text-red-600 relative">
              ë¬¸ì˜ ê´€ë¦¬
              <span id="unansweredBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[1.25rem] text-center">0</span>
            </button>
            <button onclick="showCheckinTab()" id="checkinTab"
              class="px-4 py-2 font-semibold text-gray-600 hover:text-red-600">
              QR ì²´í¬ì¸
            </button>
            <button onclick="showStoriesTab()" id="storiesTab"
              class="px-4 py-2 font-semibold text-gray-600 hover:text-red-600 relative">
              ì‚¬ì—° ê´€ë¦¬
              <span id="unreadStoriesBadge" class="hidden absolute -top-1 -right-1 bg-orange-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[1.25rem] text-center">0</span>
            </button>
            <button onclick="showRefundsTab()" id="refundsTab"
              class="px-4 py-2 font-semibold text-gray-600 hover:text-red-600 relative">
              í™˜ë¶ˆ/ì·¨ì†Œ
              <span id="pendingRefundsBadge" class="hidden absolute -top-1 -right-1 bg-yellow-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[1.25rem] text-center">0</span>
            </button>
          </div>
        </div>

        <!-- ì°¸ê°€ì ê´€ë¦¬ íƒ­ -->
        <div id="participantsSection">
          <!-- ì¢Œì„ ë°°ì • íŒ¨ë„ -->
          <div class="glass-card mb-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">ì¢Œì„ ë°°ì •</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ê·¸ë£¹ í˜•íƒœ</label>
                <select id="groupType" class="input-glass" onchange="updateGroupDisplay()">
                  <option value="alphabet" selected>ì•ŒíŒŒë²³ (A,B,C...)</option>
                  <option value="korean">ê°€ë‚˜ë‹¤ (ê°€,ë‚˜,ë‹¤...)</option>
                  <option value="number">ìˆ«ì (1,2,3...)</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ê·¸ë£¹ ê°œìˆ˜</label>
                <input type="number" id="groupCount" class="input-glass" placeholder="16" value="16" min="1" max="26"
                  onchange="updateGroupDisplay()" />
                <p class="text-xs text-gray-500 mt-1" id="groupDisplay">A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P</p>
              </div>
              <div class="col-span-2">
                <p class="text-xs text-gray-500">
                  <strong>ê·¸ë£¹ë³„ ì¢Œì„ ìˆ˜:</strong> A(90), B(100), C(100), D(90), E(100), F(90), G(90), H(100), I(100), J(90), K(90), L(100), M(90), N(100), O(100), P(90) = ì´ 1,520ì„
                </p>
              </div>
            </div>
            <div class="flex gap-3 flex-wrap mb-4">
              <button onclick="randomAssignSeats()" class="btn-primary-glass px-6">
                ëœë¤ ë°°ì •
              </button>
              <button onclick="ageBasedAssignSeats()" class="btn-primary-glass px-6">
                ì—°ë ¹ëŒ€ ê³ ë ¤ ë°°ì •
              </button>
              <button onclick="resetAllSeats()" class="btn-secondary-glass px-6"
                style="background: rgba(239, 68, 68, 0.1); color: #dc2626; border-color: rgba(220, 38, 38, 0.3);">
                ì „ì²´ ì´ˆê¸°í™”
              </button>
            </div>
            <p class="text-sm text-gray-500">ì…ê¸ˆ ì™„ë£Œëœ ì°¸ê°€ìë“¤ì—ê²Œ ìë™ìœ¼ë¡œ ì¢Œì„ì„ ë°°ì •í•©ë‹ˆë‹¤. ì—°ë ¹ëŒ€ ê³ ë ¤ ë°°ì •ì€ 00ë…„ëŒ€ìƒ â†’ 90ë…„ëŒ€ìƒ â†’ 80ë…„ëŒ€ìƒ ìˆœìœ¼ë¡œ ì•ì¢Œì„ì—
              ë°°ì •ë©ë‹ˆë‹¤.</p>
          </div>

          <div class="glass-card mb-6">
            <div class="flex gap-3 items-center">
              <div class="relative flex-1 min-w-0">
                <input type="text" id="searchInput" class="input-glass pl-10 w-full" placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰..." />
                <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none"
                  stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <button onclick="loadParticipants(1, true)" title="ìƒˆë¡œê³ ì¹¨"
                style="background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); color: #374151; font-weight: 600; padding: 0.75rem 1rem; border-radius: 0.75rem; font-size: 0.875rem; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease; white-space: nowrap; flex-shrink: 0; display: flex; align-items: center; gap: 0.5rem;"
                onmouseover="this.style.background='rgba(255, 255, 255, 0.8)'; this.style.transform='scale(1.02)'"
                onmouseout="this.style.background='rgba(255, 255, 255, 0.6)'; this.style.transform='scale(1)'">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span class="hidden md:inline">ìƒˆë¡œê³ ì¹¨</span>
              </button>
              <button onclick="downloadExcel()" class="btn-primary-glass px-6 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
              </button>
              <button onclick="downloadCancelledExcel()" class="btn-secondary-glass px-4 flex items-center gap-2" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: #dc2626;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                ì·¨ì†Œ/í™˜ë¶ˆì
              </button>
              <button onclick="downloadArchivedExcel()" class="btn-secondary-glass px-4 flex items-center gap-2" style="background: rgba(107, 114, 128, 0.1); border-color: rgba(107, 114, 128, 0.3); color: #6b7280;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                </svg>
                ì‚­ì œ ë°ì´í„°
              </button>
              <button onclick="showAddParticipantModal()" class="btn-primary-glass px-6 flex items-center gap-2" style="background: rgba(16, 185, 129, 0.9);">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                ì‹ ê·œ ë“±ë¡
              </button>
            </div>
          </div>

          <!-- ê°œì¸ì •ë³´ ë™ì˜ í˜„í™© -->
          <div class="glass-card mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë™ì˜ í˜„í™©
              </h3>
              <button onclick="loadPrivacyStats()" class="text-sm text-blue-600 hover:text-blue-800">
                ìƒˆë¡œê³ ì¹¨
              </button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="text-center p-4 bg-blue-50 rounded-xl">
                <div class="text-2xl font-bold text-blue-600" id="privacyTotalCount">-</div>
                <div class="text-sm text-gray-600">ì „ì²´ ì¸ì›</div>
              </div>
              <div class="text-center p-4 bg-green-50 rounded-xl">
                <div class="text-2xl font-bold text-green-600" id="privacyAgreedCount">-</div>
                <div class="text-sm text-gray-600">ë™ì˜ ì™„ë£Œ</div>
              </div>
              <div class="text-center p-4 bg-yellow-50 rounded-xl">
                <div class="text-2xl font-bold text-yellow-600" id="privacyPendingCount">-</div>
                <div class="text-sm text-gray-600">ë™ì˜ ë¯¸ì™„ë£Œ</div>
              </div>
              <div class="text-center p-4 bg-purple-50 rounded-xl">
                <div class="text-2xl font-bold text-purple-600" id="privacyRate">-</div>
                <div class="text-sm text-gray-600">ë™ì˜ìœ¨</div>
              </div>
            </div>
          </div>

          <div class="glass-card overflow-x-auto">
            <div id="loading" class="text-center py-8 text-gray-500">ë¡œë”© ì¤‘...</div>
            <table id="participantsTable" class="hidden">
              <thead>
                <tr>
                  <th class="text-center" style="width: 60px;">
                    ì—°ë²ˆ
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('user_name')">
                    ì´ë¦„
                    <span class="sort-icon ml-1" id="sort-icon-user_name"></span>
                  </th>
                  <th>
                    ëŒ€ë¦¬ì‹ ì²­
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('phone')">
                    ì „í™”ë²ˆí˜¸
                    <span class="sort-icon ml-1" id="sort-icon-phone"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('ssn_first')">
                    ì£¼ë¯¼ë²ˆí˜¸ ì•ìë¦¬
                    <span class="sort-icon ml-1" id="sort-icon-ssn_first"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('is_paid')">
                    ì…ê¸ˆ ìƒíƒœ
                    <span class="sort-icon ml-1" id="sort-icon-is_paid"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('is_checked_in')">
                    ì…ì¥ í™•ì¸
                    <span class="sort-icon ml-1" id="sort-icon-is_checked_in"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('seat_group')">
                    ì¢Œì„ ê·¸ë£¹
                    <span class="sort-icon ml-1" id="sort-icon-seat_group"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('seat_row')">
                    ì—´
                    <span class="sort-icon ml-1" id="sort-icon-seat_row"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('seat_number')">
                    ì¢Œì„ë²ˆí˜¸
                    <span class="sort-icon ml-1" id="sort-icon-seat_number"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('seat_full')">
                    ì „ì²´ ì¢Œì„
                    <span class="sort-icon ml-1" id="sort-icon-seat_full"></span>
                  </th>
                  <th class="sortable cursor-pointer hover:bg-gray-100" onclick="sortParticipants('created_at')">
                    ì‹ ì²­ ì¼ì‹œ
                    <span class="sort-icon ml-1" id="sort-icon-created_at"></span>
                  </th>
                  <th>ì‘ì—…</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
            <div id="emptyMessage" class="hidden text-center py-8 text-gray-500"></div>
          </div>
          <div id="paginationContainer" class="flex justify-center items-center gap-2 mt-4"></div>
          <div class="mt-4 text-sm text-gray-600" id="countText"></div>
        </div>

        <!-- ì…ê¸ˆí™•ì¸ íƒ­ -->
        <div id="paymentSection" class="hidden" style="margin-left: -2rem; margin-right: -2rem; padding-left: 1rem; padding-right: 1rem;">
          <div class="glass-card mb-6" style="max-width: none;">
            <h3 class="text-lg font-bold text-gray-900 mb-4">ì…ê¸ˆ ë‚´ì—­ í™•ì¸</h3>
            <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
              <p class="text-sm text-gray-700 mb-3"><strong>CSV íŒŒì¼ ì—…ë¡œë“œ:</strong> ì—‘ì…€ì—ì„œ CSVë¡œ ì €ì¥ í›„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
              <div class="flex gap-3 items-center flex-wrap">
                <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="handleCSVUpload(this)" />
                <button onclick="document.getElementById('csvFileInput').click()"
                  style="background-color: #3b82f6; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; box-shadow: 0 10px 15px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; border: none;"
                  onmouseover="this.style.backgroundColor='#2563eb'" onmouseout="this.style.backgroundColor='#3b82f6'">
                  ğŸ“ CSV íŒŒì¼ ì„ íƒ
                </button>
                <span id="csvFileName" class="text-sm text-gray-600"></span>
              </div>
              <p class="text-xs text-gray-500 mt-2">* CSV íŒŒì¼ì€ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì»¬ëŸ¼: ê±°ë˜ì¼ì‹œ, êµ¬ë¶„, ê±°ë˜ê¸ˆì•¡, ê±°ë˜ í›„ ì”ì•¡, ê±°ë˜êµ¬ë¶„, ë‚´ìš©, ë©”ëª¨</p>
            </div>

            <!-- ë²„íŠ¼ë“¤ì„ í…Œì´ë¸” ìœ„ë¡œ ì´ë™ -->
            <div class="flex gap-3 flex-wrap mb-4">
              <button id="addPaymentRowBtn" onclick="addPaymentRow()"
                style="background-color: #475569; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; box-shadow: 0 10px 15px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; border: none;"
                onmouseover="this.style.backgroundColor='#334155'" onmouseout="this.style.backgroundColor='#475569'">
                + í–‰ ì¶”ê°€
              </button>
              <button id="savePaymentBtn" onclick="savePaymentDataWithLock()"
                style="background-color: #3b82f6; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; box-shadow: 0 10px 15px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; border: none;"
                onmouseover="this.style.backgroundColor='#2563eb'" onmouseout="this.style.backgroundColor='#3b82f6'">
                ğŸ’¾ ì €ì¥í•˜ê¸°
              </button>
              <button id="bulkApproveBtn" onclick="bulkApproveMatched()"
                style="background-color: #10b981; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; box-shadow: 0 10px 15px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; border: none;"
                onmouseover="this.style.backgroundColor='#059669'" onmouseout="this.style.backgroundColor='#10b981'">
                âœ“ ë§¤ì¹­ëœ í•­ëª© ì¼ê´„ìŠ¹ì¸
              </button>
              <button id="resetPaymentBtn" onclick="resetPaymentTableWithLock()"
                style="background-color: #f97316; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; box-shadow: 0 10px 15px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; border: none;"
                onmouseover="this.style.backgroundColor='#ea580c'" onmouseout="this.style.backgroundColor='#f97316'">
                ğŸ—‘ï¸ ì´ˆê¸°í™”
              </button>
            </div>

            <!-- í•„í„° ë²„íŠ¼ -->
            <div class="flex gap-2 flex-wrap mb-4">
              <span class="text-sm text-gray-600 mr-2 self-center">í•„í„°:</span>
              <button onclick="filterPaymentData('all')" id="filterAll"
                style="background-color: #6b7280; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; border: none;">
                ì „ì²´ ë³´ê¸°
              </button>
              <button onclick="filterPaymentData('matched')" id="filterMatched"
                style="background-color: #e5e7eb; color: #374151; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; border: none;">
                âœ“ ë§¤ì¹­ë¨
              </button>
              <button onclick="filterPaymentData('unmatched')" id="filterUnmatched"
                style="background-color: #e5e7eb; color: #374151; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; border: none;">
                âœ— ë¯¸ë§¤ì¹­
              </button>
              <button onclick="filterPaymentData('duplicate')" id="filterDuplicate"
                style="background-color: #e5e7eb; color: #374151; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; border: none;">
                âš  ë™ëª…ì´ì¸
              </button>
              <button onclick="filterPaymentData('noPhone')" id="filterNoPhone"
                style="background-color: #e5e7eb; color: #374151; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; border: none;">
                ğŸ“± ì „í™”ë²ˆí˜¸ ì—†ìŒ
              </button>
              <button onclick="filterPaymentData('pending')" id="filterPending"
                style="background-color: #e5e7eb; color: #374151; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; border: none;">
                â³ ëŒ€ê¸°ì¤‘
              </button>
              <button onclick="filterPaymentData('approved')" id="filterApproved"
                style="background-color: #e5e7eb; color: #374151; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; border: none;">
                âœ… ìŠ¹ì¸ë¨
              </button>
              <span id="filterCount" class="text-sm text-gray-500 self-center ml-2"></span>
            </div>

            <div id="paymentTableContainer" class="overflow-x-auto mb-4" style="max-width: 100vw;">
              <table id="paymentTable" class="border-collapse border border-gray-300 bg-white" style="min-width: 1600px;">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700" style="min-width: 40px;">ì—°ë²ˆ</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-200" style="min-width: 140px;" onclick="sortPaymentData('date')">
                      ê±°ë˜ì¼ì‹œ <span id="paymentSort_date" class="text-xs text-gray-400"></span>
                    </th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-200" style="min-width: 60px;" onclick="sortPaymentData('type')">
                      êµ¬ë¶„ <span id="paymentSort_type" class="text-xs text-gray-400"></span>
                    </th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-200" style="min-width: 100px;" onclick="sortPaymentData('amount')">
                      ê±°ë˜ê¸ˆì•¡ <span id="paymentSort_amount" class="text-xs text-gray-400"></span>
                    </th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-200" style="min-width: 100px;" onclick="sortPaymentData('balance')">
                      ê±°ë˜ í›„ ì”ì•¡ <span id="paymentSort_balance" class="text-xs text-gray-400"></span>
                    </th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-200" style="min-width: 80px;" onclick="sortPaymentData('transactionType')">
                      ê±°ë˜êµ¬ë¶„ <span id="paymentSort_transactionType" class="text-xs text-gray-400"></span>
                    </th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-200" style="min-width: 150px;" onclick="sortPaymentData('content')">
                      ë‚´ìš© <span id="paymentSort_content" class="text-xs text-gray-400"></span>
                    </th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-200" style="min-width: 100px;" onclick="sortPaymentData('memo')">
                      ë©”ëª¨ <span id="paymentSort_memo" class="text-xs text-gray-400"></span>
                    </th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-200" style="min-width: 180px;" onclick="sortPaymentData('matchedName')">
                      ë§¤ì¹­ëœ ì‹ ì²­ì <span id="paymentSort_matchedName" class="text-xs text-gray-400"></span>
                    </th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700" style="min-width: 180px;">ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì</th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700" style="min-width: 80px;">ë¹„ê³ </th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-200" style="min-width: 70px;" onclick="sortPaymentData('approved')">
                      ìƒíƒœ <span id="paymentSort_approved" class="text-xs text-gray-400"></span>
                    </th>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700 sticky right-0 bg-gray-100 z-10" style="min-width: 140px;">ì‘ì—…</th>
                  </tr>
                </thead>
                <tbody id="paymentTableBody">
                  <!-- ë¹ˆ í–‰ í•˜ë‚˜ ì¶”ê°€ -->
                  <tr>
                    <td class="border border-gray-300 px-2 py-1 text-sm text-center text-gray-500">1</td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
                    <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
                    <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
                    <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
                    <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
                    <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">ëŒ€ê¸°ì¤‘</td>
                    <td class="border border-gray-300 px-2 py-2 sticky right-0 bg-white z-10">
                      <div class="flex gap-2">
                        <button onclick="approvePaymentFromTable(0)"
                          style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;"
                          onmouseover="this.style.backgroundColor='#16a34a'"
                          onmouseout="this.style.backgroundColor='#22c55e'">ìŠ¹ì¸</button>
                        <button onclick="removePaymentRowFromTable(this)"
                          style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;"
                          onmouseover="this.style.backgroundColor='#dc2626'"
                          onmouseout="this.style.backgroundColor='#ef4444'">ì‚­ì œ</button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- QR ì²´í¬ì¸ íƒ­ -->
        <div id="checkinSection" class="hidden">
          <div class="glass-card mb-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-gray-900">QR ì½”ë“œ ì²´í¬ì¸</h3>
              <div class="flex gap-2">
                <button onclick="resetAllCheckins()" class="btn-secondary-glass px-4 flex items-center gap-2 text-red-600 hover:bg-red-50">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                  </svg>
                  ì „ì²´ ì´ˆê¸°í™”
                </button>
                <button onclick="openCheckinPopup()" class="btn-primary-glass px-6 flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                  </svg>
                  ì²´í¬ì¸ íŒì—… ì—´ê¸°
                </button>
              </div>
            </div>

            <!-- í†µê³„ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <div class="text-sm text-blue-600 mb-1">ì…ê¸ˆ ì™„ë£Œ ì¸ì›</div>
                <div class="text-2xl font-bold text-blue-900" id="checkinTotal">0</div>
              </div>
              <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <div class="text-sm text-green-600 mb-1">ì…ì¥ í™•ì¸</div>
                <div class="text-2xl font-bold text-green-900" id="checkinCount">0</div>
              </div>
              <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                <div class="text-sm text-orange-600 mb-1">ë‚¨ì€ ì¸ì›</div>
                <div class="text-2xl font-bold text-orange-900" id="checkinRemaining">0</div>
              </div>
            </div>

            <!-- QR ì½”ë“œ ìŠ¤ìºë„ˆ -->
            <div class="mb-6">
              <div class="flex gap-4 mb-4">
                <button onclick="startQRScanner()" id="startScannerBtn" class="btn-primary-glass px-6">
                  ì¹´ë©”ë¼ ìŠ¤ìº” ì‹œì‘
                </button>
                <button onclick="stopQRScanner()" id="stopScannerBtn" class="btn-secondary-glass px-6 hidden">
                  ìŠ¤ìº” ì¤‘ì§€
                </button>
                <button onclick="loadCheckinStats()" class="btn-secondary-glass px-6">
                  í†µê³„ ìƒˆë¡œê³ ì¹¨
                </button>
              </div>

              <div id="qrScannerContainer" class="hidden mb-4">
                <div id="qrReader" class="max-w-md mx-auto bg-white p-4 rounded-lg border border-gray-300"
                  style="min-height: 300px; position: relative;"></div>
                <p class="text-sm text-gray-600 text-center mt-2">QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶°ì£¼ì„¸ìš”</p>
              </div>

              <!-- ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì…ë ¥ -->
              <div class="mb-4 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
                <label class="block text-sm font-medium text-green-700 mb-2">
                  <span class="inline-flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h2m10 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                    </svg>
                    ë°”ì½”ë“œ ìŠ¤ìºë„ˆ (ìë™ ì²´í¬ì¸)
                  </span>
                </label>
                <input type="text" id="barcodeScannerInput"
                  class="input-glass w-full text-lg font-mono"
                  placeholder="ë°”ì½”ë“œ ìŠ¤ìºë„ˆë¡œ ìŠ¤ìº”í•˜ì„¸ìš” (ì´ í•„ë“œì— í¬ì»¤ìŠ¤ ìœ ì§€)"
                  autocomplete="off"
                  autofocus />
                <div class="flex items-center gap-4 mt-2 flex-wrap">
                  <label class="flex items-center gap-2 text-sm text-green-700 cursor-pointer">
                    <input type="checkbox" id="autoFocusScanner" checked class="w-4 h-4" />
                    ìë™ í¬ì»¤ìŠ¤ ìœ ì§€
                  </label>
                  <label class="flex items-center gap-2 text-sm text-blue-700 cursor-pointer">
                    <input type="checkbox" id="autoPrintCheckin" class="w-4 h-4" checked />
                    ì²´í¬ì¸ ì‹œ ìë™ í”„ë¦°íŠ¸
                  </label>
                  <span id="scannerStatus" class="text-sm text-green-600 font-medium">ëŒ€ê¸° ì¤‘...</span>
                </div>
              </div>

              <!-- ìˆ˜ë™ ì…ë ¥ -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">QR ì½”ë“œ ë°ì´í„° ì§ì ‘ ì…ë ¥</label>
                <div class="flex gap-2">
                  <input type="text" id="manualQRInput" class="input-glass flex-1" placeholder="QR ì½”ë“œ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ ì…ë ¥í•˜ì„¸ìš”"
                    onkeypress="if(event.key==='Enter') processManualCheckin()" />
                  <button onclick="processManualCheckin()" class="btn-primary-glass px-6">
                    í™•ì¸
                  </button>
                </div>
              </div>

              <!-- ê²°ê³¼ ë©”ì‹œì§€ -->
              <div id="checkinResult" class="hidden mb-4 p-4 rounded-lg"></div>

              <!-- ìµœê·¼ ì²´í¬ì¸ ë‚´ì—­ -->
              <div class="mt-6">
                <h4 class="text-md font-bold text-gray-900 mb-3">ìµœê·¼ ì²´í¬ì¸ ë‚´ì—­</h4>
                <div id="recentCheckins" class="space-y-2 max-h-64 overflow-y-auto">
                  <p class="text-sm text-gray-500 text-center">ì²´í¬ì¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ë¬¸ì˜ ê´€ë¦¬ íƒ­ -->
        <div id="inquiriesSection" class="hidden">
          <div class="glass-card mb-6">
            <div class="flex justify-between items-center mb-4">
              <div class="relative flex-1 min-w-0">
                <input type="text" id="inquirySearchInput" class="input-glass pl-10 w-full"
                  placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰..." />
                <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none"
                  stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <div class="flex gap-2 ml-3">
                <select id="inquiryFilter" onchange="filterInquiries(this.value)" class="input-glass">
                  <option value="all">ì „ì²´ ë¬¸ì˜</option>
                  <option value="unanswered">ë¯¸ì‘ë‹µ ë¬¸ì˜</option>
                  <option value="answered">ë‹µë³€ ì™„ë£Œ</option>
                </select>
                <button onclick="exportInquiriesToExcel()" class="btn-secondary-glass px-4 flex items-center gap-2" title="ì—‘ì…€ ë‹¤ìš´ë¡œë“œ">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <span class="hidden md:inline">ì—‘ì…€</span>
                </button>
                <button onclick="loadInquiries()" class="btn-secondary-glass px-6 flex items-center gap-2" title="ìƒˆë¡œê³ ì¹¨">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  <span class="hidden md:inline">ìƒˆë¡œê³ ì¹¨</span>
                </button>
              </div>
            </div>
          </div>

          <div class="glass-card overflow-x-auto">
            <div id="inquiryLoading" class="text-center py-8 text-gray-500">ë¡œë”© ì¤‘...</div>
            <div id="inquiriesList" class="hidden space-y-4"></div>
            <div id="inquiryEmptyMessage" class="hidden text-center py-8 text-gray-500"></div>
          </div>

          <div class="mt-4 text-sm text-gray-600" id="inquiryCountText"></div>
        </div>

        <!-- ì‚¬ì—° ê´€ë¦¬ íƒ­ -->
        <div id="storiesSection" class="hidden">
          <div class="glass-card mb-6">
            <div class="flex justify-between items-center mb-4">
              <div class="relative flex-1 min-w-0">
                <input type="text" id="storySearchInput" class="input-glass pl-10 w-full"
                  placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰..." oninput="filterStories()" />
                <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none"
                  stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <div class="flex gap-2 ml-3">
                <select id="storyFilter" onchange="filterStories()" class="input-glass">
                  <option value="all">ì „ì²´ ì‚¬ì—°</option>
                  <option value="unread">ì•ˆ ì½ì€ ì‚¬ì—°</option>
                  <option value="read">ì½ì€ ì‚¬ì—°</option>
                </select>
                <button onclick="exportStoriesToExcel()" class="btn-secondary-glass px-4 flex items-center gap-2" title="ì—‘ì…€ ë‹¤ìš´ë¡œë“œ">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <span class="hidden md:inline">ì—‘ì…€</span>
                </button>
                <button onclick="loadStories()" class="btn-secondary-glass px-6 flex items-center gap-2" title="ìƒˆë¡œê³ ì¹¨">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  <span class="hidden md:inline">ìƒˆë¡œê³ ì¹¨</span>
                </button>
              </div>
            </div>
          </div>

          <div class="glass-card overflow-x-auto">
            <div id="storyLoading" class="text-center py-8 text-gray-500">ë¡œë”© ì¤‘...</div>
            <div id="storiesList" class="hidden space-y-4"></div>
            <div id="storyEmptyMessage" class="hidden text-center py-8 text-gray-500"></div>
          </div>

          <div class="mt-4 text-sm text-gray-600" id="storyCountText"></div>
        </div>

        <!-- í™˜ë¶ˆ/ì·¨ì†Œ ê´€ë¦¬ íƒ­ -->
        <div id="refundsSection" class="hidden">
          <div class="glass-card mb-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-gray-900">í™˜ë¶ˆ/ì·¨ì†Œ ê´€ë¦¬</h3>
              <div class="flex gap-2">
                <select id="refundFilter" onchange="filterRefunds()" class="input-glass">
                  <option value="pending">ëŒ€ê¸° ì¤‘</option>
                  <option value="completed">ì™„ë£Œ</option>
                  <option value="cancelled">ì·¨ì†Œë¨</option>
                  <option value="all">ì „ì²´</option>
                </select>
                <button onclick="loadRefunds()" class="btn-secondary-glass px-6 flex items-center gap-2" title="ìƒˆë¡œê³ ì¹¨">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  <span class="hidden md:inline">ìƒˆë¡œê³ ì¹¨</span>
                </button>
                <button onclick="downloadCancelledExcel()" class="btn-primary-glass px-4 flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                  <span class="hidden md:inline">ì—‘ì…€</span>
                </button>
              </div>
            </div>
          </div>

          <!-- í†µê³„ ì¹´ë“œ -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="glass-card text-center">
              <div class="text-3xl font-bold text-yellow-600" id="pendingRefundCount">0</div>
              <div class="text-sm text-gray-600">í™˜ë¶ˆ ëŒ€ê¸°</div>
            </div>
            <div class="glass-card text-center">
              <div class="text-3xl font-bold text-green-600" id="completedRefundCount">0</div>
              <div class="text-sm text-gray-600">í™˜ë¶ˆ ì™„ë£Œ</div>
            </div>
            <div class="glass-card text-center">
              <div class="text-3xl font-bold text-red-600" id="cancelledCount">0</div>
              <div class="text-sm text-gray-600">ì·¨ì†Œë¨</div>
            </div>
          </div>

          <div class="glass-card overflow-x-auto">
            <div id="refundLoading" class="text-center py-8 text-gray-500">ë¡œë”© ì¤‘...</div>
            <table id="refundsTable" class="hidden w-full">
              <thead>
                <tr class="bg-gray-50">
                  <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ìƒíƒœ</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ì‹ ì²­ì</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ì—°ë½ì²˜</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">í™˜ë¶ˆê¸ˆì•¡</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ì€í–‰/ê³„ì¢Œ</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ì˜ˆê¸ˆì£¼</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ì‚¬ìœ </th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ìš”ì²­ì¼</th>
                  <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">ê´€ë¦¬</th>
                </tr>
              </thead>
              <tbody id="refundsBody"></tbody>
            </table>
            <div id="refundEmptyMessage" class="hidden text-center py-8 text-gray-500">í™˜ë¶ˆ/ì·¨ì†Œ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
          </div>

          <div class="mt-4 text-sm text-gray-600" id="refundCountText"></div>
        </div>
      </main>

      <!-- í‘¸í„° (ë‚˜ì¤‘ì— ë°°í¬ì‚¬/ìš´ì˜ì‚¬ ì •ë³´ ì¶”ê°€ ì˜ˆì •) -->
      <footer class="mt-16 py-8 border-t border-white/20">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-600">
          <!-- ë°°í¬ì‚¬/ìš´ì˜ì‚¬ ì •ë³´ëŠ” ì¶”í›„ ì¶”ê°€ ì˜ˆì • -->
        </div>
      </footer>
    </div>
  </div>

  <script>
    let participants = [];
    let isAuthenticated = false;
    let adminToken = null; // JWT í† í° ì €ì¥
    let currentSort = 'created_at';
    let currentOrder = 'desc';
    let currentPage = 1;
    let itemsPerPage = 50;
    let totalItems = 0;
    let inquiryFilterState = 'all';
    let filteredParticipants = [];
    let participantsCache = null;
    let participantsCacheTime = null;
    const CACHE_DURATION = 30000; // 30ì´ˆ ìºì‹œ
    let savePaymentDataTimeout = null; // localStorage ì €ì¥ debounceìš©
    let searchDebounceTimeout = null; // ê²€ìƒ‰ debounceìš©
    const SEARCH_DEBOUNCE_MS = 300; // ê²€ìƒ‰ debounce ì‹œê°„ (300ms)

    // ë¬¸ì˜ ë° ì‚¬ì—° ê´€ë ¨ ë³€ìˆ˜ (ì „ì—­)
    let inquiries = [];
    let filteredInquiries = [];
    let stories = [];
    let filteredStories = [];

    // ì°¸ê°€ì ìˆ˜ì • ëª¨ë‹¬ ê´€ë ¨ ë³€ìˆ˜ (ì „ì—­)
    let editingParticipantId = null;
    let editingIsGuest = false;

    // í™˜ë¶ˆ/ì·¨ì†Œ ê´€ë ¨ ë³€ìˆ˜ (ì „ì—­)
    let refundsList = [];
    let filteredRefundsList = [];

    // ì¸ì¦ëœ API í˜¸ì¶œì„ ìœ„í•œ í—¬í¼ í•¨ìˆ˜
    function authFetch(url, options = {}) {
      if (!adminToken) {
        return Promise.reject(new Error('ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.'));
      }
      const headers = {
        'Content-Type': 'application/json',
        'x-admin-token': adminToken,
        ...(options.headers || {})
      };
      return fetch(url, { ...options, headers });
    }

    // ì˜¤í”ˆ ìƒíƒœ ì¡°íšŒ
    async function loadOpenStatus() {
      try {
        const response = await fetch('/api/settings/is-open');
        const data = await response.json();
        if (data.success !== undefined) {
          updateOpenStatusUI(data.isOpen);
        } else {
          // API ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ê°’ (ë§ˆê° ìƒíƒœ)
          updateOpenStatusUI(false);
        }
      } catch (error) {
        console.error('Error loading open status:', error);
        // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ê°’ (ë§ˆê° ìƒíƒœ)
        updateOpenStatusUI(false);
      }
    }

    // ì˜¤í”ˆ ìƒíƒœ UI ì—…ë°ì´íŠ¸
    function updateOpenStatusUI(isOpen) {
      const statusIcon = document.getElementById('openStatusIcon');
      const statusText = document.getElementById('openStatusText');
      const openBtn = document.getElementById('openBtn');
      const closeBtn = document.getElementById('closeBtn');

      if (isOpen) {
        statusIcon.className = 'w-12 h-12 rounded-full bg-green-100 flex items-center justify-center';
        statusIcon.innerHTML = '<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" /></svg>';
        statusText.textContent = 'ì‹ ì²­ ì ‘ìˆ˜ ì¤‘';
        statusText.className = 'text-lg font-bold text-green-600';
        openBtn.classList.add('hidden');
        closeBtn.classList.remove('hidden');
      } else {
        statusIcon.className = 'w-12 h-12 rounded-full bg-red-100 flex items-center justify-center';
        statusIcon.innerHTML = '<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>';
        statusText.textContent = 'ì‹ ì²­ ë§ˆê°';
        statusText.className = 'text-lg font-bold text-red-600';
        openBtn.classList.remove('hidden');
        closeBtn.classList.add('hidden');
      }
    }

    // ì˜¤í”ˆ/ë§ˆê° í† ê¸€
    async function toggleOpen(isOpen) {
      const action = isOpen ? 'ì˜¤í”ˆ' : 'ë§ˆê°';

      // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
      const password = prompt(`ì‹ ì²­ì„ ${action}í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
      if (password === null) {
        return; // ì·¨ì†Œ
      }
      if (password !== '2101') {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }

      if (!confirm(`ì •ë§ ì‹ ì²­ì„ ${action}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }

      try {
        const response = await authFetch('/api/admin/settings/is-open', {
          method: 'POST',
          body: JSON.stringify({ isOpen })
        });

        const data = await response.json();
        if (data.success) {
          updateOpenStatusUI(data.isOpen);
          alert(data.message);
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        console.error('Error toggling open status:', error);
        alert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // Debounce ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showError(message) {
      alert('ì˜¤ë¥˜: ' + message);
      console.error(message);
    }

    function showSuccess(message) {
      alert(message);
    }

    // ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜
    async function performLogin() {
      console.log('performLogin called');

      const loginBtn = document.getElementById('loginBtn');

      try {
        const passwordInput = document.getElementById('password');
        if (!passwordInput) {
          alert('ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          console.error('Password input element not found');
          return false;
        }

        const password = passwordInput.value.trim();

        if (!password) {
          alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          passwordInput.focus();
          return false;
        }

        // ë¡œê·¸ì¸ ë²„íŠ¼ ë¹„í™œì„±í™”
        if (loginBtn) {
          loginBtn.disabled = true;
          loginBtn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
        }

        // ì„œë²„ APIë¡œ ë¡œê·¸ì¸
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        if (data.success && data.token) {
          console.log('Login successful, token received');
          adminToken = data.token;
          isAuthenticated = true;

          // í† í°ì„ sessionStorageì— ì €ì¥ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œì—ë„ ìœ ì§€)
          sessionStorage.setItem('adminToken', adminToken);

          const loginScreen = document.getElementById('loginScreen');
          const adminScreen = document.getElementById('adminScreen');

          if (loginScreen) loginScreen.classList.add('hidden');
          if (adminScreen) adminScreen.classList.remove('hidden');

          loadParticipants();
          loadOpenStatus();
          loadPrivacyStats();
          return true;
        } else {
          throw new Error('í† í°ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('Login error:', error);
        alert(error.message || 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        const passwordInput = document.getElementById('password');
        if (passwordInput) {
          passwordInput.value = '';
          passwordInput.focus();
        }
        return false;
      } finally {
        if (loginBtn) {
          loginBtn.disabled = false;
          loginBtn.textContent = 'ë¡œê·¸ì¸';
        }
      }
    }

    // DOMì´ ë¡œë“œëœ í›„ ì‹¤í–‰
    function initAdmin() {
      const loginScreen = document.getElementById('loginScreen');
      const adminScreen = document.getElementById('adminScreen');
      const loginForm = document.getElementById('loginForm');
      const searchInput = document.getElementById('searchInput');

      console.log('Initializing admin page...');

      // sessionStorageì—ì„œ í† í° ë³µì› ì‹œë„
      const savedToken = sessionStorage.getItem('adminToken');
      if (savedToken) {
        adminToken = savedToken;
        isAuthenticated = true;
        console.log('Restored token from sessionStorage');

        // í† í°ì´ ìœ íš¨í•œì§€ í™•ì¸ (API í˜¸ì¶œ)
        authFetch('/api/admin/participants')
          .then(response => {
            if (response.ok) {
              // í† í° ìœ íš¨ - ê´€ë¦¬ì í™”ë©´ í‘œì‹œ
              if (loginScreen) loginScreen.classList.add('hidden');
              if (adminScreen) adminScreen.classList.remove('hidden');
              loadParticipants();
              loadOpenStatus();
              loadPrivacyStats();
            } else {
              // í† í° ë§Œë£Œ - ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
              sessionStorage.removeItem('adminToken');
              adminToken = null;
              isAuthenticated = false;
            }
          })
          .catch(() => {
            // ì—ëŸ¬ - ë¡œê·¸ì¸ í™”ë©´ ìœ ì§€
            sessionStorage.removeItem('adminToken');
            adminToken = null;
            isAuthenticated = false;
          });
      }

      if (!loginForm) {
        console.error('Login form not found');
        return;
      }

      // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      loginForm.addEventListener('submit', function (e) {
        e.preventDefault();
        e.stopPropagation();
        performLogin();
        return false;
      });

      // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ë°±ì—…)
      const loginBtn = document.getElementById('loginBtn');
      if (loginBtn) {
        loginBtn.addEventListener('click', function (e) {
          e.preventDefault();
          performLogin();
          return false;
        });
      }

      if (searchInput) {
        // Debounce ì ìš©ëœ ê²€ìƒ‰ (300ms)
        const debouncedFilter = debounce(() => {
          loadParticipants(1); // ê²€ìƒ‰ ì‹œ ì²« í˜ì´ì§€ë¡œ ì´ë™
        }, SEARCH_DEBOUNCE_MS);

        searchInput.addEventListener('input', debouncedFilter);
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAdmin);
    } else {
      // DOMì´ ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì¦‰ì‹œ ì‹¤í–‰
      initAdmin();
    }

    async function loadParticipants(page = 1, forceRefresh = false) {
      // ìºì‹œ í™•ì¸ (ì „ì²´ ì°¸ê°€ì ëª©ë¡ì—ë§Œ ì ìš©, ê²€ìƒ‰/ì •ë ¬/í˜ì´ì§€ë„¤ì´ì…˜ì—ëŠ” ì ìš© ì•ˆí•¨)
      const now = Date.now();
      if (!forceRefresh && !document.getElementById('searchInput').value && currentSort === 'created_at' && currentOrder === 'desc' && page === 1 && participantsCache && participantsCacheTime && (now - participantsCacheTime) < CACHE_DURATION) {
        participants = participantsCache;
        filteredParticipants = participants; // This line might be redundant if pagination is handled by backend
        updateStatistics();
        displayParticipants(participants); // Display cached data
        return;
      }

      const loading = document.getElementById('loading');
      if (loading) loading.classList.remove('hidden');

      try {
        const search = document.getElementById('searchInput').value;
        // forceRefresh ì‹œ ìºì‹œ ë²„ìŠ¤íŒ…
        const cacheBuster = forceRefresh ? `&_t=${Date.now()}` : '';
        let url = `/api/admin/participants?page=${page}&limit=${itemsPerPage}&sort=${currentSort}&order=${currentOrder}${cacheBuster}`;
        if (search) {
          url += `&search=${encodeURIComponent(search)}`;
        }

        const response = await authFetch(url);

        if (!response.ok) {
          if (response.status === 401) {
            // ì¸ì¦ ë§Œë£Œ - ë‹¤ì‹œ ë¡œê·¸ì¸ í•„ìš”
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            sessionStorage.removeItem('adminToken');
            adminToken = null;
            isAuthenticated = false;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminScreen').classList.add('hidden');
            return;
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
          participants = data.participants || [];
          filteredParticipants = participants; // For consistency, though backend handles filtering
          currentPage = data.pagination.page;
          totalItems = data.pagination.total;

          // Cache only if it's the initial load without search/sort/pagination
          if (!search && currentSort === 'created_at' && currentOrder === 'desc' && page === 1) {
            participantsCache = participants;
            participantsCacheTime = now;
          }

          updateStatistics();
          displayParticipants(participants);
          renderPagination(data.pagination);
          updateSortIcons();
        } else {
          console.error('API error:', data.error);
          const errorMsg = data.details ? `${data.error} (${data.details})` : (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
          showError('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + errorMsg);
        }
      } catch (err) {
        console.error('Error loading participants:', err);
        showError('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + err.message);
      } finally {
        if (loading) loading.classList.add('hidden');
      }
    }

    function sortParticipants(column) {
      if (currentSort === column) {
        currentOrder = currentOrder === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort = column;
        currentOrder = 'desc';
      }
      loadParticipants(1); // ì •ë ¬ ì‹œ ì²« í˜ì´ì§€ë¡œ ì´ë™
    }

    function updateSortIcons() {
      document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.innerHTML = '';
        icon.style.color = '';
      });
      const icon = document.getElementById(`sort-icon-${currentSort}`);
      if (icon) {
        icon.innerHTML = currentOrder === 'asc' ? ' â–²' : ' â–¼';
        icon.style.color = '#dc2626';
      }
    }

    function renderPagination(pagination) {
      let container = document.getElementById('paginationContainer');
      if (!container) {
        // If container doesn't exist, create it below the participants table
        const participantsSection = document.getElementById('participantsSection');
        if (participantsSection) {
          container = document.createElement('div');
          container.id = 'paginationContainer';
          container.className = 'flex justify-center items-center gap-2 mt-4';
          participantsSection.appendChild(container);
        } else {
          console.error('Participants section not found, cannot render pagination.');
          return;
        }
      }

      container.innerHTML = '';

      // ì´ì „ ë²„íŠ¼
      const prevBtn = document.createElement('button');
      prevBtn.className = `px-3 py-1 rounded ${pagination.hasPrev ? 'bg-gray-200 hover:bg-gray-300' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`;
      prevBtn.innerText = 'ì´ì „';
      prevBtn.disabled = !pagination.hasPrev;
      prevBtn.onclick = () => loadParticipants(pagination.page - 1);
      container.appendChild(prevBtn);

      // ë‹¤ìŒ ë²„íŠ¼
      const nextBtn = document.createElement('button');
      nextBtn.className = `px-3 py-1 rounded ${pagination.hasNext ? 'bg-gray-200 hover:bg-gray-300' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`;
      nextBtn.innerText = 'ë‹¤ìŒ';
      nextBtn.disabled = !pagination.hasNext;
      nextBtn.onclick = () => loadParticipants(pagination.page + 1);
      container.appendChild(nextBtn);
    }

    async function downloadExcel() {
      try {
        // ì „ì²´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ limitì„ í¬ê²Œ ì„¤ì •
        const response = await authFetch('/api/admin/participants?limit=100000');
        if (!response.ok) {
          throw new Error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        const result = await response.json();
        const allParticipants = result.participants || [];

        if (allParticipants.length === 0) {
          alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ì—‘ì…€ìš© ë°ì´í„° ë³€í™˜
        const data = allParticipants.map(p => ({
          'ID': p.id,
          'ì‹ ì²­ì¼ì‹œ': formatDateTime(p.created_at),
          'ì´ë¦„': p.user_name,
          'ì „í™”ë²ˆí˜¸': formatPhone(p.phone),
          'ìƒë…„ì›”ì¼(ì•ìë¦¬)': p.ssn_first || '-',
          'í‹°ì¼“ìˆ˜': p.ticket_count,
          'ë™ë°˜ì ì´ë¦„': p.guest2_name || '-',
          'ë™ë°˜ì ì „í™”ë²ˆí˜¸': p.guest2_phone ? formatPhone(p.guest2_phone) : '-',
          'ë™ë°˜ì ìƒë…„ì›”ì¼': p.guest2_ssn_first || '-',
          'ì¢Œì„(ë³¸ì¸)': p.seat_full || '-',
          'ì¢Œì„(ë™ë°˜ì)': p.seat_full_2 || '-',
          'ì…ê¸ˆìƒíƒœ': p.is_paid ? 'ì…ê¸ˆì™„ë£Œ' : 'ëŒ€ê¸°',
          'ì²´í¬ì¸': p.is_checked_in ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ'
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ì°¸ê°€ìëª©ë¡");

        const date = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `í•œë™í›ˆí† í¬ì½˜ì„œíŠ¸_ì°¸ê°€ìëª©ë¡_${date}.xlsx`);
      } catch (error) {
        console.error('Excel download error:', error);
        alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    // ì·¨ì†Œ/í™˜ë¶ˆì ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ì·¨ì†Œ ìš”ì²­ì - í™œì„± ë°ì´í„°ì—ì„œ is_cancelled=1ì¸ ì°¸ê°€ì)
    async function downloadCancelledExcel() {
      try {
        const response = await authFetch('/api/admin/participants?limit=100000');
        if (!response.ok) {
          throw new Error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        const result = await response.json();
        const allParticipants = result.participants || [];

        // ì·¨ì†Œìë§Œ í•„í„°ë§ (is_cancelled=1)
        const cancelledParticipants = allParticipants.filter(p => p.is_cancelled === 1);

        if (cancelledParticipants.length === 0) {
          alert('ì·¨ì†Œ/í™˜ë¶ˆ ìš”ì²­ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ì—‘ì…€ìš© ë°ì´í„° ë³€í™˜
        const data = cancelledParticipants.map(p => ({
          'ID': p.id,
          'ì‹ ì²­ì¼ì‹œ': formatDateTime(p.created_at),
          'ì´ë¦„': p.user_name,
          'ì „í™”ë²ˆí˜¸': formatPhone(p.phone),
          'ìƒë…„ì›”ì¼(ì•ìë¦¬)': p.ssn_first || '-',
          'í‹°ì¼“ìˆ˜': p.ticket_count,
          'ë™ë°˜ì ì´ë¦„': p.guest2_name || '-',
          'ë™ë°˜ì ì „í™”ë²ˆí˜¸': p.guest2_phone ? formatPhone(p.guest2_phone) : '-',
          'ìƒíƒœ': 'ì·¨ì†Œìš”ì²­',
          'ì·¨ì†Œì¼ì‹œ': p.cancelled_at ? formatDateTime(p.cancelled_at) : '-',
          'ì·¨ì†Œì‚¬ìœ ': p.cancel_reason || '-',
          'í™˜ë¶ˆìƒíƒœ': p.refund_status || '-',
          'í™˜ë¶ˆê¸ˆì•¡': p.refund_amount ? p.refund_amount.toLocaleString() + 'ì›' : '-',
          'í™˜ë¶ˆì€í–‰': p.refund_bank || '-',
          'í™˜ë¶ˆê³„ì¢Œ': p.refund_account || '-',
          'ì˜ˆê¸ˆì£¼': p.refund_holder || '-'
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ì·¨ì†Œí™˜ë¶ˆìëª©ë¡");

        const date = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `í•œë™í›ˆí† í¬ì½˜ì„œíŠ¸_ì·¨ì†Œí™˜ë¶ˆì_${date}.xlsx`);
      } catch (error) {
        console.error('Cancelled Excel download error:', error);
        alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    // ì‚­ì œ(ì•„ì¹´ì´ë¸Œ) ë°ì´í„° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    async function downloadArchivedExcel() {
      try {
        const response = await authFetch('/api/admin/participants/archive/download');
        if (!response.ok) {
          throw new Error('ì•„ì¹´ì´ë¸Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        const result = await response.json();
        const archivedParticipants = result.participants || [];

        if (archivedParticipants.length === 0) {
          alert('ì‚­ì œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ì—‘ì…€ìš© ë°ì´í„° ë³€í™˜
        const data = archivedParticipants.map(p => ({
          'ì•„ì¹´ì´ë¸ŒID': p.id,
          'ì›ë³¸ID': p.original_id,
          'ì‹ ì²­ì¼ì‹œ': formatDateTime(p.created_at),
          'ì´ë¦„': p.user_name,
          'ì „í™”ë²ˆí˜¸': formatPhone(p.original_phone || p.phone),
          'ìƒë…„ì›”ì¼(ì•ìë¦¬)': p.ssn_first || '-',
          'í‹°ì¼“ìˆ˜': p.ticket_count,
          'ë™ë°˜ì ì´ë¦„': p.guest2_name || '-',
          'ë™ë°˜ì ì „í™”ë²ˆí˜¸': p.guest2_phone ? formatPhone(p.guest2_phone) : '-',
          'ì…ê¸ˆì—¬ë¶€': p.is_paid ? 'ì…ê¸ˆ' : 'ë¯¸ì…ê¸ˆ',
          'ì¢Œì„': p.seat_full || '-',
          'ë™ë°˜ì ì¢Œì„': p.seat_full_2 || '-',
          'ì‚­ì œì¼ì‹œ': formatDateTime(p.deleted_at),
          'ì•„ì¹´ì´ë¸Œì¼ì‹œ': formatDateTime(p.archived_at),
          'ì·¨ì†Œì—¬ë¶€': p.is_cancelled ? 'ì·¨ì†Œë¨' : '-',
          'ì·¨ì†Œì‚¬ìœ ': p.cancel_reason || '-',
          'í™˜ë¶ˆìƒíƒœ': p.refund_status || '-',
          'í™˜ë¶ˆê¸ˆì•¡': p.refund_amount ? p.refund_amount.toLocaleString() + 'ì›' : '-',
          'í™˜ë¶ˆì€í–‰': p.refund_bank || '-',
          'í™˜ë¶ˆê³„ì¢Œ': p.refund_account || '-',
          'ì˜ˆê¸ˆì£¼': p.refund_holder || '-'
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ì‚­ì œë°ì´í„°");

        const date = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `í•œë™í›ˆí† í¬ì½˜ì„œíŠ¸_ì‚­ì œë°ì´í„°_${date}.xlsx`);
      } catch (error) {
        console.error('Archived Excel download error:', error);
        alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    // ì°¸ê°€ì ì‹ ê·œ ë“±ë¡ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function showAddParticipantModal() {
      document.getElementById('addParticipantModal').classList.remove('hidden');
      document.getElementById('addParticipantModal').classList.add('flex');
      // í¼ ì´ˆê¸°í™”
      document.getElementById('addParticipantForm').reset();
      document.getElementById('companionFields').classList.add('hidden');
    }

    function closeAddParticipantModal() {
      document.getElementById('addParticipantModal').classList.add('hidden');
      document.getElementById('addParticipantModal').classList.remove('flex');
    }

    function toggleCompanionFields() {
      const hasCompanion = document.getElementById('addHasCompanion').checked;
      const companionFields = document.getElementById('companionFields');
      if (hasCompanion) {
        companionFields.classList.remove('hidden');
      } else {
        companionFields.classList.add('hidden');
      }
    }

    // ì°¸ê°€ì ì‹ ê·œ ë“±ë¡ í¼ ì œì¶œ í•¸ë“¤ëŸ¬
    async function handleAddParticipantSubmit(e) {
      e.preventDefault();
      e.stopPropagation();

      const userName = document.getElementById('addUserName').value.trim();
      const phone = document.getElementById('addPhone').value.trim().replace(/-/g, '');
      const ssnFirst = document.getElementById('addSsnFirst').value.trim();
      const isPaid = document.getElementById('addIsPaid').value === '1';
      const hasCompanion = document.getElementById('addHasCompanion').checked;

      // ìœ íš¨ì„± ê²€ì‚¬
      if (!userName || !phone || !ssnFirst) {
        alert('ì´ë¦„, ì „í™”ë²ˆí˜¸, ìƒë…„ì›”ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return false;
      }

      if (phone.length < 10 || phone.length > 11) {
        alert('ì „í™”ë²ˆí˜¸ëŠ” 10~11ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return false;
      }

      if (ssnFirst.length !== 6) {
        alert('ìƒë…„ì›”ì¼ì€ 6ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤. (ì˜ˆ: 880101)');
        return false;
      }

      const data = {
        user_name: userName,
        phone: phone,
        ssn_first: ssnFirst,
        is_paid: isPaid,
        ticket_count: hasCompanion ? 2 : 1,
        admin_note: document.getElementById('addAdminNote').value.trim() || 'ê´€ë¦¬ìê°€ ìˆ˜ë™ ë“±ë¡'
      };

      // ë™ë°˜ì ì •ë³´
      if (hasCompanion) {
        data.guest2_name = document.getElementById('addCompanionName').value.trim();
        data.guest2_phone = document.getElementById('addCompanionPhone').value.trim().replace(/-/g, '');
        data.guest2_ssn_first = document.getElementById('addCompanionSsn').value.trim();
      }

      // ì¢Œì„ ì •ë³´
      const seatGroup = document.getElementById('addSeatGroup').value.trim();
      const seatRow = document.getElementById('addSeatRow').value;
      const seatNumber = document.getElementById('addSeatNumber').value;

      if (seatGroup && seatRow && seatNumber) {
        data.seat_group = seatGroup;
        data.seat_row = parseInt(seatRow);
        data.seat_number = parseInt(seatNumber);
        data.seat_full = `${seatGroup}êµ¬ì—­ ${seatRow}ì—´ ${seatNumber}ë²ˆ`;
      }

      try {
        const response = await authFetch('/api/admin/participants/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (!response.ok) {
          const errorMsg = result.details ? `${result.error} (${result.details})` : (result.error || 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          throw new Error(errorMsg);
        }

        alert('ì°¸ê°€ìê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        closeAddParticipantModal();
        // ìºì‹œ ë¬´íš¨í™” í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        participantsCache = null;
        participantsCacheTime = null;
        loadParticipants(1, true); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      } catch (error) {
        console.error('Add participant error:', error);
        alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
      return false;
    }

    // DOM ë¡œë“œ í›„ í¼ ì´ë²¤íŠ¸ ë“±ë¡
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('addParticipantForm');
        if (form) {
          form.addEventListener('submit', handleAddParticipantSubmit);
        }
      });
    } else {
      const form = document.getElementById('addParticipantForm');
      if (form) {
        form.addEventListener('submit', handleAddParticipantSubmit);
      }
    }

    async function updateStatistics() {
      const totalCountEl = document.getElementById('totalCount');
      const paidCountEl = document.getElementById('paidCount');
      const seatedCountEl = document.getElementById('seatedCount');
      const checkedInCountEl = document.getElementById('checkedInCount');

      if (!totalCountEl || !paidCountEl) return;

      // ì„œë²„ì—ì„œ ì „ì²´ í†µê³„ ê°€ì ¸ì˜¤ê¸°
      try {
        const response = await authFetch('/api/admin/participants/dashboard-stats');
        const data = await response.json();

        if (!data.success) {
          console.error('Failed to load dashboard stats:', data.error);
          return;
        }

        const stats = data.stats;
        const totalCount = stats.totalPeople || 0;
        const paidCount = stats.paidPeople || 0;
        const seatedCount = stats.seatedPeople || 0;
        const checkedInCount = stats.checkedInPeople || 0;

        const maxParticipants = 1500;

        // ì´ ì‹ ì²­ì
        totalCountEl.textContent = totalCount.toLocaleString();
        const totalProgress = document.getElementById('totalProgress');
        if (totalProgress) {
          totalProgress.style.width = Math.min((totalCount / maxParticipants) * 100, 100) + '%';
        }

        // ì…ê¸ˆ ì™„ë£Œ
        paidCountEl.textContent = paidCount.toLocaleString();
        const paidProgress = document.getElementById('paidProgress');
        const paidPercent = document.getElementById('paidPercent');
        if (paidProgress && totalCount > 0) {
          const paidPct = (paidCount / totalCount) * 100;
          paidProgress.style.width = paidPct + '%';
          if (paidPercent) paidPercent.textContent = paidPct.toFixed(1) + '%';
        }

        // ì¢Œì„ ë°°ì •
        if (seatedCountEl) {
          seatedCountEl.textContent = seatedCount.toLocaleString();
          const seatedProgress = document.getElementById('seatedProgress');
          const seatedPercent = document.getElementById('seatedPercent');
          if (seatedProgress && paidCount > 0) {
            const seatedPct = (seatedCount / paidCount) * 100;
            seatedProgress.style.width = seatedPct + '%';
            if (seatedPercent) seatedPercent.textContent = seatedPct.toFixed(1) + '%';
          }
        }

        // ì²´í¬ì¸ ì™„ë£Œ
        if (checkedInCountEl) {
          checkedInCountEl.textContent = checkedInCount.toLocaleString();
          const checkedInProgress = document.getElementById('checkedInProgress');
          const checkedInPercent = document.getElementById('checkedInPercent');
          if (checkedInProgress && paidCount > 0) {
            const checkedInPct = (checkedInCount / paidCount) * 100;
            checkedInProgress.style.width = checkedInPct + '%';
            if (checkedInPercent) checkedInPercent.textContent = checkedInPct.toFixed(1) + '%';
          }
        }
      } catch (err) {
        console.error('Error loading dashboard stats:', err);
      }
    }

    function displayParticipants(list) {
      const tableBody = document.getElementById('tableBody');
      const table = document.getElementById('participantsTable');
      const loading = document.getElementById('loading');
      const emptyMessage = document.getElementById('emptyMessage');
      const countText = document.getElementById('countText');

      loading.classList.add('hidden');

      if (list.length === 0) {
        table.classList.add('hidden');
        emptyMessage.classList.remove('hidden');
        emptyMessage.textContent = document.getElementById('searchInput').value ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.';
        countText.textContent = '';
        return;
      }

      table.classList.remove('hidden');
      emptyMessage.classList.add('hidden');

      // ì‹¤ì œ ì°¸ê°€ì ìˆ˜ ê³„ì‚° (ticket_count í•©ì‚°)
      let totalCount = 0;
      list.forEach(function (p) {
        const ticketCount = p.ticket_count || 1;
        totalCount += ticketCount;
      });
      countText.textContent = `ì´ ${totalItems}ëª… (í˜„ì¬ í˜ì´ì§€ ${list.length}ëª…)`;

      // ì°¸ê°€ì ëª©ë¡ì„ í‰íƒ„í™”í•˜ì—¬ 2ë²ˆì§¸ ì°¸ê°€ìë„ ë³„ë„ í–‰ìœ¼ë¡œ í‘œì‹œ
      const flattenedList = [];
      list.forEach(p => {
        // 1ë²ˆì§¸ ì°¸ê°€ì í–‰
        flattenedList.push({
          ...p,
          is_guest: false,
          display_name: p.user_name,
          display_phone: p.phone,
          display_ssn: p.ssn_first,
          original_id: p.id,
          representative_name: '', // 1ì¸ ì‹ ì²­ìëŠ” ëŒ€ë¦¬ì‹ ì²­ ì—†ìŒ
          display_seat: p.seat_full || '-', // ì²« ë²ˆì§¸ ì¢Œì„
          display_checked_in: p.is_checked_in || false // ì…ì¥ í™•ì¸ ìƒíƒœ
        });

        // 2ë²ˆì§¸ ì°¸ê°€ìê°€ ìˆëŠ” ê²½ìš° (2ì¸ ì‹ ì²­)
        // ticket_countê°€ 2ì´ê±°ë‚˜, guest2_nameì´ ìˆìœ¼ë©´ 2ì¸ ì‹ ì²­
        const isTwoPerson = (p.ticket_count === 2) || p.guest2_name;

        if (isTwoPerson) {
          // 2ë²ˆì§¸ ì°¸ê°€ì í–‰ ì¶”ê°€
          // ì´ë¦„: guest2_nameì´ ìˆìœ¼ë©´ ì‹¤ì œ ì´ë¦„, ì—†ìœ¼ë©´ "ì²«ë²ˆì§¸ì‹ ì²­ì_2" í˜•ì‹
          // ëŒ€ë¦¬ì‹ ì²­: ì²« ë²ˆì§¸ ì‹ ì²­ìì˜ ì´ë¦„
          // ì¢Œì„: ë‘ ë²ˆì§¸ ì¢Œì„ (seat_full_2)
          flattenedList.push({
            ...p,
            is_guest: true,
            display_name: p.guest2_name || `${p.user_name}_2`,
            display_phone: p.guest2_phone || p.phone,
            display_ssn: p.guest2_ssn_first || p.ssn_first || '-',
            original_id: p.id,
            original_name: p.user_name, // ì£¼ ì‹ ì²­ì ì´ë¦„ (ë™ë°˜ì ì·¨ì†Œ ì‹œ í‘œì‹œìš©)
            is_guest2_pending: !p.guest2_name, // ì•„ì§ ì…ë ¥ ì•ˆë¨
            representative_name: p.user_name, // ëŒ€ë¦¬ì‹ ì²­ì ì´ë¦„ (ì²« ë²ˆì§¸ ì‹ ì²­ì)
            display_seat: p.seat_full_2 || '-', // ë‘ ë²ˆì§¸ ì¢Œì„
            display_checked_in: p.is_checked_in_2 || false // ë‘ ë²ˆì§¸ ì°¸ê°€ì ì…ì¥ í™•ì¸ ìƒíƒœ
          });
        }
      });

      tableBody.innerHTML = flattenedList.map((p, index) => {
        const rowClass = p.is_guest2_pending ? 'opacity-60' : '';

        return `
        <tr class="${rowClass}">
          <td class="text-center text-gray-500">${(currentPage - 1) * itemsPerPage + index + 1}</td>
          <td>${p.display_name}${p.is_guest2_pending ? ' <span class="text-xs text-gray-400">(ì…ë ¥ ëŒ€ê¸°)</span>' : ''}</td>
          <td>${p.representative_name || '-'}</td>
          <td>${formatPhone(p.display_phone)}</td>
          <td>${p.display_ssn || '-'}</td>
          <td>
            ${p.is_cancelled ? `
              <span class="text-gray-400 line-through">ì·¨ì†Œë¨</span>
            ` : `
              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="checkbox"
                  ${p.is_paid ? 'checked' : ''}
                  onchange="togglePayment(${p.original_id}, ${p.is_paid})"
                  style="width: 1.25rem; height: 1.25rem;"
                />
                <span class="${p.is_paid ? 'text-red-600 font-medium' : 'text-gray-500'}">
                  ${p.is_paid ? 'ì…ê¸ˆ ì™„ë£Œ' : 'ì…ê¸ˆ ëŒ€ê¸°'}
                </span>
              </label>
            `}
          </td>
          <td>
            <div class="flex items-center gap-1">
              <span class="${p.display_checked_in ? 'text-green-600 font-medium' : 'text-gray-400'}">
                ${p.display_checked_in ? 'âœ“ ì…ì¥ì™„ë£Œ' : '-'}
              </span>
              ${p.display_checked_in ? `
                <button onclick="resetCheckin(${p.original_id})" class="text-xs text-red-500 hover:text-red-700 ml-1" title="ì²´í¬ì¸ ì´ˆê¸°í™”">
                  âœ•
                </button>
              ` : ''}
            </div>
          </td>
          <td>
            <select class="zone-select seat-group-select" id="group-${p.original_id}${p.is_guest ? '-2' : ''}" onchange="updateSeat(${p.original_id}, ${p.is_guest ? 'true' : 'false'})" data-current-value="${p.seat_group || ''}">
              <option value="">ì„ íƒ</option>
              ${getCurrentGroupOptions(p.seat_group)}
            </select>
          </td>
          <td>
            <input
              type="text"
              class="seat-input"
              id="row-${p.original_id}${p.is_guest ? '-2' : ''}"
              value="${p.seat_row || ''}"
              placeholder="ì—´"
              onchange="updateSeat(${p.original_id}, ${p.is_guest ? 'true' : 'false'})"
            />
          </td>
          <td>
            <input
              type="text"
              class="seat-input"
              id="seat-${p.original_id}${p.is_guest ? '-2' : ''}"
              value="${p.seat_number || ''}"
              placeholder="ë²ˆí˜¸"
              onchange="updateSeat(${p.original_id}, ${p.is_guest ? 'true' : 'false'})"
            />
          </td>
          <td class="font-semibold text-red-600">${p.display_seat || p.seat_full || '-'}</td>
          <td class="text-sm text-gray-600">${formatDateTime(p.created_at)}</td>
          <td>
            <div class="flex gap-2">
              <button
                type="button"
                onclick="openEditModal(${p.original_id}, ${p.is_guest ? 'true' : 'false'})"
                class="p-2 text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded transition-colors"
                title="ì •ë³´ ìˆ˜ì •"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
              ${p.seat_full && !p.is_guest ? `
                <button
                  onclick="resetParticipantSeat(${p.original_id}, '${p.display_name}')"
                  class="p-2 text-orange-600 hover:text-orange-700 hover:bg-orange-50 rounded transition-colors"
                  title="ì¢Œì„ ì´ˆê¸°í™”"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                </button>
              ` : ''}
              ${p.is_guest ? `
                <button
                  onclick="cancelGuest2(${p.original_id}, '${p.original_name}', '${p.display_name}')"
                  class="p-2 text-purple-600 hover:text-purple-700 hover:bg-purple-50 rounded transition-colors"
                  title="ë™ë°˜ì ì·¨ì†Œ"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6" />
                  </svg>
                </button>
              ` : ''}
              <button
                onclick="deleteParticipant(${p.original_id}, '${p.display_name}')"
                class="p-2 text-red-600 hover:text-red-700 hover:bg-red-50 rounded transition-colors"
                title="${p.is_guest ? 'ì‹ ì²­ ì „ì²´ ì‚­ì œ (ì£¼ì‹ ì²­ì í¬í•¨)' : 'ì‚­ì œ'}"
                ${p.is_guest ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `;
      }).join('');
    }

    async function togglePayment(id, currentStatus) {
      try {
        const newStatus = currentStatus ? false : true; // 0->true, 1->false
        const response = await authFetch(`/api/admin/participants/${id}/payment`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_paid: newStatus }),
        });

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || 'ì…ê¸ˆ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
        }
        if (data.success) {
          // ìºì‹œ ë¬´íš¨í™” í›„ ìƒˆë¡œê³ ì¹¨
          participantsCache = null;
          participantsCacheTime = null;
          loadParticipants(currentPage, true); // ê°•ì œ ìƒˆë¡œê³ ì¹¨
        }
      } catch (err) {
        console.error('togglePayment error:', err);
        alert('ì…ê¸ˆ ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (err.message || ''));
      }
    }

    async function updateSeat(id, isGuest) {
      const idSuffix = isGuest ? '-2' : '';
      const group = document.getElementById(`group-${id}${idSuffix}`)?.value || '';
      const row = document.getElementById(`row-${id}${idSuffix}`)?.value || '';
      const number = document.getElementById(`seat-${id}${idSuffix}`)?.value || '';

      try {
        const response = await authFetch(`/api/admin/participants/${id}/seat`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            seat_group: group,
            seat_row: row,
            seat_number: number,
            is_guest: isGuest || false
          }),
        });

        const data = await response.json();
        if (data.success) {
          loadParticipants(currentPage); // í˜„ì¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
          alert(data.error || 'ì¢Œì„ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Error updating seat:', err);
        alert('ì¢Œì„ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ê·¸ë£¹ ì´ë¦„ ìƒì„± í•¨ìˆ˜
    function getGroupNames(type, count) {
      const koreanNames = ['ê°€', 'ë‚˜', 'ë‹¤', 'ë¼', 'ë§ˆ', 'ë°”', 'ì‚¬', 'ì•„', 'ì', 'ì°¨', 'ì¹´', 'íƒ€', 'íŒŒ', 'í•˜'];
      const alphabetNames = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
      const numberNames = Array.from({ length: 26 }, (_, i) => String(i + 1));

      let baseNames;
      switch (type) {
        case 'alphabet':
          baseNames = alphabetNames;
          break;
        case 'number':
          baseNames = numberNames;
          break;
        case 'korean':
        default:
          baseNames = koreanNames;
          break;
      }

      return baseNames.slice(0, Math.min(count, baseNames.length));
    }

    // í˜„ì¬ ê·¸ë£¹ ì˜µì…˜ HTML ìƒì„±
    function getCurrentGroupOptions(selectedValue) {
      const groupType = document.getElementById('groupType')?.value || 'korean';
      const groupCount = parseInt(document.getElementById('groupCount')?.value) || 14;
      const groups = getGroupNames(groupType, groupCount);

      return groups.map(g =>
        `<option value="${g}" ${selectedValue === g ? 'selected' : ''}>${g}</option>`
      ).join('');
    }

    // ëª¨ë“  ì¢Œì„ ê·¸ë£¹ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    function updateSeatGroupDropdowns() {
      const selects = document.querySelectorAll('.seat-group-select');
      selects.forEach(select => {
        const currentValue = select.dataset.currentValue || select.value;
        const optionsHtml = '<option value="">ì„ íƒ</option>' + getCurrentGroupOptions(currentValue);
        select.innerHTML = optionsHtml;
      });
    }

    function updateGroupDisplay() {
      const groupType = document.getElementById('groupType').value || 'korean';
      const groupCount = parseInt(document.getElementById('groupCount').value) || 14;
      const selectedGroups = getGroupNames(groupType, groupCount);
      document.getElementById('groupDisplay').textContent = selectedGroups.join(',');

      // ì¢Œì„ ì„ íƒ ë“œë¡­ë‹¤ìš´ë„ ì—…ë°ì´íŠ¸
      updateSeatGroupDropdowns();
    }


    // ì¢Œì„ ë°°ì • ê³µí†µ ë¡œì§ (ìƒˆ í˜•ì‹: ê·¸ë£¹-ë²ˆí˜¸)
    function getSeatAssignmentParams() {
      const groupType = document.getElementById('groupType').value || 'alphabet';
      const groupCount = parseInt(document.getElementById('groupCount').value) || 16;

      if (!groupCount) {
        return null;
      }

      const groups = getGroupNames(groupType, groupCount);

      return { groupType, groupCount, groups };
    }

    async function assignSeatsCommon(endpoint, confirmMessage) {
      const params = getSeatAssignmentParams();
      if (!params) {
        showError('ê·¸ë£¹ ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        const response = await authFetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            groups: params.groups
          }),
        });

        const data = await response.json();
        if (data.success) {
          showSuccess(data.message + (data.total_available ? ` (ì´ ${data.total_available}ì„ ì¤‘ ${data.assigned_count}ì„ ë°°ì •)` : ''));
          loadParticipants(currentPage); // í˜„ì¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
          showError(data.error || 'ì¢Œì„ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Seat assignment error:', err);
        showError('ì¢Œì„ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function randomAssignSeats() {
      const params = getSeatAssignmentParams();
      if (!params) {
        showError('ê·¸ë£¹ ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const confirmMessage = `ì…ê¸ˆ ì™„ë£Œëœ ì°¸ê°€ìë“¤ì—ê²Œ ëœë¤ìœ¼ë¡œ ì¢Œì„ì„ ë°°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê·¸ë£¹: ${params.groups.join(', ')}`;
      await assignSeatsCommon('/api/admin/participants/random-seats', confirmMessage);
    }

    async function resetParticipantSeat(id, userName) {
      const confirmMessage = userName
        ? `"${userName}" ì°¸ê°€ìì˜ ì¢Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
        : 'ì´ ì°¸ê°€ìì˜ ì¢Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';

      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        const response = await authFetch(`/api/admin/participants/${id}/seat`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (data.success) {
          alert('ì¢Œì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadParticipants(currentPage); // í˜„ì¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
          alert(data.error || 'ì¢Œì„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Reset seat error:', err);
        alert('ì¢Œì„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì²´í¬ì¸ ì´ˆê¸°í™”
    async function resetCheckin(participantId) {
      if (!confirm('ì´ ì°¸ê°€ìì˜ ì²´í¬ì¸ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const response = await authFetch(`/api/admin/checkin/participant/${participantId}`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (data.success) {
          alert(data.message);
          loadParticipants(currentPage);
          loadCheckinStats();
        } else {
          alert(data.error || 'ì²´í¬ì¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Reset checkin error:', err);
        alert('ì²´í¬ì¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë™ë°˜ìë§Œ ì·¨ì†Œ (2ì¸ ì‹ ì²­ -> 1ì¸ ì‹ ì²­)
    async function cancelGuest2(participantId, mainName, guestName) {
      const confirmMessage = `"${mainName}"ë‹˜ì˜ ë™ë°˜ì "${guestName}"ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ 2ì¸ ì‹ ì²­ â†’ 1ì¸ ì‹ ì²­ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤\nâ€¢ ë™ë°˜ìì˜ ì¢Œì„ë„ í•¨ê»˜ í•´ì œë©ë‹ˆë‹¤\nâ€¢ ì£¼ ì‹ ì²­ìëŠ” ìœ ì§€ë©ë‹ˆë‹¤`;

      if (!confirm(confirmMessage)) return;

      try {
        const response = await authFetch(`/api/admin/participants/${participantId}/guest2`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (data.success) {
          alert(data.message || 'ë™ë°˜ìê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          // ìºì‹œ ë¬´íš¨í™” í›„ ìƒˆë¡œê³ ì¹¨
          participantsCache = null;
          participantsCacheTime = null;
          loadParticipants(currentPage, true);
        } else {
          alert(data.error || 'ë™ë°˜ì ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Cancel guest2 error:', err);
        alert('ë™ë°˜ì ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }

    async function deleteParticipant(id, userName) {
      const confirmMessage = userName
        ? `"${userName}" ì°¸ê°€ì ì •ë³´ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
        : 'ì´ ì°¸ê°€ì ì •ë³´ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';

      if (!confirm(confirmMessage)) return;

      try {
        const response = await authFetch(`/api/admin/participants/${id}`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (data.success) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadParticipants(currentPage); // í˜„ì¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
          alert(data.error || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Delete error:', err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }

    async function ageBasedAssignSeats() {
      const params = getSeatAssignmentParams();
      if (!params) {
        showError('ê·¸ë£¹ ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const confirmMessage = `ì…ê¸ˆ ì™„ë£Œëœ ì°¸ê°€ìë“¤ì—ê²Œ ì—°ë ¹ëŒ€ë³„ë¡œ ì¢Œì„ì„ ë°°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n00ë…„ëŒ€ìƒ â†’ 90ë…„ëŒ€ìƒ â†’ 80ë…„ëŒ€ìƒ ìˆœìœ¼ë¡œ ì•ì¢Œì„(Aê·¸ë£¹ë¶€í„°)ì— ë°°ì •ë©ë‹ˆë‹¤.\n\nê·¸ë£¹: ${params.groups.join(', ')}`;
      await assignSeatsCommon('/api/admin/participants/age-based-seats', confirmMessage);
    }

    async function resetAllSeats() {
      if (!confirm('ëª¨ë“  ì°¸ê°€ìì˜ ì¢Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
      }

      try {
        const response = await authFetch('/api/admin/participants/reset-seats', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        const data = await response.json();
        if (data.success) {
          alert(data.message || 'ëª¨ë“  ì¢Œì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadParticipants(currentPage); // í˜„ì¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
          alert(data.error || 'ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Reset seats error:', err);
        alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function formatPhone(value) {
      if (!value) return '-';
      const cleaned = value.replace(/\D/g, '');
      if (cleaned.length <= 3) return cleaned;
      if (cleaned.length <= 7) return `${cleaned.slice(0, 3)}-${cleaned.slice(3)}`;
      return `${cleaned.slice(0, 3)}-${cleaned.slice(3, 7)}-${cleaned.slice(7, 11)}`;
    }

    function formatDateTime(dateTimeStr) {
      if (!dateTimeStr) return '-';
      try {
        // YYYY-MM-DD HH:mm:ss í˜•ì‹ì„ íŒŒì‹±
        const dateStr = dateTimeStr.replace(' ', 'T');
        const date = new Date(dateStr);
        // í•œêµ­ ì‹œê°„ëŒ€ë¡œ í‘œì‹œ
        return date.toLocaleString('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false,
          timeZone: 'Asia/Seoul'
        });
      } catch (e) {
        return dateTimeStr;
      }
    }

    // íƒ­ ì „í™˜ í•¨ìˆ˜
    function resetAllTabStyles() {
      const tabs = ['participantsTab', 'paymentTab', 'inquiriesTab', 'checkinTab', 'storiesTab', 'refundsTab'];
      const sections = ['participantsSection', 'paymentSection', 'inquiriesSection', 'checkinSection', 'storiesSection', 'refundsSection'];
      tabs.forEach(tab => {
        const el = document.getElementById(tab);
        if (el) {
          el.classList.remove('text-red-600', 'border-b-2', 'border-red-600');
          el.classList.add('text-gray-600');
        }
      });
      sections.forEach(section => {
        const el = document.getElementById(section);
        if (el) el.classList.add('hidden');
      });
    }

    function showParticipantsTab() {
      resetAllTabStyles();
      document.getElementById('participantsSection').classList.remove('hidden');
      document.getElementById('participantsTab').classList.add('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('participantsTab').classList.remove('text-gray-600');
      // íƒ­ ì „í™˜ ì‹œ í•­ìƒ ìµœì‹  ë°ì´í„° ë¡œë“œ (ìºì‹œ ë¬´ì‹œ)
      loadParticipants(1, true);
      // ê°œì¸ì •ë³´ ë™ì˜ í˜„í™© ë¡œë“œ
      loadPrivacyStats();
    }

    function showPaymentTab() {
      resetAllTabStyles();
      document.getElementById('paymentSection').classList.remove('hidden');
      document.getElementById('paymentTab').classList.add('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('paymentTab').classList.remove('text-gray-600');

      // ì €ì¥ëœ ë°ì´í„° ë³µì›
      if (paymentDataList.length === 0) {
        loadPaymentDataFromStorage();
      }
    }

    function showInquiriesTab() {
      resetAllTabStyles();
      document.getElementById('inquiriesSection').classList.remove('hidden');
      document.getElementById('inquiriesTab').classList.add('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('inquiriesTab').classList.remove('text-gray-600');
      loadInquiries();
    }

    function showCheckinTab() {
      resetAllTabStyles();
      document.getElementById('checkinSection').classList.remove('hidden');
      document.getElementById('checkinTab').classList.add('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('checkinTab').classList.remove('text-gray-600');

      // ì²´í¬ì¸ í†µê³„ ë° ìµœê·¼ ê¸°ë¡ ë¡œë“œ
      loadCheckinStats();
      loadRecentCheckins();

      // ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì´ˆê¸°í™” ë° í¬ì»¤ìŠ¤
      initBarcodeScanner();
    }

    function showStoriesTab() {
      resetAllTabStyles();
      document.getElementById('storiesSection').classList.remove('hidden');
      document.getElementById('storiesTab').classList.add('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('storiesTab').classList.remove('text-gray-600');
      loadStories();
    }

    function showRefundsTab() {
      resetAllTabStyles();
      document.getElementById('refundsSection').classList.remove('hidden');
      document.getElementById('refundsTab').classList.add('text-red-600', 'border-b-2', 'border-red-600');
      document.getElementById('refundsTab').classList.remove('text-gray-600');
      loadRefunds();
    }

    // í™˜ë¶ˆ/ì·¨ì†Œ ê´€ë ¨ í•¨ìˆ˜
    async function loadRefunds() {
      const loadingEl = document.getElementById('refundLoading');
      const tableEl = document.getElementById('refundsTable');
      const emptyEl = document.getElementById('refundEmptyMessage');

      loadingEl.classList.remove('hidden');
      tableEl.classList.add('hidden');
      emptyEl.classList.add('hidden');

      try {
        const response = await authFetch('/api/participants/refunds');
        const data = await response.json();

        if (data.success) {
          refundsList = data.data || [];
          filterRefunds();
          updateRefundStats();
          updatePendingRefundsBadge();
        } else {
          throw new Error(data.error || 'í™˜ë¶ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Load refunds error:', err);
        alert(err.message || 'í™˜ë¶ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      } finally {
        loadingEl.classList.add('hidden');
      }
    }

    function updateRefundStats() {
      const pending = refundsList.filter(r => r.refund_status === 'pending').length;
      const completed = refundsList.filter(r => r.refund_status === 'completed').length;
      // ì·¨ì†Œëœ ëª¨ë“  ì‚¬ëŒ (í™˜ë¶ˆ ì‹ ì²­ ì—¬ë¶€ ë¬´ê´€)
      const cancelled = refundsList.filter(r => r.is_cancelled === 1).length;

      document.getElementById('pendingRefundCount').textContent = pending;
      document.getElementById('completedRefundCount').textContent = completed;
      document.getElementById('cancelledCount').textContent = cancelled;
    }

    function updatePendingRefundsBadge() {
      const pending = refundsList.filter(r => r.refund_status === 'pending').length;
      const badge = document.getElementById('pendingRefundsBadge');
      if (pending > 0) {
        badge.textContent = pending;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    function filterRefunds() {
      const filter = document.getElementById('refundFilter').value;

      if (filter === 'all') {
        filteredRefundsList = refundsList;
      } else if (filter === 'pending') {
        filteredRefundsList = refundsList.filter(r => r.refund_status === 'pending');
      } else if (filter === 'completed') {
        filteredRefundsList = refundsList.filter(r => r.refund_status === 'completed');
      } else if (filter === 'cancelled') {
        // ì·¨ì†Œëœ ëª¨ë“  ì‚¬ëŒ í‘œì‹œ (í™˜ë¶ˆ ì‹ ì²­ ì—¬ë¶€ ë¬´ê´€)
        filteredRefundsList = refundsList.filter(r => r.is_cancelled === 1);
      }

      renderRefundsTable();
    }

    function renderRefundsTable() {
      const tableEl = document.getElementById('refundsTable');
      const bodyEl = document.getElementById('refundsBody');
      const emptyEl = document.getElementById('refundEmptyMessage');
      const countEl = document.getElementById('refundCountText');

      if (filteredRefundsList.length === 0) {
        tableEl.classList.add('hidden');
        emptyEl.classList.remove('hidden');
        countEl.textContent = '';
        return;
      }

      tableEl.classList.remove('hidden');
      emptyEl.classList.add('hidden');
      countEl.textContent = `ì´ ${filteredRefundsList.length}ê±´`;

      bodyEl.innerHTML = filteredRefundsList.map(r => {
        let statusBadge = '';
        let actionButtons = '';

        if (r.refund_status === 'pending') {
          statusBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">í™˜ë¶ˆ ëŒ€ê¸°</span>';
          actionButtons = `<button onclick="completeRefund(${r.id})" class="btn-primary-glass px-3 py-1 text-xs">í™˜ë¶ˆ ì™„ë£Œ</button>`;
        } else if (r.refund_status === 'completed') {
          statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">í™˜ë¶ˆ ì™„ë£Œ</span>';
          actionButtons = `<span class="text-xs text-gray-500">${formatDateTime(r.refund_completed_at)}</span>`;
        } else if (r.is_cancelled === 1) {
          statusBadge = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">ì·¨ì†Œë¨</span>';
          actionButtons = '-';
        }

        const cancelReason = r.cancel_reason || '-';
        const refundReason = r.refund_reason || '';
        const displayReason = refundReason || cancelReason;

        return `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3">${statusBadge}</td>
            <td class="px-4 py-3 font-medium">${r.user_name}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${r.phone}</td>
            <td class="px-4 py-3 font-medium">${r.refund_amount ? r.refund_amount.toLocaleString() + 'ì›' : '-'}</td>
            <td class="px-4 py-3 text-sm">${r.refund_bank || '-'} ${r.refund_account || ''}</td>
            <td class="px-4 py-3 text-sm">${r.refund_holder || '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-600 max-w-xs truncate" title="${displayReason}">${displayReason}</td>
            <td class="px-4 py-3 text-sm text-gray-500">${formatDateTime(r.cancelled_at || r.created_at)}</td>
            <td class="px-4 py-3 text-center">${actionButtons}</td>
          </tr>
        `;
      }).join('');
    }

    async function completeRefund(participantId) {
      if (!confirm('í™˜ë¶ˆ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        const response = await authFetch(`/api/participants/${participantId}/refund-complete`, {
          method: 'PUT'
        });
        const data = await response.json();

        if (data.success) {
          alert('í™˜ë¶ˆ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadRefunds();
        } else {
          throw new Error(data.error || 'í™˜ë¶ˆ ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Complete refund error:', err);
        alert(err.message || 'í™˜ë¶ˆ ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ========== ë¬¸ì˜ ê´€ë¦¬ ==========

    // ë¬¸ì˜ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    function exportInquiriesToExcel() {
      if (inquiries.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // BOM for UTF-8
      const BOM = '\uFEFF';

      // CSV í—¤ë”
      const headers = ['ë²ˆí˜¸', 'ì´ë¦„', 'ì „í™”ë²ˆí˜¸', 'ë¬¸ì˜ë‚´ìš©', 'ë¬¸ì˜ì¼ì‹œ', 'ë‹µë³€ìƒíƒœ', 'ë‹µë³€ë‚´ìš©', 'ë‹µë³€ì¼ì‹œ'];

      // CSV ë°ì´í„° ìƒì„±
      const rows = inquiries.map((inq, index) => {
        const escapeCsv = (str) => {
          if (!str) return '';
          const escaped = String(str).replace(/"/g, '""');
          return `"${escaped}"`;
        };

        return [
          index + 1,
          escapeCsv(inq.user_name),
          escapeCsv(inq.phone),
          escapeCsv(inq.content),
          escapeCsv(inq.created_at),
          inq.is_answered ? 'ë‹µë³€ì™„ë£Œ' : 'ë¯¸ë‹µë³€',
          escapeCsv(inq.answer || ''),
          escapeCsv(inq.answered_at || '')
        ].join(',');
      });

      const csvContent = BOM + headers.join(',') + '\n' + rows.join('\n');

      // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);

      const now = new Date();
      const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
      const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '').substring(0, 4);

      link.setAttribute('href', url);
      link.setAttribute('download', `ë¬¸ì˜ë‚´ì—­_${dateStr}_${timeStr}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      alert(`ì´ ${inquiries.length}ê±´ì˜ ë¬¸ì˜ ë‚´ì—­ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    async function loadInquiries() {
      const loading = document.getElementById('inquiryLoading');
      if (loading) loading.classList.remove('hidden');

      try {
        const response = await authFetch('/api/admin/inquiries');

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
          inquiries = data.inquiries || [];
          updateUnansweredBadge(); // ë¯¸ë‹µë³€ ë°°ì§€ ì—…ë°ì´íŠ¸
          filterInquiries(inquiryFilterState); // Apply current filter state
        } else {
          console.error('API error:', data.error);
          alert('ë¬¸ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (err) {
        console.error('Error loading inquiries:', err);
        alert('ë¬¸ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      } finally {
        if (loading) loading.classList.add('hidden');
      }
    }

    // ë¯¸ë‹µë³€ ë¬¸ì˜ ê°œìˆ˜ ë°°ì§€ ì—…ë°ì´íŠ¸
    function updateUnansweredBadge() {
      const unansweredCount = inquiries.filter(inq => !inq.is_answered).length;
      const badge = document.getElementById('unansweredBadge');
      if (badge) {
        if (unansweredCount > 0) {
          badge.textContent = unansweredCount > 99 ? '99+' : unansweredCount;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }

    function filterInquiries(filter) {
      inquiryFilterState = filter; // Update filter state
      const searchInput = document.getElementById('inquirySearchInput');
      const search = searchInput ? searchInput.value.toLowerCase() : '';

      let tempFiltered = inquiries;

      if (filter === 'unanswered') {
        tempFiltered = tempFiltered.filter(inq => !inq.is_answered);
      } else if (filter === 'answered') {
        tempFiltered = tempFiltered.filter(inq => inq.is_answered);
      }

      if (search) {
        tempFiltered = tempFiltered.filter(i =>
          i.user_name.toLowerCase().includes(search) ||
          i.phone.includes(search) ||
          i.content.toLowerCase().includes(search)
        );
      }

      filteredInquiries = tempFiltered;
      displayInquiries(filteredInquiries);
    }

    function displayInquiries(list) {
      const inquiriesList = document.getElementById('inquiriesList');
      const loading = document.getElementById('inquiryLoading');
      const emptyMessage = document.getElementById('inquiryEmptyMessage');
      const countText = document.getElementById('inquiryCountText');

      loading.classList.add('hidden');

      if (list.length === 0) {
        inquiriesList.classList.add('hidden');
        emptyMessage.classList.remove('hidden');
        emptyMessage.textContent = document.getElementById('inquirySearchInput').value ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.';
        countText.textContent = '';
        return;
      }

      inquiriesList.classList.remove('hidden');
      emptyMessage.classList.add('hidden');
      countText.textContent = `ì´ ${list.length}ê±´`;

      inquiriesList.innerHTML = list.map(inq => `
        <div class="glass-card p-6 ${inq.is_answered ? 'bg-green-50/50' : 'bg-white'}">
          <div class="flex justify-between items-start mb-4">
            <div>
              <div class="flex items-center gap-3 mb-2">
                <span class="font-semibold text-gray-900">${inq.user_name}</span>
                <span class="text-sm text-gray-500">${formatPhone(inq.phone)}</span>
                <span class="text-xs text-gray-400">${formatDateTime(inq.created_at)}</span>
              </div>
              ${inq.is_answered ? '<span class="badge-green text-xs">ë‹µë³€ ì™„ë£Œ</span>' : '<span class="badge-red text-xs">ë‹µë³€ ëŒ€ê¸°</span>'}
            </div>
            <button 
              onclick="deleteInquiry(${inq.id}, '${inq.user_name}')" 
              class="p-2 text-red-600 hover:text-red-700 hover:bg-red-50 rounded transition-colors"
              title="ì‚­ì œ"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
          
          <div class="mb-4">
            <p class="text-sm font-medium text-gray-700 mb-2">ë¬¸ì˜ë‚´ìš©</p>
            <p class="text-gray-900 whitespace-pre-wrap">${inq.content}</p>
          </div>

          ${inq.is_answered ? `
            <div class="mt-4 pt-4 border-t border-gray-200">
              <div class="flex justify-between items-start mb-2">
                <p class="text-sm font-medium text-gray-700">ë‹µë³€</p>
                <button
                  onclick="toggleEditAnswer(${inq.id})"
                  class="text-xs text-blue-600 hover:text-blue-700"
                  id="editAnswerBtn-${inq.id}"
                >
                  ìˆ˜ì •
                </button>
              </div>
              <div id="answerDisplay-${inq.id}">
                <p class="text-gray-900 whitespace-pre-wrap">${inq.answer}</p>
                <p class="text-xs text-gray-400 mt-2">ë‹µë³€ì¼ì‹œ: ${formatDateTime(inq.answered_at)}</p>
              </div>
              <div id="answerEdit-${inq.id}" class="hidden">
                <textarea
                  id="editAnswer-${inq.id}"
                  class="input-glass w-full"
                  rows="3"
                >${inq.answer}</textarea>
                <div class="flex gap-2 mt-2">
                  <button
                    onclick="cancelEditAnswer(${inq.id})"
                    class="btn-secondary-glass"
                  >
                    ì·¨ì†Œ
                  </button>
                  <button
                    onclick="updateAnswer(${inq.id})"
                    class="btn-primary-glass"
                  >
                    ì €ì¥
                  </button>
                </div>
              </div>
            </div>
          ` : `
            <div class="mt-4 pt-4 border-t border-gray-200">
              <textarea
                id="answer-${inq.id}"
                class="input-glass w-full"
                rows="3"
                placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..."
              ></textarea>
              <button 
                onclick="submitAnswer(${inq.id})" 
                class="btn-primary-glass mt-2"
              >
                ë‹µë³€ ë“±ë¡
              </button>
            </div>
          `}
        </div>
      `).join('');

      // ê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      const inquirySearchInput = document.getElementById('inquirySearchInput');
      if (inquirySearchInput) {
        // Debounce ì ìš©ëœ ê²€ìƒ‰ (300ms)
        const debouncedInquiryFilter = debounce(() => {
          filterInquiries(inquiryFilterState);
        }, SEARCH_DEBOUNCE_MS);
        inquirySearchInput.removeEventListener('input', debouncedInquiryFilter); // Prevent multiple listeners
        inquirySearchInput.addEventListener('input', debouncedInquiryFilter);
      }
    }

    async function submitAnswer(id) {
      const answerInput = document.getElementById(`answer-${id}`);
      if (!answerInput || !answerInput.value.trim()) {
        alert('ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const response = await authFetch(`/api/admin/inquiries/${id}/answer`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ answer: answerInput.value.trim() }),
        });

        const data = await response.json();
        if (data.success) {
          alert('ë‹µë³€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadInquiries();
        } else {
          alert(data.error || 'ë‹µë³€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Submit answer error:', err);
        alert('ë‹µë³€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë‹µë³€ ìˆ˜ì • í† ê¸€
    function toggleEditAnswer(id) {
      const displayDiv = document.getElementById(`answerDisplay-${id}`);
      const editDiv = document.getElementById(`answerEdit-${id}`);
      const editBtn = document.getElementById(`editAnswerBtn-${id}`);

      if (editDiv.classList.contains('hidden')) {
        displayDiv.classList.add('hidden');
        editDiv.classList.remove('hidden');
        editBtn.textContent = 'ì·¨ì†Œ';
      } else {
        displayDiv.classList.remove('hidden');
        editDiv.classList.add('hidden');
        editBtn.textContent = 'ìˆ˜ì •';
      }
    }

    // ë‹µë³€ ìˆ˜ì • ì·¨ì†Œ
    function cancelEditAnswer(id) {
      const displayDiv = document.getElementById(`answerDisplay-${id}`);
      const editDiv = document.getElementById(`answerEdit-${id}`);
      const editBtn = document.getElementById(`editAnswerBtn-${id}`);

      displayDiv.classList.remove('hidden');
      editDiv.classList.add('hidden');
      editBtn.textContent = 'ìˆ˜ì •';
    }

    // ë‹µë³€ ìˆ˜ì • ì €ì¥
    async function updateAnswer(id) {
      const editInput = document.getElementById(`editAnswer-${id}`);
      if (!editInput || !editInput.value.trim()) {
        alert('ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const response = await authFetch(`/api/admin/inquiries/${id}/answer`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ answer: editInput.value.trim() }),
        });

        const data = await response.json();
        if (data.success) {
          alert('ë‹µë³€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadInquiries();
        } else {
          alert(data.error || 'ë‹µë³€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Update answer error:', err);
        alert('ë‹µë³€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function deleteInquiry(id, userName) {
      if (!confirm(`"${userName}"ë‹˜ì˜ ë¬¸ì˜ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
      }

      try {
        const response = await authFetch(`/api/admin/inquiries/${id}`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (data.success) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadInquiries();
        } else {
          alert(data.error || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Delete inquiry error:', err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ========== ì‚¬ì—° ê´€ë¦¬ ==========

    async function loadStories() {
      const loading = document.getElementById('storyLoading');
      if (loading) loading.classList.remove('hidden');

      try {
        const response = await authFetch('/api/admin/stories?limit=100');

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
          stories = data.stories || [];
          updateUnreadStoriesBadge();
          filterStories();
        } else {
          console.error('API error:', data.error);
          alert('ì‚¬ì—° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (err) {
        console.error('Error loading stories:', err);
        alert('ì‚¬ì—° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        if (loading) loading.classList.add('hidden');
      }
    }

    function updateUnreadStoriesBadge() {
      const unreadCount = stories.filter(s => !s.is_read).length;
      const badge = document.getElementById('unreadStoriesBadge');
      if (badge) {
        if (unreadCount > 0) {
          badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }

    function filterStories() {
      const filter = document.getElementById('storyFilter')?.value || 'all';
      const searchTerm = document.getElementById('storySearchInput')?.value?.toLowerCase() || '';

      filteredStories = stories.filter(story => {
        // í•„í„° ì ìš©
        if (filter === 'unread' && story.is_read) return false;
        if (filter === 'read' && !story.is_read) return false;

        // ê²€ìƒ‰ì–´ ì ìš©
        if (searchTerm) {
          const name = (story.name || '').toLowerCase();
          const phone = (story.phone || '').replace(/\D/g, '');
          const searchPhone = searchTerm.replace(/\D/g, '');
          if (!name.includes(searchTerm) && !phone.includes(searchPhone)) {
            return false;
          }
        }

        return true;
      });

      renderStories();
    }

    function renderStories() {
      const list = document.getElementById('storiesList');
      const emptyMessage = document.getElementById('storyEmptyMessage');
      const countText = document.getElementById('storyCountText');
      const loading = document.getElementById('storyLoading');

      if (loading) loading.classList.add('hidden');

      if (filteredStories.length === 0) {
        if (list) list.classList.add('hidden');
        if (emptyMessage) {
          emptyMessage.textContent = stories.length === 0 ? 'ë“±ë¡ëœ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤.' : 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
          emptyMessage.classList.remove('hidden');
        }
        if (countText) countText.textContent = '';
        return;
      }

      if (emptyMessage) emptyMessage.classList.add('hidden');
      if (list) list.classList.remove('hidden');

      const unreadCount = stories.filter(s => !s.is_read).length;
      if (countText) {
        countText.textContent = `ì „ì²´ ${stories.length}ê±´ (ì•ˆ ì½ìŒ ${unreadCount}ê±´) | í‘œì‹œ ${filteredStories.length}ê±´`;
      }

      list.innerHTML = filteredStories.map(story => `
        <div class="p-4 rounded-xl ${story.is_read ? 'bg-gray-50' : 'bg-orange-50 border-l-4 border-orange-400'}">
          <div class="flex justify-between items-start mb-2">
            <div class="flex items-center gap-3">
              <span class="font-semibold text-gray-900">${story.name}</span>
              <span class="text-sm text-gray-500">${formatPhone(story.phone)}</span>
              ${story.is_read ? '<span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded">ì½ìŒ</span>' : '<span class="text-xs bg-orange-500 text-white px-2 py-0.5 rounded">ì•ˆ ì½ìŒ</span>'}
            </div>
            <span class="text-xs text-gray-400">${formatDateTime(story.created_at)}</span>
          </div>
          ${story.title ? `<p class="font-medium text-gray-800 mb-2">${escapeHtml(story.title)}</p>` : ''}
          <div class="text-gray-700 text-sm whitespace-pre-wrap bg-white p-3 rounded-lg border border-gray-100 max-h-40 overflow-y-auto">${escapeHtml(story.content)}</div>
          <div class="flex gap-2 mt-3">
            ${!story.is_read ? `
              <button onclick="markStoryAsRead(${story.id})" class="text-sm text-blue-600 hover:text-blue-800">
                ì½ìŒ í‘œì‹œ
              </button>
            ` : ''}
            <button onclick="deleteStory(${story.id}, '${story.name}')" class="text-sm text-red-600 hover:text-red-800">
              ì‚­ì œ
            </button>
          </div>
        </div>
      `).join('');
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function markStoryAsRead(id) {
      try {
        const response = await authFetch(`/api/admin/stories/${id}/read`, {
          method: 'PUT',
        });

        const data = await response.json();
        if (data.success) {
          // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
          const story = stories.find(s => s.id === id);
          if (story) story.is_read = 1;
          updateUnreadStoriesBadge();
          filterStories();
        } else {
          alert(data.error || 'ì½ìŒ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Mark story as read error:', err);
        alert('ì½ìŒ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function deleteStory(id, userName) {
      if (!confirm(`"${userName}"ë‹˜ì˜ ì‚¬ì—°ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
      }

      try {
        const response = await authFetch(`/api/admin/stories/${id}`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (data.success) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadStories();
        } else {
          alert(data.error || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Delete story error:', err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function exportStoriesToExcel() {
      if (stories.length === 0) {
        alert('ë‚´ë³´ë‚¼ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const data = stories.map(story => ({
        'ì´ë¦„': story.name,
        'ì—°ë½ì²˜': formatPhone(story.phone),
        'ì œëª©': story.title || '',
        'ë‚´ìš©': story.content,
        'ì½ìŒì—¬ë¶€': story.is_read ? 'ì½ìŒ' : 'ì•ˆ ì½ìŒ',
        'ë“±ë¡ì¼ì‹œ': formatDateTime(story.created_at)
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'ì‚¬ì—°ëª©ë¡');

      const today = new Date().toISOString().slice(0, 10);
      XLSX.writeFile(wb, `í•œë™í›ˆí† í¬ì½˜ì„œíŠ¸_ì‚¬ì—°_${today}.xlsx`);
    }

    // ì…ê¸ˆ ë°ì´í„° íŒŒì‹± ë° ë§¤ì¹­
    let paymentDataList = [];
    let allParticipants = [];

    // ì „ì²´ ì°¸ê°€ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
    async function reloadAllParticipants() {
      try {
        // ìºì‹œ ë²„ìŠ¤íŒ…ì„ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
        const timestamp = Date.now();
        const response = await authFetch(`/api/admin/participants?limit=9999&_t=${timestamp}`);
        const data = await response.json();
        if (data.success) {
          allParticipants = data.participants || [];
          console.log('[Payment] Reloaded allParticipants:', allParticipants.length, 'paid:', allParticipants.filter(p => p.is_paid).length);
        }
      } catch (err) {
        console.error('Error reloading allParticipants:', err);
      }
    }

    // ì„œë²„ì— ì…ê¸ˆ ë°ì´í„° ì €ì¥ (debounce ì ìš©)
    function savePaymentDataToStorage() {
      // ì´ì „ íƒ€ì´ë¨¸ ì·¨ì†Œ
      if (savePaymentDataTimeout) {
        clearTimeout(savePaymentDataTimeout);
      }

      // 1ì´ˆ í›„ ì €ì¥ (debounce)
      savePaymentDataTimeout = setTimeout(function () {
        try {
          // matchedParticipantëŠ” ê°ì²´ì´ë¯€ë¡œ IDë§Œ ì €ì¥
          const dataToSave = paymentDataList.map(function (item) {
            return {
              date: item.date,
              type: item.type,
              amount: item.amount,
              balance: item.balance,
              transactionType: item.transactionType,
              content: item.content,
              memo: item.memo,
              matchedName: item.matchedName,
              matchedPhoneLast4: item.matchedPhoneLast4,
              matchedParticipantId: item.matchedParticipant ? item.matchedParticipant.id : null,
              approved: item.approved
            };
          });

          // ì„œë²„ì— ì €ì¥
          authFetch('/api/admin/participants/payment-records/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ records: dataToSave })
          })
            .then(function (response) { return response.json(); })
            .then(function (data) {
              if (data.success) {
                console.log('[Payment] ì„œë²„ ì €ì¥ ì™„ë£Œ:', dataToSave.length, 'ê°œ');
              } else {
                console.error('[Payment] ì„œë²„ ì €ì¥ ì‹¤íŒ¨:', data.error);
              }
            })
            .catch(function (err) {
              console.error('[Payment] ì„œë²„ ì €ì¥ ì˜¤ë¥˜:', err);
            });
        } catch (err) {
          console.error('Error saving payment data to storage:', err);
        }
      }, 1000);
    }

    // ì„œë²„ì—ì„œ ì…ê¸ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    function loadPaymentDataFromStorage() {
      // ë¨¼ì € ì°¸ê°€ì ëª©ë¡ ë¡œë“œ
      authFetch('/api/admin/participants?limit=100000')
        .then(function (response) { return response.json(); })
        .then(function (data) {
          if (data.success) {
            allParticipants = data.participants || [];
            console.log('[Payment] ì°¸ê°€ì ëª©ë¡ ë¡œë“œ:', allParticipants.length, 'ëª…');
          }

          // ì„œë²„ì—ì„œ ì…ê¸ˆ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
          return authFetch('/api/admin/participants/payment-records');
        })
        .then(function (response) { return response.json(); })
        .then(function (data) {
          if (data.success && data.records && data.records.length > 0) {
            console.log('[Payment] ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¨ ì…ê¸ˆ ë‚´ì—­:', data.records.length, 'ê°œ');

            // ì„œë²„ ë°ì´í„°ë¥¼ paymentDataListë¡œ ë³€í™˜
            paymentDataList = data.records.map(function (record) {
              let matchedParticipant = null;
              if (record.matched_participant_id) {
                matchedParticipant = allParticipants.find(function (p) {
                  return p.id === record.matched_participant_id;
                });
              }

              // ì´ë¦„ìœ¼ë¡œ ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ì°¾ê¸°
              let expectedParticipants = [];
              if (record.matched_name) {
                expectedParticipants = allParticipants.filter(function (p) {
                  return p.user_name.trim() === record.matched_name.trim();
                });
              }

              return {
                date: record.date || '',
                type: record.type || '',
                amount: record.amount || '',
                balance: record.balance || '',
                transactionType: record.transaction_type || '',
                content: record.content || '',
                memo: record.memo || '',
                matchedName: record.matched_name || '',
                matchedPhoneLast4: record.matched_phone_last4 || '',
                matchedParticipant: matchedParticipant,
                expectedParticipants: expectedParticipants,
                approved: record.approved === 1
              };
            });

            // í…Œì´ë¸”ì— ë³µì›ëœ ë°ì´í„° í‘œì‹œ
            restorePaymentTableFromData();
          } else {
            console.log('[Payment] ì„œë²„ì— ì €ì¥ëœ ì…ê¸ˆ ë‚´ì—­ ì—†ìŒ');
          }
        })
        .catch(function (err) {
          console.error('[Payment] ì„œë²„ì—ì„œ ì…ê¸ˆ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', err);
        });

      return true;
    }

    // ì €ì¥ëœ ë°ì´í„°ë¥¼ í…Œì´ë¸”ì— ë³µì›
    function restorePaymentTableFromData() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody || paymentDataList.length === 0) return;

      tbody.innerHTML = '';

      paymentDataList.forEach(function (item, index) {
        const row = document.createElement('tr');
        const hasMatch = item.matchedParticipant !== null;
        const hasPhoneLast4 = item.matchedPhoneLast4 !== '';

        row.className = hasMatch ? '' : 'bg-yellow-50';
        row.innerHTML = `
          <td class="border border-gray-300 px-2 py-1 text-sm text-center text-gray-500">${index + 1}</td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.date || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.type || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.amount || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.balance || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.transactionType || ''}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.content || ''}" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.memo || ''}" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1">
            ${hasMatch ? `
              <div class="text-green-600 font-semibold text-sm">
                âœ“ ${item.matchedParticipant.user_name} (${formatPhone(item.matchedParticipant.phone)})
              </div>
            ` : hasPhoneLast4 ? `
              <div class="text-red-600 text-sm">
                âœ— ë§¤ì¹­ë˜ì§€ ì•ŠìŒ (${item.matchedName}${item.matchedPhoneLast4})
              </div>
            ` : `
              <div class="text-orange-600 text-sm">
                âš  ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ì—†ìŒ
              </div>
            `}
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${!item.matchedParticipant && item.expectedParticipants && item.expectedParticipants.length > 0 ? (
            item.expectedParticipants.length === 1 ? `
                <div class="text-blue-600 text-sm">
                  ${item.expectedParticipants[0].user_name} (${formatPhone(item.expectedParticipants[0].phone)})
                </div>
              ` : `
                <div class="text-orange-600 font-semibold text-sm">
                  âš  ë™ëª…ì´ì¸ ë°œìƒ, ì—°ë½ í›„ ì…ê¸ˆí™•ì¸ í•„ìš”
                </div>
              `
          ) : '<span class="text-gray-400 text-sm">-</span>'}
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${(() => {
            // matchedParticipantê°€ ì •í™•íˆ ë§¤ì¹­ë˜ì—ˆìœ¼ë©´ ë¹„ê³ ë€ ë¹„ì›€
            // matchedParticipantê°€ ì—†ê³  ë™ëª…ì´ì¸ì´ ì—¬ëŸ¬ ëª…ì¼ ë•Œë§Œ ë¹„ê³ ë€ì— ë™ëª…ì´ì¸ ëª©ë¡ í‘œì‹œ
            if (item.matchedParticipant) {
              return '<span class="text-gray-400 text-sm">-</span>';
            } else if (item.expectedParticipants && item.expectedParticipants.length > 1) {
              return '<div class="text-sm space-y-2">' + item.expectedParticipants.map(function (p, pIndex) {
                return '<div class="flex items-center justify-between gap-2 p-2 bg-gray-50 rounded border border-gray-200"><span class="text-gray-700">' + p.user_name + ' (' + formatPhone(p.phone) + ')</span><button onclick="approveDuplicateParticipant(' + index + ', ' + p.id + ')" style="background-color: #22c55e; color: white; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-weight: bold; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; white-space: nowrap;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button></div>';
              }).join('') + '</div>';
            } else {
              return '<span class="text-gray-400 text-sm">-</span>';
            }
          })()}
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${item.approved ? '<span class="text-green-600 font-semibold text-sm">ìŠ¹ì¸ë¨</span>' : '<span class="text-gray-500 text-sm">ëŒ€ê¸°ì¤‘</span>'}
          </td>
          <td class="border border-gray-300 px-2 py-2 sticky right-0 bg-white z-10">
            <div class="flex gap-2">
              ${!item.approved ? `
                <button onclick="approvePaymentFromTable(${index})" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#16a34a'" onmouseout="this.style.backgroundColor='#22c55e'">
                  ìŠ¹ì¸
                </button>
              ` : `
                <span style="background-color: #dcfce7; color: #166534; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; display: inline-block;">âœ“ ìŠ¹ì¸ë¨</span>
              `}
              <button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">
                ì‚­ì œ
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // ë”ë¸”í´ë¦­ ë°©ì§€ìš© ë³€ìˆ˜
    let isSavingPayment = false;
    let isResettingPayment = false;

    // ë”ë¸”í´ë¦­ ë°©ì§€ ë˜í¼ - ì €ì¥í•˜ê¸°
    async function savePaymentDataWithLock() {
      if (isSavingPayment) {
        console.log('[savePaymentData] ì´ë¯¸ ì €ì¥ ì¤‘...');
        return;
      }
      isSavingPayment = true;
      const btn = document.getElementById('savePaymentBtn');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'â³ ì €ì¥ ì¤‘...';
      }
      try {
        await savePaymentData();
      } finally {
        isSavingPayment = false;
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'ğŸ’¾ ì €ì¥í•˜ê¸°';
        }
      }
    }

    // ë”ë¸”í´ë¦­ ë°©ì§€ ë˜í¼ - ì´ˆê¸°í™”
    async function resetPaymentTableWithLock() {
      if (isResettingPayment) {
        console.log('[resetPaymentTable] ì´ë¯¸ ì´ˆê¸°í™” ì¤‘...');
        return;
      }
      isResettingPayment = true;
      const btn = document.getElementById('resetPaymentBtn');
      if (btn) {
        btn.disabled = true;
      }
      try {
        await resetPaymentTable();
      } finally {
        isResettingPayment = false;
        if (btn) {
          btn.disabled = false;
        }
      }
    }

    // ì…ê¸ˆ ë°ì´í„° ì €ì¥í•˜ê¸°
    async function savePaymentData() {
      console.log('[savePaymentData] í•¨ìˆ˜ ì‹œì‘');

      // ìë™ ì €ì¥ íƒ€ì´ë¨¸ ì·¨ì†Œ (ì¤‘ë³µ ì €ì¥ ë°©ì§€)
      if (savePaymentDataTimeout) {
        clearTimeout(savePaymentDataTimeout);
        savePaymentDataTimeout = null;
        console.log('[savePaymentData] ìë™ ì €ì¥ íƒ€ì´ë¨¸ ì·¨ì†Œë¨');
      }

      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) {
        console.log('[savePaymentData] tbody ì—†ìŒ');
        return;
      }

      console.log('[savePaymentData] tbody í–‰ ê°œìˆ˜:', tbody.querySelectorAll('tr').length);

      // ì°¸ê°€ì ëª©ë¡ì´ ì—†ìœ¼ë©´ ë¨¼ì € ë¡œë“œ
      if (allParticipants.length === 0) {
        try {
          const response = await authFetch('/api/admin/participants?limit=9999'); // ëª¨ë“  ì°¸ê°€ì ë¡œë“œ
          const data = await response.json();
          if (data.success) {
            allParticipants = data.participants || [];
          }
        } catch (err) {
          console.error('Error loading participants:', err);
          alert('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return;
        }
      }

      // í…Œì´ë¸”ì—ì„œ ì§ì ‘ ë°ì´í„°ë¥¼ ì½ì–´ì„œ paymentDataList ì—…ë°ì´íŠ¸
      const rows = tbody.querySelectorAll('tr');
      const updatedList = [];

      rows.forEach(function (row, rowIndex) {
        const inputs = row.querySelectorAll('input[type="text"]');
        if (inputs.length < 7) return;

        const date = inputs[0].value.trim();
        const type = inputs[1].value.trim();
        const amount = inputs[2].value.trim();
        const balance = inputs[3].value.trim();
        const transactionType = inputs[4].value.trim();
        const content = inputs[5].value.trim();
        const memo = inputs[6].value.trim();

        // ë¹ˆ í–‰ì€ ì œì™¸
        if (!date && !type && !amount && !content) return;

        // ê¸°ì¡´ paymentDataListì—ì„œ í•´ë‹¹ ì¸ë±ìŠ¤ì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìˆëŠ” ê²½ìš°)
        // paymentDataListê°€ ì¶©ë¶„íˆ í¬ì§€ ì•Šìœ¼ë©´ í™•ì¥
        while (paymentDataList.length <= rowIndex) {
          paymentDataList.push({
            date: '',
            type: '',
            amount: '',
            balance: '',
            transactionType: '',
            content: '',
            memo: '',
            matchedName: '',
            matchedPhoneLast4: '',
            matchedParticipant: null,
            expectedParticipants: [],
            approved: false
          });
        }
        const existingItem = paymentDataList[rowIndex] || null;

        // ë‚´ìš© ë˜ëŠ” ë©”ëª¨ì—ì„œ ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ 4ê°œ ì¶”ì¶œ
        // ë©”ëª¨ë€ì„ ìš°ì„  í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ë‚´ìš©ë€ì—ì„œ ì¶”ì¶œ
        let matchedName = '';
        let matchedPhoneLast4 = '';

        // ë©”ëª¨ë€ì—ì„œ ë¨¼ì € ì‹œë„ (ì• ê³µë°± ë¬´ì‹œ)
        const memoTrimmed = memo.trim();
        const memoMatch = memoTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
        if (memoMatch && memoMatch[1].trim()) {
          matchedName = memoMatch[1].trim();
          matchedPhoneLast4 = memoMatch[2] || '';
        }

        // ë©”ëª¨ë€ì—ì„œ ì´ë¦„ì„ ëª» ì°¾ì•˜ìœ¼ë©´ ë‚´ìš©ë€ì—ì„œ ì‹œë„ (ì• ê³µë°± ë¬´ì‹œ)
        if (!matchedName) {
          const contentTrimmed = content.trim();
          const contentMatch = contentTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
          if (contentMatch) {
            matchedName = contentMatch[1].trim();
            matchedPhoneLast4 = contentMatch[2] || '';
          }
        }

        // ì‹ ì²­ì ë§¤ì¹­
        let matchedParticipant = null;
        if (matchedName && matchedPhoneLast4) {
          matchedParticipant = allParticipants.find(function (p) {
            // ì´ë¦„ ë§¤ì¹­: ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš°
            // ë‹¨, í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();

            // ì •í™•íˆ ì¼ì¹˜
            if (pName === matchedNameTrimmed) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }

            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }

            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }

            return false;
          });
        }

        // ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ì°¾ê¸° (ì´ë¦„ë§Œìœ¼ë¡œ ë§¤ì¹­, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ëŠ” ë¬´ì‹œ)
        let expectedParticipants = [];
        if (matchedName) {
          expectedParticipants = allParticipants.filter(function (p) {
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();

            // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš° (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            if (pName === matchedNameTrimmed) {
              return true;
            }

            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }

            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              return true;
            }

            return false;
          });
        }

        // ê¸°ì¡´ ë°ì´í„°ì˜ approved ìƒíƒœ ìœ ì§€ (ì—†ìœ¼ë©´ false)
        const approved = existingItem ? existingItem.approved : false;

        updatedList.push({
          date: date,
          type: type,
          amount: amount,
          balance: balance,
          transactionType: transactionType,
          content: content,
          memo: memo,
          matchedName: matchedName,
          matchedPhoneLast4: matchedPhoneLast4,
          matchedParticipant: matchedParticipant,
          expectedParticipants: expectedParticipants,
          approved: approved
        });
      });

      console.log('[savePaymentData] ì—…ë°ì´íŠ¸ëœ ë¦¬ìŠ¤íŠ¸ ê°œìˆ˜:', updatedList.length);

      if (updatedList.length === 0) {
        alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // paymentDataList ì—…ë°ì´íŠ¸
      paymentDataList = updatedList;
      console.log('[savePaymentData] paymentDataList ì—…ë°ì´íŠ¸ ì™„ë£Œ:', paymentDataList.length);

      // í…Œì´ë¸” ì—…ë°ì´íŠ¸
      updatePaymentTableWithMatches();

      // ì„œë²„ì— ì¦‰ì‹œ ì €ì¥ (debounce ì—†ì´)
      try {
        const dataToSave = paymentDataList.map(function (item) {
          return {
            date: item.date,
            type: item.type,
            amount: item.amount,
            balance: item.balance,
            transactionType: item.transactionType,
            content: item.content,
            memo: item.memo,
            matchedName: item.matchedName,
            matchedPhoneLast4: item.matchedPhoneLast4,
            matchedParticipantId: item.matchedParticipant ? item.matchedParticipant.id : null,
            approved: item.approved
          };
        });

        console.log('[savePaymentData] API í˜¸ì¶œ ì‹œì‘, ë°ì´í„° ê°œìˆ˜:', dataToSave.length);
        const response = await authFetch('/api/admin/participants/payment-records/sync', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ records: dataToSave })
        });
        console.log('[savePaymentData] API ì‘ë‹µ ìƒíƒœ:', response.status);
        const responseText = await response.text();
        console.log('[savePaymentData] API ì‘ë‹µ ë³¸ë¬¸:', responseText);

        let result;
        try {
          result = JSON.parse(responseText);
        } catch (parseErr) {
          alert('ì„œë²„ ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜: ' + responseText.substring(0, 200));
          return;
        }

        if (result.success) {
          alert('ì…ê¸ˆ ë‚´ì—­ì´ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (' + dataToSave.length + 'ê°œ)');
        } else {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (err) {
        console.error('Error saving payment data:', err);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (err.message || String(err)));
      }
    }

    // í…Œì´ë¸”ì—ì„œ ë°ì´í„° ì½ê¸° ë° ë§¤ì¹­
    async function parsePaymentDataFromTable() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;

      const rows = tbody.querySelectorAll('tr');
      const tempDataList = [];

      // ë¨¼ì € í…Œì´ë¸” ë°ì´í„°ë¥¼ ì„ì‹œ ë°°ì—´ì— ì €ì¥ (API í˜¸ì¶œ ì „)
      // ëª¨ë“  í–‰ì„ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ (ë¹ˆ í–‰ë„ í¬í•¨í•˜ì—¬ ì¸ë±ìŠ¤ ìœ ì§€)
      rows.forEach(function (row, rowIndex) {
        const inputs = row.querySelectorAll('input[type="text"]');
        if (inputs.length < 7) {
          // ì…ë ¥ í•„ë“œê°€ ë¶€ì¡±í•œ í–‰ì€ ë¹ˆ ë°ì´í„°ë¡œ ì¶”ê°€
          tempDataList.push({
            date: '', type: '', amount: '', balance: '', transactionType: '', content: '', memo: '',
            matchedName: '', matchedPhoneLast4: '', matchedParticipant: null, expectedParticipants: [], approved: false, isEmpty: true
          });
          return;
        }

        const date = inputs[0].value.trim();
        const type = inputs[1].value.trim();
        const amount = inputs[2].value.trim();
        const balance = inputs[3].value.trim();
        const transactionType = inputs[4].value.trim();
        const content = inputs[5].value.trim();
        const memo = inputs[6].value.trim();

        // ë¹ˆ í–‰ ì²´í¬
        const isEmpty = !date && !type && !amount && !content;

        // ê¸°ì¡´ paymentDataListì—ì„œ approved ìƒíƒœ ìœ ì§€
        const existingItem = paymentDataList[rowIndex] || null;

        tempDataList.push({
          date: date,
          type: type,
          amount: amount,
          balance: balance,
          transactionType: transactionType,
          content: content,
          memo: memo,
          matchedName: '',
          matchedPhoneLast4: '',
          matchedParticipant: null,
          expectedParticipants: [],
          approved: existingItem ? existingItem.approved : false,
          isEmpty: isEmpty
        });
      });

      // ì„ì‹œ ë°ì´í„°ë¥¼ ë°”ë¡œ paymentDataListì— ì €ì¥ (ë§¤ì¹­ ì „ì´ë¼ë„ ì €ì¥)
      paymentDataList = tempDataList;
      savePaymentDataToStorage();

      // ì°¸ê°€ì ëª©ë¡ ë¡œë“œ (ë§¤ì¹­ì„ ìœ„í•´)
      try {
        const response = await authFetch('/api/admin/participants?limit=100000');
        const data = await response.json();
        if (data.success) {
          allParticipants = data.participants || [];
          console.log('[Payment] Loaded allParticipants:', allParticipants.length);
        }
      } catch (err) {
        console.error('Error loading participants:', err);
        // ë§¤ì¹­ ì‹¤íŒ¨í•´ë„ ë°ì´í„°ëŠ” ì´ë¯¸ ì €ì¥ë¨
        return;
      }

      // ë§¤ì¹­ ì •ë³´ ì—…ë°ì´íŠ¸
      paymentDataList.forEach(function (item, index) {
        // ë¹ˆ í–‰ì€ ê±´ë„ˆë›°ê¸°
        if (item.isEmpty) return;

        const content = item.content;
        const memo = item.memo;

        // ë‚´ìš© ë˜ëŠ” ë©”ëª¨ì—ì„œ ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ 4ê°œ ì¶”ì¶œ
        let matchedName = '';
        let matchedPhoneLast4 = '';

        // ë©”ëª¨ë€ì—ì„œ ë¨¼ì € ì‹œë„
        const memoTrimmed = memo.trim();
        const memoMatch = memoTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
        if (memoMatch && memoMatch[1].trim()) {
          matchedName = memoMatch[1].trim();
          matchedPhoneLast4 = memoMatch[2] || '';
        }

        // ë©”ëª¨ë€ì—ì„œ ì´ë¦„ì„ ëª» ì°¾ì•˜ìœ¼ë©´ ë‚´ìš©ë€ì—ì„œ ì‹œë„
        if (!matchedName) {
          const contentTrimmed = content.trim();
          const contentMatch = contentTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
          if (contentMatch) {
            matchedName = contentMatch[1].trim();
            matchedPhoneLast4 = contentMatch[2] || '';
          }
        }

        item.matchedName = matchedName;
        item.matchedPhoneLast4 = matchedPhoneLast4;

        // ì‹ ì²­ì ë§¤ì¹­
        if (matchedName && matchedPhoneLast4) {
          item.matchedParticipant = allParticipants.find(function (p) {
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();

            if (pName === matchedNameTrimmed) {
              return p.phone.slice(-4) === matchedPhoneLast4;
            }

            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }

            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              return p.phone.slice(-4) === matchedPhoneLast4;
            }
            return false;
          }) || null;
        }

        // ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ì°¾ê¸° (ì´ë¦„ë§Œìœ¼ë¡œ ë§¤ì¹­)
        if (matchedName) {
          item.expectedParticipants = allParticipants.filter(function (p) {
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();

            if (pName === matchedNameTrimmed) return true;

            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }

            return pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
          });
        }
      });

      // ë§¤ì¹­ ê²°ê³¼ë¥¼ í…Œì´ë¸”ì— ë°˜ì˜
      updatePaymentTableWithMatches();
      // localStorageì— ì €ì¥
      savePaymentDataToStorage();
    }

    function updatePaymentTableWithMatches() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;

      const rows = tbody.querySelectorAll('tr');
      rows.forEach(function (row, index) {
        const item = paymentDataList[index];
        if (!item) return;

        // ì—°ë²ˆ ì—…ë°ì´íŠ¸ (ì²« ë²ˆì§¸ ì…€)
        const numberCell = row.cells[0];
        if (numberCell) {
          numberCell.textContent = index + 1;
        }

        // ë¹ˆ í–‰ì€ ê¸°ë³¸ ìƒíƒœ ìœ ì§€
        if (item.isEmpty) return;

        // ë§¤ì¹­ ê²°ê³¼ ì…€ ì—…ë°ì´íŠ¸
        // ì…€ ì¸ë±ìŠ¤: 0=ì—°ë²ˆ, 1=ê±°ë˜ì¼ì‹œ, 2=êµ¬ë¶„, 3=ê±°ë˜ê¸ˆì•¡, 4=ê±°ë˜í›„ì”ì•¡, 5=ê±°ë˜êµ¬ë¶„, 6=ë‚´ìš©, 7=ë©”ëª¨, 8=ë§¤ì¹­ëœì‹ ì²­ì, 9=ì˜ˆìƒë˜ëŠ”ì‹ ì²­ì, 10=ë¹„ê³ , 11=ìƒíƒœ, 12=ì‘ì—…
        const matchCell = row.cells[8];
        const expectedCell = row.cells[9];
        const noteCell = row.cells[10];
        const statusCell = row.cells[11];
        const actionCell = row.cells[12];

        if (matchCell) {
          const hasMatch = item.matchedParticipant !== null;
          const hasPhoneLast4 = item.matchedPhoneLast4 !== '';

          if (hasMatch) {
            matchCell.innerHTML = '<div class="text-green-600 font-semibold text-sm">âœ“ ' + item.matchedParticipant.user_name + ' (' + formatPhone(item.matchedParticipant.phone) + ')</div>';
            row.className = '';
          } else if (hasPhoneLast4) {
            matchCell.innerHTML = '<div class="text-red-600 text-sm">âœ— ë§¤ì¹­ë˜ì§€ ì•ŠìŒ (' + item.matchedName + item.matchedPhoneLast4 + ')</div>';
            row.className = 'bg-yellow-50';
          } else {
            matchCell.innerHTML = '<div class="text-orange-600 text-sm">âš  ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ì—†ìŒ</div>';
            row.className = 'bg-yellow-50';
          }
        }

        if (expectedCell) {
          // matchedParticipantê°€ ì—†ì„ ë•Œë§Œ ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì í‘œì‹œ
          if (!item.matchedParticipant && item.expectedParticipants && item.expectedParticipants.length > 0) {
            if (item.expectedParticipants.length === 1) {
              expectedCell.innerHTML = '<div class="text-blue-600 text-sm">' + item.expectedParticipants[0].user_name + ' (' + formatPhone(item.expectedParticipants[0].phone) + ')</div>';
            } else {
              expectedCell.innerHTML = '<div class="text-orange-600 font-semibold text-sm">âš  ë™ëª…ì´ì¸ ë°œìƒ, ì—°ë½ í›„ ì…ê¸ˆí™•ì¸ í•„ìš”</div>';
            }
          } else {
            expectedCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
          }
        }

        if (noteCell) {
          // matchedParticipantê°€ ì •í™•íˆ ë§¤ì¹­ë˜ì—ˆìœ¼ë©´(ì´ë¦„+ì „í™”ë²ˆí˜¸ ë’·4ìë¦¬ ëª¨ë‘ ì¼ì¹˜) ë¹„ê³ ë€ ë¹„ì›€
          // matchedParticipantê°€ ì—†ê³  ë™ëª…ì´ì¸ì´ ì—¬ëŸ¬ ëª…ì¼ ë•Œë§Œ ë¹„ê³ ë€ì— ë™ëª…ì´ì¸ ëª©ë¡ í‘œì‹œ
          if (item.matchedParticipant) {
            // ì •í™•íˆ ë§¤ì¹­ëœ ê²½ìš° ë¹„ê³ ë€ ë¹„ì›€
            noteCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
          } else if (item.expectedParticipants && item.expectedParticipants.length > 1) {
            // ë§¤ì¹­ ì•ˆëê³  ë™ëª…ì´ì¸ì´ ì—¬ëŸ¬ ëª…ì¸ ê²½ìš°
            let noteHtml = '<div class="text-sm space-y-2">';
            item.expectedParticipants.forEach(function (p) {
              noteHtml += '<div class="flex items-center justify-between gap-2 p-2 bg-gray-50 rounded border border-gray-200"><span class="text-gray-700">' + p.user_name + ' (' + formatPhone(p.phone) + ')</span><button onclick="approveDuplicateParticipant(' + index + ', ' + p.id + ')" style="background-color: #22c55e; color: white; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-weight: bold; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; white-space: nowrap;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button></div>';
            });
            noteHtml += '</div>';
            noteCell.innerHTML = noteHtml;
          } else {
            noteCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
          }
        }

        if (statusCell) {
          statusCell.innerHTML = item.approved ? '<span class="text-green-600 font-semibold text-sm">ìŠ¹ì¸ë¨</span>' : '<span class="text-gray-500 text-sm">ëŒ€ê¸°ì¤‘</span>';
        }

        if (actionCell) {
          const approveBtn = !item.approved
            ? '<button onclick="approvePaymentFromTable(' + index + ')" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button>'
            : '<span style="background-color: #dcfce7; color: #166534; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; display: inline-block;">âœ“ ìŠ¹ì¸ë¨</span>';
          const deleteBtn = '<button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#dc2626\'" onmouseout="this.style.backgroundColor=\'#ef4444\'">ì‚­ì œ</button>';
          actionCell.innerHTML = '<div class="flex gap-2">' + approveBtn + deleteBtn + '</div>';
        }
      });
    }

    function updatePaymentDataFromInput(input) {
      // í…Œì´ë¸”ì—ì„œ ì§ì ‘ ì…ë ¥ ì‹œ paymentDataList ì—…ë°ì´íŠ¸ëŠ” savePaymentData()ì—ì„œ ì²˜ë¦¬
      // ì—¬ê¸°ì„œëŠ” ì¦‰ì‹œ ì €ì¥í•˜ì§€ ì•Šê³ , ì €ì¥ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ í•œ ë²ˆì— ì²˜ë¦¬
    }

    async function reMatchPaymentFromInput(input) {
      // ë‚´ìš© í•„ë“œ ë³€ê²½ ì‹œ ìë™ ì¬ë§¤ì¹­
      const row = input.closest('tr');
      if (!row) return;

      // ì°¸ê°€ì ëª©ë¡ ë¡œë“œ (ì—†ìœ¼ë©´)
      if (allParticipants.length === 0) {
        try {
          const response = await authFetch('/api/admin/participants?limit=100000');
          const data = await response.json();
          if (data.success) {
            allParticipants = data.participants || [];
            console.log('[Payment] Loaded allParticipants:', allParticipants.length);
          }
        } catch (err) {
          console.error('Error loading participants:', err);
          return;
        }
      }

      // í–‰ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;
      const rows = tbody.querySelectorAll('tr');
      const rowIndex = Array.from(rows).indexOf(row);
      if (rowIndex < 0) return;

      // í•´ë‹¹ í–‰ì˜ ëª¨ë“  ì…ë ¥ê°’ ì½ê¸°
      const inputs = row.querySelectorAll('input[type="text"]');
      if (inputs.length < 7) return;

      const date = inputs[0].value.trim();
      const type = inputs[1].value.trim();
      const amount = inputs[2].value.trim();
      const balance = inputs[3].value.trim();
      const transactionType = inputs[4].value.trim();
      const content = inputs[5].value.trim();
      const memo = inputs[6].value.trim();

      // ë‚´ìš© ë˜ëŠ” ë©”ëª¨ì—ì„œ ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ 4ê°œ ì¶”ì¶œ
      // ë©”ëª¨ë€ì„ ìš°ì„  í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ë‚´ìš©ë€ì—ì„œ ì¶”ì¶œ
      let matchedName = '';
      let matchedPhoneLast4 = '';

      // ë©”ëª¨ë€ì—ì„œ ë¨¼ì € ì‹œë„
      const memoMatch = memo.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
      if (memoMatch && memoMatch[1].trim()) {
        matchedName = memoMatch[1].trim();
        matchedPhoneLast4 = memoMatch[2] || '';
      }

      // ë©”ëª¨ë€ì—ì„œ ì´ë¦„ì„ ëª» ì°¾ì•˜ìœ¼ë©´ ë‚´ìš©ë€ì—ì„œ ì‹œë„
      if (!matchedName) {
        const contentMatch = content.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
        if (contentMatch) {
          matchedName = contentMatch[1].trim();
          matchedPhoneLast4 = contentMatch[2] || '';
        }
      }

      // ì‹ ì²­ì ë§¤ì¹­
      let matchedParticipant = null;
      if (matchedName && matchedPhoneLast4) {
        matchedParticipant = allParticipants.find(function (p) {
          // ì´ë¦„ ë§¤ì¹­: ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš°
          // ë‹¨, í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
          const pName = p.user_name.trim();
          const matchedNameTrimmed = matchedName.trim();

          // ì •í™•íˆ ì¼ì¹˜
          if (pName === matchedNameTrimmed) {
            const phoneLast4 = p.phone.slice(-4);
            return phoneLast4 === matchedPhoneLast4;
          }

          // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ)
          const pNameHasHangul = /[ê°€-í£]/.test(pName);
          const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
          const pNameHasEnglish = /[a-zA-Z]/.test(pName);
          const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

          // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
          if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
            return false;
          }

          // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸
          const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
          if (nameMatch) {
            const phoneLast4 = p.phone.slice(-4);
            return phoneLast4 === matchedPhoneLast4;
          }

          return false;
        });
      }

      // ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ì°¾ê¸° (ì´ë¦„ë§Œìœ¼ë¡œ ë§¤ì¹­, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ëŠ” ë¬´ì‹œ)
      let expectedParticipants = [];
      if (matchedName) {
        expectedParticipants = allParticipants.filter(function (p) {
          const pName = p.user_name.trim();
          const matchedNameTrimmed = matchedName.trim();

          // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš° (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
          if (pName === matchedNameTrimmed) {
            return true;
          }

          // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
          const pNameHasHangul = /[ê°€-í£]/.test(pName);
          const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
          const pNameHasEnglish = /[a-zA-Z]/.test(pName);
          const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

          // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
          if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
            return false;
          }

          // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
          const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
          if (nameMatch) {
            return true;
          }

          return false;
        });
      }

      // ê¸°ì¡´ paymentDataListì—ì„œ í•´ë‹¹ ì¸ë±ìŠ¤ì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìˆëŠ” ê²½ìš°)
      // paymentDataListê°€ ì¶©ë¶„íˆ í¬ì§€ ì•Šìœ¼ë©´ í™•ì¥
      while (paymentDataList.length <= rowIndex) {
        paymentDataList.push({
          date: '',
          type: '',
          amount: '',
          balance: '',
          transactionType: '',
          content: '',
          memo: '',
          matchedName: '',
          matchedPhoneLast4: '',
          matchedParticipant: null,
          expectedParticipants: [],
          approved: false
        });
      }

      const existingItem = paymentDataList[rowIndex] || null;
      const approved = existingItem ? existingItem.approved : false;

      // paymentDataList ì—…ë°ì´íŠ¸ (í•´ë‹¹ ì¸ë±ìŠ¤ë§Œ)
      paymentDataList[rowIndex] = {
        date: date,
        type: type,
        amount: amount,
        balance: balance,
        transactionType: transactionType,
        content: content,
        memo: memo,
        matchedName: matchedName,
        matchedPhoneLast4: matchedPhoneLast4,
        matchedParticipant: matchedParticipant,
        expectedParticipants: expectedParticipants,
        approved: approved
      };

      // í•´ë‹¹ í–‰ë§Œ ì—…ë°ì´íŠ¸
      updateSinglePaymentRow(row, rowIndex, paymentDataList[rowIndex]);

      // localStorageì— ì €ì¥
      savePaymentDataToStorage();
    }

    function updateSinglePaymentRow(row, index, item) {
      if (!row || !item) return;

      // ë§¤ì¹­ ê²°ê³¼ ì…€ ì—…ë°ì´íŠ¸
      // ì…€ ì¸ë±ìŠ¤: 0=ì—°ë²ˆ, 1=ê±°ë˜ì¼ì‹œ, 2=êµ¬ë¶„, 3=ê±°ë˜ê¸ˆì•¡, 4=ê±°ë˜í›„ì”ì•¡, 5=ê±°ë˜êµ¬ë¶„, 6=ë‚´ìš©, 7=ë©”ëª¨, 8=ë§¤ì¹­ëœì‹ ì²­ì, 9=ì˜ˆìƒë˜ëŠ”ì‹ ì²­ì, 10=ë¹„ê³ , 11=ìƒíƒœ, 12=ì‘ì—…
      const matchCell = row.cells[8];
      const expectedCell = row.cells[9];
      const noteCell = row.cells[10];
      const statusCell = row.cells[11];
      const actionCell = row.cells[12];

      if (matchCell) {
        const hasMatch = item.matchedParticipant !== null;
        const hasPhoneLast4 = item.matchedPhoneLast4 !== '';

        if (hasMatch) {
          matchCell.innerHTML = '<div class="text-green-600 font-semibold text-sm">âœ“ ' + item.matchedParticipant.user_name + ' (' + formatPhone(item.matchedParticipant.phone) + ')</div>';
          row.className = '';
        } else if (hasPhoneLast4) {
          matchCell.innerHTML = '<div class="text-red-600 text-sm">âœ— ë§¤ì¹­ë˜ì§€ ì•ŠìŒ (' + item.matchedName + item.matchedPhoneLast4 + ')</div>';
          row.className = 'bg-yellow-50';
        } else {
          matchCell.innerHTML = '<div class="text-orange-600 text-sm">âš  ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ì—†ìŒ</div>';
          row.className = 'bg-yellow-50';
        }
      }

      if (expectedCell) {
        // matchedParticipantê°€ ì—†ì„ ë•Œë§Œ ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì í‘œì‹œ
        if (!item.matchedParticipant && item.expectedParticipants && item.expectedParticipants.length > 0) {
          if (item.expectedParticipants.length === 1) {
            expectedCell.innerHTML = '<div class="text-blue-600 text-sm">' + item.expectedParticipants[0].user_name + ' (' + formatPhone(item.expectedParticipants[0].phone) + ')</div>';
          } else {
            expectedCell.innerHTML = '<div class="text-orange-600 font-semibold text-sm">âš  ë™ëª…ì´ì¸ ë°œìƒ, ì—°ë½ í›„ ì…ê¸ˆí™•ì¸ í•„ìš”</div>';
          }
        } else {
          expectedCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
        }
      }

      if (noteCell) {
        // matchedParticipantê°€ ì •í™•íˆ ë§¤ì¹­ë˜ì—ˆìœ¼ë©´(ì´ë¦„+ì „í™”ë²ˆí˜¸ ë’·4ìë¦¬ ëª¨ë‘ ì¼ì¹˜) ë¹„ê³ ë€ ë¹„ì›€
        // matchedParticipantê°€ ì—†ê³  ë™ëª…ì´ì¸ì´ ì—¬ëŸ¬ ëª…ì¼ ë•Œë§Œ ë¹„ê³ ë€ì— ë™ëª…ì´ì¸ ëª©ë¡ í‘œì‹œ
        if (item.matchedParticipant) {
          // ì •í™•íˆ ë§¤ì¹­ëœ ê²½ìš° ë¹„ê³ ë€ ë¹„ì›€
          noteCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
        } else if (item.expectedParticipants && item.expectedParticipants.length > 1) {
          // ë§¤ì¹­ ì•ˆëê³  ë™ëª…ì´ì¸ì´ ì—¬ëŸ¬ ëª…ì¸ ê²½ìš°
          let noteHtml = '<div class="text-sm space-y-2">';
          item.expectedParticipants.forEach(function (p) {
            noteHtml += '<div class="flex items-center justify-between gap-2 p-2 bg-gray-50 rounded border border-gray-200"><span class="text-gray-700">' + p.user_name + ' (' + formatPhone(p.phone) + ')</span><button onclick="approveDuplicateParticipant(' + index + ', ' + p.id + ')" style="background-color: #22c55e; color: white; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-weight: bold; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; white-space: nowrap;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button></div>';
          });
          noteHtml += '</div>';
          noteCell.innerHTML = noteHtml;
        } else {
          noteCell.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
        }
      }

      if (statusCell) {
        statusCell.innerHTML = item.approved ? '<span class="text-green-600 font-semibold text-sm">ìŠ¹ì¸ë¨</span>' : '<span class="text-gray-500 text-sm">ëŒ€ê¸°ì¤‘</span>';
      }

      if (actionCell) {
        const approveBtn = !item.approved
          ? '<button onclick="approvePaymentFromTable(' + index + ')" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button>'
          : '<div class="flex items-center gap-2"><span style="background-color: #dcfce7; color: #166534; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; display: inline-block;">âœ“ ìŠ¹ì¸ë¨</span><button onclick="cancelPaymentFromTable(' + index + ')" style="background-color: #fca5a5; color: #991b1b; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#f87171\'" onmouseout="this.style.backgroundColor=\'#fca5a5\'">ì·¨ì†Œ</button></div>';
        const deleteBtn = '<button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#dc2626\'" onmouseout="this.style.backgroundColor=\'#ef4444\'">ì‚­ì œ</button>';
        actionCell.innerHTML = '<div class="flex gap-2">' + approveBtn + deleteBtn + '</div>';
      }
    }

    function removePaymentRowFromTable(button) {
      const row = button.closest('tr');
      if (row && confirm('ì´ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        row.remove();
        // paymentDataListì—ì„œë„ ì œê±°
        const tbody = document.getElementById('paymentTableBody');
        if (tbody) {
          const rows = tbody.querySelectorAll('tr');
          const index = Array.from(rows).indexOf(row);
          if (index >= 0 && paymentDataList[index]) {
            paymentDataList.splice(index, 1);
          }
          // ì—°ë²ˆ ì¬ì •ë ¬
          updatePaymentRowNumbers();
          // localStorageì— ì €ì¥
          savePaymentDataToStorage();
        }
      }
    }

    async function approveDuplicateParticipant(paymentIndex, participantId) {
      const item = paymentDataList[paymentIndex];
      if (!item) return;

      // ì„ íƒí•œ ì°¸ê°€ì ì°¾ê¸°
      const selectedParticipant = allParticipants.find(function (p) {
        return p.id === participantId;
      });

      if (!selectedParticipant) {
        alert('ì°¸ê°€ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ë§¤ì¹­ëœ ì°¸ê°€ìë¡œ ì„¤ì •
      item.matchedParticipant = selectedParticipant;
      item.matchedName = selectedParticipant.user_name;
      item.matchedPhoneLast4 = selectedParticipant.phone.slice(-4);
      // ë™ëª…ì´ì¸ ìŠ¹ì¸ í›„ expectedParticipantsëŠ” ìœ ì§€í•˜ë˜, ë¹„ê³  ë€ì€ matchedParticipantê°€ ìˆìœ¼ë©´ í‘œì‹œë˜ì§€ ì•ŠìŒ

      // ì…ê¸ˆ í™•ì¸ ì²˜ë¦¬
      try {
        const response = await authFetch('/api/admin/participants/' + selectedParticipant.id + '/payment', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_paid: true }),
        });

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }

        item.approved = true;

        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        const tbody = document.getElementById('paymentTableBody');
        if (tbody) {
          const rows = tbody.querySelectorAll('tr');
          if (rows[paymentIndex]) {
            updateSinglePaymentRow(rows[paymentIndex], paymentIndex, item);
          }
        }

        savePaymentDataToStorage();
        alert('ì…ê¸ˆì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (err) {
        console.error('Error approving payment:', err);
        alert(err.message || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function approvePaymentFromTable(index) {
      const item = paymentDataList[index];
      if (!item) return;

      if (!item.matchedParticipant && item.matchedPhoneLast4) {
        if (!confirm('ë§¤ì¹­ëœ ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.\në‚´ìš©: ' + item.content + '\n\nìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
      } else if (!item.matchedPhoneLast4) {
        if (!confirm('ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.\në‚´ìš©: ' + item.content + '\n\nìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
      }

      if (item.matchedParticipant) {
        try {
          console.log('Approving payment for participant:', item.matchedParticipant.id);
          const response = await authFetch('/api/admin/participants/' + item.matchedParticipant.id + '/payment', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_paid: true }),
          });

          const data = await response.json();
          console.log('Payment approval response:', data);

          if (!response.ok || !data.success) {
            throw new Error(data.error || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }

          item.approved = true;

          // ìºì‹œ ë¬´íš¨í™”
          participantsCache = null;
          participantsCacheTime = null;

          // ì „ì²´ ì°¸ê°€ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ë§¤ì¹­ ë° í†µê³„ ë™ê¸°í™”)
          await reloadAllParticipants();

          updatePaymentTableWithMatches();
          savePaymentDataToStorage();

          // ì°¸ê°€ì ê´€ë¦¬ íƒ­ë„ ê°±ì‹ 
          loadParticipants(currentPage, true);

          alert('ì…ê¸ˆì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (err) {
          console.error('Error approving payment:', err);
          alert(err.message || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } else {
        item.approved = true;

        // ì°¸ê°€ì ëª©ë¡ ìƒíƒœ ì—…ë°ì´íŠ¸ (UI ë™ê¸°í™”)
        if (item.matchedParticipant) {
          const participant = allParticipants.find(p => p.id === item.matchedParticipant.id);
          if (participant) {
            participant.is_paid = 1;
          }
        }
        // ìºì‹œ ë¬´íš¨í™”
        participantsCache = null;
        participantsCacheTime = null;

        updatePaymentTableWithMatches();
        savePaymentDataToStorage();
        alert('ìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì°¸ê°€ì ê´€ë¦¬ì—ì„œ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.');
      }
    }

    async function cancelPaymentFromTable(index) {
      const item = paymentDataList[index];
      if (!item) return;

      if (!confirm('ì…ê¸ˆ ìŠ¹ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      if (item.matchedParticipant) {
        try {
          const response = await authFetch('/api/admin/participants/' + item.matchedParticipant.id + '/payment', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_paid: false }),
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || 'ì…ê¸ˆ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }

          item.approved = false;

          // ì°¸ê°€ì ëª©ë¡ ìƒíƒœ ì—…ë°ì´íŠ¸ (UI ë™ê¸°í™”)
          const participant = allParticipants.find(p => p.id === item.matchedParticipant.id);
          if (participant) {
            participant.is_paid = 0;
          }
          // ìºì‹œ ë¬´íš¨í™”
          participantsCache = null;
          participantsCacheTime = null;

          updatePaymentTableWithMatches();
          savePaymentDataToStorage();
          alert('ì…ê¸ˆ ìŠ¹ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (err) {
          console.error('Error canceling payment:', err);
          alert(err.message || 'ì…ê¸ˆ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } else {
        // ë§¤ì¹­ëœ ì°¸ê°€ìê°€ ì—†ëŠ” ê²½ìš° (ìˆ˜ë™ ìŠ¹ì¸ ì·¨ì†Œ)
        item.approved = false;
        updatePaymentTableWithMatches();
        savePaymentDataToStorage();
        alert('ìŠ¹ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    }

    // í…Œì´ë¸”ì— ë¶™ì—¬ë„£ê¸° ì§€ì›
    document.addEventListener('DOMContentLoaded', function () {
      const paymentTable = document.getElementById('paymentTable');
      if (paymentTable) {
        paymentTable.addEventListener('paste', function (e) {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text');
          const rows = paste.split('\n').filter(function (row) { return row.trim(); });

          if (rows.length === 0) return;

          const tbody = document.getElementById('paymentTableBody');
          if (!tbody) return;

          // í˜„ì¬ í¬ì»¤ìŠ¤ëœ ì…€ ì°¾ê¸°
          const activeElement = document.activeElement;
          if (!activeElement || activeElement.tagName !== 'INPUT') return;

          const currentRow = activeElement.closest('tr');
          if (!currentRow) return;

          const currentInputs = currentRow.querySelectorAll('input[type="text"]');
          const startCol = Array.from(currentInputs).indexOf(activeElement);
          if (startCol < 0) return;

          // ì²« ë²ˆì§¸ í–‰ì˜ ì²« ë²ˆì§¸ ì…€ì— ë¶™ì—¬ë„£ì„ ë•ŒëŠ” í•­ìƒ ì²« ë²ˆì§¸ ì—´ë¶€í„° ì‹œì‘
          const isFirstCell = startCol === 0 && currentRow === tbody.querySelector('tr:first-child');
          const actualStartCol = isFirstCell ? 0 : startCol;

          rows.forEach(function (row, rowIndex) {
            // íƒ­ìœ¼ë¡œ êµ¬ë¶„ (ì—‘ì…€ì€ íƒ­ìœ¼ë¡œ êµ¬ë¶„)
            const values = row.split('\t').map(function (v) { return v.trim(); });

            // ë¹ˆ í–‰ì€ ê±´ë„ˆë›°ê¸°
            if (values.length === 0 || (values.length === 1 && !values[0])) return;

            let targetRow = currentRow;
            if (rowIndex > 0 || (rowIndex === 0 && isFirstCell)) {
              // ì²« ë²ˆì§¸ í–‰ì˜ ì²« ë²ˆì§¸ ì…€ì— ë¶™ì—¬ë„£ì„ ë•ŒëŠ” ìƒˆ í–‰ë¶€í„° ì‹œì‘
              if (rowIndex === 0 && isFirstCell) {
                // ì²« ë²ˆì§¸ í–‰ì€ í˜„ì¬ í–‰ì— ë®ì–´ì“°ê¸°
                targetRow = currentRow;
              } else if (rowIndex > 0) {
                // ìƒˆ í–‰ ì¶”ê°€
                const newRow = currentRow.cloneNode(true);
                const newInputs = newRow.querySelectorAll('input[type="text"]');
                newInputs.forEach(function (input) { input.value = ''; });
                // ë§¤ì¹­ ê²°ê³¼ ì…€ë“¤ë„ ì´ˆê¸°í™” (ë¹„ê³  ì—´ ì¶”ê°€ë¡œ ì¸ë±ìŠ¤ ë³€ê²½)
                const newCells = newRow.querySelectorAll('td');
                if (newCells.length >= 13) {
                  newCells[8].innerHTML = '<span class="text-sm text-gray-400">-</span>';
                  newCells[9].innerHTML = '<span class="text-sm text-gray-400">-</span>';
                  newCells[10].innerHTML = '<span class="text-sm text-gray-400">-</span>';
                  newCells[11].innerHTML = '<span class="text-sm text-gray-400">ëŒ€ê¸°ì¤‘</span>';
                  newCells[12].innerHTML = '<div class="flex gap-2"><button onclick="approvePaymentFromTable(' + (paymentDataList.length) + ')" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#16a34a\'" onmouseout="this.style.backgroundColor=\'#22c55e\'">ìŠ¹ì¸</button><button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#dc2626\'" onmouseout="this.style.backgroundColor=\'#ef4444\'">ì‚­ì œ</button></div>';
                }
                tbody.appendChild(newRow);
                targetRow = newRow;
              }
            }

            const inputs = targetRow.querySelectorAll('input[type="text"]');
            values.forEach(function (value, colIndex) {
              const targetCol = actualStartCol + colIndex;
              if (targetCol < inputs.length && value) {
                inputs[targetCol].value = value;
                // ë‚´ìš© í•„ë“œ(ì¸ë±ìŠ¤ 5) ë³€ê²½ ì‹œ ìë™ ë§¤ì¹­
                if (targetCol === 5) {
                  reMatchPaymentFromInput(inputs[targetCol]);
                }
              }
            });
          });

          // ì—°ë²ˆ ì¬ì •ë ¬
          updatePaymentRowNumbers();

          // ë§ˆì§€ë§‰ í–‰ì˜ ë‚´ìš© í•„ë“œì—ì„œ ìë™ ë§¤ì¹­ ì‹¤í–‰
          setTimeout(async function () {
            await parsePaymentDataFromTable();
            // localStorageì— ì €ì¥ (parsePaymentDataFromTable ì™„ë£Œ í›„)
            savePaymentDataToStorage();
          }, 100);
        });
      }
    });

    async function parsePaymentData() {
      const input = document.getElementById('paymentDataInput');
      if (!input) {
        alert('ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const inputValue = input.value.trim();
      if (!inputValue) {
        alert('ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ì°¸ê°€ì ëª©ë¡ ë¡œë“œ (ì „ì²´)
      try {
        const response = await authFetch('/api/admin/participants?limit=100000');
        const data = await response.json();
        if (data.success) {
          allParticipants = data.participants || [];
          console.log('[Payment] Loaded allParticipants for matching:', allParticipants.length);
        }
      } catch (err) {
        console.error('Error loading participants:', err);
        alert('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      // ë°ì´í„° íŒŒì‹± (íƒ­ ë˜ëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„)
      const lines = inputValue.split('\n').filter(line => line.trim());
      if (lines.length < 2) {
        alert('í—¤ë”ì™€ ìµœì†Œ 1ê°œì˜ ë°ì´í„° í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      // í—¤ë” íŒŒì‹±
      const headerLine = lines[0];
      const headers = headerLine.split(/\t|,/).map(h => h.trim());

      // í—¤ë” ì¸ë±ìŠ¤ ì°¾ê¸°
      const headerMap = {};
      headers.forEach(function (h, i) {
        if (h.includes('ê±°ë˜ì¼ì‹œ') || h.includes('ì¼ì‹œ')) headerMap.date = i;
        if (h.includes('êµ¬ë¶„')) headerMap.type = i;
        if (h.includes('ê±°ë˜ê¸ˆì•¡') || h.includes('ê¸ˆì•¡')) headerMap.amount = i;
        if (h.includes('ê±°ë˜ í›„ ì”ì•¡') || h.includes('ì”ì•¡')) headerMap.balance = i;
        if (h.includes('ê±°ë˜êµ¬ë¶„')) headerMap.transactionType = i;
        if (h.includes('ë‚´ìš©')) headerMap.content = i;
        if (h.includes('ë©”ëª¨')) headerMap.memo = i;
      });

      if (headerMap.content === undefined) {
        alert('"ë‚´ìš©" ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í—¤ë”ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ë°ì´í„° í–‰ íŒŒì‹±
      paymentDataList = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(/\t|,/).map(function (v) { return v.trim(); });
        if (values.length < headers.length) continue;

        const content = values[headerMap.content] || '';
        const memo = headerMap.memo !== undefined ? (values[headerMap.memo] || '') : '';

        // ë©”ëª¨ë€ì—ì„œ ë¨¼ì € ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ 4ê°œ ì¶”ì¶œ ì‹œë„
        // í˜•ì‹: "ì´ë¦„0000" ë˜ëŠ” "ì´ë¦„ 0000" ë“±
        let matchedName = '';
        let matchedPhoneLast4 = '';

        // ë©”ëª¨ë€ì—ì„œ ë¨¼ì € ì‹œë„ (ì• ê³µë°± ë¬´ì‹œ)
        const memoTrimmed = memo.trim();
        const memoMatch = memoTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
        if (memoMatch && memoMatch[1].trim()) {
          matchedName = memoMatch[1].trim();
          matchedPhoneLast4 = memoMatch[2] || '';
        }

        // ë©”ëª¨ë€ì—ì„œ ì´ë¦„ì„ ëª» ì°¾ì•˜ìœ¼ë©´ ë‚´ìš©ë€ì—ì„œ ì‹œë„ (ì• ê³µë°± ë¬´ì‹œ)
        if (!matchedName) {
          const contentTrimmed = content.trim();
          const contentMatch = contentTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
          if (contentMatch) {
            matchedName = contentMatch[1].trim();
            matchedPhoneLast4 = contentMatch[2] || '';
          }
        }

        // ì‹ ì²­ì ë§¤ì¹­
        let matchedParticipant = null;
        if (matchedName && matchedPhoneLast4) {
          matchedParticipant = allParticipants.find(function (p) {
            // ì´ë¦„ ë§¤ì¹­: ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš°
            // ë‹¨, í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();

            // ì •í™•íˆ ì¼ì¹˜
            if (pName === matchedNameTrimmed) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }

            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }

            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }

            return false;
          });
        }

        // ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ì°¾ê¸° (ì´ë¦„ë§Œìœ¼ë¡œ ë§¤ì¹­, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ëŠ” ë¬´ì‹œ)
        let expectedParticipants = [];
        if (matchedName) {
          expectedParticipants = allParticipants.filter(function (p) {
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();

            // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš° (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            if (pName === matchedNameTrimmed) {
              return true;
            }

            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš° (ê°™ì€ ë¬¸ì ì²´ê³„ë§Œ, ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);
            const pNameHasEnglish = /[a-zA-Z]/.test(pName);
            const matchedNameHasEnglish = /[a-zA-Z]/.test(matchedNameTrimmed);

            // í•œê¸€ê³¼ ì˜ë¬¸ì´ ì„ì¸ ê²½ìš°ëŠ” ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
            if ((pNameHasHangul && matchedNameHasEnglish) || (pNameHasEnglish && matchedNameHasHangul)) {
              return false;
            }

            // ê°™ì€ ë¬¸ì ì²´ê³„ì¸ ê²½ìš°ì—ë§Œ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë¬´ì‹œ)
            const nameMatch = pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
            if (nameMatch) {
              return true;
            }

            return false;
          });
        }

        paymentDataList.push({
          date: values[headerMap.date] || '',
          type: values[headerMap.type] || '',
          amount: values[headerMap.amount] || '',
          balance: values[headerMap.balance] || '',
          transactionType: values[headerMap.transactionType] || '',
          content: content,
          memo: memo,
          matchedName: matchedName,
          matchedPhoneLast4: matchedPhoneLast4,
          matchedParticipant: matchedParticipant,
          expectedParticipants: expectedParticipants,
          approved: false
        });
      }

      displayPaymentData();
    }

    // ì…ê¸ˆë‚´ì—­ ì •ë ¬ ê´€ë ¨ ë³€ìˆ˜
    let paymentSortColumn = null;
    let paymentSortOrder = 'asc';

    function sortPaymentData(column) {
      // ê°™ì€ ì»¬ëŸ¼ í´ë¦­ ì‹œ ì •ë ¬ ìˆœì„œ í† ê¸€
      if (paymentSortColumn === column) {
        paymentSortOrder = paymentSortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        paymentSortColumn = column;
        paymentSortOrder = 'asc';
      }

      // ì •ë ¬ ì‹¤í–‰
      paymentDataList.sort(function(a, b) {
        let valA, valB;

        if (column === 'amount' || column === 'balance') {
          // ìˆ«ì ì •ë ¬ (ì½¤ë§ˆ ì œê±°)
          valA = parseFloat((a[column] || '0').replace(/[^0-9.-]/g, '')) || 0;
          valB = parseFloat((b[column] || '0').replace(/[^0-9.-]/g, '')) || 0;
        } else if (column === 'approved') {
          // ìŠ¹ì¸ ìƒíƒœ ì •ë ¬
          valA = a.approved ? 1 : 0;
          valB = b.approved ? 1 : 0;
        } else if (column === 'matchedName') {
          // ë§¤ì¹­ëœ ì‹ ì²­ì ì´ë¦„ ì •ë ¬
          valA = a.matchedParticipant ? a.matchedParticipant.user_name : '';
          valB = b.matchedParticipant ? b.matchedParticipant.user_name : '';
        } else {
          // ë¬¸ìì—´ ì •ë ¬
          valA = (a[column] || '').toString().toLowerCase();
          valB = (b[column] || '').toString().toLowerCase();
        }

        if (valA < valB) return paymentSortOrder === 'asc' ? -1 : 1;
        if (valA > valB) return paymentSortOrder === 'asc' ? 1 : -1;
        return 0;
      });

      // ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
      updatePaymentSortIcons();

      // í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§
      displayPaymentData();

      // localStorageì— ì €ì¥
      savePaymentDataToStorage();
    }

    function updatePaymentSortIcons() {
      const columns = ['date', 'type', 'amount', 'balance', 'transactionType', 'content', 'memo', 'matchedName', 'approved'];
      columns.forEach(function(col) {
        const span = document.getElementById('paymentSort_' + col);
        if (span) {
          if (paymentSortColumn === col) {
            span.textContent = paymentSortOrder === 'asc' ? 'â–²' : 'â–¼';
            span.classList.remove('text-gray-400');
            span.classList.add('text-red-600');
          } else {
            span.textContent = '';
            span.classList.remove('text-red-600');
            span.classList.add('text-gray-400');
          }
        }
      });
    }

    function displayPaymentData() {
      const container = document.getElementById('paymentResults');
      const tbody = document.getElementById('paymentTableBody');

      if (!container || !tbody) return;

      container.classList.remove('hidden');
      tbody.innerHTML = '';

      paymentDataList.forEach(function (item, index) {
        const row = document.createElement('tr');
        const hasMatch = item.matchedParticipant !== null;
        const hasPhoneLast4 = item.matchedPhoneLast4 !== '';
        const rowClass = hasMatch ? '' : 'bg-yellow-50';

        // ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ëª©ë¡ ìƒì„±
        let expectedParticipantsHtml = '';
        if (item.expectedParticipants && item.expectedParticipants.length > 0) {
          expectedParticipantsHtml = item.expectedParticipants.map(function(p) {
            return `<div class="text-xs text-blue-600">${p.user_name} (${formatPhone(p.phone)})</div>`;
          }).join('');
        } else {
          expectedParticipantsHtml = '<span class="text-sm text-gray-400">-</span>';
        }

        row.className = rowClass;
        row.innerHTML = `
          <td class="border border-gray-300 px-2 py-1 text-sm text-center text-gray-500">${index + 1}</td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.date || ''}" onchange="updatePaymentData(${index}, 'date', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.type || ''}" onchange="updatePaymentData(${index}, 'type', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.amount || ''}" onchange="updatePaymentData(${index}, 'amount', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.balance || ''}" onchange="updatePaymentData(${index}, 'balance', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.transactionType || ''}" onchange="updatePaymentData(${index}, 'transactionType', this.value)" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.content || ''}" onchange="updatePaymentData(${index}, 'content', this.value); reMatchPayment(${index})" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            <input type="text" class="w-full border-0 bg-transparent text-sm" value="${item.memo || ''}" onchange="updatePaymentData(${index}, 'memo', this.value); reMatchPayment(${index})" />
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${hasMatch ? `
              <div class="text-green-600 font-semibold text-sm">
                âœ“ ${item.matchedParticipant.user_name} (${formatPhone(item.matchedParticipant.phone)})
              </div>
            ` : hasPhoneLast4 ? `
              <div class="text-red-600 text-sm">
                âœ— ë§¤ì¹­ë˜ì§€ ì•ŠìŒ (${item.matchedName}${item.matchedPhoneLast4})
              </div>
            ` : `
              <div class="text-orange-600 text-sm">
                âš  ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ì—†ìŒ
              </div>
            `}
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${expectedParticipantsHtml}
          </td>
          <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
          <td class="border border-gray-300 px-2 py-1">
            ${item.approved ? '<span class="text-green-600 font-semibold text-sm">ìŠ¹ì¸ë¨</span>' : '<span class="text-gray-500 text-sm">ëŒ€ê¸°ì¤‘</span>'}
          </td>
          <td class="border border-gray-300 px-2 py-1">
            ${!item.approved ? `
              <button onclick="approvePayment(${index})" class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">
                ìŠ¹ì¸
              </button>
            ` : `
              <span class="text-green-600">âœ“</span>
            `}
            <button onclick="removePaymentRow(${index})" class="ml-1 px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs">
              ì‚­ì œ
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function updatePaymentData(index, field, value) {
      if (paymentDataList[index]) {
        paymentDataList[index][field] = value;
      }
    }

    function reMatchPayment(index) {
      const item = paymentDataList[index];
      if (!item) return;

      const content = item.content || '';
      const memo = item.memo || '';

      let matchedName = '';
      let matchedPhoneLast4 = '';

      // ë©”ëª¨ë€ì—ì„œ ë¨¼ì € ì‹œë„ (ì• ê³µë°± ë¬´ì‹œ)
      const memoTrimmed = memo.trim();
      const memoMatch = memoTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
      if (memoMatch && memoMatch[1].trim()) {
        matchedName = memoMatch[1].trim();
        matchedPhoneLast4 = memoMatch[2] || '';
      }

      // ë©”ëª¨ë€ì—ì„œ ì´ë¦„ì„ ëª» ì°¾ì•˜ìœ¼ë©´ ë‚´ìš©ë€ì—ì„œ ì‹œë„ (ì• ê³µë°± ë¬´ì‹œ)
      if (!matchedName) {
        const contentTrimmed = content.trim();
        const contentMatch = contentTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
        if (contentMatch) {
          matchedName = contentMatch[1].trim();
          matchedPhoneLast4 = contentMatch[2] || '';
        }
      }

      let matchedParticipant = null;
      if (matchedName && matchedPhoneLast4) {
        matchedParticipant = allParticipants.find(function (p) {
          const pName = p.user_name.trim();
          const matchedNameTrimmed = matchedName.trim();
          const nameMatch = pName === matchedNameTrimmed || pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
          const phoneLast4 = p.phone.slice(-4);
          return nameMatch && phoneLast4 === matchedPhoneLast4;
        });
      }

      // ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ì°¾ê¸° (ì´ë¦„ë§Œìœ¼ë¡œ ë§¤ì¹­)
      let expectedParticipants = [];
      if (matchedName) {
        expectedParticipants = allParticipants.filter(function (p) {
          const pName = p.user_name.trim();
          const matchedNameTrimmed = matchedName.trim();
          return pName === matchedNameTrimmed || pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName);
        });
      }

      item.matchedName = matchedName;
      item.matchedPhoneLast4 = matchedPhoneLast4;
      item.matchedParticipant = matchedParticipant;
      item.expectedParticipants = expectedParticipants;
      item.approved = false;

      displayPaymentData();
    }

    function addPaymentRow() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;

      const rowCount = tbody.querySelectorAll('tr').length;
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td class="border border-gray-300 px-2 py-1 text-sm text-center text-gray-500">${rowCount + 1}</td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" placeholder="ê±°ë˜ì¼ì‹œ" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" placeholder="êµ¬ë¶„" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" placeholder="ê±°ë˜ê¸ˆì•¡" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" placeholder="ê±°ë˜ í›„ ì”ì•¡" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" placeholder="ê±°ë˜êµ¬ë¶„" onchange="updatePaymentDataFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" placeholder="ë‚´ìš©" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" placeholder="ë©”ëª¨" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
        <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
        <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
        <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" placeholder="ë¹„ê³ " /></td>
        <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">ëŒ€ê¸°ì¤‘</td>
        <td class="border border-gray-300 px-2 py-2 sticky right-0 bg-white z-10">
          <div class="flex gap-2">
            <button onclick="approvePaymentFromTable(${rowCount})" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#16a34a'" onmouseout="this.style.backgroundColor='#22c55e'">ìŠ¹ì¸</button>
            <button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">ì‚­ì œ</button>
          </div>
        </td>
      `;
      tbody.appendChild(newRow);

      // paymentDataListì— ë¹ˆ í•­ëª© ì¶”ê°€
      paymentDataList.push({
        date: '',
        type: '',
        amount: '',
        balance: '',
        transactionType: '',
        content: '',
        memo: '',
        matchedName: '',
        matchedPhoneLast4: '',
        matchedParticipant: null,
        expectedParticipants: [],
        approved: false
      });

      // ìƒˆ í–‰ì˜ ì²« ë²ˆì§¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
      const inputs = newRow.querySelectorAll('input');
      if (inputs.length > 0) inputs[0].focus();

      // ì—°ë²ˆ ì¬ì •ë ¬
      updatePaymentRowNumbers();
      // localStorageì— ì €ì¥
      savePaymentDataToStorage();
    }

    function updatePaymentRowNumbers() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;

      const rows = tbody.querySelectorAll('tr');
      rows.forEach(function (row, index) {
        const numberCell = row.cells[0];
        if (numberCell) {
          numberCell.textContent = index + 1;
        }
      });
    }

    // CSV íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    async function handleCSVUpload(input) {
      const file = input.files[0];
      if (!file) return;

      // íŒŒì¼ëª… í‘œì‹œ
      document.getElementById('csvFileName').textContent = file.name;

      const reader = new FileReader();
      reader.onload = async function(e) {
        const csvText = e.target.result;
        await parseCSVData(csvText);
      };
      reader.readAsText(file, 'UTF-8');

      // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
      input.value = '';
    }

    // CSV ë°ì´í„° íŒŒì‹± ë° í…Œì´ë¸” ìƒì„±
    async function parseCSVData(csvText) {
      const lines = csvText.split('\n').filter(line => line.trim());
      if (lines.length < 2) {
        alert('CSV íŒŒì¼ì— í—¤ë”ì™€ ìµœì†Œ 1ê°œì˜ ë°ì´í„° í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      // CSV íŒŒì‹± í•¨ìˆ˜ (ì‰¼í‘œ êµ¬ë¶„, ë”°ì˜´í‘œ ë‚´ ì‰¼í‘œ ì²˜ë¦¬)
      function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];

          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current.trim());
        return result;
      }

      // í—¤ë” íŒŒì‹±
      const headers = parseCSVLine(lines[0]);

      // í—¤ë” ì¸ë±ìŠ¤ ì°¾ê¸°
      const headerMap = {};
      headers.forEach(function(h, i) {
        const hLower = h.toLowerCase();
        if (hLower.includes('ê±°ë˜ì¼ì‹œ') || hLower.includes('ì¼ì‹œ') || hLower.includes('ë‚ ì§œ')) headerMap.date = i;
        if (hLower.includes('êµ¬ë¶„') && !hLower.includes('ê±°ë˜êµ¬ë¶„')) headerMap.type = i;
        if (hLower.includes('ê±°ë˜ê¸ˆì•¡') || (hLower.includes('ê¸ˆì•¡') && !hLower.includes('ì”ì•¡'))) headerMap.amount = i;
        if (hLower.includes('ì”ì•¡')) headerMap.balance = i;
        if (hLower.includes('ê±°ë˜êµ¬ë¶„')) headerMap.transactionType = i;
        if (hLower.includes('ë‚´ìš©') || hLower.includes('ì ìš”')) headerMap.content = i;
        if (hLower.includes('ë©”ëª¨') || hLower.includes('ë¹„ê³ ')) headerMap.memo = i;
      });

      console.log('[CSV] Header map:', headerMap);
      console.log('[CSV] Headers:', headers);

      // ë°ì´í„° í–‰ íŒŒì‹±
      const newPaymentDataList = [];
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length === 0 || (values.length === 1 && !values[0])) continue;

        const date = headerMap.date !== undefined ? (values[headerMap.date] || '') : '';
        const type = headerMap.type !== undefined ? (values[headerMap.type] || '') : '';
        const amount = headerMap.amount !== undefined ? (values[headerMap.amount] || '') : '';
        const balance = headerMap.balance !== undefined ? (values[headerMap.balance] || '') : '';
        const transactionType = headerMap.transactionType !== undefined ? (values[headerMap.transactionType] || '') : '';
        const content = headerMap.content !== undefined ? (values[headerMap.content] || '') : '';
        const memo = headerMap.memo !== undefined ? (values[headerMap.memo] || '') : '';

        // ë¹ˆ í–‰ ì²´í¬
        const isEmpty = !date && !type && !amount && !content;
        if (isEmpty) continue;

        newPaymentDataList.push({
          date: date,
          type: type,
          amount: amount,
          balance: balance,
          transactionType: transactionType,
          content: content,
          memo: memo,
          matchedName: '',
          matchedPhoneLast4: '',
          matchedParticipant: null,
          expectedParticipants: [],
          approved: false,
          isEmpty: false
        });
      }

      if (newPaymentDataList.length === 0) {
        alert('íŒŒì‹±ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. CSV í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        return;
      }

      // paymentDataListì— ì €ì¥
      paymentDataList = newPaymentDataList;
      savePaymentDataToStorage();

      // í…Œì´ë¸” UI ì—…ë°ì´íŠ¸
      updatePaymentTableUI();

      // ì°¸ê°€ì ëª©ë¡ ë¡œë“œ í›„ ë§¤ì¹­ ìˆ˜í–‰
      try {
        const response = await authFetch('/api/admin/participants?limit=100000');
        const data = await response.json();
        if (data.success) {
          allParticipants = data.participants || [];
          console.log('[CSV] Loaded allParticipants:', allParticipants.length);
        }
      } catch (err) {
        console.error('Error loading participants:', err);
      }

      // ë§¤ì¹­ ì •ë³´ ì—…ë°ì´íŠ¸
      performPaymentMatching();

      // í…Œì´ë¸” ë‹¤ì‹œ ì—…ë°ì´íŠ¸ (ë§¤ì¹­ ì •ë³´ í¬í•¨)
      updatePaymentTableWithMatches();
      savePaymentDataToStorage();

      alert('CSV íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ' + newPaymentDataList.length + 'ê°œì˜ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ë§¤ì¹­ ë¡œì§ ìˆ˜í–‰
    function performPaymentMatching() {
      paymentDataList.forEach(function(item, index) {
        if (item.isEmpty) return;

        const content = item.content;
        const memo = item.memo;

        // ë‚´ìš© ë˜ëŠ” ë©”ëª¨ì—ì„œ ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ 4ê°œ ì¶”ì¶œ
        let matchedName = '';
        let matchedPhoneLast4 = '';

        // ë©”ëª¨ë€ì—ì„œ ë¨¼ì € ì‹œë„
        const memoTrimmed = memo.trim();
        const memoMatch = memoTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
        if (memoMatch && memoMatch[1].trim()) {
          matchedName = memoMatch[1].trim();
          matchedPhoneLast4 = memoMatch[2] || '';
        }

        // ë©”ëª¨ë€ì—ì„œ ì´ë¦„ì„ ëª» ì°¾ì•˜ìœ¼ë©´ ë‚´ìš©ë€ì—ì„œ ì‹œë„
        if (!matchedName) {
          const contentTrimmed = content.trim();
          const contentMatch = contentTrimmed.match(/^([ê°€-í£a-zA-Z\s]+)(\d{4})?/);
          if (contentMatch) {
            matchedName = contentMatch[1].trim();
            matchedPhoneLast4 = contentMatch[2] || '';
          }
        }

        item.matchedName = matchedName;
        item.matchedPhoneLast4 = matchedPhoneLast4;

        // ì‹ ì²­ì ë§¤ì¹­
        if (matchedName && matchedPhoneLast4) {
          item.matchedParticipant = allParticipants.find(function(p) {
            const pName = p.user_name.trim();
            const matchedNameTrimmed = matchedName.trim();

            if (pName === matchedNameTrimmed) {
              const phoneLast4 = p.phone.slice(-4);
              return phoneLast4 === matchedPhoneLast4;
            }

            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨í•˜ëŠ” ê²½ìš°
            const pNameHasHangul = /[ê°€-í£]/.test(pName);
            const matchedNameHasHangul = /[ê°€-í£]/.test(matchedNameTrimmed);

            if (pNameHasHangul === matchedNameHasHangul) {
              if (pName.includes(matchedNameTrimmed) || matchedNameTrimmed.includes(pName)) {
                const phoneLast4 = p.phone.slice(-4);
                return phoneLast4 === matchedPhoneLast4;
              }
            }

            return false;
          }) || null;
        }

        // ì˜ˆìƒë˜ëŠ” ì‹ ì²­ì ì°¾ê¸° (ì´ë¦„ë§Œìœ¼ë¡œ)
        if (matchedName) {
          item.expectedParticipants = allParticipants.filter(function(p) {
            return p.user_name.trim() === matchedName.trim();
          });
        }
      });
    }

    // í…Œì´ë¸” UI ì—…ë°ì´íŠ¸ (ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ í…Œì´ë¸” í–‰ ìƒì„±)
    function updatePaymentTableUI() {
      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;

      tbody.innerHTML = '';

      paymentDataList.forEach(function(item, index) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border border-gray-300 px-2 py-1 text-sm text-center text-gray-500">${index + 1}</td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${escapeHtml(item.date)}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${escapeHtml(item.type)}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${escapeHtml(item.amount)}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${escapeHtml(item.balance)}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${escapeHtml(item.transactionType)}" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${escapeHtml(item.content)}" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" value="${escapeHtml(item.memo)}" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
          <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
          <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
          <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">ëŒ€ê¸°ì¤‘</td>
          <td class="border border-gray-300 px-2 py-2 sticky right-0 bg-white z-10">
            <div class="flex gap-2">
              <button onclick="approvePaymentFromTable(${index})" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#16a34a'" onmouseout="this.style.backgroundColor='#22c55e'">ìŠ¹ì¸</button>
              <button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">ì‚­ì œ</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // ë¹ˆ í–‰ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ì¶”ê°€
      if (paymentDataList.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border border-gray-300 px-2 py-1 text-sm text-center text-gray-500">1</td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
          <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
          <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
          <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
          <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">ëŒ€ê¸°ì¤‘</td>
          <td class="border border-gray-300 px-2 py-2 sticky right-0 bg-white z-10">
            <div class="flex gap-2">
              <button onclick="approvePaymentFromTable(0)" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#16a34a'" onmouseout="this.style.backgroundColor='#22c55e'">ìŠ¹ì¸</button>
              <button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">ì‚­ì œ</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function resetPaymentTable() {
      if (!confirm('ì…ê¸ˆ ë‚´ì—­ì„ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. (ì„œë²„ì—ì„œë„ ì‚­ì œë¨)')) {
        return;
      }

      // ì„œë²„ì—ì„œ ì‚­ì œ
      try {
        const response = await authFetch('/api/admin/participants/payment-records', {
          method: 'DELETE'
        });
        const data = await response.json();
        if (data.success) {
          console.log('[Payment] ì„œë²„ ì´ˆê¸°í™” ì™„ë£Œ');
          alert('ì…ê¸ˆ ë‚´ì—­ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          console.error('[Payment] ì„œë²„ ì´ˆê¸°í™” ì‹¤íŒ¨:', data.error);
          alert('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (err) {
        console.error('[Payment] ì„œë²„ ì´ˆê¸°í™” ì˜¤ë¥˜:', err);
        alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }

      paymentDataList = [];

      // CSV íŒŒì¼ëª… ì´ˆê¸°í™”
      const csvFileName = document.getElementById('csvFileName');
      if (csvFileName) csvFileName.textContent = '';

      const tbody = document.getElementById('paymentTableBody');
      if (tbody) {
        tbody.innerHTML = `
          <tr>
            <td class="border border-gray-300 px-2 py-1 text-sm text-center text-gray-500">1</td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1"><input type="text" class="w-full border-0 bg-transparent text-sm" onchange="updatePaymentDataFromInput(this); reMatchPaymentFromInput(this)" /></td>
            <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
            <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
            <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">-</td>
            <td class="border border-gray-300 px-2 py-1 text-sm text-gray-400">ëŒ€ê¸°ì¤‘</td>
            <td class="border border-gray-300 px-2 py-2 sticky right-0 bg-white z-10">
              <div class="flex gap-2">
                <button onclick="approvePaymentFromTable(0)" style="background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#16a34a'" onmouseout="this.style.backgroundColor='#22c55e'">ìŠ¹ì¸</button>
                <button onclick="removePaymentRowFromTable(this)" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">ì‚­ì œ</button>
              </div>
            </td>
          </tr>
        `;
      }
    }

    function removePaymentRow(index) {
      if (confirm('ì´ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        paymentDataList.splice(index, 1);
        displayPaymentData();
      }
    }

    // í˜„ì¬ í•„í„° ìƒíƒœ
    let currentPaymentFilter = 'all';

    // í•„í„° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    function updateFilterButtonStyles(activeFilter) {
      const filterIds = ['filterAll', 'filterMatched', 'filterUnmatched', 'filterDuplicate', 'filterNoPhone', 'filterPending', 'filterApproved'];
      filterIds.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          if (id === 'filter' + activeFilter.charAt(0).toUpperCase() + activeFilter.slice(1) ||
              (activeFilter === 'all' && id === 'filterAll') ||
              (activeFilter === 'noPhone' && id === 'filterNoPhone')) {
            btn.style.backgroundColor = '#6b7280';
            btn.style.color = 'white';
          } else {
            btn.style.backgroundColor = '#e5e7eb';
            btn.style.color = '#374151';
          }
        }
      });
    }

    // í•„í„°ë§ í•¨ìˆ˜
    function filterPaymentData(filterType) {
      currentPaymentFilter = filterType;
      updateFilterButtonStyles(filterType);

      const tbody = document.getElementById('paymentTableBody');
      if (!tbody) return;

      const rows = tbody.querySelectorAll('tr');
      let visibleCount = 0;

      rows.forEach((row, index) => {
        const item = paymentDataList[index];
        if (!item) {
          row.style.display = '';
          return;
        }

        let shouldShow = false;

        switch (filterType) {
          case 'all':
            shouldShow = true;
            break;
          case 'matched':
            shouldShow = item.matchedParticipant !== null;
            break;
          case 'unmatched':
            shouldShow = item.matchedParticipant === null && item.matchedPhoneLast4 !== '';
            break;
          case 'duplicate':
            shouldShow = item.matchedParticipant === null && item.expectedParticipants && item.expectedParticipants.length > 1;
            break;
          case 'noPhone':
            shouldShow = item.matchedPhoneLast4 === '' || !item.matchedPhoneLast4;
            break;
          case 'pending':
            shouldShow = !item.approved;
            break;
          case 'approved':
            shouldShow = item.approved === true;
            break;
        }

        row.style.display = shouldShow ? '' : 'none';
        if (shouldShow) visibleCount++;
      });

      // í•„í„° ì¹´ìš´íŠ¸ í‘œì‹œ
      const filterCount = document.getElementById('filterCount');
      if (filterCount) {
        filterCount.textContent = `(${visibleCount}/${paymentDataList.length}ê°œ í‘œì‹œ)`;
      }
    }

    // ë§¤ì¹­ëœ í•­ëª© ì¼ê´„ìŠ¹ì¸
    async function bulkApproveMatched() {
      // ë§¤ì¹­ë˜ì—ˆì§€ë§Œ ì•„ì§ ìŠ¹ì¸ë˜ì§€ ì•Šì€ í•­ëª© ì°¾ê¸°
      const itemsToApprove = paymentDataList.filter(item =>
        item.matchedParticipant !== null && !item.approved
      );

      if (itemsToApprove.length === 0) {
        alert('ìŠ¹ì¸í•  ë§¤ì¹­ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      if (!confirm(`ë§¤ì¹­ëœ ${itemsToApprove.length}ê°œ í•­ëª©ì„ ì¼ê´„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ë¯¸ë§¤ì¹­, ë™ëª…ì´ì¸, ì „í™”ë²ˆí˜¸ ì—†ìŒ í•­ëª©ì€ ì œì™¸ë©ë‹ˆë‹¤)`)) {
        return;
      }

      const btn = document.getElementById('bulkApproveBtn');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'â³ ì²˜ë¦¬ ì¤‘...';
      }

      let successCount = 0;
      let failCount = 0;

      try {
        for (let i = 0; i < paymentDataList.length; i++) {
          const item = paymentDataList[i];
          if (item.matchedParticipant && !item.approved) {
            try {
              const response = await authFetch('/api/admin/participants/' + item.matchedParticipant.id + '/payment', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_paid: true }),
              });

              const data = await response.json();
              if (response.ok) {
                item.approved = true;
                successCount++;
              } else {
                console.error('Failed to approve:', item.matchedParticipant.user_name, data.error);
                failCount++;
              }
            } catch (err) {
              console.error('Error approving:', item.matchedParticipant.user_name, err);
              failCount++;
            }
          }
        }

        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        restorePaymentTableFromData();

        // í˜„ì¬ í•„í„° ë‹¤ì‹œ ì ìš©
        filterPaymentData(currentPaymentFilter);

        // ì„œë²„ì— ì¦‰ì‹œ ì €ì¥ (debounce ì—†ì´)
        try {
          const dataToSave = paymentDataList.map(function (item) {
            return {
              date: item.date,
              type: item.type,
              amount: item.amount,
              balance: item.balance,
              transactionType: item.transactionType,
              content: item.content,
              memo: item.memo,
              matchedName: item.matchedName,
              matchedPhoneLast4: item.matchedPhoneLast4,
              matchedParticipantId: item.matchedParticipant ? item.matchedParticipant.id : null,
              approved: item.approved
            };
          });

          const saveResponse = await authFetch('/api/admin/participants/payment-records/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ records: dataToSave })
          });
          const saveData = await saveResponse.json();
          if (saveData.success) {
            console.log('[BulkApprove] ì…ê¸ˆ ë‚´ì—­ ì €ì¥ ì™„ë£Œ:', dataToSave.length, 'ê°œ');
          } else {
            console.error('[BulkApprove] ì €ì¥ ì‹¤íŒ¨:', saveData.error);
          }
        } catch (saveErr) {
          console.error('[BulkApprove] ì €ì¥ ì˜¤ë¥˜:', saveErr);
        }

        // ìºì‹œ ë¬´íš¨í™”
        participantsCache = null;
        participantsCacheTime = null;

        alert(`ì¼ê´„ ìŠ¹ì¸ ì™„ë£Œ!\n\nì„±ê³µ: ${successCount}ê°œ\nì‹¤íŒ¨: ${failCount}ê°œ`);
      } catch (err) {
        console.error('Bulk approve error:', err);
        alert('ì¼ê´„ ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'âœ“ ë§¤ì¹­ëœ í•­ëª© ì¼ê´„ìŠ¹ì¸';
        }
      }
    }

    async function approvePayment(index) {
      const item = paymentDataList[index];
      if (!item) return;

      if (!item.matchedParticipant && item.matchedPhoneLast4) {
        // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° í™•ì¸
        if (!confirm('ë§¤ì¹­ëœ ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.\në‚´ìš©: ' + item.content + '\n\nìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
      } else if (!item.matchedPhoneLast4) {
        // ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ê°€ ì—†ëŠ” ê²½ìš° í™•ì¸
        if (!confirm('ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.\në‚´ìš©: ' + item.content + '\n\nìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
      }

      if (item.matchedParticipant) {
        // ë§¤ì¹­ëœ ì°¸ê°€ìì˜ ì…ê¸ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
        try {
          const response = await authFetch('/api/admin/participants/' + item.matchedParticipant.id + '/payment', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_paid: true }),
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }

          item.approved = true;

          // ìºì‹œ ë¬´íš¨í™” ë° ì „ì²´ ì°¸ê°€ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          participantsCache = null;
          participantsCacheTime = null;
          await reloadAllParticipants();

          displayPaymentData();
          loadParticipants(currentPage, true);
          alert('ì…ê¸ˆì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (err) {
          console.error('Error approving payment:', err);
          const errorMessage = err.message || 'ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          alert(errorMessage);
        }
      } else {
        // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° ìˆ˜ë™ ìŠ¹ì¸
        item.approved = true;
        displayPaymentData();
        alert('ìˆ˜ë™ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì°¸ê°€ì ê´€ë¦¬ì—ì„œ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.');
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê·¸ë£¹ í‘œì‹œ ì—…ë°ì´íŠ¸
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function () {
        updateGroupDisplay();
      });
    } else {
      updateGroupDisplay();
    }

    // QR ì²´í¬ì¸ ê´€ë ¨ ë³€ìˆ˜
    let html5QrCode = null;
    let recentCheckins = [];
    let barcodeScannerTimeout = null;
    let isProcessingBarcode = false;

    // ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì´ˆê¸°í™”
    function initBarcodeScanner() {
      const scannerInput = document.getElementById('barcodeScannerInput');
      if (!scannerInput) return;

      // ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì…ë ¥ ì²˜ë¦¬ (Enter í‚¤ ë˜ëŠ” íƒ€ì´ë¨¸)
      scannerInput.addEventListener('input', function(e) {
        // ì´ì „ íƒ€ì´ë¨¸ ì·¨ì†Œ
        if (barcodeScannerTimeout) {
          clearTimeout(barcodeScannerTimeout);
        }

        // 50ms í›„ì— ìë™ ì²˜ë¦¬ (ë°”ì½”ë“œ ìŠ¤ìºë„ˆëŠ” ë¹ ë¥´ê²Œ ì…ë ¥ í›„ ì™„ë£Œë¨)
        barcodeScannerTimeout = setTimeout(() => {
          if (scannerInput.value.trim() && !isProcessingBarcode) {
            processBarcodeInput();
          }
        }, 100);
      });

      // Enter í‚¤ ì²˜ë¦¬
      scannerInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (barcodeScannerTimeout) {
            clearTimeout(barcodeScannerTimeout);
          }
          if (scannerInput.value.trim() && !isProcessingBarcode) {
            processBarcodeInput();
          }
        }
      });

      // í¬ì»¤ìŠ¤ ìœ ì§€
      scannerInput.addEventListener('blur', function() {
        const autoFocus = document.getElementById('autoFocusScanner');
        if (autoFocus && autoFocus.checked) {
          setTimeout(() => {
            scannerInput.focus();
          }, 100);
        }
      });

      // ì´ˆê¸° í¬ì»¤ìŠ¤
      setTimeout(() => scannerInput.focus(), 500);
    }

    // ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì…ë ¥ ì²˜ë¦¬
    async function processBarcodeInput() {
      const scannerInput = document.getElementById('barcodeScannerInput');
      const statusEl = document.getElementById('scannerStatus');
      const qrData = scannerInput.value.trim();

      if (!qrData || isProcessingBarcode) return;

      isProcessingBarcode = true;
      statusEl.textContent = 'ì²˜ë¦¬ ì¤‘...';
      statusEl.className = 'text-sm text-yellow-600 font-medium';

      try {
        await processCheckin(qrData);
        statusEl.textContent = 'ìŠ¤ìº” ì„±ê³µ!';
        statusEl.className = 'text-sm text-green-600 font-medium';

        // ì„±ê³µ í›„ 3ì´ˆ ë’¤ ëŒ€ê¸° ìƒíƒœë¡œ
        setTimeout(() => {
          statusEl.textContent = 'ëŒ€ê¸° ì¤‘...';
          statusEl.className = 'text-sm text-green-600 font-medium';
        }, 3000);
      } catch (err) {
        statusEl.textContent = 'ìŠ¤ìº” ì‹¤íŒ¨: ' + (err.message || 'ì˜¤ë¥˜ ë°œìƒ');
        statusEl.className = 'text-sm text-red-600 font-medium';

        setTimeout(() => {
          statusEl.textContent = 'ëŒ€ê¸° ì¤‘...';
          statusEl.className = 'text-sm text-green-600 font-medium';
        }, 3000);
      } finally {
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ë° í¬ì»¤ìŠ¤
        scannerInput.value = '';
        scannerInput.focus();
        isProcessingBarcode = false;
      }
    }

    // í˜„ì¬ ì¸ì‡„ ì¤‘ì¸ì§€ ì¶”ì  (ë¬´í•œ ì¸ì‡„ ë°©ì§€)
    let isPrinting = false;
    let printQueue = [];

    // ì¸ì‡„ ì™„ë£Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•œ ë²ˆë§Œ ë“±ë¡)
    window.addEventListener('afterprint', function() {
      console.log('Print completed or cancelled');
      isPrinting = false;

      // íì— ëŒ€ê¸° ì¤‘ì¸ ì¸ì‡„ê°€ ìˆìœ¼ë©´ ë‹¤ìŒ ì¸ì‡„ ì‹¤í–‰
      if (printQueue.length > 0) {
        const next = printQueue.shift();
        setTimeout(() => printCheckinLabel(next.name, next.seat), 500);
      }
    });

    // ë„¤ëª¨ë‹‰ í”„ë¦°í„°ë¡œ ì´ë¦„í‘œ ì¶œë ¥
    function printCheckinLabel(name, seat) {
      // ì´ë¯¸ ì¸ì‡„ ì¤‘ì´ë©´ íì— ì¶”ê°€
      if (isPrinting) {
        console.log('Already printing, adding to queue...');
        // ì¤‘ë³µ ë°©ì§€: ê°™ì€ ì´ë¦„ì´ íì— ì—†ì„ ë•Œë§Œ ì¶”ê°€
        if (!printQueue.some(p => p.name === name && p.seat === seat)) {
          printQueue.push({ name, seat });
        }
        return;
      }

      isPrinting = true;

      // í”„ë¦°íŠ¸ ì˜ì—­ ì—…ë°ì´íŠ¸
      const printName = document.getElementById('printName');
      const printSeat = document.getElementById('printSeat');

      if (printName && printSeat) {
        printName.textContent = name;
        printSeat.textContent = seat || 'ì¢Œì„ ë¯¸ë°°ì •';
      }

      // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ì¸ì‡„ ì‹¤í–‰
      setTimeout(() => {
        window.print();
      }, 100);
    }

    // ì²´í¬ì¸ íŒì—… ì—´ê¸°
    function openCheckinPopup() {
      // adminToken ë³€ìˆ˜ ë˜ëŠ” sessionStorageì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
      const token = adminToken || sessionStorage.getItem('adminToken') || '';
      if (!token) {
        alert('ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        return;
      }
      const url = `/checkin.html?token=${encodeURIComponent(token)}`;
      const popup = window.open(url, 'checkin_popup', 'width=800,height=900,scrollbars=yes,resizable=yes');
      if (popup) {
        popup.focus();
      } else {
        alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”.');
      }
    }

    // ì²´í¬ì¸ í†µê³„ ë¡œë“œ
    // ì „ì²´ ì²´í¬ì¸ ì´ˆê¸°í™”
    async function resetAllCheckins() {
      const checkedInCount = document.getElementById('checkinCount').textContent;

      if (!confirm(`ì •ë§ë¡œ ëª¨ë“  ì²´í¬ì¸ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní˜„ì¬ ì²´í¬ì¸ëœ ì¸ì›: ${checkedInCount}ëª…\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
      }

      // ì´ì¤‘ í™•ì¸
      const confirmText = prompt('ì •ë§ë¡œ ì´ˆê¸°í™”í•˜ë ¤ë©´ "ì´ˆê¸°í™”"ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (confirmText !== 'ì´ˆê¸°í™”') {
        alert('ì´ˆê¸°í™”ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        return;
      }

      try {
        const response = await authFetch('/api/admin/checkin/reset-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ confirmToken: 'RESET_ALL_CHECKINS_CONFIRM' })
        });

        const data = await response.json();

        if (data.success) {
          alert(data.message);
          // í†µê³„ ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          loadCheckinStats();
          recentCheckins = [];
          displayRecentCheckins();
          // ì°¸ê°€ì ëª©ë¡ë„ ê°±ì‹ 
          participantsCache = null;
          participantsCacheTime = null;
          loadParticipants(currentPage, true);
        } else {
          throw new Error(data.error || 'ì´ˆê¸°í™” ì‹¤íŒ¨');
        }
      } catch (err) {
        console.error('Error resetting all check-ins:', err);
        alert('ì²´í¬ì¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
      }
    }

    async function loadCheckinStats() {
      try {
        const response = await authFetch('/api/admin/checkin/stats');
        const data = await response.json();

        if (data.success) {
          document.getElementById('checkinTotal').textContent = data.stats.total;
          document.getElementById('checkinCount').textContent = data.stats.checkedIn;
          document.getElementById('checkinRemaining').textContent = data.stats.remaining;
        }
      } catch (err) {
        console.error('Error loading check-in stats:', err);
      }
    }

    // QR ìŠ¤ìºë„ˆ ì‹œì‘
    async function startQRScanner() {
      const qrReader = document.getElementById('qrReader');
      const startBtn = document.getElementById('startScannerBtn');
      const stopBtn = document.getElementById('stopScannerBtn');
      const container = document.getElementById('qrScannerContainer');

      if (!qrReader || !container) {
        alert('QR ìŠ¤ìºë„ˆ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // html5-qrcode ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
      if (typeof Html5Qrcode === 'undefined') {
        alert('QR ìŠ¤ìºë„ˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        // ì»¨í…Œì´ë„ˆ ë¨¼ì € í‘œì‹œ
        container.classList.remove('hidden');
        startBtn.classList.add('hidden');
        stopBtn.classList.remove('hidden');

        // qrReader ë‚´ìš© ì´ˆê¸°í™”
        qrReader.innerHTML = '';

        // html5-qrcode ì´ˆê¸°í™”
        html5QrCode = new Html5Qrcode('qrReader');

        // ì¹´ë©”ë¼ ì‹œì‘
        await html5QrCode.start(
          { facingMode: 'environment' }, // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          (decodedText, decodedResult) => {
            // QR ì½”ë“œ ìŠ¤ìº” ì„±ê³µ
            handleQRScan(decodedText);
          },
          (errorMessage) => {
            // ìŠ¤ìº” ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œ)
            // console.log('Scan error:', errorMessage);
          }
        );
      } catch (err) {
        console.error('Error starting QR scanner:', err);
        // ì—ëŸ¬ ë°œìƒ ì‹œ UI ë³µì›
        container.classList.add('hidden');
        startBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');

        if (html5QrCode) {
          try {
            await html5QrCode.stop();
            html5QrCode.clear();
            html5QrCode = null;
          } catch (e) {
            // ë¬´ì‹œ
          }
        }

        let errorMsg = 'ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.';
        if (err.message && err.message.includes('Permission')) {
          errorMsg = 'ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
        } else if (err.message && err.message.includes('NotFound')) {
          errorMsg = 'ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
        }
        alert(errorMsg);
      }
    }

    // QR ìŠ¤ìºë„ˆ ì¤‘ì§€
    async function stopQRScanner() {
      const container = document.getElementById('qrScannerContainer');
      const startBtn = document.getElementById('startScannerBtn');
      const stopBtn = document.getElementById('stopScannerBtn');

      if (html5QrCode) {
        try {
          await html5QrCode.stop();
          html5QrCode.clear();
          html5QrCode = null;
        } catch (err) {
          console.error('Error stopping QR scanner:', err);
        }
      }

      if (container) {
        container.classList.add('hidden');
        // qrReader ë‚´ìš© ì´ˆê¸°í™”
        const qrReader = document.getElementById('qrReader');
        if (qrReader) qrReader.innerHTML = '';
      }
      if (startBtn) startBtn.classList.remove('hidden');
      if (stopBtn) stopBtn.classList.add('hidden');
    }

    // QR ì½”ë“œ ìŠ¤ìº” ì²˜ë¦¬
    async function handleQRScan(qrData) {
      // ìŠ¤ìº” ì¤‘ì§€ (ì¤‘ë³µ ìŠ¤ìº” ë°©ì§€)
      await stopQRScanner();

      // ì²´í¬ì¸ ì²˜ë¦¬
      await processCheckin(qrData);
    }

    // ìˆ˜ë™ ì…ë ¥ ì²˜ë¦¬
    async function processManualCheckin() {
      const input = document.getElementById('manualQRInput');
      if (!input || !input.value.trim()) {
        alert('QR ì½”ë“œ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      await processCheckin(input.value.trim());
      input.value = '';
    }

    // ì²´í¬ì¸ ì²˜ë¦¬
    async function processCheckin(qrData) {
      const resultDiv = document.getElementById('checkinResult');
      if (!resultDiv) return;

      resultDiv.classList.remove('hidden');
      resultDiv.innerHTML = '<p class="text-gray-600">ì²˜ë¦¬ ì¤‘...</p>';
      resultDiv.className = 'mb-4 p-4 rounded-lg bg-gray-50';

      // QR ë°ì´í„° ê²€ì¦
      if (!qrData || !qrData.trim()) {
        resultDiv.className = 'mb-4 p-4 rounded-lg bg-red-50 border border-red-200';
        resultDiv.innerHTML = '<p class="font-semibold text-red-900">QR ì½”ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      try {
        // í•œê¸€ ìíŒ -> ì˜ë¬¸ ìíŒ ë³€í™˜ ë§µ
        const korToEngMap = {
          'ã…‚': 'q', 'ã…ˆ': 'w', 'ã„·': 'e', 'ã„±': 'r', 'ã……': 't', 'ã…›': 'y', 'ã…•': 'u', 'ã…‘': 'i', 'ã…': 'o', 'ã…”': 'p',
          'ã…': 'a', 'ã„´': 's', 'ã…‡': 'd', 'ã„¹': 'f', 'ã…': 'g', 'ã…—': 'h', 'ã…“': 'j', 'ã…': 'k', 'ã…£': 'l',
          'ã…‹': 'z', 'ã…Œ': 'x', 'ã…Š': 'c', 'ã…': 'v', 'ã… ': 'b', 'ã…œ': 'n', 'ã…¡': 'm',
          'ã…ƒ': 'Q', 'ã…‰': 'W', 'ã„¸': 'E', 'ã„²': 'R', 'ã…†': 'T', 'ã…’': 'O', 'ã…–': 'P'
        };

        // í•œê¸€ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì˜ë¬¸ìœ¼ë¡œ ë³€í™˜
        let convertedData = qrData;
        if (/[ã„±-ã…ã…-ã…£]/.test(qrData)) {
          convertedData = qrData.split('').map(char => korToEngMap[char] || char).join('');
          console.log('Converted Korean to English:', qrData, '->', convertedData);
        }

        // QR ë°ì´í„°ê°€ JSON ë¬¸ìì—´ì¸ì§€ í™•ì¸
        let qrDataToSend = convertedData;
        try {
          // ì´ë¯¸ JSON ë¬¸ìì—´ì¸ì§€ í™•ì¸
          JSON.parse(convertedData);
          qrDataToSend = convertedData;
        } catch (e) {
          // JSONì´ ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ ì „ì†¡ (ì„œë²„ì—ì„œ ì²˜ë¦¬)
          qrDataToSend = convertedData;
        }

        console.log('Sending QR data:', qrDataToSend);

        const response = await authFetch('/api/admin/checkin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ qrData: qrDataToSend })
        });

        const data = await response.json();

        console.log('Check-in response:', data);

        if (response.ok && data.success) {
          // ì„±ê³µ
          resultDiv.className = 'mb-4 p-4 rounded-lg bg-green-50 border border-green-200';
          if (data.alreadyCheckedIn) {
            resultDiv.innerHTML = `
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <div>
                  <p class="font-semibold text-green-900">${data.message}</p>
                  <p class="text-sm text-green-700">${data.participant.user_name} (${data.participant.phone})</p>
                </div>
              </div>
            `;
          } else {
            resultDiv.innerHTML = `
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <div>
                  <p class="font-semibold text-green-900">${data.message}</p>
                  <p class="text-sm text-green-700">${data.participant.user_name} (${data.participant.phone})</p>
                </div>
              </div>
            `;
          }

          // ìµœê·¼ ì²´í¬ì¸ ëª©ë¡ì— ì¶”ê°€
          addToRecentCheckins(data.participant, data.alreadyCheckedIn);

          // í†µê³„ ì—…ë°ì´íŠ¸
          loadCheckinStats();

          // ìë™ í”„ë¦°íŠ¸ (ì´ë¯¸ ì²´í¬ì¸ëœ ê²½ìš°ëŠ” í”„ë¦°íŠ¸í•˜ì§€ ì•ŠìŒ)
          const autoPrint = document.getElementById('autoPrintCheckin');
          if (autoPrint && autoPrint.checked && !data.alreadyCheckedIn) {
            const seatInfo = data.participant.seat_full || 'ì¢Œì„ ë¯¸ë°°ì •';
            printCheckinLabel(data.participant.user_name, seatInfo);
          }

          // 3ì´ˆ í›„ ë©”ì‹œì§€ ìë™ ìˆ¨ê¹€
          setTimeout(() => {
            resultDiv.classList.add('hidden');
          }, 3000);
        } else {
          // ì‹¤íŒ¨
          resultDiv.className = 'mb-4 p-4 rounded-lg bg-red-50 border border-red-200';
          const errorMsg = data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          resultDiv.innerHTML = `
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
              </svg>
              <div>
                <p class="font-semibold text-red-900">${errorMsg}</p>
                ${data.participant ? `<p class="text-sm text-red-700">${data.participant.user_name} (${data.participant.phone})</p>` : ''}
                <p class="text-xs text-red-600 mt-1">QR ë°ì´í„°: ${qrData.substring(0, 100)}...</p>
              </div>
            </div>
          `;
        }
      } catch (err) {
        console.error('Error processing check-in:', err);
        resultDiv.className = 'mb-4 p-4 rounded-lg bg-red-50 border border-red-200';
        resultDiv.innerHTML = `
          <div>
            <p class="font-semibold text-red-900">ì²´í¬ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
            <p class="text-sm text-red-700 mt-1">${err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
            <p class="text-xs text-red-600 mt-1">QR ë°ì´í„°: ${qrData.substring(0, 100)}...</p>
          </div>
        `;
      }
    }

    // ìµœê·¼ ì²´í¬ì¸ ëª©ë¡ì— ì¶”ê°€
    function addToRecentCheckins(participant, alreadyCheckedIn) {
      const recentDiv = document.getElementById('recentCheckins');
      if (!recentDiv) return;

      const checkinItem = {
        participant: participant,
        timestamp: new Date().toLocaleString('ko-KR'),
        alreadyCheckedIn: alreadyCheckedIn
      };

      recentCheckins.unshift(checkinItem);
      if (recentCheckins.length > 10) {
        recentCheckins = recentCheckins.slice(0, 10);
      }

      displayRecentCheckins();
    }

    // ìµœê·¼ ì²´í¬ì¸ ë‚´ì—­ í‘œì‹œ
    function displayRecentCheckins() {
      const recentDiv = document.getElementById('recentCheckins');
      if (!recentDiv) return;

      if (recentCheckins.length === 0) {
        recentDiv.innerHTML = '<p class="text-sm text-gray-500 text-center">ì²´í¬ì¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      } else {
        recentDiv.innerHTML = recentCheckins.map(item => `
          <div class="p-3 bg-white rounded-lg border border-gray-200 flex items-center justify-between">
            <div>
              <p class="font-semibold text-gray-900">${item.participant.user_name}</p>
              <p class="text-sm text-gray-600">${item.participant.seat_full || ''} â€¢ ${item.timestamp}</p>
            </div>
            ${item.alreadyCheckedIn ?
            '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">ì¤‘ë³µ</span>' :
            '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">ì™„ë£Œ</span>'
          }
          </div>
        `).join('');
      }
    }

    // ì„œë²„ì—ì„œ ìµœê·¼ ì²´í¬ì¸ ê¸°ë¡ ë¡œë“œ
    async function loadRecentCheckins() {
      try {
        const response = await authFetch('/api/admin/checkin/recent?limit=20');
        const data = await response.json();

        if (data.success && data.records) {
          recentCheckins = data.records.map(record => ({
            participant: {
              id: record.participant_id,
              user_name: record.user_name,
              phone: record.phone,
              seat_full: record.seat_full
            },
            timestamp: new Date(record.checked_in_at).toLocaleString('ko-KR'),
            alreadyCheckedIn: false
          }));
          displayRecentCheckins();
        }
      } catch (err) {
        console.error('Error loading recent checkins:', err);
      }
    }

    // ===== ì°¸ê°€ì ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ =====
    async function openEditModal(participantId, isGuest = false) {
      editingParticipantId = participantId;
      editingIsGuest = isGuest;

      // ì°¸ê°€ì ë°ì´í„° ì°¾ê¸° (í˜„ì¬ í‘œì‹œëœ ëª©ë¡, ìºì‹œ, allParticipantsì—ì„œ ìˆœì°¨ì ìœ¼ë¡œ ê²€ìƒ‰)
      let participant = null;

      // 1. í˜„ì¬ í‘œì‹œëœ participants ë°°ì—´ì—ì„œ ì°¾ê¸°
      if (Array.isArray(participants)) {
        participant = participants.find(p => p.id === participantId);
      }

      // 2. ìºì‹œì—ì„œ ì°¾ê¸°
      if (!participant && Array.isArray(participantsCache)) {
        participant = participantsCache.find(p => p.id === participantId);
      }

      // 3. allParticipantsì—ì„œ ì°¾ê¸°
      if (!participant && Array.isArray(allParticipants)) {
        participant = allParticipants.find(p => p.id === participantId);
      }

      // 4. ì—¬ì „íˆ ì—†ìœ¼ë©´ APIë¡œ ì§ì ‘ ì¡°íšŒ
      if (!participant) {
        try {
          const response = await authFetch(`/api/admin/participants?search=${participantId}&limit=1`);
          const data = await response.json();
          if (data.success && data.participants && data.participants.length > 0) {
            participant = data.participants.find(p => p.id === participantId);
          }
        } catch (err) {
          console.error('Error fetching participant:', err);
        }
      }

      if (!participant) {
        alert('ì°¸ê°€ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ëª¨ë‹¬ ì œëª© ì„¤ì •
      const titleEl = document.getElementById('editModalTitle');

      if (isGuest) {
        // ë™ë°˜ì ìˆ˜ì • ëª¨ë“œ
        titleEl.textContent = `ë™ë°˜ì ì •ë³´ ìˆ˜ì • (ì‹ ì²­ì: ${participant.user_name})`;

        // ë³¸ì¸ ì •ë³´ í•„ë“œ ìˆ¨ê¸°ê¸°
        document.getElementById('editMainFields').classList.add('hidden');
        // ì·¨ì†Œ/í™˜ë¶ˆ ì •ë³´ ìˆ¨ê¸°ê¸° (ë™ë°˜ìëŠ” ë³„ë„ ì·¨ì†Œ/í™˜ë¶ˆ ì—†ìŒ)
        document.getElementById('editCancelRefundFields').classList.add('hidden');
        // ë³¸ì¸ ì¢Œì„ ì •ë³´ ìˆ¨ê¸°ê¸°
        document.getElementById('editMainSeatFields').classList.add('hidden');

        // ë™ë°˜ì ì •ë³´ í•„ë“œ í‘œì‹œ
        document.getElementById('editGuestFields').classList.remove('hidden');
        document.getElementById('editGuestSeatFields').classList.remove('hidden');

        // ë™ë°˜ì ì •ë³´ ì±„ìš°ê¸°
        document.getElementById('editGuest2Name').value = participant.guest2_name || '';
        document.getElementById('editGuest2Phone').value = participant.guest2_phone || '';
        document.getElementById('editGuest2Ssn').value = participant.guest2_ssn_first || '';
        // ë™ë°˜ì ì¢Œì„
        document.getElementById('editSeatGroup2').value = participant.seat_group_2 || '';
        document.getElementById('editSeatRow2').value = participant.seat_row_2 || '';
        document.getElementById('editSeatNumber2').value = participant.seat_number_2 || '';
        // ë™ë°˜ì ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ
        const guestPwDisplay = participant.guest2_password
          ? `ë³€ê²½ë¨ (${participant.guest2_password})`
          : `ìƒë…„ì›”ì¼ (${participant.guest2_ssn_first || 'ë¯¸ë“±ë¡'})`;
        document.getElementById('editGuestPasswordDisplay').textContent = guestPwDisplay;
      } else {
        // ë³¸ì¸ ìˆ˜ì • ëª¨ë“œ
        titleEl.textContent = `ì‹ ì²­ì ì •ë³´ ìˆ˜ì • (ID: ${participant.id})`;

        // ë³¸ì¸ ì •ë³´ í•„ë“œ í‘œì‹œ
        document.getElementById('editMainFields').classList.remove('hidden');
        // ì·¨ì†Œ/í™˜ë¶ˆ ì •ë³´ í‘œì‹œ
        document.getElementById('editCancelRefundFields').classList.remove('hidden');
        // ë³¸ì¸ ì¢Œì„ ì •ë³´ í‘œì‹œ
        document.getElementById('editMainSeatFields').classList.remove('hidden');

        // ë™ë°˜ì ì •ë³´ í•„ë“œ ìˆ¨ê¸°ê¸°
        document.getElementById('editGuestFields').classList.add('hidden');
        document.getElementById('editGuestSeatFields').classList.add('hidden');

        // ë³¸ì¸ ì •ë³´ ì±„ìš°ê¸°
        document.getElementById('editUserName').value = participant.user_name || '';
        document.getElementById('editPhone').value = participant.phone || '';
        document.getElementById('editSsnFirst').value = participant.ssn_first || '';
        document.getElementById('editTicketCount').value = participant.ticket_count || 1;
        document.getElementById('editIsPaid').value = participant.is_paid ? '1' : '0';
        document.getElementById('editIsCheckedIn').value = participant.is_checked_in ? '1' : '0';

        // ì·¨ì†Œ/í™˜ë¶ˆ ì •ë³´ ì±„ìš°ê¸°
        document.getElementById('editIsCancelled').value = participant.is_cancelled ? '1' : '0';
        document.getElementById('editRefundStatus').value = participant.refund_status || '';
        document.getElementById('editRefundAmount').value = participant.refund_amount || '';
        document.getElementById('editRefundBank').value = participant.refund_bank || '';
        document.getElementById('editRefundAccount').value = participant.refund_account || '';
        document.getElementById('editRefundHolder').value = participant.refund_holder || '';
        document.getElementById('editRefundReason').value = participant.refund_reason || '';

        // ì¢Œì„ ì •ë³´ ì±„ìš°ê¸°
        document.getElementById('editSeatGroup').value = participant.seat_group || '';
        document.getElementById('editSeatRow').value = participant.seat_row || '';
        document.getElementById('editSeatNumber').value = participant.seat_number || '';

        // ë³¸ì¸ ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ
        const mainPwDisplay = participant.password
          ? `ë³€ê²½ë¨ (${participant.password})`
          : `ìƒë…„ì›”ì¼ (${participant.ssn_first || 'ë¯¸ë“±ë¡'})`;
        document.getElementById('editMainPasswordDisplay').textContent = mainPwDisplay;
      }

      // ëª¨ë‹¬ í‘œì‹œ
      document.getElementById('editParticipantModal').classList.remove('hidden');
    }

    // ë¹„ë°€ë²ˆí˜¸ ë¦¬ì…‹
    async function resetPassword(target) {
      if (!editingParticipantId) return;

      const targetName = target === 'guest' ? 'ë™ë°˜ì' : 'ì‹ ì²­ì';
      if (!confirm(`${targetName}ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìƒë…„ì›”ì¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        const response = await authFetch(`/api/admin/participants/${editingParticipantId}/reset-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ target })
        });

        const data = await response.json();
        if (data.success) {
          alert(data.message);
          // ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ ì—…ë°ì´íŠ¸
          if (target === 'guest') {
            document.getElementById('editGuestPasswordDisplay').textContent = `ìƒë…„ì›”ì¼ (${data.reset_to || 'ë¯¸ë“±ë¡'})`;
          } else {
            document.getElementById('editMainPasswordDisplay').textContent = `ìƒë…„ì›”ì¼ (${data.reset_to || 'ë¯¸ë“±ë¡'})`;
          }
        } else {
          alert(data.error || 'ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('Error resetting password:', error);
        alert('ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function closeEditModal() {
      document.getElementById('editParticipantModal').classList.add('hidden');
      editingParticipantId = null;
      editingIsGuest = false;
    }

    async function saveParticipantEdit() {
      if (!editingParticipantId) return;

      let updateData = {};

      if (editingIsGuest) {
        // ë™ë°˜ì ì •ë³´ë§Œ ìˆ˜ì •
        const guest2Name = document.getElementById('editGuest2Name').value.trim();

        updateData = {
          guest2_name: guest2Name || null,
          guest2_phone: document.getElementById('editGuest2Phone').value.trim() || null,
          guest2_ssn_first: document.getElementById('editGuest2Ssn').value.trim() || null,
          // ë™ë°˜ì ì¢Œì„
          seat_group_2: document.getElementById('editSeatGroup2').value.trim() || null,
          seat_row_2: parseInt(document.getElementById('editSeatRow2').value) || null,
          seat_number_2: parseInt(document.getElementById('editSeatNumber2').value) || null,
        };

        // seat_full_2 ìƒì„±
        if (updateData.seat_group_2 && updateData.seat_row_2 && updateData.seat_number_2) {
          updateData.seat_full_2 = `${updateData.seat_group_2}-${updateData.seat_row_2}-${updateData.seat_number_2}`;
        } else {
          updateData.seat_full_2 = null;
        }
      } else {
        // ë³¸ì¸ ì •ë³´ë§Œ ìˆ˜ì •
        const userName = document.getElementById('editUserName').value.trim();
        const phone = document.getElementById('editPhone').value.trim();

        if (!userName) {
          alert('ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
          return;
        }
        if (!phone) {
          alert('ì „í™”ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
          return;
        }

        updateData = {
          user_name: userName,
          phone: phone,
          ssn_first: document.getElementById('editSsnFirst').value.trim() || null,
          ticket_count: parseInt(document.getElementById('editTicketCount').value),
          is_paid: document.getElementById('editIsPaid').value === '1' ? 1 : 0,
          is_checked_in: document.getElementById('editIsCheckedIn').value === '1' ? 1 : 0,
          // ì·¨ì†Œ/í™˜ë¶ˆ ì •ë³´
          is_cancelled: document.getElementById('editIsCancelled').value === '1' ? 1 : 0,
          refund_status: document.getElementById('editRefundStatus').value || null,
          refund_amount: parseInt(document.getElementById('editRefundAmount').value) || null,
          refund_bank: document.getElementById('editRefundBank').value || null,
          refund_account: document.getElementById('editRefundAccount').value.trim() || null,
          refund_holder: document.getElementById('editRefundHolder').value.trim() || null,
          refund_reason: document.getElementById('editRefundReason').value.trim() || null,
          // ì¢Œì„ ì •ë³´
          seat_group: document.getElementById('editSeatGroup').value.trim() || null,
          seat_row: parseInt(document.getElementById('editSeatRow').value) || null,
          seat_number: parseInt(document.getElementById('editSeatNumber').value) || null,
        };

        // seat_full ìƒì„±
        if (updateData.seat_group && updateData.seat_row && updateData.seat_number) {
          updateData.seat_full = `${updateData.seat_group}-${updateData.seat_row}-${updateData.seat_number}`;
        } else {
          updateData.seat_full = null;
        }
      }

      try {
        const response = await authFetch(`/api/admin/participants/${editingParticipantId}/full`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updateData),
        });

        const data = await response.json();
        if (!response.ok) {
          const errorMsg = data.details ? `${data.error} (${data.details})` : (data.error || 'ìˆ˜ì • ì‹¤íŒ¨');
          throw new Error(errorMsg);
        }

        if (data.success) {
          alert(editingIsGuest ? 'ë™ë°˜ì ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹ ì²­ì ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeEditModal();
          // ìºì‹œ ë¬´íš¨í™” í›„ ìƒˆë¡œê³ ì¹¨
          participantsCache = null;
          participantsCacheTime = null;
          loadParticipants(currentPage, true);
          // í™˜ë¶ˆ/ì·¨ì†Œ íƒ­ë„ ìƒˆë¡œê³ ì¹¨
          loadRefunds();
        }
      } catch (err) {
        console.error('saveParticipantEdit error:', err);
        alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (err.message || ''));
      }
    }

    // ê°œì¸ì •ë³´ ë™ì˜ í˜„í™© ë¡œë“œ
    async function loadPrivacyStats() {
      try {
        const response = await authFetch('/api/admin/participants/privacy-stats');

        if (!response.ok) {
          console.error('Failed to load privacy stats');
          return;
        }

        const data = await response.json();
        if (data.success && data.stats) {
          document.getElementById('privacyTotalCount').textContent = data.stats.total.toLocaleString();
          document.getElementById('privacyAgreedCount').textContent = data.stats.agreed.toLocaleString();
          document.getElementById('privacyPendingCount').textContent = data.stats.pending.toLocaleString();
          document.getElementById('privacyRate').textContent = data.stats.rate + '%';
        }
      } catch (err) {
        console.error('loadPrivacyStats error:', err);
      }
    }
  </script>

  <!-- ì°¸ê°€ì ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ (ì „ì²´) -->
  <div id="editParticipantModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h3 id="editModalTitle" class="text-xl font-bold text-gray-900">ì°¸ê°€ì ì •ë³´ ìˆ˜ì •</h3>
        <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- ë³¸ì¸ ì •ë³´ í•„ë“œ -->
      <div id="editMainFields" class="space-y-4 mb-4">
        <h4 class="font-semibold text-gray-700 border-b pb-2">ì‹ ì²­ì ì •ë³´</h4>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„ *</label>
            <input type="text" id="editUserName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì „í™”ë²ˆí˜¸ *</label>
            <input type="text" id="editPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="01012345678" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ìƒë…„ì›”ì¼ (6ìë¦¬)</label>
            <input type="text" id="editSsnFirst" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="YYMMDD" maxlength="6" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">í‹°ì¼“ ìˆ˜</label>
            <select id="editTicketCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
              <option value="1">1ì¸</option>
              <option value="2">2ì¸</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì…ê¸ˆ ìƒíƒœ</label>
            <select id="editIsPaid" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
              <option value="0">ì…ê¸ˆ ëŒ€ê¸°</option>
              <option value="1">ì…ê¸ˆ ì™„ë£Œ</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì²´í¬ì¸</label>
            <select id="editIsCheckedIn" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
              <option value="0">ë¯¸ì…ì¥</option>
              <option value="1">ì…ì¥ì™„ë£Œ</option>
            </select>
          </div>
        </div>
        <!-- ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬ -->
        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center justify-between">
            <div>
              <span class="text-sm font-medium text-gray-700">ë¹„ë°€ë²ˆí˜¸:</span>
              <span id="editMainPasswordDisplay" class="ml-2 text-sm text-gray-600">-</span>
            </div>
            <button type="button" onclick="resetPassword('main')" class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white text-sm rounded-lg transition-colors">
              ë¹„ë°€ë²ˆí˜¸ ë¦¬ì…‹
            </button>
          </div>
        </div>
      </div>

      <!-- ë™ë°˜ì°¸ê°€ì ì •ë³´ í•„ë“œ -->
      <div id="editGuestFields" class="hidden space-y-4 mb-4">
        <h4 class="font-semibold text-gray-700 border-b pb-2">ë™ë°˜ì°¸ê°€ì ì •ë³´</h4>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
            <input type="text" id="editGuest2Name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì „í™”ë²ˆí˜¸</label>
            <input type="text" id="editGuest2Phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="01012345678" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ìƒë…„ì›”ì¼ (6ìë¦¬)</label>
            <input type="text" id="editGuest2Ssn" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="YYMMDD" maxlength="6" />
          </div>
        </div>
        <!-- ë™ë°˜ì ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬ -->
        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center justify-between">
            <div>
              <span class="text-sm font-medium text-gray-700">ë¹„ë°€ë²ˆí˜¸:</span>
              <span id="editGuestPasswordDisplay" class="ml-2 text-sm text-gray-600">-</span>
            </div>
            <button type="button" onclick="resetPassword('guest')" class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white text-sm rounded-lg transition-colors">
              ë¹„ë°€ë²ˆí˜¸ ë¦¬ì…‹
            </button>
          </div>
        </div>
      </div>

      <!-- ì·¨ì†Œ/í™˜ë¶ˆ ì •ë³´ -->
      <div id="editCancelRefundFields" class="space-y-4 mb-4">
        <h4 class="font-semibold text-gray-700 border-b pb-2">ì·¨ì†Œ/í™˜ë¶ˆ ì •ë³´</h4>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì·¨ì†Œ ìƒíƒœ</label>
            <select id="editIsCancelled" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
              <option value="0">ì •ìƒ</option>
              <option value="1">ì·¨ì†Œë¨</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">í™˜ë¶ˆ ìƒíƒœ</label>
            <select id="editRefundStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
              <option value="">ë¯¸ì‹ ì²­</option>
              <option value="pending">í™˜ë¶ˆ ëŒ€ê¸°</option>
              <option value="completed">í™˜ë¶ˆ ì™„ë£Œ</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">í™˜ë¶ˆ ê¸ˆì•¡</label>
            <input type="number" id="editRefundAmount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="35000" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">í™˜ë¶ˆ ì€í–‰</label>
            <select id="editRefundBank" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
              <option value="">ì„ íƒ</option>
              <option value="KBêµ­ë¯¼ì€í–‰">KBêµ­ë¯¼ì€í–‰</option>
              <option value="ì‹ í•œì€í–‰">ì‹ í•œì€í–‰</option>
              <option value="ìš°ë¦¬ì€í–‰">ìš°ë¦¬ì€í–‰</option>
              <option value="í•˜ë‚˜ì€í–‰">í•˜ë‚˜ì€í–‰</option>
              <option value="NHë†í˜‘ì€í–‰">NHë†í˜‘ì€í–‰</option>
              <option value="IBKê¸°ì—…ì€í–‰">IBKê¸°ì—…ì€í–‰</option>
              <option value="ì¹´ì¹´ì˜¤ë±…í¬">ì¹´ì¹´ì˜¤ë±…í¬</option>
              <option value="í† ìŠ¤ë±…í¬">í† ìŠ¤ë±…í¬</option>
              <option value="ì¼€ì´ë±…í¬">ì¼€ì´ë±…í¬</option>
              <option value="SCì œì¼ì€í–‰">SCì œì¼ì€í–‰</option>
              <option value="ì”¨í‹°ì€í–‰">ì”¨í‹°ì€í–‰</option>
              <option value="ëŒ€êµ¬ì€í–‰">ëŒ€êµ¬ì€í–‰</option>
              <option value="ë¶€ì‚°ì€í–‰">ë¶€ì‚°ì€í–‰</option>
              <option value="ê²½ë‚¨ì€í–‰">ê²½ë‚¨ì€í–‰</option>
              <option value="ê´‘ì£¼ì€í–‰">ê´‘ì£¼ì€í–‰</option>
              <option value="ì „ë¶ì€í–‰">ì „ë¶ì€í–‰</option>
              <option value="ì œì£¼ì€í–‰">ì œì£¼ì€í–‰</option>
              <option value="ìƒˆë§ˆì„ê¸ˆê³ ">ìƒˆë§ˆì„ê¸ˆê³ </option>
              <option value="ì‹ í˜‘">ì‹ í˜‘</option>
              <option value="ìš°ì²´êµ­">ìš°ì²´êµ­</option>
              <option value="ìˆ˜í˜‘">ìˆ˜í˜‘</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ê³„ì¢Œë²ˆí˜¸</label>
            <input type="text" id="editRefundAccount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="ê³„ì¢Œë²ˆí˜¸" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì˜ˆê¸ˆì£¼</label>
            <input type="text" id="editRefundHolder" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="ì˜ˆê¸ˆì£¼ëª…" />
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">í™˜ë¶ˆ ì‚¬ìœ </label>
            <input type="text" id="editRefundReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="í™˜ë¶ˆ ì‚¬ìœ " />
          </div>
        </div>
      </div>

      <!-- ë³¸ì¸ ì¢Œì„ ì •ë³´ -->
      <div id="editMainSeatFields" class="space-y-4 mb-6">
        <h4 class="font-semibold text-gray-700 border-b pb-2">ì¢Œì„ ì •ë³´</h4>
        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì¢Œì„ ê·¸ë£¹</label>
            <input type="text" id="editSeatGroup" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="ê°€" maxlength="2" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì—´</label>
            <input type="number" id="editSeatRow" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="1" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì¢Œì„ë²ˆí˜¸</label>
            <input type="number" id="editSeatNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="1" />
          </div>
        </div>
      </div>

      <!-- ë™ë°˜ì ì¢Œì„ ì •ë³´ -->
      <div id="editGuestSeatFields" class="hidden space-y-4 mb-6">
        <h4 class="font-semibold text-gray-700 border-b pb-2">ì¢Œì„ ì •ë³´</h4>
        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì¢Œì„ ê·¸ë£¹</label>
            <input type="text" id="editSeatGroup2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="ê°€" maxlength="2" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì—´</label>
            <input type="number" id="editSeatRow2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="1" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì¢Œì„ë²ˆí˜¸</label>
            <input type="number" id="editSeatNumber2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="1" />
          </div>
        </div>
      </div>

      <div class="flex gap-3">
        <button onclick="closeEditModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
          ì·¨ì†Œ
        </button>
        <button onclick="saveParticipantEdit()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
          ì €ì¥
        </button>
      </div>
    </div>
  </div>

  <!-- í”„ë¦°íŠ¸ ì˜ì—­ (ë„¤ëª¨ë‹‰ 3x3 ìš©ì§€ìš©) -->
  <div id="printArea">
    <div class="label-content" style="text-align: center; font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;">
      <p id="printName" class="print-name"></p>
      <p id="printSeat" class="print-seat"></p>
      <hr class="print-divider" />
      <p class="print-event">í•œë™í›ˆ í† í¬ì½˜ì„œíŠ¸</p>
    </div>
  </div>

  <!-- ì°¸ê°€ì ì‹ ê·œ ë“±ë¡ ëª¨ë‹¬ -->
  <div id="addParticipantModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-gray-900">ì°¸ê°€ì ì‹ ê·œ ë“±ë¡</h2>
        <button onclick="closeAddParticipantModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <form id="addParticipantForm" class="space-y-4">
        <!-- ì‹ ì²­ì ì •ë³´ -->
        <div class="border-b pb-4">
          <h3 class="font-semibold text-gray-800 mb-3">ì‹ ì²­ì ì •ë³´</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„ <span class="text-red-500">*</span></label>
              <input type="text" id="addUserName" class="input-glass w-full" required placeholder="í™ê¸¸ë™" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ì „í™”ë²ˆí˜¸ <span class="text-red-500">*</span></label>
              <input type="tel" id="addPhone" class="input-glass w-full" required placeholder="01012345678" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ìƒë…„ì›”ì¼ <span class="text-red-500">*</span></label>
              <input type="text" id="addSsnFirst" class="input-glass w-full" required placeholder="880101" maxlength="6" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ì…ê¸ˆ ìƒíƒœ</label>
              <select id="addIsPaid" class="input-glass w-full">
                <option value="0">ì…ê¸ˆ ëŒ€ê¸°</option>
                <option value="1">ì…ê¸ˆ ì™„ë£Œ</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ë™ë°˜ì ì •ë³´ (ì„ íƒ) -->
        <div class="border-b pb-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-gray-800">ë™ë°˜ì ì •ë³´ (ì„ íƒ)</h3>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="addHasCompanion" onchange="toggleCompanionFields()" class="w-4 h-4 accent-red-600" />
              <span class="text-sm text-gray-600">ë™ë°˜ì ìˆìŒ</span>
            </label>
          </div>
          <div id="companionFields" class="hidden grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ë™ë°˜ì ì´ë¦„</label>
              <input type="text" id="addCompanionName" class="input-glass w-full" placeholder="ë™ë°˜ì ì´ë¦„" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ë™ë°˜ì ì „í™”ë²ˆí˜¸</label>
              <input type="tel" id="addCompanionPhone" class="input-glass w-full" placeholder="01098765432" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ë™ë°˜ì ìƒë…„ì›”ì¼</label>
              <input type="text" id="addCompanionSsn" class="input-glass w-full" placeholder="900202" maxlength="6" />
            </div>
          </div>
        </div>

        <!-- ì¢Œì„ ì •ë³´ (ì„ íƒ) -->
        <div class="pb-4">
          <h3 class="font-semibold text-gray-800 mb-3">ì¢Œì„ ì •ë³´ (ì„ íƒ)</h3>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ê·¸ë£¹</label>
              <input type="text" id="addSeatGroup" class="input-glass w-full" placeholder="ê°€" maxlength="2" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ì—´</label>
              <input type="number" id="addSeatRow" class="input-glass w-full" placeholder="1" min="1" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ì¢Œì„ë²ˆí˜¸</label>
              <input type="number" id="addSeatNumber" class="input-glass w-full" placeholder="1" min="1" />
            </div>
          </div>
        </div>

        <!-- ë©”ëª¨ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ê´€ë¦¬ì ë©”ëª¨</label>
          <textarea id="addAdminNote" class="input-glass w-full" rows="2" placeholder="ê´€ë¦¬ìê°€ ì°¸ê³ í•  ë©”ëª¨ (ì˜ˆ: ê´€ë¦¬ìê°€ ê°•ì œë“±ë¡í•¨)"></textarea>
        </div>

        <div class="flex gap-3 pt-4">
          <button type="button" onclick="closeAddParticipantModal()" class="flex-1 btn-secondary-glass">ì·¨ì†Œ</button>
          <button type="button" onclick="handleAddParticipantSubmit(event)" class="flex-1 btn-primary-glass" style="background: rgba(16, 185, 129, 0.9);">ë“±ë¡í•˜ê¸°</button>
        </div>
      </form>
    </div>
  </div>
</body>

</html>