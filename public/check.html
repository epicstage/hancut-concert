<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="한동훈 토크콘서트 신청내역 확인" />
  <meta name="theme-color" content="#dc2626" />
  <title>신청내역 확인 - 한동훈 토크콘서트</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#dc2626',
            'primary-dark': '#b91c1c',
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="/styles.css?v=3" />
</head>
<body>
  <div class="min-h-screen main-content">
    <!-- 헤더 -->
    <header class="glass-header">
      <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
        <a href="/" class="inline-flex items-center gap-2 text-gray-700 hover:text-gray-900" style="text-decoration: none;">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          <span>돌아가기</span>
        </a>
        <span class="text-sm text-gray-500">신청내역 확인</span>
      </div>
    </header>

    <main class="max-w-2xl mx-auto px-4 py-8">
      <!-- 전화번호 조회 폼 -->
      <div id="loginForm" class="glass-card">
        <div class="text-center mb-6">
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-900 mb-2">신청내역 확인</h2>
          <p class="text-gray-500">전화번호와 비밀번호를 입력하세요</p>
        </div>

        <form id="checkForm" class="space-y-6">
          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">전화번호</label>
            <div class="input-group">
              <input
                id="phone"
                type="tel"
                inputmode="numeric"
                autocomplete="tel"
                class="input-glass"
                placeholder="01012345678"
                maxlength="11"
                required
              />
            </div>
            <p class="input-hint">하이픈(-) 없이 11자리 숫자만 입력</p>
          </div>

          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">비밀번호</label>
            <div class="input-group">
              <input
                id="password"
                type="password"
                inputmode="numeric"
                autocomplete="current-password"
                class="input-glass"
                placeholder="생년월일 6자리 (예: 900101)"
                maxlength="6"
                required
              />
            </div>
            <p class="input-hint">초기 비밀번호는 생년월일 6자리입니다</p>
          </div>

          <div id="error" class="alert alert-error hidden">
            <svg class="alert-icon flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div class="alert-content">
              <p class="alert-message" id="errorMessage"></p>
            </div>
          </div>

          <button type="submit" class="btn-primary-glass w-full" id="submitBtn">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <span>조회하기</span>
          </button>
        </form>
      </div>

      <!-- 티켓 형태 결과 카드 -->
      <div id="resultCard" class="hidden">
        <!-- 티켓 카드 -->
        <div class="ticket-card mb-6">
          <!-- 티켓 헤더 -->
          <div class="ticket-header">
            <div class="check-icon">
              <svg id="headerIcon" class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" />
              </svg>
            </div>
            <h2 class="text-xl font-bold">한동훈 토크콘서트</h2>
            <p class="text-white/80 text-sm mt-1">2025년 12월 21일 (일)</p>
          </div>

          <!-- 티켓 바디 -->
          <div class="ticket-body">
            <!-- 참가자 정보 (표시 모드) -->
            <div id="userInfoDisplay" class="space-y-1 mb-4">
              <div class="flex items-center justify-between">
                <span id="userName" class="text-xl font-bold text-gray-900"></span>
                <button onclick="showEditUserInfo()" class="text-sm text-blue-600 hover:text-blue-800 underline">정보 수정</button>
              </div>
              <p id="userPhone" class="text-gray-500"></p>
              <p id="userSsn" class="text-gray-400 text-sm"></p>
            </div>

            <!-- 참가자 정보 (수정 모드) -->
            <div id="userInfoEdit" class="hidden mb-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
              <h4 class="font-semibold text-gray-900 mb-3">내 정보 수정</h4>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm text-gray-600 mb-1">이름</label>
                  <input id="editUserName" type="text" class="input-glass w-full bg-gray-100" disabled />
                  <p class="text-xs text-gray-400 mt-1">이름은 변경할 수 없습니다</p>
                </div>
                <div>
                  <label class="block text-sm text-gray-600 mb-1">전화번호</label>
                  <input id="editUserPhone" type="tel" inputmode="numeric" class="input-glass w-full" placeholder="01012345678" maxlength="11" />
                  <p class="text-xs text-gray-400 mt-1">하이픈(-) 없이 11자리</p>
                </div>
                <div>
                  <label class="block text-sm text-gray-600 mb-1">주민번호 앞자리 (생년월일)</label>
                  <input id="editUserSsn" type="tel" inputmode="numeric" class="input-glass w-full" placeholder="620126" maxlength="6" />
                </div>
                <div id="editUserError" class="text-sm text-red-600 hidden"></div>
                <div class="flex gap-2 pt-2">
                  <button type="button" onclick="cancelEditUserInfo()" class="btn-secondary-glass flex-1">취소</button>
                  <button type="button" onclick="saveEditUserInfo()" class="btn-primary-glass flex-1">저장</button>
                </div>
              </div>
            </div>

            <div class="ticket-divider"></div>

            <!-- 상태 정보 -->
            <div class="space-y-3">
              <div class="ticket-info-row">
                <span class="ticket-info-label">신청 유형</span>
                <span id="ticketType" class="ticket-info-value"></span>
              </div>
              <div class="ticket-info-row">
                <span class="ticket-info-label">입금 상태</span>
                <span id="paymentBadge" class="badge badge-gray"></span>
              </div>
              <div class="ticket-info-row">
                <span class="ticket-info-label">좌석 배정</span>
                <span id="seatBadge" class="badge badge-gray"></span>
              </div>
              <div id="seatInfoRow" class="ticket-info-row hidden">
                <span class="ticket-info-label">좌석 번호</span>
                <span id="seatNumber" class="text-xl font-bold text-red-600"></span>
              </div>
              <div id="seatInfo2Row" class="ticket-info-row hidden">
                <span class="ticket-info-label">동반자 좌석</span>
                <span id="seatNumber2" class="text-xl font-bold text-blue-600"></span>
              </div>
              <div class="ticket-info-row">
                <span class="ticket-info-label">신청 일시</span>
                <span id="createdAt" class="ticket-info-value text-sm"></span>
              </div>
            </div>
          </div>

          <!-- QR 코드 섹션 -->
          <div id="qrCodeSection" class="ticket-qr hidden">
            <p class="text-sm text-gray-600 mb-3">행사 당일 아래 QR코드를 제시해주세요</p>
            <!-- 본인 QR 코드 -->
            <div class="mb-4">
              <p id="qrLabel1" class="text-xs text-gray-500 mb-2 font-medium"></p>
              <div id="qrCodeContainer" class="ticket-qr-code">
                <div class="skeleton w-32 h-32"></div>
              </div>
            </div>
            <!-- 동반자 QR 코드 (2인 신청 시) -->
            <div id="qrCode2Section" class="hidden border-t border-gray-200 pt-4 mt-4">
              <p id="qrLabel2" class="text-xs text-blue-600 mb-2 font-medium"></p>
              <div id="qrCodeContainer2" class="ticket-qr-code">
                <div class="skeleton w-32 h-32"></div>
              </div>
            </div>
          </div>

          <!-- 입금 안내 (미입금 시) -->
          <div id="paymentGuide" class="hidden p-4 bg-yellow-50 border-t border-yellow-200">
            <div class="flex items-start gap-3">
              <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-lg">💰</span>
              </div>
              <div class="flex-1">
                <p class="font-semibold text-gray-900 mb-1">입금 안내</p>
                <p id="paymentAmount" class="text-lg font-bold text-red-600 mb-2"></p>
                <div class="bg-white p-3 rounded-lg border border-yellow-200 mb-2">
                  <p class="text-sm text-gray-500">국민은행</p>
                  <p class="font-bold text-gray-900">7940-0104-178355</p>
                  <p class="text-sm text-gray-600">예금주: 샘커뮤니케이션즈</p>
                </div>
                <p class="text-xs text-red-600 font-medium">
                  ⚠️ 입금 시 입금자명을 '<span id="depositName"></span>' 형식으로 입력해주세요.
                </p>
              </div>
            </div>
          </div>

          <!-- 티켓 액션 버튼 -->
          <div class="ticket-actions">
            <button onclick="addToCalendar()" class="btn-secondary-glass" id="calendarBtn">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <span>캘린더 추가</span>
            </button>
            <button onclick="shareTicket()" class="btn-secondary-glass" id="shareBtn">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
              </svg>
              <span>공유하기</span>
            </button>
          </div>
        </div>

        <!-- 2번째 참가자 정보 섹션 -->
        <div id="guest2Section" class="glass-card hidden mb-6">
          <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
            </svg>
            <span>동반 참가자 정보</span>
          </h3>

          <!-- 입력 폼 -->
          <div id="guest2Form" class="space-y-4">
            <div class="alert alert-info mb-4">
              <svg class="alert-icon flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div class="alert-content">
                <p class="alert-message">2인 신청이므로 동반 참가자 정보를 입력해주세요. 각각 별도의 QR코드가 발급됩니다.</p>
              </div>
            </div>

            <div>
              <label for="guest2Name" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-red-500">*</span> 이름
              </label>
              <input
                id="guest2Name"
                type="text"
                class="input-glass"
                placeholder="동반자 이름"
              />
            </div>

            <div>
              <label for="guest2Phone" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-red-500">*</span> 전화번호
              </label>
              <input
                id="guest2Phone"
                type="tel"
                inputmode="numeric"
                class="input-glass"
                placeholder="01012345678"
                maxlength="11"
              />
              <p class="input-hint">하이픈(-) 없이 11자리 숫자만 입력</p>
            </div>

            <div>
              <label for="guest2SsnFirst" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-red-500">*</span> 주민번호 앞자리
              </label>
              <input
                id="guest2SsnFirst"
                type="tel"
                inputmode="numeric"
                autocomplete="bday"
                class="input-glass"
                placeholder="620126"
                maxlength="6"
              />
              <p class="input-hint">생년월일 6자리 (YYMMDD)</p>
            </div>

            <div id="guest2Error" class="alert alert-error hidden">
              <svg class="alert-icon flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <div class="alert-content">
                <p class="alert-message" id="guest2ErrorMessage"></p>
              </div>
            </div>

            <button id="saveGuest2Btn" class="btn-primary-glass w-full">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              <span>동반자 정보 저장</span>
            </button>
          </div>

          <!-- 저장된 정보 표시 -->
          <div id="guest2Info" class="hidden">
            <div class="p-4 bg-green-50 rounded-xl border border-green-200">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  <span class="font-semibold text-green-800">동반자 정보 등록 완료</span>
                </div>
                <button
                  id="editGuest2Btn"
                  onclick="toggleEditGuest2()"
                  class="text-sm text-blue-600 hover:text-blue-700 font-medium"
                >
                  수정
                </button>
              </div>
              <div id="guest2DisplayInfo" class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-500">이름</span>
                  <span id="guest2NameDisplay" class="font-medium text-gray-900"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-500">전화번호</span>
                  <span id="guest2PhoneDisplay" class="font-medium text-gray-900"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-500">생년월일</span>
                  <span id="guest2SsnFirstDisplay" class="font-medium text-gray-900"></span>
                </div>
              </div>
              <!-- 수정 폼 (숨김) -->
              <div id="guest2EditForm" class="hidden mt-4 pt-4 border-t border-green-200 space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">전화번호</label>
                  <input type="tel" id="editGuest2Phone" class="input-glass w-full" placeholder="01012345678" maxlength="11" inputmode="numeric" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">생년월일 (6자리)</label>
                  <input type="tel" id="editGuest2Ssn" class="input-glass w-full" placeholder="YYMMDD" maxlength="6" inputmode="numeric" />
                </div>
                <div id="editGuest2Error" class="text-sm text-red-600 hidden"></div>
                <div class="flex gap-2">
                  <button type="button" onclick="cancelEditGuest2()" class="btn-secondary-glass flex-1">취소</button>
                  <button type="button" onclick="saveEditGuest2()" class="btn-primary-glass flex-1">저장</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 비밀번호 변경 섹션 -->
        <div id="passwordSection" class="glass-card mb-6 hidden">
          <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
            </svg>
            <span>비밀번호 변경</span>
          </h3>
          <div id="passwordChangeForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">현재 비밀번호</label>
              <input type="password" id="currentPassword" class="input-glass w-full" placeholder="현재 비밀번호 6자리" maxlength="6" inputmode="numeric" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">새 비밀번호</label>
              <input type="password" id="newPassword" class="input-glass w-full" placeholder="새 비밀번호 6자리" maxlength="6" inputmode="numeric" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">새 비밀번호 확인</label>
              <input type="password" id="confirmPassword" class="input-glass w-full" placeholder="새 비밀번호 확인" maxlength="6" inputmode="numeric" />
            </div>
            <div id="passwordError" class="hidden text-sm text-red-600"></div>
            <div id="passwordSuccess" class="hidden text-sm text-green-600"></div>
            <button onclick="changePassword()" class="w-full py-3 px-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
              </svg>
              <span>비밀번호 변경</span>
            </button>
          </div>
        </div>

        <!-- 취소 및 환불 섹션 -->
        <div id="cancelSection" class="glass-card mb-6 hidden">
          <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span>신청 취소 / 환불</span>
          </h3>

          <!-- 이미 취소된 경우 -->
          <div id="alreadyCancelled" class="hidden p-4 bg-gray-100 rounded-xl border border-gray-300">
            <div class="flex items-center gap-2 text-gray-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
              <span class="font-medium">이미 취소된 신청입니다.</span>
            </div>
            <p id="cancelledInfo" class="text-sm text-gray-500 mt-2"></p>
            <p id="cancelledRefundNotice" class="hidden text-sm text-blue-600 mt-2 font-medium">※ 이미 입금하신 경우 아래 환불신청도 완료해주세요.</p>
          </div>

          <!-- 취소 옵션 -->
          <div id="cancelOptions" class="space-y-4">
            <!-- 전체 취소 버튼 -->
            <div id="cancelFullOption" class="p-4 bg-red-50 rounded-xl border border-red-200">
              <p id="cancelFullDesc" class="text-sm text-gray-700 mb-3">신청을 취소하시겠습니까?</p>
              <button onclick="showCancelModal('full')" class="w-full py-3 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                <span id="cancelFullBtnText">참가신청 취소</span>
              </button>
            </div>

            <!-- 동반자만 취소 (2인 신청인 경우만 표시) -->
            <div id="cancelGuest2Only" class="hidden p-4 bg-orange-50 rounded-xl border border-orange-200">
              <p class="text-sm text-gray-700 mb-2">동반자만 취소하고 1인 신청으로 변경하시겠습니까?</p>
              <p class="text-xs text-orange-700 mb-3">※ 동반자 명의 변경은 불가하며, 최초 신청한 동반자가 불참시 취소하셔야 합니다.</p>
              <button onclick="showCancelModal('guest2')" class="w-full py-3 px-4 bg-orange-600 hover:bg-orange-700 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6" />
                </svg>
                <span>동반자만 취소 (2인→1인)</span>
              </button>
            </div>
          </div>
        </div>

        <!-- 중복입금 / 환불 계좌 섹션 -->
        <div id="refundSection" class="glass-card mb-6 hidden">
          <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
            <span>중복입금 / 환불 신청</span>
          </h3>

          <!-- 환불 대기 중인 경우 -->
          <div id="refundPending" class="hidden p-4 bg-yellow-50 rounded-xl border border-yellow-200">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2 text-yellow-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="font-medium">환불 처리 대기 중</span>
              </div>
              <button onclick="showRefundEditForm()" id="refundEditBtn" class="text-sm text-blue-600 hover:text-blue-800 underline">
                정보 수정
              </button>
            </div>
            <div id="refundPendingInfo" class="text-sm text-gray-600 space-y-1"></div>

            <!-- 환불 정보 수정 폼 -->
            <div id="refundEditForm" class="hidden mt-4 pt-4 border-t border-yellow-200 space-y-3">
              <p class="text-sm font-medium text-gray-700 mb-2">환불 계좌 정보 수정</p>
              <div>
                <label class="block text-xs text-gray-600 mb-1">환불 은행</label>
                <select id="editRefundBank" class="input-glass text-sm py-2">
                  <option value="">은행 선택</option>
                  <option value="KB국민은행">KB국민은행</option>
                  <option value="신한은행">신한은행</option>
                  <option value="우리은행">우리은행</option>
                  <option value="하나은행">하나은행</option>
                  <option value="NH농협은행">NH농협은행</option>
                  <option value="IBK기업은행">IBK기업은행</option>
                  <option value="카카오뱅크">카카오뱅크</option>
                  <option value="토스뱅크">토스뱅크</option>
                  <option value="케이뱅크">케이뱅크</option>
                  <option value="SC제일은행">SC제일은행</option>
                  <option value="씨티은행">씨티은행</option>
                  <option value="대구은행">대구은행</option>
                  <option value="부산은행">부산은행</option>
                  <option value="경남은행">경남은행</option>
                  <option value="광주은행">광주은행</option>
                  <option value="전북은행">전북은행</option>
                  <option value="제주은행">제주은행</option>
                  <option value="새마을금고">새마을금고</option>
                  <option value="신협">신협</option>
                  <option value="우체국">우체국</option>
                  <option value="수협">수협</option>
                </select>
              </div>
              <div>
                <label class="block text-xs text-gray-600 mb-1">계좌번호</label>
                <input type="text" id="editRefundAccount" class="input-glass text-sm py-2" placeholder="- 없이 숫자만 입력" />
              </div>
              <div>
                <label class="block text-xs text-gray-600 mb-1">예금주</label>
                <input type="text" id="editRefundHolder" class="input-glass text-sm py-2" placeholder="예금주명" />
              </div>
              <div id="refundEditError" class="hidden text-sm text-red-600"></div>
              <div class="flex gap-2">
                <button onclick="cancelRefundEdit()" class="flex-1 btn-secondary-glass text-sm py-2">취소</button>
                <button onclick="saveRefundEdit()" class="flex-1 btn-primary-glass text-sm py-2">저장</button>
              </div>
            </div>
          </div>

          <!-- 환불 완료된 경우 -->
          <div id="refundCompleted" class="hidden p-4 bg-green-50 rounded-xl border border-green-200">
            <div class="flex items-center gap-2 text-green-700 mb-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              <span class="font-medium">환불 완료</span>
            </div>
            <div id="refundCompletedInfo" class="text-sm text-gray-600"></div>
          </div>

          <!-- 환불 신청 폼 -->
          <div id="refundForm" class="space-y-4">
            <div class="alert alert-info mb-4">
              <svg class="alert-icon flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div class="alert-content">
                <p class="alert-message">중복 입금하셨거나 환불이 필요한 경우 아래 정보를 입력해주세요.</p>
              </div>
            </div>

            <div>
              <label for="refundAmount" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-red-500">*</span> 환불 요청 금액
              </label>
              <div class="relative">
                <input
                  id="refundAmount"
                  type="tel"
                  inputmode="numeric"
                  class="input-glass pr-12"
                  placeholder="35000"
                />
                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500">원</span>
              </div>
              <p class="input-hint">중복 입금된 금액 또는 환불받을 금액</p>
            </div>

            <div>
              <label for="refundBank" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-red-500">*</span> 환불 은행
              </label>
              <select id="refundBank" class="input-glass">
                <option value="">은행 선택</option>
                <option value="국민은행">국민은행</option>
                <option value="신한은행">신한은행</option>
                <option value="우리은행">우리은행</option>
                <option value="하나은행">하나은행</option>
                <option value="농협은행">농협은행</option>
                <option value="기업은행">기업은행</option>
                <option value="SC제일은행">SC제일은행</option>
                <option value="카카오뱅크">카카오뱅크</option>
                <option value="토스뱅크">토스뱅크</option>
                <option value="케이뱅크">케이뱅크</option>
                <option value="우체국">우체국</option>
                <option value="새마을금고">새마을금고</option>
                <option value="수협">수협</option>
                <option value="신협">신협</option>
                <option value="대구은행">대구은행</option>
                <option value="부산은행">부산은행</option>
                <option value="경남은행">경남은행</option>
                <option value="광주은행">광주은행</option>
                <option value="전북은행">전북은행</option>
                <option value="제주은행">제주은행</option>
              </select>
            </div>

            <div>
              <label for="refundAccount" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-red-500">*</span> 환불 계좌번호
              </label>
              <input
                id="refundAccount"
                type="tel"
                inputmode="numeric"
                class="input-glass"
                placeholder="계좌번호 (숫자만 입력)"
              />
            </div>

            <div>
              <label for="refundHolder" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-red-500">*</span> 예금주
              </label>
              <input
                id="refundHolder"
                type="text"
                class="input-glass"
                placeholder="예금주 이름"
              />
            </div>

            <div>
              <label for="refundReason" class="block text-sm font-medium text-gray-700 mb-2">
                환불 사유 (선택)
              </label>
              <textarea
                id="refundReason"
                class="input-glass"
                rows="3"
                placeholder="예: 35,000원 2회 입금하여 1회분 환불 요청합니다."
              ></textarea>
              <p class="input-hint">중복입금 상황이나 환불 사유를 자세히 기입해주세요</p>
            </div>

            <div id="refundError" class="alert alert-error hidden">
              <svg class="alert-icon flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <div class="alert-content">
                <p class="alert-message" id="refundErrorMessage"></p>
              </div>
            </div>

            <button id="submitRefundBtn" onclick="submitRefundRequest()" class="btn-primary-glass w-full">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              <span>환불 신청하기</span>
            </button>
          </div>
        </div>

        <!-- 다른 번호로 조회 -->
        <button onclick="resetForm()" class="btn-secondary-glass w-full">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <span>다른 번호로 조회하기</span>
        </button>
      </div>

      <!-- 취소 확인 모달 -->
      <div id="cancelModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/50">
        <div class="bg-white rounded-2xl max-w-md w-full p-6 shadow-xl">
          <h3 id="cancelModalTitle" class="text-xl font-bold text-gray-900 mb-4"></h3>
          <p id="cancelModalMessage" class="text-gray-600 mb-6"></p>

          <!-- 환불 계좌 입력 (입금완료자만) -->
          <div id="cancelRefundFields" class="hidden space-y-4 mb-6 p-4 bg-gray-50 rounded-xl">
            <p class="text-sm font-medium text-gray-700">환불받을 계좌 정보를 입력해주세요</p>
            <div>
              <label class="block text-sm text-gray-600 mb-1">환불 은행</label>
              <select id="cancelRefundBank" class="input-glass w-full text-sm">
                <option value="">은행 선택</option>
                <option value="국민은행">국민은행</option>
                <option value="신한은행">신한은행</option>
                <option value="우리은행">우리은행</option>
                <option value="하나은행">하나은행</option>
                <option value="농협은행">농협은행</option>
                <option value="기업은행">기업은행</option>
                <option value="SC제일은행">SC제일은행</option>
                <option value="카카오뱅크">카카오뱅크</option>
                <option value="토스뱅크">토스뱅크</option>
                <option value="케이뱅크">케이뱅크</option>
                <option value="우체국">우체국</option>
                <option value="새마을금고">새마을금고</option>
                <option value="수협">수협</option>
                <option value="신협">신협</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">계좌번호</label>
              <input id="cancelRefundAccount" type="tel" inputmode="numeric" class="input-glass w-full text-sm" placeholder="숫자만 입력" />
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">예금주</label>
              <input id="cancelRefundHolder" type="text" class="input-glass w-full text-sm" placeholder="예금주 이름" />
            </div>
          </div>

          <div id="cancelModalError" class="text-sm text-red-600 mb-4 hidden"></div>

          <div class="flex gap-3">
            <button onclick="closeCancelModal()" class="flex-1 py-3 px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-xl transition-colors">
              취소
            </button>
            <button id="confirmCancelBtn" onclick="confirmCancel()" class="flex-1 py-3 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-colors">
              확인
            </button>
          </div>
        </div>
      </div>

      <!-- 개인정보 수집 동의 모달 -->
      <div id="privacyModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/50">
        <div class="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto shadow-xl">
          <div class="p-6">
            <div class="text-center mb-4">
              <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
              </div>
              <h3 class="text-xl font-bold text-gray-900">개인정보 수집 및 이용 동의</h3>
            </div>

            <div class="bg-gray-50 rounded-xl p-4 mb-4 text-sm text-gray-700 max-h-60 overflow-y-auto">
              <p class="font-semibold mb-2">1. 수집하는 개인정보 항목</p>
              <p class="mb-3">- 필수항목: 성명, 연락처(휴대전화번호), 생년월일</p>

              <p class="font-semibold mb-2">2. 개인정보의 수집 및 이용 목적</p>
              <p class="mb-3">- 한동훈 토크콘서트 참가 신청 및 본인 확인<br>
              - 입장 시 본인확인 및 좌석 배정<br>
              - 행사 관련 공지사항 안내</p>

              <p class="font-semibold mb-2">3. 개인정보의 보유 및 이용 기간</p>
              <p class="mb-3">- 행사 종료 후 1개월 이내 파기<br>
              - 단, 관련 법령에 따라 보존이 필요한 경우 해당 기간 동안 보관</p>

              <p class="font-semibold mb-2">4. 동의 거부권 및 불이익</p>
              <p>- 귀하는 개인정보 수집 및 이용에 대한 동의를 거부할 권리가 있습니다.<br>
              - 다만, 동의를 거부할 경우 행사 참가가 제한될 수 있습니다.</p>
            </div>

            <label class="flex items-center gap-3 p-4 bg-blue-50 rounded-xl cursor-pointer mb-4">
              <input type="checkbox" id="privacyAgreeCheck" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500" />
              <span class="text-gray-900 font-medium">위 개인정보 수집 및 이용에 동의합니다.</span>
            </label>

            <div id="privacyError" class="text-sm text-red-600 mb-4 hidden">동의에 체크해주세요.</div>

            <button onclick="submitPrivacyAgree()" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              <span>동의하고 계속하기</span>
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- 푸터 -->
    <footer class="mt-12 py-8 border-t border-gray-200">
      <div class="max-w-4xl mx-auto px-4 text-center text-sm text-gray-500">
        <p>© 2025 샘커뮤니케이션즈. All rights reserved.</p>
      </div>
    </footer>

    <!-- 토스트 컨테이너 -->
    <div id="toastContainer" class="toast-container"></div>
  </div>

  <!-- 바텀 네비게이션 (모바일) -->
  <nav class="bottom-nav">
    <a href="/" class="bottom-nav-item" aria-label="홈">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
      </svg>
      <span>홈</span>
    </a>
    <a href="/apply.html" class="bottom-nav-item" aria-label="신청">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
      </svg>
      <span>신청</span>
    </a>
    <a href="/check.html" class="bottom-nav-item active" aria-label="확인">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
      </svg>
      <span>확인</span>
    </a>
    <a href="/inquiry.html" class="bottom-nav-item" aria-label="문의">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-4l-4 4z" />
      </svg>
      <span>문의</span>
    </a>
    <a href="/story.html" class="bottom-nav-item" aria-label="사연" style="color: #ea580c;">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
      </svg>
      <span>사연</span>
    </a>
  </nav>

  <script>
    let currentParticipant = null;

    // 정보수정 마감 시간 체크 (2025년 12월 8일 오후 6시 3분 KST)
    function isEditDeadlinePassed() {
      // KST 기준 마감 시간: 2025-12-08 18:03:00
      const deadline = new Date('2025-12-08T18:03:00+09:00');
      const now = new Date();
      return now >= deadline;
    }

    // DOM 요소
    const phoneInput = document.getElementById('phone');
    const form = document.getElementById('checkForm');
    const loginForm = document.getElementById('loginForm');
    const resultCard = document.getElementById('resultCard');
    const errorDiv = document.getElementById('error');
    const submitBtn = document.getElementById('submitBtn');

    // 초기화
    document.addEventListener('DOMContentLoaded', function() {
      // 전화번호 숫자만 입력
      setupNumericInput(phoneInput, 11);

      // 폼 제출
      form.addEventListener('submit', handleSubmit);

      // 2번째 참가자 입력 설정
      setupGuest2Form();
    });

    // 숫자 입력 설정
    function setupNumericInput(input, maxLength) {
      if (!input) return;

      input.addEventListener('keydown', (e) => {
        const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End'];
        if (allowedKeys.includes(e.key)) return;
        if (!/^[0-9]$/.test(e.key)) {
          e.preventDefault();
          return;
        }
        if (input.value.length >= maxLength) {
          e.preventDefault();
        }
      });

      input.addEventListener('input', (e) => {
        const value = e.target.value.replace(/[^0-9]/g, '');
        input.value = value.slice(0, maxLength);
      });
    }

    // 전화번호 포맷
    function formatPhone(value) {
      if (!value) return '';
      const numbers = value.replace(/[^0-9]/g, '');
      if (numbers.length <= 3) return numbers;
      if (numbers.length <= 7) return `${numbers.slice(0, 3)}-${numbers.slice(3)}`;
      return `${numbers.slice(0, 3)}-${numbers.slice(3, 7)}-${numbers.slice(7, 11)}`;
    }

    // 주민번호 앞자리 포맷 (YYMMDD -> YY.MM.DD)
    function formatSsnFirst(value) {
      if (!value) return '';
      const numbers = value.replace(/[^0-9]/g, '');
      if (numbers.length !== 6) return numbers;
      return `${numbers.slice(0, 2)}.${numbers.slice(2, 4)}.${numbers.slice(4, 6)}`;
    }

    // 폼 제출 처리
    async function handleSubmit(e) {
      e.preventDefault();
      hideError();

      const phone = phoneInput.value.replace(/[^0-9]/g, '');

      if (phone.length !== 11) {
        showError('전화번호를 정확히 입력해주세요. (11자리)');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML = `
        <div class="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>
        <span>조회 중...</span>
      `;

      const password = document.getElementById('password').value.trim();

      if (!password) {
        showError('비밀번호를 입력해주세요.');
        showToast('비밀번호를 입력해주세요.', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <span>조회하기</span>
        `;
        return;
      }

      try {
        // 타임아웃 설정 (30초)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);

        const response = await fetch('/api/participants/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ phone, password }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || '조회 중 오류가 발생했습니다.');
        }

        currentParticipant = data.participant;
        // 동반참가자인 경우 표시
        if (data.isGuest) {
          currentParticipant._isGuest = true;
          currentParticipant._guestInfo = data.guestInfo;
        }

        // 개인정보 동의 여부 확인
        const needsPrivacyAgree = data.isGuest
          ? !data.participant.guest2_privacy_agreed
          : !data.participant.privacy_agreed;

        if (needsPrivacyAgree) {
          // 동의 필요 시 팝업 표시
          showPrivacyModal();
        } else {
          // 이미 동의한 경우 바로 결과 표시
          displayResult(data.participant, data.isGuest, data.guestInfo);
        }
      } catch (err) {
        console.error('Fetch error:', err);
        
        let errorMessage = '조회 중 오류가 발생했습니다.';
        if (err.name === 'AbortError') {
          errorMessage = '요청 시간이 초과되었습니다. 네트워크 연결을 확인하고 다시 시도해주세요.';
        } else if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
          errorMessage = '네트워크 연결을 확인하고 다시 시도해주세요.';
        } else if (err.message) {
          errorMessage = err.message;
        }
        
        showError(errorMessage);
        showToast(errorMessage, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <span>조회하기</span>
        `;
      }
    }

    // 결과 표시
    function displayResult(participant, isGuest = false, guestInfo = null) {
      // 동반참가자인 경우 전용 정보 표시
      if (isGuest && guestInfo) {
        displayGuestResult(participant, guestInfo);
        return;
      }

      // 기본 정보
      document.getElementById('userName').textContent = participant.user_name;
      document.getElementById('userPhone').textContent = formatPhone(participant.phone);
      document.getElementById('userSsn').textContent = participant.ssn_first ? `생년월일: ${formatSsnFirst(participant.ssn_first)}` : '';

      // 수정 모드 초기화
      document.getElementById('userInfoDisplay').classList.remove('hidden');
      document.getElementById('userInfoEdit').classList.add('hidden');

      // 마감 시간이 지났으면 정보수정 버튼 숨기기
      const editUserInfoBtn = document.querySelector('#userInfoDisplay button[onclick="showEditUserInfo()"]');
      if (editUserInfoBtn) {
        if (isEditDeadlinePassed()) {
          editUserInfoBtn.style.display = 'none';
        } else {
          editUserInfoBtn.style.display = '';
        }
      }

      // 신청 유형
      const ticketCount = participant.ticket_count || 1;
      const isTwoPerson = ticketCount === 2 || participant.guest2_name;
      document.getElementById('ticketType').textContent = isTwoPerson ? '2인 신청' : '1인 신청';

      // 입금 상태
      const paymentBadge = document.getElementById('paymentBadge');
      if (participant.is_paid) {
        paymentBadge.className = 'badge badge-green';
        paymentBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-600"></span> 입금 완료';
      } else {
        paymentBadge.className = 'badge badge-yellow';
        paymentBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-yellow-600 animate-pulse"></span> 입금 대기';
      }

      // 좌석 배정
      const seatBadge = document.getElementById('seatBadge');
      const seatInfoRow = document.getElementById('seatInfoRow');
      const seatInfo2Row = document.getElementById('seatInfo2Row');

      if (participant.seat_full) {
        seatBadge.className = 'badge badge-green';
        seatBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-600"></span> 배정 완료';
        seatInfoRow.classList.remove('hidden');
        document.getElementById('seatNumber').textContent = participant.seat_full;

        // 동반자 좌석 표시 (2인 신청 시)
        if (isTwoPerson && participant.seat_full_2) {
          seatInfo2Row.classList.remove('hidden');
          document.getElementById('seatNumber2').textContent = participant.seat_full_2;
        } else {
          seatInfo2Row.classList.add('hidden');
        }
      } else {
        seatBadge.className = 'badge badge-gray';
        seatBadge.innerHTML = '배정 대기';
        seatInfoRow.classList.add('hidden');
        seatInfo2Row.classList.add('hidden');
      }

      // 신청 일시
      if (participant.created_at) {
        const date = new Date(participant.created_at.replace(' ', 'T'));
        document.getElementById('createdAt').textContent = date.toLocaleString('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false,
          timeZone: 'Asia/Seoul'
        });
      }

      // 입금 안내 (미입금 시)
      const paymentGuide = document.getElementById('paymentGuide');
      if (!participant.is_paid) {
        paymentGuide.classList.remove('hidden');
        const amount = isTwoPerson ? '₩70,000' : '₩35,000';
        document.getElementById('paymentAmount').textContent = amount;
        const phoneLast4 = participant.phone.slice(-4);
        document.getElementById('depositName').textContent = `${participant.user_name}${phoneLast4}`;
      } else {
        paymentGuide.classList.add('hidden');
      }

      // QR 코드 (입금 완료 시)
      const qrCodeSection = document.getElementById('qrCodeSection');
      if (participant.is_paid) {
        qrCodeSection.classList.remove('hidden');
        generateQRCode(participant);
      } else {
        qrCodeSection.classList.add('hidden');
      }

      // 2번째 참가자 섹션
      const guest2Section = document.getElementById('guest2Section');
      const guest2Form = document.getElementById('guest2Form');
      const guest2Info = document.getElementById('guest2Info');

      if (isTwoPerson) {
        guest2Section.classList.remove('hidden');

        // 동반자 정보가 등록된 경우: is_guest2_completed=1 이거나 guest2_name이 있는 경우
        const isGuest2Registered = participant.is_guest2_completed || participant.guest2_name;

        if (isGuest2Registered) {
          guest2Form.classList.add('hidden');
          guest2Info.classList.remove('hidden');
          document.getElementById('guest2NameDisplay').textContent = participant.guest2_name || '(이름 미입력)';
          document.getElementById('guest2PhoneDisplay').textContent = formatPhone(participant.guest2_phone || '') || '-';
          document.getElementById('guest2SsnFirstDisplay').textContent = participant.guest2_ssn_first || '-';

          // 마감 시간이 지났으면 동반자 정보 수정 버튼 숨기기
          const editGuest2Btn = document.getElementById('editGuest2Btn');
          if (editGuest2Btn) {
            if (isEditDeadlinePassed()) {
              editGuest2Btn.style.display = 'none';
            } else {
              editGuest2Btn.style.display = '';
            }
          }
        } else {
          // 동반자 정보 미등록 상태 - 마감 시간 상관없이 등록 가능
          guest2Form.classList.remove('hidden');
          guest2Info.classList.add('hidden');
        }
      } else {
        guest2Section.classList.add('hidden');
      }

      // 취소/환불 섹션 표시
      displayCancelRefundSection(participant, false);

      // 비밀번호 변경 섹션 표시 (취소되지 않은 경우만)
      const passwordSection = document.getElementById('passwordSection');
      if (!participant.is_cancelled) {
        passwordSection.classList.remove('hidden');
      } else {
        passwordSection.classList.add('hidden');
      }

      // 화면 전환
      loginForm.classList.add('hidden');
      resultCard.classList.remove('hidden');

      // 스크롤 상단
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // QR 코드 생성
    function generateQRCode(participant) {
      const qrCodeContainer = document.getElementById('qrCodeContainer');
      const qrCode2Section = document.getElementById('qrCode2Section');
      const qrCodeContainer2 = document.getElementById('qrCodeContainer2');
      const qrLabel1 = document.getElementById('qrLabel1');
      const qrLabel2 = document.getElementById('qrLabel2');

      const ticketCount = participant.ticket_count || 1;
      const isTwoPerson = ticketCount === 2 || participant.guest2_name;

      // 본인 QR 데이터 - 간결하게 (id와 type만으로 체크인 가능)
      const qrData1 = JSON.stringify({
        i: participant.id,
        t: 'm'  // main
      });

      // 2인 신청 시 라벨 표시
      if (isTwoPerson) {
        qrLabel1.textContent = `본인: ${participant.user_name}`;
      } else {
        qrLabel1.textContent = '';
      }

      qrCodeContainer.innerHTML = '<div class="skeleton w-32 h-32"></div>';

      // QR 라이브러리 로드
      loadQRCodeLibrary()
        .then(() => {
          // 본인 QR 코드 생성
          qrCodeContainer.innerHTML = '';
          new QRCode(qrCodeContainer, {
            text: qrData1,
            width: 180,
            height: 180,
            colorDark: '#000000',
            colorLight: '#FFFFFF',
            correctLevel: QRCode.CorrectLevel.M  // Medium 레벨로 변경 (더 많은 데이터 허용)
          });

          // 2인 신청 시 동반자 QR 코드 생성
          if (isTwoPerson && participant.guest2_name && participant.is_guest2_completed) {
            qrCode2Section.classList.remove('hidden');
            qrLabel2.textContent = `동반자: ${participant.guest2_name}`;

            // 동반자 QR 데이터 - 간결하게
            const qrData2 = JSON.stringify({
              i: participant.id,
              t: 'g'  // guest
            });

            qrCodeContainer2.innerHTML = '';
            new QRCode(qrCodeContainer2, {
              text: qrData2,
              width: 180,
              height: 180,
              colorDark: '#1e40af',  // 파란색으로 동반자 구분
              colorLight: '#FFFFFF',
              correctLevel: QRCode.CorrectLevel.M
            });
          } else {
            qrCode2Section.classList.add('hidden');
          }
        })
        .catch(err => {
          console.error('QR 코드 생성 실패:', err);
          qrCodeContainer.innerHTML = '<p class="text-red-600 text-sm">QR 코드 생성 실패</p>';
        });
    }

    // QR 라이브러리 로드
    function loadQRCodeLibrary() {
      return new Promise((resolve, reject) => {
        if (typeof QRCode !== 'undefined') {
          resolve();
          return;
        }

        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
        script.onload = resolve;
        script.onerror = () => reject(new Error('Failed to load QRCode library'));
        document.head.appendChild(script);
      });
    }

    // 동반참가자 전용 결과 표시
    function displayGuestResult(participant, guestInfo) {
      // 동반참가자 정보로 표시
      document.getElementById('userName').textContent = guestInfo.name + ' (동반참가자)';
      document.getElementById('userPhone').textContent = formatPhone(guestInfo.phone);

      // 신청 유형
      document.getElementById('ticketType').textContent = '2인 신청 (동반참가자)';

      // 입금 상태
      const paymentBadge = document.getElementById('paymentBadge');
      if (participant.is_paid) {
        paymentBadge.className = 'badge badge-green';
        paymentBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-600"></span> 입금 완료';
      } else {
        paymentBadge.className = 'badge badge-yellow';
        paymentBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-yellow-600 animate-pulse"></span> 입금 대기';
      }

      // 좌석 배정 (동반참가자 좌석만 표시)
      const seatBadge = document.getElementById('seatBadge');
      const seatInfoRow = document.getElementById('seatInfoRow');
      const seatInfo2Row = document.getElementById('seatInfo2Row');

      if (guestInfo.seat) {
        seatBadge.className = 'badge badge-green';
        seatBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-600"></span> 배정 완료';
        seatInfoRow.classList.remove('hidden');
        document.getElementById('seatNumber').textContent = guestInfo.seat;
        seatInfo2Row.classList.add('hidden'); // 동반참가자는 본인 좌석만 표시
      } else {
        seatBadge.className = 'badge badge-gray';
        seatBadge.innerHTML = '배정 대기';
        seatInfoRow.classList.add('hidden');
        seatInfo2Row.classList.add('hidden');
      }

      // 신청 일시 (원 신청자의 신청일시)
      if (participant.created_at) {
        const date = new Date(participant.created_at.replace(' ', 'T'));
        document.getElementById('createdAt').textContent = date.toLocaleString('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false,
          timeZone: 'Asia/Seoul'
        });
      }

      // 입금 안내 - 동반참가자는 입금 안내 표시하지 않음 (주 신청자가 입금)
      const paymentGuide = document.getElementById('paymentGuide');
      paymentGuide.classList.add('hidden');

      // QR 코드 (입금 완료 시) - 동반참가자용 QR만 생성
      const qrCodeSection = document.getElementById('qrCodeSection');
      if (participant.is_paid) {
        qrCodeSection.classList.remove('hidden');
        generateGuestQRCode(participant, guestInfo);
      } else {
        qrCodeSection.classList.add('hidden');
      }

      // 2번째 참가자 섹션 숨기기 (동반참가자 본인이므로)
      document.getElementById('guest2Section').classList.add('hidden');

      // 취소/환불 섹션 숨기기 (동반참가자는 취소할 수 없음)
      displayCancelRefundSection(participant, true);

      // 비밀번호 변경 섹션 표시 (동반참가자도 변경 가능)
      const passwordSection = document.getElementById('passwordSection');
      if (!participant.is_cancelled) {
        passwordSection.classList.remove('hidden');
      } else {
        passwordSection.classList.add('hidden');
      }

      // 화면 전환
      loginForm.classList.add('hidden');
      resultCard.classList.remove('hidden');

      // 스크롤 상단
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 동반참가자용 QR 코드 생성
    function generateGuestQRCode(participant, guestInfo) {
      const qrCodeContainer = document.getElementById('qrCodeContainer');
      const qrCode2Section = document.getElementById('qrCode2Section');
      const qrLabel1 = document.getElementById('qrLabel1');

      // 동반참가자 QR 데이터
      const qrData = JSON.stringify({
        i: participant.id,
        t: 'g'  // guest
      });

      qrLabel1.textContent = `동반참가자: ${guestInfo.name}`;

      // 2번째 QR 섹션 숨기기
      qrCode2Section.classList.add('hidden');

      qrCodeContainer.innerHTML = '<div class="skeleton w-32 h-32"></div>';

      // QR 라이브러리 로드
      loadQRCodeLibrary()
        .then(() => {
          qrCodeContainer.innerHTML = '';
          new QRCode(qrCodeContainer, {
            text: qrData,
            width: 180,
            height: 180,
            colorDark: '#1e40af',  // 파란색으로 동반자 구분
            colorLight: '#FFFFFF',
            correctLevel: QRCode.CorrectLevel.M
          });
        })
        .catch(err => {
          console.error('QR 코드 생성 실패:', err);
          qrCodeContainer.innerHTML = '<p class="text-red-600 text-sm">QR 코드 생성 실패</p>';
        });
    }

    // 2번째 참가자 폼 설정
    function setupGuest2Form() {
      const guest2PhoneInput = document.getElementById('guest2Phone');
      const guest2SsnFirstInput = document.getElementById('guest2SsnFirst');
      const saveGuest2Btn = document.getElementById('saveGuest2Btn');

      setupNumericInput(guest2PhoneInput, 11);
      setupNumericInput(guest2SsnFirstInput, 6);

      saveGuest2Btn?.addEventListener('click', async () => {
        // 동반자 정보 첫 등록은 마감 시간 상관없이 허용

        const guest2Name = document.getElementById('guest2Name').value.trim();
        const guest2Phone = document.getElementById('guest2Phone').value.replace(/[^0-9]/g, '');
        const guest2SsnFirst = document.getElementById('guest2SsnFirst').value.replace(/[^0-9]/g, '');

        // 유효성 검사
        if (!guest2Name) {
          showGuest2Error('동반자 이름을 입력해주세요.');
          return;
        }

        if (guest2Phone.length !== 11) {
          showGuest2Error('전화번호를 정확히 입력해주세요. (11자리)');
          return;
        }

        if (guest2SsnFirst.length !== 6) {
          showGuest2Error('주민번호 앞자리를 정확히 입력해주세요. (6자리)');
          return;
        }

        // 생년월일 검증
        const mm = parseInt(guest2SsnFirst.substring(2, 4));
        const dd = parseInt(guest2SsnFirst.substring(4, 6));
        const daysInMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

        if (mm < 1 || mm > 12) {
          showGuest2Error('생년월일의 월이 올바르지 않습니다. (01-12)');
          return;
        }

        if (dd < 1 || dd > daysInMonth[mm - 1]) {
          showGuest2Error(`생년월일의 일이 올바르지 않습니다. (${mm}월은 01-${daysInMonth[mm-1]}일)`);
          return;
        }

        hideGuest2Error();

        saveGuest2Btn.disabled = true;
        saveGuest2Btn.innerHTML = `
          <div class="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>
          <span>저장 중...</span>
        `;

        try {
          const response = await fetch(`/api/participants/phone/${currentParticipant.phone}/guest2`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              guest2_name: guest2Name,
              guest2_phone: guest2Phone,
              guest2_ssn_first: guest2SsnFirst,
            }),
          });

          const data = await response.json();
          if (!response.ok) throw new Error(data.error);

          // 새로고침
          const refreshResponse = await fetch(`/api/participants/phone/${currentParticipant.phone}`);
          const refreshData = await refreshResponse.json();

          if (refreshData.success) {
            currentParticipant = refreshData.participant;
            displayResult(refreshData.participant);
            showToast('동반자 정보가 저장되었습니다.', 'success');
          }
        } catch (err) {
          showGuest2Error(err.message || '저장 중 오류가 발생했습니다.');
          saveGuest2Btn.disabled = false;
          saveGuest2Btn.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            <span>동반자 정보 저장</span>
          `;
        }
      });
    }

    // 캘린더 추가
    function addToCalendar() {
      const eventTitle = '한동훈 토크콘서트';
      const eventLocation = '고양 킨텍스 제1전시장 3층 그랜드볼룸';
      const startDate = '20251221T100000';
      const endDate = '20251221T180000';

      // Google Calendar
      const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(eventTitle)}&dates=${startDate}/${endDate}&location=${encodeURIComponent(eventLocation)}&sf=true&output=xml`;

      window.open(googleUrl, '_blank');
      showToast('캘린더가 열립니다.', 'info');
    }

    // 공유하기
    async function shareTicket() {
      const shareData = {
        title: '한동훈 토크콘서트',
        text: `한동훈 토크콘서트에 참가합니다!\n📅 2025년 12월 21일 (일)\n📍 고양 킨텍스 제1전시장 3층 그랜드볼룸`,
        url: window.location.origin
      };

      try {
        if (navigator.share) {
          await navigator.share(shareData);
        } else {
          // Fallback: 클립보드 복사
          await navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`);
          showToast('내용이 클립보드에 복사되었습니다.', 'success');
        }
      } catch (err) {
        console.error('Share error:', err);
      }
    }

    // 폼 리셋
    function resetForm() {
      loginForm.classList.remove('hidden');
      resultCard.classList.add('hidden');
      phoneInput.value = '';
      currentParticipant = null;
      hideError();
    }

    // 에러 표시
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      errorDiv.classList.remove('hidden');
    }

    function hideError() {
      errorDiv.classList.add('hidden');
    }

    function showGuest2Error(message) {
      document.getElementById('guest2ErrorMessage').textContent = message;
      document.getElementById('guest2Error').classList.remove('hidden');
    }

    function hideGuest2Error() {
      document.getElementById('guest2Error').classList.add('hidden');
    }

    // 동반자 정보 수정 토글
    function toggleEditGuest2() {
      // 마감 시간 체크
      if (isEditDeadlinePassed()) {
        alert('정보수정 기간이 마감되었습니다.\n(마감: 2025년 12월 8일 오후 6시 3분)');
        return;
      }

      const displayInfo = document.getElementById('guest2DisplayInfo');
      const editForm = document.getElementById('guest2EditForm');
      const editBtn = document.getElementById('editGuest2Btn');

      // 수정 폼 표시
      displayInfo.classList.add('hidden');
      editForm.classList.remove('hidden');
      editBtn.classList.add('hidden');

      // 현재 값으로 폼 채우기 (전화번호, 생년월일만)
      document.getElementById('editGuest2Phone').value = currentParticipant.guest2_phone || '';
      document.getElementById('editGuest2Ssn').value = currentParticipant.guest2_ssn_first || '';

      // 숫자만 입력되도록 설정
      setupNumericInput(document.getElementById('editGuest2Phone'), 11);
      setupNumericInput(document.getElementById('editGuest2Ssn'), 6);

      // 에러 숨기기
      document.getElementById('editGuest2Error').classList.add('hidden');
    }

    // 동반자 정보 수정 취소
    function cancelEditGuest2() {
      const displayInfo = document.getElementById('guest2DisplayInfo');
      const editForm = document.getElementById('guest2EditForm');
      const editBtn = document.getElementById('editGuest2Btn');

      displayInfo.classList.remove('hidden');
      editForm.classList.add('hidden');
      editBtn.classList.remove('hidden');
      document.getElementById('editGuest2Error').classList.add('hidden');
    }

    // 동반자 정보 저장 (전화번호, 생년월일만)
    async function saveEditGuest2() {
      const phone = document.getElementById('editGuest2Phone').value.replace(/[^0-9]/g, '');
      const ssn = document.getElementById('editGuest2Ssn').value.replace(/[^0-9]/g, '');
      const errorDiv = document.getElementById('editGuest2Error');

      // 유효성 검사
      if (phone.length !== 11) {
        errorDiv.textContent = '전화번호를 정확히 입력해주세요. (11자리)';
        errorDiv.classList.remove('hidden');
        return;
      }

      if (ssn.length !== 6) {
        errorDiv.textContent = '생년월일을 정확히 입력해주세요. (6자리)';
        errorDiv.classList.remove('hidden');
        return;
      }

      // 생년월일 검증
      const mm = parseInt(ssn.substring(2, 4));
      const dd = parseInt(ssn.substring(4, 6));
      const daysInMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

      if (mm < 1 || mm > 12) {
        errorDiv.textContent = '생년월일의 월이 올바르지 않습니다. (01-12)';
        errorDiv.classList.remove('hidden');
        return;
      }

      if (dd < 1 || dd > daysInMonth[mm - 1]) {
        errorDiv.textContent = `생년월일의 일이 올바르지 않습니다. (${mm}월은 01-${daysInMonth[mm-1]}일)`;
        errorDiv.classList.remove('hidden');
        return;
      }

      errorDiv.classList.add('hidden');

      try {
        const response = await fetch(`/api/participants/phone/${currentParticipant.phone}/update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            guest2_phone: phone,
            guest2_ssn_first: ssn,
          }),
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error);

        // 새로고침
        const refreshResponse = await fetch(`/api/participants/phone/${currentParticipant.phone}`);
        const refreshData = await refreshResponse.json();

        if (refreshData.success) {
          currentParticipant = refreshData.participant;
          displayResult(refreshData.participant);
          showToast('동반자 정보가 수정되었습니다.', 'success');
        }

        cancelEditGuest2();
      } catch (err) {
        errorDiv.textContent = err.message || '수정 중 오류가 발생했습니다.';
        errorDiv.classList.remove('hidden');
      }
    }

    // 내 정보 수정 모드 표시
    function showEditUserInfo() {
      // 마감 시간 체크
      if (isEditDeadlinePassed()) {
        alert('정보수정 기간이 마감되었습니다.\n(마감: 2025년 12월 8일 오후 6시 3분)');
        return;
      }

      const displayDiv = document.getElementById('userInfoDisplay');
      const editDiv = document.getElementById('userInfoEdit');

      // 현재 정보로 폼 채우기
      document.getElementById('editUserName').value = currentParticipant.user_name;
      document.getElementById('editUserPhone').value = currentParticipant.phone;
      document.getElementById('editUserSsn').value = currentParticipant.ssn_first || '';

      displayDiv.classList.add('hidden');
      editDiv.classList.remove('hidden');
      document.getElementById('editUserError').classList.add('hidden');
    }

    // 내 정보 수정 취소
    function cancelEditUserInfo() {
      const displayDiv = document.getElementById('userInfoDisplay');
      const editDiv = document.getElementById('userInfoEdit');

      displayDiv.classList.remove('hidden');
      editDiv.classList.add('hidden');
      document.getElementById('editUserError').classList.add('hidden');
    }

    // 내 정보 저장
    async function saveEditUserInfo() {
      const newPhone = document.getElementById('editUserPhone').value.replace(/[^0-9]/g, '');
      const newSsn = document.getElementById('editUserSsn').value.replace(/[^0-9]/g, '');
      const errorDiv = document.getElementById('editUserError');

      // 유효성 검사
      if (newPhone.length !== 11) {
        errorDiv.textContent = '전화번호를 정확히 입력해주세요. (11자리)';
        errorDiv.classList.remove('hidden');
        return;
      }

      if (newSsn && newSsn.length !== 6) {
        errorDiv.textContent = '생년월일을 정확히 입력해주세요. (6자리)';
        errorDiv.classList.remove('hidden');
        return;
      }

      // 생년월일 검증 (입력된 경우)
      if (newSsn) {
        const mm = parseInt(newSsn.substring(2, 4));
        const dd = parseInt(newSsn.substring(4, 6));
        const daysInMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

        if (mm < 1 || mm > 12) {
          errorDiv.textContent = '생년월일의 월이 올바르지 않습니다. (01-12)';
          errorDiv.classList.remove('hidden');
          return;
        }

        if (dd < 1 || dd > daysInMonth[mm - 1]) {
          errorDiv.textContent = `생년월일의 일이 올바르지 않습니다. (${mm}월은 01-${daysInMonth[mm-1]}일)`;
          errorDiv.classList.remove('hidden');
          return;
        }
      }

      errorDiv.classList.add('hidden');

      try {
        const oldPhone = currentParticipant.phone;
        const response = await fetch(`/api/participants/phone/${oldPhone}/update-self`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            phone: newPhone,
            ssn_first: newSsn || null,
          }),
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error);

        // 새 전화번호로 다시 조회
        const refreshResponse = await fetch(`/api/participants/phone/${newPhone}`);
        const refreshData = await refreshResponse.json();

        if (refreshData.success) {
          currentParticipant = refreshData.participant;
          displayResult(refreshData.participant);
          showToast('정보가 수정되었습니다.', 'success');
        }

        cancelEditUserInfo();
      } catch (err) {
        errorDiv.textContent = err.message || '수정 중 오류가 발생했습니다.';
        errorDiv.classList.remove('hidden');
      }
    }

    // 취소/환불 섹션 표시
    function displayCancelRefundSection(participant, isGuest = false) {
      const cancelSection = document.getElementById('cancelSection');
      const refundSection = document.getElementById('refundSection');

      // 동반참가자인 경우 취소/환불 섹션 숨김
      if (isGuest) {
        cancelSection.classList.add('hidden');
        refundSection.classList.add('hidden');
        return;
      }

      // 취소 섹션 표시
      cancelSection.classList.remove('hidden');

      const alreadyCancelled = document.getElementById('alreadyCancelled');
      const cancelOptions = document.getElementById('cancelOptions');
      const cancelGuest2Only = document.getElementById('cancelGuest2Only');

      // 이미 취소된 경우
      if (participant.is_cancelled) {
        alreadyCancelled.classList.remove('hidden');
        cancelOptions.classList.add('hidden');
        const cancelledAt = participant.cancelled_at ? new Date(participant.cancelled_at.replace(' ', 'T')).toLocaleString('ko-KR') : '';
        document.getElementById('cancelledInfo').textContent = `취소일: ${cancelledAt}`;
        // 입금완료 상태이고 환불 신청이 없는 경우 안내 문구 표시
        const refundNotice = document.getElementById('cancelledRefundNotice');
        if (participant.is_paid && !participant.refund_status) {
          refundNotice.classList.remove('hidden');
        } else {
          refundNotice.classList.add('hidden');
        }
      } else {
        alreadyCancelled.classList.add('hidden');
        cancelOptions.classList.remove('hidden');

        // 2인 신청인 경우 동반자 취소 옵션 표시
        const ticketCount = participant.ticket_count || 1;
        const isTwoPerson = ticketCount === 2 || participant.guest2_name;
        if (isTwoPerson) {
          cancelGuest2Only.classList.remove('hidden');
          // 2인 신청: 전체 취소 문구
          document.getElementById('cancelFullDesc').textContent = '본인과 동반자 신청을 모두 취소하시겠습니까?';
          document.getElementById('cancelFullBtnText').textContent = '전체 신청 취소';
        } else {
          cancelGuest2Only.classList.add('hidden');
          // 1인 신청: 단순 취소 문구
          document.getElementById('cancelFullDesc').textContent = '참가신청을 취소하시겠습니까?';
          document.getElementById('cancelFullBtnText').textContent = '참가신청 취소';
        }
      }

      // 환불 섹션 표시
      refundSection.classList.remove('hidden');

      const refundPending = document.getElementById('refundPending');
      const refundCompleted = document.getElementById('refundCompleted');
      const refundForm = document.getElementById('refundForm');

      // 환불 상태에 따른 표시
      if (participant.refund_status === 'completed') {
        refundPending.classList.add('hidden');
        refundCompleted.classList.remove('hidden');
        refundForm.classList.add('hidden');
        document.getElementById('refundCompletedInfo').innerHTML = `
          <p>환불 금액: ₩${(participant.refund_amount || 0).toLocaleString()}</p>
          <p>환불 완료일: ${participant.refund_completed_at ? new Date(participant.refund_completed_at.replace(' ', 'T')).toLocaleString('ko-KR') : '-'}</p>
        `;
      } else if (participant.refund_status === 'pending') {
        refundPending.classList.remove('hidden');
        refundCompleted.classList.add('hidden');
        refundForm.classList.add('hidden');
        let pendingInfo = `
          <p>환불 요청 금액: ₩${(participant.refund_amount || 0).toLocaleString()}</p>
          <p>환불 은행: ${participant.refund_bank || '-'}</p>
          <p>계좌번호: ${participant.refund_account || '-'}</p>
          <p>예금주: ${participant.refund_holder || '-'}</p>
        `;
        if (participant.refund_reason) {
          pendingInfo += `<p class="mt-2 pt-2 border-t border-yellow-200">사유: ${participant.refund_reason}</p>`;
        }
        document.getElementById('refundPendingInfo').innerHTML = pendingInfo;
      } else {
        refundPending.classList.add('hidden');
        refundCompleted.classList.add('hidden');
        refundForm.classList.remove('hidden');
      }
    }

    // 취소 모달 관련 변수
    let cancelType = null; // 'full' or 'guest2'

    // 취소 모달 표시
    function showCancelModal(type) {
      cancelType = type;
      const modal = document.getElementById('cancelModal');
      const title = document.getElementById('cancelModalTitle');
      const message = document.getElementById('cancelModalMessage');
      const refundFields = document.getElementById('cancelRefundFields');
      const errorDiv = document.getElementById('cancelModalError');

      errorDiv.classList.add('hidden');

      if (type === 'full') {
        title.textContent = '전체 신청 취소';
        const ticketCount = currentParticipant.ticket_count || 1;
        if (ticketCount === 2) {
          message.textContent = '본인 및 동반자 신청이 모두 취소됩니다. 정말 취소하시겠습니까?';
        } else {
          message.textContent = '신청이 취소됩니다. 정말 취소하시겠습니까?';
        }
      } else {
        title.textContent = '동반자 취소';
        message.textContent = '동반자 신청만 취소하고 1인 신청으로 변경됩니다. 정말 취소하시겠습니까?';
      }

      // 입금 완료자인 경우 환불 계좌 입력 필드 표시
      if (currentParticipant.is_paid) {
        refundFields.classList.remove('hidden');
        // 기존 환불 정보가 있으면 채우기
        if (currentParticipant.refund_bank) {
          document.getElementById('cancelRefundBank').value = currentParticipant.refund_bank;
        }
        if (currentParticipant.refund_account) {
          document.getElementById('cancelRefundAccount').value = currentParticipant.refund_account;
        }
        if (currentParticipant.refund_holder) {
          document.getElementById('cancelRefundHolder').value = currentParticipant.refund_holder;
        }
      } else {
        refundFields.classList.add('hidden');
      }

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    // 취소 모달 닫기
    function closeCancelModal() {
      const modal = document.getElementById('cancelModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      cancelType = null;
    }

    // 취소 확인
    async function confirmCancel() {
      const errorDiv = document.getElementById('cancelModalError');
      const confirmBtn = document.getElementById('confirmCancelBtn');
      errorDiv.classList.add('hidden');

      // 입금 완료자인 경우 환불 계좌 검증
      let refundData = {};
      if (currentParticipant.is_paid) {
        const bank = document.getElementById('cancelRefundBank').value;
        const account = document.getElementById('cancelRefundAccount').value.replace(/[^0-9]/g, '');
        const holder = document.getElementById('cancelRefundHolder').value.trim();

        if (!bank) {
          errorDiv.textContent = '환불 은행을 선택해주세요.';
          errorDiv.classList.remove('hidden');
          return;
        }
        if (!account) {
          errorDiv.textContent = '환불 계좌번호를 입력해주세요.';
          errorDiv.classList.remove('hidden');
          return;
        }
        if (!holder) {
          errorDiv.textContent = '예금주를 입력해주세요.';
          errorDiv.classList.remove('hidden');
          return;
        }

        refundData = {
          refund_bank: bank,
          refund_account: account,
          refund_holder: holder
        };
      }

      confirmBtn.disabled = true;
      confirmBtn.textContent = '처리 중...';

      try {
        let endpoint = '';
        if (cancelType === 'full') {
          endpoint = `/api/participants/phone/${currentParticipant.phone}/cancel`;
        } else {
          endpoint = `/api/participants/phone/${currentParticipant.phone}/cancel-guest2`;
        }

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cancel_reason: cancelType === 'full' ? '본인 취소 요청' : '동반자 취소 요청',
            ...refundData
          })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error);

        closeCancelModal();
        showToast(cancelType === 'full' ? '신청이 취소되었습니다.' : '동반자가 취소되었습니다.', 'success');

        // 새로고침
        const refreshResponse = await fetch(`/api/participants/phone/${currentParticipant.phone}`);
        const refreshData = await refreshResponse.json();
        if (refreshData.success) {
          currentParticipant = refreshData.participant;
          displayResult(refreshData.participant);
        }
      } catch (err) {
        errorDiv.textContent = err.message || '처리 중 오류가 발생했습니다.';
        errorDiv.classList.remove('hidden');
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = '확인';
      }
    }

    // 환불 신청
    async function submitRefundRequest() {
      const errorDiv = document.getElementById('refundError');
      const errorMessage = document.getElementById('refundErrorMessage');
      const submitBtn = document.getElementById('submitRefundBtn');

      errorDiv.classList.add('hidden');

      const amount = document.getElementById('refundAmount').value.replace(/[^0-9]/g, '');
      const bank = document.getElementById('refundBank').value;
      const account = document.getElementById('refundAccount').value.replace(/[^0-9]/g, '');
      const holder = document.getElementById('refundHolder').value.trim();
      const reason = document.getElementById('refundReason').value.trim();

      // 유효성 검사
      if (!amount || parseInt(amount) <= 0) {
        errorMessage.textContent = '환불 요청 금액을 입력해주세요.';
        errorDiv.classList.remove('hidden');
        return;
      }
      if (!bank) {
        errorMessage.textContent = '환불 은행을 선택해주세요.';
        errorDiv.classList.remove('hidden');
        return;
      }
      if (!account) {
        errorMessage.textContent = '환불 계좌번호를 입력해주세요.';
        errorDiv.classList.remove('hidden');
        return;
      }
      if (!holder) {
        errorMessage.textContent = '예금주를 입력해주세요.';
        errorDiv.classList.remove('hidden');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML = `
        <div class="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>
        <span>신청 중...</span>
      `;

      try {
        const response = await fetch(`/api/participants/phone/${currentParticipant.phone}/refund-account`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            refund_amount: parseInt(amount),
            refund_bank: bank,
            refund_account: account,
            refund_holder: holder,
            refund_reason: reason || null
          })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error);

        showToast('환불 신청이 완료되었습니다.', 'success');

        // 새로고침
        const refreshResponse = await fetch(`/api/participants/phone/${currentParticipant.phone}`);
        const refreshData = await refreshResponse.json();
        if (refreshData.success) {
          currentParticipant = refreshData.participant;
          displayResult(refreshData.participant);
        }
      } catch (err) {
        errorMessage.textContent = err.message || '신청 중 오류가 발생했습니다.';
        errorDiv.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          <span>환불 신청하기</span>
        `;
      }
    }

    // 환불 정보 수정 폼 표시
    function showRefundEditForm() {
      const editForm = document.getElementById('refundEditForm');
      const editBtn = document.getElementById('refundEditBtn');
      const pendingInfo = document.getElementById('refundPendingInfo');

      // 현재 정보를 폼에 채우기
      if (currentParticipant.refund_bank) {
        document.getElementById('editRefundBank').value = currentParticipant.refund_bank;
      }
      if (currentParticipant.refund_account) {
        document.getElementById('editRefundAccount').value = currentParticipant.refund_account;
      }
      if (currentParticipant.refund_holder) {
        document.getElementById('editRefundHolder').value = currentParticipant.refund_holder;
      }

      editForm.classList.remove('hidden');
      editBtn.classList.add('hidden');
      pendingInfo.classList.add('hidden');
      document.getElementById('refundEditError').classList.add('hidden');
    }

    // 환불 정보 수정 취소
    function cancelRefundEdit() {
      const editForm = document.getElementById('refundEditForm');
      const editBtn = document.getElementById('refundEditBtn');
      const pendingInfo = document.getElementById('refundPendingInfo');

      editForm.classList.add('hidden');
      editBtn.classList.remove('hidden');
      pendingInfo.classList.remove('hidden');
    }

    // 환불 정보 저장
    async function saveRefundEdit() {
      const errorDiv = document.getElementById('refundEditError');
      errorDiv.classList.add('hidden');

      const bank = document.getElementById('editRefundBank').value;
      const account = document.getElementById('editRefundAccount').value.replace(/[^0-9]/g, '');
      const holder = document.getElementById('editRefundHolder').value.trim();

      // 유효성 검사
      if (!bank) {
        errorDiv.textContent = '환불 은행을 선택해주세요.';
        errorDiv.classList.remove('hidden');
        return;
      }
      if (!account) {
        errorDiv.textContent = '계좌번호를 입력해주세요.';
        errorDiv.classList.remove('hidden');
        return;
      }
      if (!holder) {
        errorDiv.textContent = '예금주를 입력해주세요.';
        errorDiv.classList.remove('hidden');
        return;
      }

      try {
        const response = await fetch(`/api/participants/phone/${currentParticipant.phone}/refund-account`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            refund_amount: currentParticipant.refund_amount,
            refund_bank: bank,
            refund_account: account,
            refund_holder: holder,
            refund_reason: currentParticipant.refund_reason || null
          })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error);

        showToast('환불 계좌 정보가 수정되었습니다.', 'success');

        // 새로고침
        const refreshResponse = await fetch(`/api/participants/phone/${currentParticipant.phone}`);
        const refreshData = await refreshResponse.json();
        if (refreshData.success) {
          currentParticipant = refreshData.participant;
          displayResult(refreshData.participant);
        }

        cancelRefundEdit();
      } catch (err) {
        errorDiv.textContent = err.message || '수정 중 오류가 발생했습니다.';
        errorDiv.classList.remove('hidden');
      }
    }

    // 비밀번호 변경
    async function changePassword() {
      const errorDiv = document.getElementById('passwordError');
      const successDiv = document.getElementById('passwordSuccess');
      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');

      const currentPw = document.getElementById('currentPassword').value.trim();
      const newPw = document.getElementById('newPassword').value.trim();
      const confirmPw = document.getElementById('confirmPassword').value.trim();

      // 유효성 검사
      if (!currentPw) {
        errorDiv.textContent = '현재 비밀번호를 입력해주세요.';
        errorDiv.classList.remove('hidden');
        return;
      }
      if (!newPw) {
        errorDiv.textContent = '새 비밀번호를 입력해주세요.';
        errorDiv.classList.remove('hidden');
        return;
      }
      if (newPw.length !== 6 || !/^\d{6}$/.test(newPw)) {
        errorDiv.textContent = '새 비밀번호는 숫자 6자리여야 합니다.';
        errorDiv.classList.remove('hidden');
        return;
      }
      if (newPw !== confirmPw) {
        errorDiv.textContent = '새 비밀번호가 일치하지 않습니다.';
        errorDiv.classList.remove('hidden');
        return;
      }
      if (currentPw === newPw) {
        errorDiv.textContent = '새 비밀번호는 현재 비밀번호와 달라야 합니다.';
        errorDiv.classList.remove('hidden');
        return;
      }

      try {
        const phone = currentParticipant._isGuest ? currentParticipant._guestInfo.phone : currentParticipant.phone;

        const response = await fetch('/api/participants/password', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            phone: phone,
            current_password: currentPw,
            new_password: newPw
          })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error);

        successDiv.textContent = '비밀번호가 변경되었습니다.';
        successDiv.classList.remove('hidden');
        showToast('비밀번호가 변경되었습니다.', 'success');

        // 입력 필드 초기화
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
      } catch (err) {
        errorDiv.textContent = err.message || '비밀번호 변경 중 오류가 발생했습니다.';
        errorDiv.classList.remove('hidden');
      }
    }

    // 개인정보 동의 모달 표시
    function showPrivacyModal() {
      const modal = document.getElementById('privacyModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.getElementById('privacyAgreeCheck').checked = false;
      document.getElementById('privacyError').classList.add('hidden');
    }

    // 개인정보 동의 제출
    async function submitPrivacyAgree() {
      const checkbox = document.getElementById('privacyAgreeCheck');
      const errorDiv = document.getElementById('privacyError');

      if (!checkbox.checked) {
        errorDiv.classList.remove('hidden');
        return;
      }

      errorDiv.classList.add('hidden');

      try {
        const phone = currentParticipant._isGuest
          ? currentParticipant._guestInfo.phone
          : currentParticipant.phone;

        const response = await fetch('/api/participants/privacy-agree', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error);

        // 모달 닫기
        const modal = document.getElementById('privacyModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');

        // 동의 상태 업데이트
        if (currentParticipant._isGuest) {
          currentParticipant.guest2_privacy_agreed = 1;
        } else {
          currentParticipant.privacy_agreed = 1;
        }

        showToast('개인정보 수집에 동의하셨습니다.', 'success');

        // 결과 화면 표시
        displayResult(
          currentParticipant,
          currentParticipant._isGuest,
          currentParticipant._guestInfo
        );
      } catch (err) {
        errorDiv.textContent = err.message || '동의 처리 중 오류가 발생했습니다.';
        errorDiv.classList.remove('hidden');
      }
    }

    // 토스트 알림
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast';

      const iconColors = {
        success: 'text-green-600',
        error: 'text-red-600',
        warning: 'text-yellow-600',
        info: 'text-blue-600'
      };

      const icons = {
        success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />',
        error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />',
        warning: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />',
        info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />'
      };

      toast.innerHTML = `
        <svg class="w-5 h-5 ${iconColors[type]}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          ${icons[type]}
        </svg>
        <span>${message}</span>
      `;

      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>
