<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>신청내역 확인 - 한동훈 토크콘서트</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="min-h-screen bg-gradient-to-br from-red-50 via-white to-sky-50">
    <header class="glass-header">
      <div class="max-w-4xl mx-auto px-4 py-4">
        <a href="/" class="inline-flex items-center gap-2 text-gray-700 hover:text-gray-900" style="text-decoration: none;">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          <span>돌아가기</span>
        </a>
      </div>
    </header>

    <main class="max-w-2xl mx-auto px-4 py-8">
      <div id="loginForm" class="glass-card">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">신청내역 확인</h2>

        <form id="checkForm" class="space-y-6">
          <div>
            <label for="phone" class="block text-lg font-medium text-gray-700 mb-2">전화번호</label>
            <input
              id="phone"
              type="tel"
              inputmode="numeric"
              class="input-glass"
              placeholder="01012345678"
              maxlength="11"
              required
            />
            <p class="mt-2 text-sm text-gray-500">11자리 숫자를 입력하세요 (예: 01012345678)</p>
          </div>

          <div id="error" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg text-red-700"></div>

          <button type="submit" class="btn-primary-glass w-full" id="submitBtn">
            조회하기
          </button>
        </form>
      </div>

      <div id="resultCard" class="glass-card hidden">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">신청 내역</h2>

        <div class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-gray-500 mb-1">이름</label>
            <div class="flex items-center gap-2">
              <span id="userName" class="text-lg font-medium text-gray-900"></span>
              <button id="editBtn" class="p-2 text-gray-500 hover:text-gray-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
            </div>
            <div id="editForm" class="hidden mt-2 flex items-center gap-2">
              <input type="text" id="editNameInput" inputmode="text" class="input-glass flex-1" />
              <button id="saveBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">저장</button>
              <button id="cancelBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">취소</button>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-500 mb-1">전화번호</label>
            <p id="userPhone" class="text-lg text-gray-900"></p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-500 mb-1">주민번호 앞자리</label>
            <p id="userSsnFirst" class="text-lg text-gray-900"></p>
          </div>

          <div id="paymentInfo" class="hidden">
            <label class="block text-sm font-medium text-gray-500 mb-2">입금 안내</label>
            <p id="paymentAmount" class="text-xl font-bold text-red-600 mb-3"></p>
            <p class="text-lg font-semibold text-gray-900 mb-2">카카오뱅크 3333-3548-32957</p>
            <p class="text-sm text-gray-600 mb-2">예금주: 샘커뮤니케이션즈</p>
            <p class="text-sm text-red-600 font-semibold">⚠️ 입금시 입금자명을 '홍길동3747' 과 같이 이름+전화번호뒷자리로 송금해주셔야 합니다. 혹시 놓치신 경우 '문의하기' 를 통해 알려주세요.</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-500 mb-2">신청 상태</label>
            <div class="space-y-2">
              <div>
                <span class="text-xs text-gray-500 mb-1 block">입금 확인</span>
                <span id="paymentBadge" class="badge-gray"></span>
              </div>
              <div>
                <span class="text-xs text-gray-500 mb-1 block">좌석 배정</span>
                <span id="seatBadge" class="badge-gray"></span>
              </div>
            </div>
          </div>

          <!-- 2번째 참가자 정보 입력 섹션 -->
          <div id="guest2Section" class="pt-6 border-t border-gray-200">
            <h3 class="text-lg font-bold text-gray-900 mb-4">2번째 참가자 정보</h3>
            
            <div id="guest2Form" class="space-y-4">
              <div>
                <label for="guest2Name" class="block text-sm font-medium text-gray-700 mb-2">이름</label>
                <input
                  id="guest2Name"
                  type="text"
                  inputmode="text"
                  class="input-glass"
                  placeholder="이름을 입력하세요"
                />
              </div>

              <div>
                <label for="guest2Phone" class="block text-sm font-medium text-gray-700 mb-2">전화번호</label>
                <input
                  id="guest2Phone"
                  type="tel"
                  inputmode="numeric"
                  class="input-glass"
                  placeholder="01012345678"
                  maxlength="11"
                />
                <p class="mt-1 text-xs text-gray-500">11자리 숫자를 입력하세요</p>
              </div>

              <div>
                <label for="guest2SsnFirst" class="block text-sm font-medium text-gray-700 mb-2">생년월일 앞자리</label>
                <input
                  id="guest2SsnFirst"
                  type="tel"
                  inputmode="numeric"
                  class="input-glass"
                  placeholder="620126"
                  maxlength="6"
                />
                <p class="mt-1 text-xs text-gray-500">6자리 숫자를 입력하세요 (예: 620126)</p>
              </div>

              <div id="guest2Error" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>

              <button id="saveGuest2Btn" class="btn-primary-glass w-full">
                2번째 참가자 정보 저장
              </button>
            </div>

            <div id="guest2Info" class="hidden space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-500 mb-1">이름</label>
                <p id="guest2NameDisplay" class="text-lg text-gray-900"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-500 mb-1">전화번호</label>
                <p id="guest2PhoneDisplay" class="text-lg text-gray-900"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-500 mb-1">생년월일 앞자리</label>
                <p id="guest2SsnFirstDisplay" class="text-lg text-gray-900"></p>
              </div>
            </div>
          </div>

          <div id="seatInfo" class="hidden">
            <label class="block text-sm font-medium text-gray-500 mb-1">좌석 번호</label>
            <p id="seatNumber" class="text-4xl font-bold text-red-600"></p>
            <p class="text-sm text-gray-500 mt-2">(그룹-열-좌석번호)</p>
          </div>

          <!-- QR 코드 섹션 (입금 완료된 경우에만 표시) -->
          <div id="qrCodeSection" class="hidden pt-6 border-t border-gray-200">
            <label class="block text-sm font-medium text-gray-500 mb-3">입장용 QR 코드</label>
            <div class="flex flex-col items-center">
              <div id="qrCodeContainer" class="bg-white p-4 rounded-lg shadow-md mb-3"></div>
              <p class="text-sm text-gray-600 text-center">행사 당일 이 QR 코드를 제시해주세요</p>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-500 mb-1">신청 일시</label>
            <p id="createdAt" class="text-lg text-gray-700"></p>
          </div>
        </div>

        <div class="mt-6">
          <button onclick="resetForm()" class="btn-secondary-glass w-full">
            다른 번호로 조회하기
          </button>
        </div>
      </div>
    </main>

    <!-- 푸터 (나중에 배포사/운영사 정보 추가 예정) -->
    <footer class="mt-16 py-8 border-t border-white/20">
      <div class="max-w-4xl mx-auto px-4 text-center text-sm text-gray-600">
        <!-- 배포사/운영사 정보는 추후 추가 예정 -->
      </div>
    </footer>
  </div>

  <script>
    let currentParticipant = null;

    document.addEventListener('DOMContentLoaded', function() {
      const phoneInput = document.getElementById('phone');
      const form = document.getElementById('checkForm');
      const loginForm = document.getElementById('loginForm');
      const resultCard = document.getElementById('resultCard');
      const errorDiv = document.getElementById('error');
      const submitBtn = document.getElementById('submitBtn');

      if (!phoneInput || !form) {
        console.error('Required elements not found');
        return;
      }

      // 전화번호 숫자만 입력 (숫자가 아닌 키는 차단)
      phoneInput.addEventListener('keydown', (e) => {
        // 숫자(0-9), 백스페이스, Delete, Tab, Arrow keys, Home, End 키만 허용
        const allowedKeys = [
          'Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
          'Home', 'End'
        ];
        
        if (allowedKeys.includes(e.key)) {
          return; // 허용된 키는 통과
        }
        
        // 숫자 키만 허용
        if (!/^[0-9]$/.test(e.key)) {
          e.preventDefault(); // 숫자가 아닌 키는 차단
          return;
        }
        
        // 11자리 제한
        if (phoneInput.value.length >= 11 && !allowedKeys.includes(e.key)) {
          e.preventDefault();
        }
      });

      // 붙여넣기 시 숫자만 추출
      phoneInput.addEventListener('input', (e) => {
        const value = e.target.value.replace(/[^0-9]/g, '');
        if (value.length <= 11) {
          phoneInput.value = value;
        } else {
          phoneInput.value = value.slice(0, 11);
        }
      });

      // 전화번호 표시용 포맷팅 함수 (하이픈 포함)
      function formatPhone(value) {
        if (!value) return '';
        const numbers = value.replace(/[^0-9]/g, '');
        if (numbers.length <= 3) return numbers;
        if (numbers.length <= 7) return `${numbers.slice(0, 3)}-${numbers.slice(3)}`;
        return `${numbers.slice(0, 3)}-${numbers.slice(3, 7)}-${numbers.slice(7, 11)}`;
      }

      form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorDiv.classList.add('hidden');
      
      const phone = phoneInput.value.replace(/[^0-9]/g, '');

      if (phone.length !== 11) {
        showError('전화번호를 정확히 입력해주세요. (11자리)');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = '조회 중...';

      try {
        const response = await fetch(`/api/participants/phone/${phone}`);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || '조회 중 오류가 발생했습니다.');
        }

        currentParticipant = data.participant;
        displayResult(data.participant);
      } catch (err) {
        console.error('Fetch error:', err);
        showError(err.message || '조회 중 오류가 발생했습니다. 다시 시도해주세요.');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = '조회하기';
        }
      }
      });

      function displayResult(participant) {
      document.getElementById('userName').textContent = participant.user_name;
      document.getElementById('userPhone').textContent = formatPhone(participant.phone);
      document.getElementById('userSsnFirst').textContent = participant.ssn_first || '-';
      
      // 2번째 참가자 정보 표시 (2인 신청인 경우에만)
      const guest2Section = document.getElementById('guest2Section');
      const guest2Form = document.getElementById('guest2Form');
      const guest2Info = document.getElementById('guest2Info');
      
      if (guest2Section) {
        const ticketCount = participant.ticket_count || 1;
        const isTwoPerson = ticketCount === 2 || participant.guest2_name;
        
        if (isTwoPerson) {
          // 2인 신청인 경우에만 섹션 표시
          guest2Section.classList.remove('hidden');
          
          if (participant.is_guest2_completed && participant.guest2_name) {
            // 2번째 참가자 정보가 이미 입력된 경우
            guest2Form.classList.add('hidden');
            guest2Info.classList.remove('hidden');
            document.getElementById('guest2NameDisplay').textContent = participant.guest2_name;
            document.getElementById('guest2PhoneDisplay').textContent = formatPhone(participant.guest2_phone || '');
            document.getElementById('guest2SsnFirstDisplay').textContent = participant.guest2_ssn_first || '-';
          } else {
            // 2번째 참가자 정보 입력 폼 표시
            guest2Form.classList.remove('hidden');
            guest2Info.classList.add('hidden');
          }
        } else {
          // 1인 신청인 경우 섹션 숨김
          guest2Section.classList.add('hidden');
        }
      }
      
      // created_at 표시 (YYYY-MM-DD HH:mm:ss 형식을 한국어 형식으로 변환)
      const createdAt = participant.created_at;
      if (createdAt) {
        // YYYY-MM-DD HH:mm:ss 형식을 파싱
        const dateStr = createdAt.replace(' ', 'T');
        const date = new Date(dateStr);
        // 한국 시간대로 표시
        document.getElementById('createdAt').textContent = date.toLocaleString('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false,
          timeZone: 'Asia/Seoul'
        });
      } else {
        document.getElementById('createdAt').textContent = '-';
      }
      
      // 입금 계좌 정보 표시 (입금 완료 전에만 표시)
      const paymentInfo = document.getElementById('paymentInfo');
      const paymentAmount = document.getElementById('paymentAmount');
      if (paymentInfo) {
        if (!participant.is_paid) {
          paymentInfo.classList.remove('hidden');
          // ticket_count 또는 2번째 참가자 정보 입력 여부에 따라 금액 결정
          // ticket_count가 2이거나, guest2_name이 있거나, is_guest2_completed가 0이면 2인 신청으로 간주
          const ticketCount = participant.ticket_count || 1;
          const hasGuest2 = participant.guest2_name || (participant.is_guest2_completed === 0 && ticketCount === 2);
          const isTwoPerson = ticketCount === 2 || hasGuest2;
          
          console.log('Payment amount check:', { 
            ticket_count: participant.ticket_count, 
            ticketCount, 
            hasGuest2, 
            isTwoPerson,
            guest2_name: participant.guest2_name,
            is_guest2_completed: participant.is_guest2_completed
          });
          
          if (isTwoPerson) {
            // 2인 신청: 60,000원
            if (paymentAmount) {
              paymentAmount.textContent = '₩60,000원을 아래 계좌로 입금해주세요';
            }
          } else {
            // 1인 신청: 30,000원
            if (paymentAmount) {
              paymentAmount.textContent = '₩30,000원을 아래 계좌로 입금해주세요';
            }
          }
        } else {
          paymentInfo.classList.add('hidden');
        }
      }
      
      // 입금 확인 배지
      const paymentBadge = document.getElementById('paymentBadge');
      if (participant.is_paid) {
        paymentBadge.className = 'badge-green';
        paymentBadge.innerHTML = '✓ 입금 완료';
      } else {
        paymentBadge.className = 'badge-red';
        paymentBadge.textContent = '입금 확인 중';
      }

      // 좌석 배정 배지
      const seatBadge = document.getElementById('seatBadge');
      if (participant.seat_full) {
        seatBadge.className = 'badge-green';
        seatBadge.innerHTML = '✓ 좌석 배정 완료';
      } else {
        seatBadge.className = 'badge-red';
        seatBadge.textContent = '좌석 배정 대기';
      }

      if (participant.seat_full) {
        document.getElementById('seatInfo').classList.remove('hidden');
        document.getElementById('seatNumber').textContent = participant.seat_full;
      } else {
        document.getElementById('seatInfo').classList.add('hidden');
      }

      // QR 코드 생성 (입금 완료된 경우에만)
      const qrCodeSection = document.getElementById('qrCodeSection');
      const qrCodeContainer = document.getElementById('qrCodeContainer');
      if (participant.is_paid && qrCodeSection && qrCodeContainer) {
        qrCodeSection.classList.remove('hidden');
        // QR 코드에 포함할 데이터: 참가자 ID, 이름, 전화번호
        const qrData = JSON.stringify({
          id: participant.id,
          name: participant.user_name,
          phone: participant.phone,
          seat: participant.seat_full || null
        });
        
        // 기존 QR 코드 제거
        qrCodeContainer.innerHTML = '<p class="text-gray-600 text-sm">QR 코드 생성 중...</p>';
        
        // QR 코드 생성 함수
        function generateQRCode() {
          // qrcodejs 라이브러리 확인 (다른 API 사용)
          if (typeof QRCode !== 'undefined') {
            qrCodeContainer.innerHTML = '';
            // qrcodejs는 생성자로 직접 사용
            new QRCode(qrCodeContainer, {
              text: qrData,
              width: 256,
              height: 256,
              colorDark: '#000000',
              colorLight: '#FFFFFF',
              correctLevel: QRCode.CorrectLevel.H
            });
          } else {
            console.error('QRCode library not available:', { QRCode: typeof QRCode });
            qrCodeContainer.innerHTML = '<p class="text-red-600 text-sm">QR 코드 라이브러리를 사용할 수 없습니다.</p>';
          }
        }
        
        // 라이브러리 로드 함수
        function loadQRCodeLibrary() {
          return new Promise(function(resolve, reject) {
            // 이미 로드되어 있는지 확인
            if (typeof QRCode !== 'undefined') {
              resolve();
              return;
            }
            
            // 이미 로딩 중이면 대기
            if (window.qrcodeScriptLoading) {
              const checkInterval = setInterval(function() {
                if (window.qrcodeLoaded || (typeof QRCode !== 'undefined')) {
                  clearInterval(checkInterval);
                  resolve();
                }
              }, 100);
              setTimeout(function() {
                clearInterval(checkInterval);
                reject(new Error('Timeout'));
              }, 5000);
              return;
            }
            
            // 스크립트 로드 (여러 CDN 시도)
            window.qrcodeScriptLoading = true;
            
            const cdnUrls = [
              'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js',
              'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js',
              'https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js'
            ];
            
            let currentIndex = 0;
            
            function tryLoadScript() {
              if (currentIndex >= cdnUrls.length) {
                window.qrcodeScriptLoading = false;
                reject(new Error('Failed to load QRCode library from all CDNs'));
                return;
              }
              
              const script = document.createElement('script');
              script.src = cdnUrls[currentIndex];
              script.async = true;
              script.crossOrigin = 'anonymous';
              
              script.onload = function() {
                window.qrcodeLoaded = true;
                window.qrcodeScriptLoading = false;
                resolve();
              };
              
              script.onerror = function() {
                currentIndex++;
                tryLoadScript();
              };
              
              document.head.appendChild(script);
            }
            
            tryLoadScript();
          });
        }
        
        // 라이브러리 로드 후 QR 코드 생성
        loadQRCodeLibrary()
          .then(function() {
            generateQRCode();
          })
          .catch(function(error) {
            console.error('QR 코드 라이브러리 로드 실패:', error);
            qrCodeContainer.innerHTML = '<p class="text-red-600 text-sm">QR 코드 라이브러리 로드 실패. 페이지를 새로고침해주세요.</p>';
          });
      } else {
        if (qrCodeSection) qrCodeSection.classList.add('hidden');
      }

        if (loginForm) loginForm.classList.add('hidden');
        if (resultCard) resultCard.classList.remove('hidden');
      }

      // 이름 수정
      const editBtn = document.getElementById('editBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const saveBtn = document.getElementById('saveBtn');

      if (editBtn) {
        editBtn.addEventListener('click', () => {
          const editForm = document.getElementById('editForm');
          const editNameInput = document.getElementById('editNameInput');
          if (editForm && editNameInput && currentParticipant) {
            editForm.classList.remove('hidden');
            editNameInput.value = currentParticipant.user_name;
          }
        });
      }

      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          const editForm = document.getElementById('editForm');
          if (editForm) editForm.classList.add('hidden');
        });
      }

      if (saveBtn) {
        saveBtn.addEventListener('click', async () => {
          const editNameInput = document.getElementById('editNameInput');
          if (!editNameInput || !currentParticipant) return;

          const newName = editNameInput.value.trim();
          if (!newName) {
            alert('이름을 입력해주세요.');
            return;
          }

          try {
            const response = await fetch(`/api/participants/${currentParticipant.id}/name`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ user_name: newName }),
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error);

            currentParticipant.user_name = newName;
            const userNameEl = document.getElementById('userName');
            if (userNameEl) userNameEl.textContent = newName;
            const editForm = document.getElementById('editForm');
            if (editForm) editForm.classList.add('hidden');
          } catch (err) {
            console.error('Update name error:', err);
            alert(err.message || '이름 수정 중 오류가 발생했습니다.');
          }
        });
      }

      // 2번째 참가자 정보 저장
      const saveGuest2Btn = document.getElementById('saveGuest2Btn');
      const guest2Error = document.getElementById('guest2Error');
      
      if (saveGuest2Btn) {
        saveGuest2Btn.addEventListener('click', async () => {
          if (!currentParticipant) return;
          
          const guest2Name = document.getElementById('guest2Name').value.trim();
          const guest2Phone = document.getElementById('guest2Phone').value.replace(/[^0-9]/g, '');
          const guest2SsnFirst = document.getElementById('guest2SsnFirst').value.replace(/[^0-9]/g, '');
          
          if (!guest2Name) {
            showError('2번째 참가자 이름을 입력해주세요.', guest2Error);
            return;
          }
          
          if (guest2Phone.length !== 11) {
            showError('전화번호를 정확히 입력해주세요. (11자리)', guest2Error);
            return;
          }
          
          if (guest2SsnFirst.length !== 6) {
            showError('생년월일 앞자리를 정확히 입력해주세요. (6자리)', guest2Error);
            return;
          }

          // 주민번호 앞자리 유효성 검사 (yymmdd 형식)
          const yy = parseInt(guest2SsnFirst.substring(0, 2));
          const mm = parseInt(guest2SsnFirst.substring(2, 4));
          const dd = parseInt(guest2SsnFirst.substring(4, 6));
          
          // 월 검증 (01-12)
          if (mm < 1 || mm > 12) {
            showError('생년월일 앞자리의 월(3-4번째 자리)이 올바르지 않습니다. (01-12)', guest2Error);
            return;
          }
          
          // 일 검증 (월에 따른 유효한 일자 범위)
          const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
          const maxDay = daysInMonth[mm - 1];
          
          if (dd < 1 || dd > maxDay) {
            showError(`생년월일 앞자리의 일(5-6번째 자리)이 올바르지 않습니다. (${mm}월은 01-${String(maxDay).padStart(2, '0')}일까지 가능)`, guest2Error);
            return;
          }
          
          saveGuest2Btn.disabled = true;
          saveGuest2Btn.textContent = '저장 중...';
          if (guest2Error) guest2Error.classList.add('hidden');
          
          try {
            const response = await fetch(`/api/participants/phone/${currentParticipant.phone}/guest2`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                guest2_name: guest2Name,
                guest2_phone: guest2Phone,
                guest2_ssn_first: guest2SsnFirst,
              }),
            });
            
            const data = await response.json();
            
            if (!response.ok) {
              throw new Error(data.error || '2번째 참가자 정보 저장 중 오류가 발생했습니다.');
            }
            
            // 성공 시 정보 새로고침 (입금 금액도 업데이트됨)
            const refreshResponse = await fetch(`/api/participants/phone/${currentParticipant.phone}`);
            const refreshData = await refreshResponse.json();
            if (refreshData.success) {
              currentParticipant = refreshData.participant;
              displayResult(refreshData.participant);
            }
          } catch (err) {
            console.error('Save guest2 error:', err);
            showError(err.message || '2번째 참가자 정보 저장 중 오류가 발생했습니다.', guest2Error);
            saveGuest2Btn.disabled = false;
            saveGuest2Btn.textContent = '2번째 참가자 정보 저장';
          }
        });
      }
      
      // 2번째 참가자 전화번호 및 생년월일 숫자만 입력
      const guest2PhoneInput = document.getElementById('guest2Phone');
      const guest2SsnFirstInput = document.getElementById('guest2SsnFirst');
      
      if (guest2PhoneInput) {
        guest2PhoneInput.addEventListener('keydown', (e) => {
          const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'];
          if (allowedKeys.includes(e.key)) return;
          if (!/^[0-9]$/.test(e.key)) {
            e.preventDefault();
            return;
          }
          if (guest2PhoneInput.value.length >= 11 && !allowedKeys.includes(e.key)) {
            e.preventDefault();
          }
        });
        
        guest2PhoneInput.addEventListener('input', (e) => {
          const value = e.target.value.replace(/[^0-9]/g, '');
          guest2PhoneInput.value = value.slice(0, 11);
        });
      }
      
      if (guest2SsnFirstInput) {
        guest2SsnFirstInput.addEventListener('keydown', (e) => {
          const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'];
          if (allowedKeys.includes(e.key)) return;
          if (!/^[0-9]$/.test(e.key)) {
            e.preventDefault();
            return;
          }
          if (guest2SsnFirstInput.value.length >= 6 && !allowedKeys.includes(e.key)) {
            e.preventDefault();
          }
        });
        
        guest2SsnFirstInput.addEventListener('input', (e) => {
          const value = e.target.value.replace(/[^0-9]/g, '');
          guest2SsnFirstInput.value = value.slice(0, 6);
        });
      }

      window.resetForm = function() {
        if (loginForm) loginForm.classList.remove('hidden');
        if (resultCard) resultCard.classList.add('hidden');
        if (phoneInput) phoneInput.value = '';
        currentParticipant = null;
      };

      function showError(message, errorElement) {
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.classList.remove('hidden');
        } else if (errorDiv) {
          errorDiv.textContent = message;
          errorDiv.classList.remove('hidden');
        } else {
          alert(message);
        }
      }
    });
  </script>
</body>
</html>

