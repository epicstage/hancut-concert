<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="í•œë™í›ˆ í† í¬ì½˜ì„œíŠ¸ ì‹ ì²­ë‚´ì—­ í™•ì¸" />
  <meta name="theme-color" content="#dc2626" />
  <title>ì‹ ì²­ë‚´ì—­ í™•ì¸ - í•œë™í›ˆ í† í¬ì½˜ì„œíŠ¸</title>
  <link rel="stylesheet" href="/styles.css?v=2" />
</head>
<body>
  <div class="min-h-screen main-content">
    <!-- í—¤ë” -->
    <header class="glass-header">
      <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
        <a href="/" class="inline-flex items-center gap-2 text-gray-700 hover:text-gray-900" style="text-decoration: none;">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          <span>ëŒì•„ê°€ê¸°</span>
        </a>
        <span class="text-sm text-gray-500">ì‹ ì²­ë‚´ì—­ í™•ì¸</span>
      </div>
    </header>

    <main class="max-w-2xl mx-auto px-4 py-8">
      <!-- ì „í™”ë²ˆí˜¸ ì¡°íšŒ í¼ -->
      <div id="loginForm" class="glass-card">
        <div class="text-center mb-6">
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-900 mb-2">ì‹ ì²­ë‚´ì—­ í™•ì¸</h2>
          <p class="text-gray-500">ì‹ ì²­ ì‹œ ì…ë ¥í•œ ì „í™”ë²ˆí˜¸ë¡œ ì¡°íšŒí•˜ì„¸ìš”</p>
        </div>

        <form id="checkForm" class="space-y-6">
          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">ì „í™”ë²ˆí˜¸</label>
            <div class="input-group">
              <input
                id="phone"
                type="tel"
                inputmode="numeric"
                autocomplete="tel"
                class="input-glass"
                placeholder="01012345678"
                maxlength="11"
                required
              />
            </div>
            <p class="input-hint">í•˜ì´í”ˆ(-) ì—†ì´ 11ìë¦¬ ìˆ«ìë§Œ ì…ë ¥</p>
          </div>

          <div id="error" class="alert alert-error hidden">
            <svg class="alert-icon flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div class="alert-content">
              <p class="alert-message" id="errorMessage"></p>
            </div>
          </div>

          <button type="submit" class="btn-primary-glass w-full" id="submitBtn">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <span>ì¡°íšŒí•˜ê¸°</span>
          </button>
        </form>
      </div>

      <!-- í‹°ì¼“ í˜•íƒœ ê²°ê³¼ ì¹´ë“œ -->
      <div id="resultCard" class="hidden">
        <!-- í‹°ì¼“ ì¹´ë“œ -->
        <div class="ticket-card mb-6">
          <!-- í‹°ì¼“ í—¤ë” -->
          <div class="ticket-header">
            <div class="check-icon">
              <svg id="headerIcon" class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" />
              </svg>
            </div>
            <h2 class="text-xl font-bold">í•œë™í›ˆ í† í¬ì½˜ì„œíŠ¸</h2>
            <p class="text-white/80 text-sm mt-1">2025ë…„ 12ì›” 21ì¼ (ì¼)</p>
          </div>

          <!-- í‹°ì¼“ ë°”ë”” -->
          <div class="ticket-body">
            <!-- ì°¸ê°€ì ì •ë³´ -->
            <div class="space-y-1 mb-4">
              <div class="flex items-center justify-between">
                <span id="userName" class="text-xl font-bold text-gray-900"></span>
                <button 
                  id="editBtn" 
                  class="btn-icon text-gray-400 hover:text-gray-600"
                  aria-label="ì´ë¦„ ìˆ˜ì •"
                  tabindex="0"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                </button>
              </div>
              <p id="userPhone" class="text-gray-500"></p>
            </div>

            <!-- ì´ë¦„ ìˆ˜ì • í¼ -->
            <div id="editForm" class="hidden mb-4 p-3 bg-gray-50 rounded-lg">
              <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„ ìˆ˜ì •</label>
              <div class="flex gap-2">
                <input type="text" id="editNameInput" class="input-glass flex-1" placeholder="ìƒˆ ì´ë¦„" />
                <button id="saveBtn" class="btn-primary-glass px-4">ì €ì¥</button>
                <button id="cancelBtn" class="btn-secondary-glass px-4">ì·¨ì†Œ</button>
              </div>
            </div>

            <div class="ticket-divider"></div>

            <!-- ìƒíƒœ ì •ë³´ -->
            <div class="space-y-3">
              <div class="ticket-info-row">
                <span class="ticket-info-label">ì‹ ì²­ ìœ í˜•</span>
                <span id="ticketType" class="ticket-info-value"></span>
              </div>
              <div class="ticket-info-row">
                <span class="ticket-info-label">ì…ê¸ˆ ìƒíƒœ</span>
                <span id="paymentBadge" class="badge badge-gray"></span>
              </div>
              <div class="ticket-info-row">
                <span class="ticket-info-label">ì¢Œì„ ë°°ì •</span>
                <span id="seatBadge" class="badge badge-gray"></span>
              </div>
              <div id="seatInfoRow" class="ticket-info-row hidden">
                <span class="ticket-info-label">ì¢Œì„ ë²ˆí˜¸</span>
                <span id="seatNumber" class="text-xl font-bold text-red-600"></span>
              </div>
              <div class="ticket-info-row">
                <span class="ticket-info-label">ì‹ ì²­ ì¼ì‹œ</span>
                <span id="createdAt" class="ticket-info-value text-sm"></span>
              </div>
            </div>
          </div>

          <!-- QR ì½”ë“œ ì„¹ì…˜ -->
          <div id="qrCodeSection" class="ticket-qr hidden">
            <p class="text-sm text-gray-600 mb-3">í–‰ì‚¬ ë‹¹ì¼ ì•„ë˜ QRì½”ë“œë¥¼ ì œì‹œí•´ì£¼ì„¸ìš”</p>
            <div id="qrCodeContainer" class="ticket-qr-code">
              <div class="skeleton w-32 h-32"></div>
            </div>
          </div>

          <!-- ì…ê¸ˆ ì•ˆë‚´ (ë¯¸ì…ê¸ˆ ì‹œ) -->
          <div id="paymentGuide" class="hidden p-4 bg-yellow-50 border-t border-yellow-200">
            <div class="flex items-start gap-3">
              <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-lg">ğŸ’°</span>
              </div>
              <div class="flex-1">
                <p class="font-semibold text-gray-900 mb-1">ì…ê¸ˆ ì•ˆë‚´</p>
                <p id="paymentAmount" class="text-lg font-bold text-red-600 mb-2"></p>
                <div class="bg-white p-3 rounded-lg border border-yellow-200 mb-2">
                  <p class="text-sm text-gray-500">ì¹´ì¹´ì˜¤ë±…í¬</p>
                  <p class="font-bold text-gray-900">3333-3548-32957</p>
                  <p class="text-sm text-gray-600">ì˜ˆê¸ˆì£¼: ìƒ˜ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ì¦ˆ</p>
                </div>
                <p class="text-xs text-red-600 font-medium">
                  âš ï¸ ì…ê¸ˆ ì‹œ ì…ê¸ˆìëª…ì„ '<span id="depositName"></span>' í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.
                </p>
              </div>
            </div>
          </div>

          <!-- í‹°ì¼“ ì•¡ì…˜ ë²„íŠ¼ -->
          <div class="ticket-actions">
            <button onclick="addToCalendar()" class="btn-secondary-glass" id="calendarBtn">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <span>ìº˜ë¦°ë” ì¶”ê°€</span>
            </button>
            <button onclick="shareTicket()" class="btn-secondary-glass" id="shareBtn">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
              </svg>
              <span>ê³µìœ í•˜ê¸°</span>
            </button>
          </div>
        </div>

        <!-- 2ë²ˆì§¸ ì°¸ê°€ì ì •ë³´ ì„¹ì…˜ -->
        <div id="guest2Section" class="glass-card hidden mb-6">
          <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
            </svg>
            <span>ë™ë°˜ ì°¸ê°€ì ì •ë³´</span>
          </h3>

          <!-- ì…ë ¥ í¼ -->
          <div id="guest2Form" class="space-y-4">
            <div class="alert alert-info mb-4">
              <svg class="alert-icon flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div class="alert-content">
                <p class="alert-message">2ì¸ ì‹ ì²­ì´ë¯€ë¡œ ë™ë°˜ ì°¸ê°€ì ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. ê°ê° ë³„ë„ì˜ QRì½”ë“œê°€ ë°œê¸‰ë©ë‹ˆë‹¤.</p>
              </div>
            </div>

            <div>
              <label for="guest2Name" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-red-500">*</span> ì´ë¦„
              </label>
              <input
                id="guest2Name"
                type="text"
                class="input-glass"
                placeholder="ë™ë°˜ì ì´ë¦„"
              />
            </div>

            <div>
              <label for="guest2Phone" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-red-500">*</span> ì „í™”ë²ˆí˜¸
              </label>
              <input
                id="guest2Phone"
                type="tel"
                inputmode="numeric"
                class="input-glass"
                placeholder="01012345678"
                maxlength="11"
              />
              <p class="input-hint">í•˜ì´í”ˆ(-) ì—†ì´ 11ìë¦¬ ìˆ«ìë§Œ ì…ë ¥</p>
            </div>

            <div>
              <label for="guest2SsnFirst" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-red-500">*</span> ì£¼ë¯¼ë²ˆí˜¸ ì•ìë¦¬
              </label>
              <input
                id="guest2SsnFirst"
                type="tel"
                inputmode="numeric"
                autocomplete="bday"
                class="input-glass"
                placeholder="620126"
                maxlength="6"
              />
              <p class="input-hint">ìƒë…„ì›”ì¼ 6ìë¦¬ (YYMMDD)</p>
            </div>

            <div id="guest2Error" class="alert alert-error hidden">
              <svg class="alert-icon flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <div class="alert-content">
                <p class="alert-message" id="guest2ErrorMessage"></p>
              </div>
            </div>

            <button id="saveGuest2Btn" class="btn-primary-glass w-full">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              <span>ë™ë°˜ì ì •ë³´ ì €ì¥</span>
            </button>
          </div>

          <!-- ì €ì¥ëœ ì •ë³´ í‘œì‹œ -->
          <div id="guest2Info" class="hidden">
            <div class="p-4 bg-green-50 rounded-xl border border-green-200">
              <div class="flex items-center gap-2 mb-3">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <span class="font-semibold text-green-800">ë™ë°˜ì ì •ë³´ ë“±ë¡ ì™„ë£Œ</span>
              </div>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-500">ì´ë¦„</span>
                  <span id="guest2NameDisplay" class="font-medium text-gray-900"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-500">ì „í™”ë²ˆí˜¸</span>
                  <span id="guest2PhoneDisplay" class="font-medium text-gray-900"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-500">ìƒë…„ì›”ì¼</span>
                  <span id="guest2SsnFirstDisplay" class="font-medium text-gray-900"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ë‹¤ë¥¸ ë²ˆí˜¸ë¡œ ì¡°íšŒ -->
        <button onclick="resetForm()" class="btn-secondary-glass w-full">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <span>ë‹¤ë¥¸ ë²ˆí˜¸ë¡œ ì¡°íšŒí•˜ê¸°</span>
        </button>
      </div>
    </main>

    <!-- í‘¸í„° -->
    <footer class="mt-12 py-8 border-t border-gray-200">
      <div class="max-w-4xl mx-auto px-4 text-center text-sm text-gray-500">
        <p>Â© 2025 ìƒ˜ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ì¦ˆ. All rights reserved.</p>
      </div>
    </footer>

    <!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
    <div id="toastContainer" class="toast-container"></div>
  </div>

  <!-- ë°”í…€ ë„¤ë¹„ê²Œì´ì…˜ (ëª¨ë°”ì¼) -->
  <nav class="bottom-nav">
    <a href="/" class="bottom-nav-item" aria-label="í™ˆ">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
      </svg>
      <span>í™ˆ</span>
    </a>
    <a href="/apply.html" class="bottom-nav-item" aria-label="ì‹ ì²­">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
      </svg>
      <span>ì‹ ì²­</span>
    </a>
    <a href="/check.html" class="bottom-nav-item active" aria-label="í™•ì¸">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
      </svg>
      <span>í™•ì¸</span>
    </a>
    <a href="/inquiry.html" class="bottom-nav-item" aria-label="ë¬¸ì˜">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-4l-4 4z" />
      </svg>
      <span>ë¬¸ì˜</span>
    </a>
  </nav>

  <script>
    let currentParticipant = null;

    // DOM ìš”ì†Œ
    const phoneInput = document.getElementById('phone');
    const form = document.getElementById('checkForm');
    const loginForm = document.getElementById('loginForm');
    const resultCard = document.getElementById('resultCard');
    const errorDiv = document.getElementById('error');
    const submitBtn = document.getElementById('submitBtn');

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      // ì „í™”ë²ˆí˜¸ ìˆ«ìë§Œ ì…ë ¥
      setupNumericInput(phoneInput, 11);

      // í¼ ì œì¶œ
      form.addEventListener('submit', handleSubmit);

      // ì´ë¦„ ìˆ˜ì • ì´ë²¤íŠ¸
      setupNameEdit();

      // 2ë²ˆì§¸ ì°¸ê°€ì ì…ë ¥ ì„¤ì •
      setupGuest2Form();
    });

    // ìˆ«ì ì…ë ¥ ì„¤ì •
    function setupNumericInput(input, maxLength) {
      if (!input) return;

      input.addEventListener('keydown', (e) => {
        const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End'];
        if (allowedKeys.includes(e.key)) return;
        if (!/^[0-9]$/.test(e.key)) {
          e.preventDefault();
          return;
        }
        if (input.value.length >= maxLength) {
          e.preventDefault();
        }
      });

      input.addEventListener('input', (e) => {
        const value = e.target.value.replace(/[^0-9]/g, '');
        input.value = value.slice(0, maxLength);
      });
    }

    // ì „í™”ë²ˆí˜¸ í¬ë§·
    function formatPhone(value) {
      if (!value) return '';
      const numbers = value.replace(/[^0-9]/g, '');
      if (numbers.length <= 3) return numbers;
      if (numbers.length <= 7) return `${numbers.slice(0, 3)}-${numbers.slice(3)}`;
      return `${numbers.slice(0, 3)}-${numbers.slice(3, 7)}-${numbers.slice(7, 11)}`;
    }

    // í¼ ì œì¶œ ì²˜ë¦¬
    async function handleSubmit(e) {
      e.preventDefault();
      hideError();

      const phone = phoneInput.value.replace(/[^0-9]/g, '');

      if (phone.length !== 11) {
        showError('ì „í™”ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”. (11ìë¦¬)');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML = `
        <div class="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>
        <span>ì¡°íšŒ ì¤‘...</span>
      `;

      try {
        // íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ì´ˆ)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const response = await fetch(`/api/participants/phone/${phone}`, {
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }

        currentParticipant = data.participant;
        displayResult(data.participant);
      } catch (err) {
        console.error('Fetch error:', err);
        
        let errorMessage = 'ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        if (err.name === 'AbortError') {
          errorMessage = 'ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        } else if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
          errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        } else if (err.message) {
          errorMessage = err.message;
        }
        
        showError(errorMessage);
        showToast(errorMessage, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <span>ì¡°íšŒí•˜ê¸°</span>
        `;
      }
    }

    // ê²°ê³¼ í‘œì‹œ
    function displayResult(participant) {
      // ê¸°ë³¸ ì •ë³´
      document.getElementById('userName').textContent = participant.user_name;
      document.getElementById('userPhone').textContent = formatPhone(participant.phone);

      // ì‹ ì²­ ìœ í˜•
      const ticketCount = participant.ticket_count || 1;
      const isTwoPerson = ticketCount === 2 || participant.guest2_name;
      document.getElementById('ticketType').textContent = isTwoPerson ? '2ì¸ ì‹ ì²­' : '1ì¸ ì‹ ì²­';

      // ì…ê¸ˆ ìƒíƒœ
      const paymentBadge = document.getElementById('paymentBadge');
      if (participant.is_paid) {
        paymentBadge.className = 'badge badge-green';
        paymentBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-600"></span> ì…ê¸ˆ ì™„ë£Œ';
      } else {
        paymentBadge.className = 'badge badge-yellow';
        paymentBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-yellow-600 animate-pulse"></span> ì…ê¸ˆ ëŒ€ê¸°';
      }

      // ì¢Œì„ ë°°ì •
      const seatBadge = document.getElementById('seatBadge');
      const seatInfoRow = document.getElementById('seatInfoRow');
      if (participant.seat_full) {
        seatBadge.className = 'badge badge-green';
        seatBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-600"></span> ë°°ì • ì™„ë£Œ';
        seatInfoRow.classList.remove('hidden');
        document.getElementById('seatNumber').textContent = participant.seat_full;
      } else {
        seatBadge.className = 'badge badge-gray';
        seatBadge.innerHTML = 'ë°°ì • ëŒ€ê¸°';
        seatInfoRow.classList.add('hidden');
      }

      // ì‹ ì²­ ì¼ì‹œ
      if (participant.created_at) {
        const date = new Date(participant.created_at.replace(' ', 'T'));
        document.getElementById('createdAt').textContent = date.toLocaleString('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false,
          timeZone: 'Asia/Seoul'
        });
      }

      // ì…ê¸ˆ ì•ˆë‚´ (ë¯¸ì…ê¸ˆ ì‹œ)
      const paymentGuide = document.getElementById('paymentGuide');
      if (!participant.is_paid) {
        paymentGuide.classList.remove('hidden');
        const amount = isTwoPerson ? 'â‚©60,000' : 'â‚©30,000';
        document.getElementById('paymentAmount').textContent = amount;
        const phoneLast4 = participant.phone.slice(-4);
        document.getElementById('depositName').textContent = `${participant.user_name}${phoneLast4}`;
      } else {
        paymentGuide.classList.add('hidden');
      }

      // QR ì½”ë“œ (ì…ê¸ˆ ì™„ë£Œ ì‹œ)
      const qrCodeSection = document.getElementById('qrCodeSection');
      if (participant.is_paid) {
        qrCodeSection.classList.remove('hidden');
        generateQRCode(participant);
      } else {
        qrCodeSection.classList.add('hidden');
      }

      // 2ë²ˆì§¸ ì°¸ê°€ì ì„¹ì…˜
      const guest2Section = document.getElementById('guest2Section');
      const guest2Form = document.getElementById('guest2Form');
      const guest2Info = document.getElementById('guest2Info');

      if (isTwoPerson) {
        guest2Section.classList.remove('hidden');

        if (participant.is_guest2_completed && participant.guest2_name) {
          guest2Form.classList.add('hidden');
          guest2Info.classList.remove('hidden');
          document.getElementById('guest2NameDisplay').textContent = participant.guest2_name;
          document.getElementById('guest2PhoneDisplay').textContent = formatPhone(participant.guest2_phone || '');
          document.getElementById('guest2SsnFirstDisplay').textContent = participant.guest2_ssn_first || '-';
        } else {
          guest2Form.classList.remove('hidden');
          guest2Info.classList.add('hidden');
        }
      } else {
        guest2Section.classList.add('hidden');
      }

      // í™”ë©´ ì „í™˜
      loginForm.classList.add('hidden');
      resultCard.classList.remove('hidden');

      // ìŠ¤í¬ë¡¤ ìƒë‹¨
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // QR ì½”ë“œ ìƒì„±
    function generateQRCode(participant) {
      const qrCodeContainer = document.getElementById('qrCodeContainer');
      const qrData = JSON.stringify({
        id: participant.id,
        name: participant.user_name,
        phone: participant.phone,
        seat: participant.seat_full || null
      });

      qrCodeContainer.innerHTML = '<div class="skeleton w-32 h-32"></div>';

      // QR ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
      loadQRCodeLibrary()
        .then(() => {
          qrCodeContainer.innerHTML = '';
          new QRCode(qrCodeContainer, {
            text: qrData,
            width: 180,
            height: 180,
            colorDark: '#000000',
            colorLight: '#FFFFFF',
            correctLevel: QRCode.CorrectLevel.H
          });
        })
        .catch(err => {
          console.error('QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨:', err);
          qrCodeContainer.innerHTML = '<p class="text-red-600 text-sm">QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨</p>';
        });
    }

    // QR ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
    function loadQRCodeLibrary() {
      return new Promise((resolve, reject) => {
        if (typeof QRCode !== 'undefined') {
          resolve();
          return;
        }

        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
        script.onload = resolve;
        script.onerror = () => reject(new Error('Failed to load QRCode library'));
        document.head.appendChild(script);
      });
    }

    // ì´ë¦„ ìˆ˜ì • ì„¤ì •
    function setupNameEdit() {
      const editBtn = document.getElementById('editBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const saveBtn = document.getElementById('saveBtn');
      const editForm = document.getElementById('editForm');
      const editNameInput = document.getElementById('editNameInput');

      editBtn?.addEventListener('click', () => {
        editForm.classList.remove('hidden');
        editNameInput.value = currentParticipant?.user_name || '';
        editNameInput.focus();
      });

      cancelBtn?.addEventListener('click', () => {
        editForm.classList.add('hidden');
      });

      saveBtn?.addEventListener('click', async () => {
        const newName = editNameInput.value.trim();
        if (!newName) {
          showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
          return;
        }

        try {
          const response = await fetch(`/api/participants/${currentParticipant.id}/name`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_name: newName }),
          });

          const data = await response.json();
          if (!response.ok) throw new Error(data.error);

          currentParticipant.user_name = newName;
          document.getElementById('userName').textContent = newName;
          editForm.classList.add('hidden');
          showToast('ì´ë¦„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } catch (err) {
          showToast(err.message || 'ì´ë¦„ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      });
    }

    // 2ë²ˆì§¸ ì°¸ê°€ì í¼ ì„¤ì •
    function setupGuest2Form() {
      const guest2PhoneInput = document.getElementById('guest2Phone');
      const guest2SsnFirstInput = document.getElementById('guest2SsnFirst');
      const saveGuest2Btn = document.getElementById('saveGuest2Btn');

      setupNumericInput(guest2PhoneInput, 11);
      setupNumericInput(guest2SsnFirstInput, 6);

      saveGuest2Btn?.addEventListener('click', async () => {
        const guest2Name = document.getElementById('guest2Name').value.trim();
        const guest2Phone = document.getElementById('guest2Phone').value.replace(/[^0-9]/g, '');
        const guest2SsnFirst = document.getElementById('guest2SsnFirst').value.replace(/[^0-9]/g, '');

        // ìœ íš¨ì„± ê²€ì‚¬
        if (!guest2Name) {
          showGuest2Error('ë™ë°˜ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        if (guest2Phone.length !== 11) {
          showGuest2Error('ì „í™”ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”. (11ìë¦¬)');
          return;
        }

        if (guest2SsnFirst.length !== 6) {
          showGuest2Error('ì£¼ë¯¼ë²ˆí˜¸ ì•ìë¦¬ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”. (6ìë¦¬)');
          return;
        }

        // ìƒë…„ì›”ì¼ ê²€ì¦
        const mm = parseInt(guest2SsnFirst.substring(2, 4));
        const dd = parseInt(guest2SsnFirst.substring(4, 6));
        const daysInMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

        if (mm < 1 || mm > 12) {
          showGuest2Error('ìƒë…„ì›”ì¼ì˜ ì›”ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (01-12)');
          return;
        }

        if (dd < 1 || dd > daysInMonth[mm - 1]) {
          showGuest2Error(`ìƒë…„ì›”ì¼ì˜ ì¼ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (${mm}ì›”ì€ 01-${daysInMonth[mm-1]}ì¼)`);
          return;
        }

        hideGuest2Error();

        saveGuest2Btn.disabled = true;
        saveGuest2Btn.innerHTML = `
          <div class="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>
          <span>ì €ì¥ ì¤‘...</span>
        `;

        try {
          const response = await fetch(`/api/participants/phone/${currentParticipant.phone}/guest2`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              guest2_name: guest2Name,
              guest2_phone: guest2Phone,
              guest2_ssn_first: guest2SsnFirst,
            }),
          });

          const data = await response.json();
          if (!response.ok) throw new Error(data.error);

          // ìƒˆë¡œê³ ì¹¨
          const refreshResponse = await fetch(`/api/participants/phone/${currentParticipant.phone}`);
          const refreshData = await refreshResponse.json();

          if (refreshData.success) {
            currentParticipant = refreshData.participant;
            displayResult(refreshData.participant);
            showToast('ë™ë°˜ì ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          }
        } catch (err) {
          showGuest2Error(err.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          saveGuest2Btn.disabled = false;
          saveGuest2Btn.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            <span>ë™ë°˜ì ì •ë³´ ì €ì¥</span>
          `;
        }
      });
    }

    // ìº˜ë¦°ë” ì¶”ê°€
    function addToCalendar() {
      const eventTitle = 'í•œë™í›ˆ í† í¬ì½˜ì„œíŠ¸';
      const eventLocation = 'ê³ ì–‘ í‚¨í…ìŠ¤ ì œ1ì „ì‹œì¥ 3ì¸µ ê·¸ëœë“œë³¼ë£¸';
      const startDate = '20251221T100000';
      const endDate = '20251221T180000';

      // Google Calendar
      const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(eventTitle)}&dates=${startDate}/${endDate}&location=${encodeURIComponent(eventLocation)}&sf=true&output=xml`;

      window.open(googleUrl, '_blank');
      showToast('ìº˜ë¦°ë”ê°€ ì—´ë¦½ë‹ˆë‹¤.', 'info');
    }

    // ê³µìœ í•˜ê¸°
    async function shareTicket() {
      const shareData = {
        title: 'í•œë™í›ˆ í† í¬ì½˜ì„œíŠ¸',
        text: `í•œë™í›ˆ í† í¬ì½˜ì„œíŠ¸ì— ì°¸ê°€í•©ë‹ˆë‹¤!\nğŸ“… 2025ë…„ 12ì›” 21ì¼ (ì¼)\nğŸ“ ê³ ì–‘ í‚¨í…ìŠ¤ ì œ1ì „ì‹œì¥ 3ì¸µ ê·¸ëœë“œë³¼ë£¸`,
        url: window.location.origin
      };

      try {
        if (navigator.share) {
          await navigator.share(shareData);
        } else {
          // Fallback: í´ë¦½ë³´ë“œ ë³µì‚¬
          await navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`);
          showToast('ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
      } catch (err) {
        console.error('Share error:', err);
      }
    }

    // í¼ ë¦¬ì…‹
    function resetForm() {
      loginForm.classList.remove('hidden');
      resultCard.classList.add('hidden');
      phoneInput.value = '';
      currentParticipant = null;
      hideError();
    }

    // ì—ëŸ¬ í‘œì‹œ
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      errorDiv.classList.remove('hidden');
    }

    function hideError() {
      errorDiv.classList.add('hidden');
    }

    function showGuest2Error(message) {
      document.getElementById('guest2ErrorMessage').textContent = message;
      document.getElementById('guest2Error').classList.remove('hidden');
    }

    function hideGuest2Error() {
      document.getElementById('guest2Error').classList.add('hidden');
    }

    // í† ìŠ¤íŠ¸ ì•Œë¦¼
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast';

      const iconColors = {
        success: 'text-green-600',
        error: 'text-red-600',
        warning: 'text-yellow-600',
        info: 'text-blue-600'
      };

      const icons = {
        success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />',
        error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />',
        warning: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />',
        info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />'
      };

      toast.innerHTML = `
        <svg class="w-5 h-5 ${iconColors[type]}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          ${icons[type]}
        </svg>
        <span>${message}</span>
      `;

      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>
